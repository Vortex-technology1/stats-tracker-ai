<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TALKO Statistics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <style>
        /* ============================================
           CSS VARIABLES & RESET
           ============================================ */
        :root {
            --primary: #22c55e;
            --primary-dark: #16a34a;
            --primary-light: #bbf7d0;
            --primary-bg: #f0fdf4;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --danger-light: #fecaca;
            --danger-bg: #fef2f2;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --warning-light: #fef3c7;
            --warning-bg: #fffbeb;
            --info: #3b82f6;
            --info-dark: #2563eb;
            --info-light: #dbeafe;
            --info-bg: #eff6ff;
            --purple: #8b5cf6;
            --purple-light: #ddd6fe;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --radius-xs: 4px;
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1);
            --transition-fast: 0.15s ease;
            --transition: 0.2s ease;
            --transition-slow: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--gray-50);
            color: var(--gray-800);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============================================
           LOADING OVERLAY
           ============================================ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            z-index: 99999;
            opacity: 1;
            transition: opacity var(--transition-slow);
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .spinner-sm {
            width: 20px;
            height: 20px;
            border-width: 2px;
        }

        .spinner-lg {
            width: 64px;
            height: 64px;
            border-width: 5px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 15px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .loading-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .loading-logo svg {
            width: 40px;
            height: 40px;
            color: var(--primary);
        }

        .loading-logo span {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
        }

        /* ============================================
           AUTH SCREEN
           ============================================ */
        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-bg) 0%, #ecfdf5 50%, var(--primary-bg) 100%);
        }

        .auth-container {
            width: 100%;
            max-width: 440px;
        }

        .auth-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-xl);
            padding: 40px;
            position: relative;
            overflow: hidden;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .auth-logo svg {
            width: 48px;
            height: 48px;
            color: var(--primary);
        }

        .auth-logo span {
            font-size: 28px;
            font-weight: 700;
            color: var(--gray-800);
        }

        .auth-subtitle {
            text-align: center;
            color: var(--gray-500);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--gray-100);
            padding: 4px;
            border-radius: var(--radius-sm);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
        }

        .auth-tab:hover {
            color: var(--gray-800);
        }

        .auth-tab.active {
            background: white;
            color: var(--gray-900);
            box-shadow: var(--shadow-sm);
        }

        .auth-error {
            background: var(--danger-bg);
            border: 1px solid var(--danger-light);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .auth-error.show {
            display: flex;
        }

        .auth-error svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .auth-success {
            background: var(--primary-bg);
            border: 1px solid var(--primary-light);
            color: var(--primary-dark);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .auth-success.show {
            display: flex;
        }

        /* ============================================
           FORM ELEMENTS
           ============================================ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-label-optional {
            font-weight: 400;
            color: var(--gray-400);
            font-size: 13px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-family: inherit;
            transition: all var(--transition);
            background: white;
        }

        .form-input:hover {
            border-color: var(--gray-300);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .form-input:disabled {
            background: var(--gray-100);
            cursor: not-allowed;
        }

        .form-input-error {
            border-color: var(--danger);
        }

        .form-input-error:focus {
            box-shadow: 0 0 0 3px var(--danger-light);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            padding-right: 40px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-family: inherit;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E") no-repeat right 12px center;
            background-size: 18px;
            cursor: pointer;
            appearance: none;
            transition: all var(--transition);
        }

        .form-select:hover {
            border-color: var(--gray-300);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: all var(--transition);
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-hint {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 6px;
        }

        .form-error-text {
            font-size: 13px;
            color: var(--danger);
            margin-top: 6px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--gray-700);
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--gray-300);
            border-radius: 26px;
            transition: var(--transition);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--primary);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(22px);
        }

        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all var(--transition);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--gray-200);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--gray-300);
            color: var(--gray-700);
        }

        .btn-outline:hover:not(:disabled) {
            border-color: var(--gray-400);
            background: var(--gray-50);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: var(--danger-dark);
        }

        .btn-ghost {
            background: transparent;
            color: var(--gray-600);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 16px;
        }

        .btn-icon {
            padding: 10px;
            min-width: 40px;
            min-height: 40px;
        }

        .btn-icon-sm {
            padding: 6px;
            min-width: 32px;
            min-height: 32px;
        }

        .btn-block {
            width: 100%;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .btn svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .btn-sm svg {
            width: 16px;
            height: 16px;
        }

        /* ============================================
           APP CONTAINER
           ============================================ */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.show {
            display: block;
        }

        /* ============================================
           HEADER
           ============================================ */
        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 20px;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-xs);
        }

        .header-content {
            max-width: 1440px;
            margin: 0 auto;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 20px;
            color: var(--gray-800);
            text-decoration: none;
        }

        .logo svg {
            width: 32px;
            height: 32px;
            color: var(--primary);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }

        .logo-name {
            font-size: 18px;
        }

        .logo-subtitle {
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-500);
        }

        .company-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary-bg);
            border: 1px solid var(--primary-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
        }

        .company-selector:hover {
            background: var(--primary-light);
        }

        .company-selector svg {
            width: 18px;
            height: 18px;
            color: var(--primary-dark);
        }

        .company-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-dark);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-btn {
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
        }

        .user-menu:hover {
            background: var(--gray-200);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .user-role {
            font-size: 11px;
            color: var(--gray-500);
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .role-owner {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .role-manager {
            background: var(--purple-light);
            color: var(--purple);
        }

        .role-employee {
            background: var(--info-light);
            color: var(--info);
        }

        .role-superadmin {
            background: var(--warning-light);
            color: var(--warning-dark);
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 12px;
                height: 56px;
            }

            .logo-text {
                display: none;
            }

            .company-selector {
                padding: 6px 10px;
            }

            .company-name {
                max-width: 100px;
                font-size: 13px;
            }

            .user-info {
                display: none;
            }

            .header-actions {
                gap: 4px;
            }
        }

        /* ============================================
           NAVIGATION
           ============================================ */
        .nav-container {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 64px;
            z-index: 90;
        }

        .nav-tabs {
            max-width: 1440px;
            margin: 0 auto;
            display: flex;
            gap: 4px;
            padding: 8px 20px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--transition);
            font-family: inherit;
        }

        .nav-tab:hover {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        .nav-tab svg {
            width: 18px;
            height: 18px;
        }

        .nav-tab-badge {
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .nav-tab.active .nav-tab-badge {
            background: white;
            color: var(--primary);
        }

        @media (max-width: 768px) {
            .nav-container {
                top: 56px;
            }

            .nav-tabs {
                padding: 8px 12px;
            }

            .nav-tab {
                padding: 8px 14px;
                font-size: 13px;
            }

            .nav-tab span {
                display: none;
            }

            .nav-tab svg {
                width: 20px;
                height: 20px;
            }
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */
        .main-content {
            max-width: 1440px;
            margin: 0 auto;
            padding: 24px 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 16px 12px;
            }
        }

        .tab-panel {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .page-subtitle {
            font-size: 14px;
            color: var(--gray-500);
        }

        .page-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        @media (max-width: 640px) {
            .page-header {
                flex-direction: column;
            }

            .page-actions {
                width: 100%;
            }

            .page-actions .btn {
                flex: 1;
            }
        }

        /* ============================================
           CARDS
           ============================================ */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-100);
            gap: 16px;
        }

        .card-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            flex-shrink: 0;
        }

        .card-icon svg {
            width: 22px;
            height: 22px;
        }

        .card-icon-primary {
            background: var(--primary-bg);
            color: var(--primary);
        }

        .card-icon-danger {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .card-icon-warning {
            background: var(--warning-bg);
            color: var(--warning);
        }

        .card-icon-info {
            background: var(--info-bg);
            color: var(--info);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .card-subtitle {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .card-body {
            padding: 24px;
        }

        .card-body-compact {
            padding: 16px 24px;
        }

        .card-footer {
            padding: 16px 24px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-100);
        }

        .card-flush .card-body {
            padding: 0;
        }

        @media (max-width: 640px) {
            .card-header {
                padding: 16px;
                flex-wrap: wrap;
            }

            .card-body {
                padding: 16px;
            }
        }

        /* ============================================
           STATS GRID
           ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .stat-card-primary::before { background: var(--primary); }
        .stat-card-danger::before { background: var(--danger); }
        .stat-card-warning::before { background: var(--warning); }
        .stat-card-info::before { background: var(--info); }

        .stat-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
        }

        .stat-icon svg {
            width: 24px;
            height: 24px;
        }

        .stat-icon-primary { background: var(--primary-bg); color: var(--primary); }
        .stat-icon-danger { background: var(--danger-bg); color: var(--danger); }
        .stat-icon-warning { background: var(--warning-bg); color: var(--warning); }
        .stat-icon-info { background: var(--info-bg); color: var(--info); }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .stat-trend svg {
            width: 14px;
            height: 14px;
        }

        .stat-trend-up {
            background: var(--primary-bg);
            color: var(--primary-dark);
        }

        .stat-trend-down {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .stat-trend-neutral {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray-500);
        }

        .stat-footer {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-100);
            font-size: 13px;
            color: var(--gray-600);
        }

        .stat-progress {
            flex: 1;
            height: 6px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .stat-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width var(--transition-slow);
        }

        .stat-progress-primary { background: var(--primary); }
        .stat-progress-danger { background: var(--danger); }
        .stat-progress-warning { background: var(--warning); }

        /* ============================================
           DATA TABLE
           ============================================ */
        .table-container {
            overflow-x: auto;
            margin: -24px;
            padding: 0;
        }

        .table-container-compact {
            margin: 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 800px;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        .data-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            background: var(--gray-50);
        }

        .data-table td:first-child {
            position: sticky;
            left: 0;
            background: white;
            font-weight: 500;
        }

        .data-table tbody tr:hover td {
            background: var(--gray-50);
        }

        .data-table tbody tr:hover td:first-child {
            background: var(--gray-50);
        }

        .data-table-sortable th {
            cursor: pointer;
            user-select: none;
        }

        .data-table-sortable th:hover {
            background: var(--gray-100);
        }

        .th-content {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sort-icon {
            width: 14px;
            height: 14px;
            color: var(--gray-400);
        }

        .sort-icon.active {
            color: var(--primary);
        }

        .cell-metric {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .metric-drag-handle {
            cursor: grab;
            color: var(--gray-400);
            padding: 4px;
        }

        .metric-drag-handle:hover {
            color: var(--gray-600);
        }

        .metric-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .metric-name {
            font-weight: 500;
            color: var(--gray-800);
        }

        .metric-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--gray-500);
        }

        .metric-responsible {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stats-input {
            width: 90px;
            padding: 8px 10px;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xs);
            font-size: 14px;
            text-align: center;
            font-family: inherit;
            transition: all var(--transition);
        }

        .stats-input:hover {
            border-color: var(--gray-300);
        }

        .stats-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .stats-input:disabled {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .stats-input-readonly {
            background: transparent;
            border-color: transparent;
            text-align: center;
        }

        .cell-value {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .value-main {
            font-weight: 600;
            font-size: 15px;
        }

        .value-plan {
            font-size: 11px;
            color: var(--gray-400);
        }

        .percent-badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .percent-success {
            background: var(--primary-bg);
            color: var(--primary-dark);
        }

        .percent-warning {
            background: var(--warning-bg);
            color: var(--warning-dark);
        }

        .percent-danger {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .trend-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
            font-weight: 600;
        }

        .trend-badge svg {
            width: 14px;
            height: 14px;
        }

        .trend-up {
            color: var(--primary);
        }

        .trend-down {
            color: var(--danger);
        }

        .trend-neutral {
            color: var(--gray-500);
        }

        .cell-actions {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .importance-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .importance-critical { background: var(--danger); }
        .importance-high { background: #ea580c; }
        .importance-medium { background: var(--warning); }
        .importance-low { background: var(--primary); }

        /* ============================================
           PERIOD SELECTOR
           ============================================ */
        .period-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 16px;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
        }

        .period-btn:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }

        .period-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .period-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .period-nav-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition);
            color: var(--gray-600);
        }

        .period-nav-btn:hover {
            background: var(--gray-200);
            color: var(--gray-800);
        }

        .period-nav-btn svg {
            width: 18px;
            height: 18px;
        }

        .period-current {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-800);
            padding: 0 12px;
        }

        /* ============================================
           RED FLAGS
           ============================================ */
        .red-flags-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .red-flag {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--danger-bg);
            border: 1px solid var(--danger-light);
            border-left: 4px solid var(--danger);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            transition: all var(--transition);
        }

        .red-flag:hover {
            box-shadow: var(--shadow-md);
        }

        .red-flag-icon {
            width: 40px;
            height: 40px;
            background: var(--danger-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .red-flag-icon svg {
            width: 20px;
            height: 20px;
            color: var(--danger);
        }

        .red-flag-content {
            flex: 1;
        }

        .red-flag-title {
            font-weight: 600;
            color: var(--danger);
            margin-bottom: 4px;
        }

        .red-flag-text {
            font-size: 14px;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .red-flag-meta {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
            color: var(--gray-500);
        }

        .red-flag-action {
            flex-shrink: 0;
        }

        .warning-flag {
            background: var(--warning-bg);
            border-color: var(--warning-light);
            border-left-color: var(--warning);
        }

        .warning-flag .red-flag-icon {
            background: var(--warning-light);
        }

        .warning-flag .red-flag-icon svg,
        .warning-flag .red-flag-title {
            color: var(--warning-dark);
        }

        /* ============================================
           AI ANALYSIS
           ============================================ */
        .ai-card {
            background: linear-gradient(135deg, var(--primary-bg) 0%, #ecfdf5 100%);
            border: 1px solid var(--primary-light);
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 24px;
            border-bottom: 1px solid var(--primary-light);
        }

        .ai-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ai-badge svg {
            width: 14px;
            height: 14px;
        }

        .ai-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .ai-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .ai-body {
            padding: 24px;
        }

        .ai-content {
            background: white;
            border-radius: var(--radius-sm);
            padding: 20px;
            font-size: 14px;
            line-height: 1.8;
            color: var(--gray-700);
            white-space: pre-wrap;
            min-height: 200px;
        }

        .ai-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 60px 20px;
            text-align: center;
        }

        .ai-loading-text {
            color: var(--gray-600);
            font-size: 14px;
        }

        .ai-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 60px 20px;
            text-align: center;
            color: var(--gray-500);
        }

        .ai-placeholder svg {
            width: 48px;
            height: 48px;
            opacity: 0.5;
        }

        .ai-section {
            margin-bottom: 20px;
        }

        .ai-section:last-child {
            margin-bottom: 0;
        }

        .ai-section-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-section-content {
            color: var(--gray-600);
            line-height: 1.7;
        }

        .ai-recommendation {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .ai-recommendation-number {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* ============================================
           EMPTY STATE
           ============================================ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-500);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
            color: var(--gray-400);
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 20px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-slow);
            padding: 20px;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: translateY(20px) scale(0.98);
            transition: transform var(--transition-slow);
        }

        .modal-overlay.show .modal {
            transform: translateY(0) scale(1);
        }

        .modal-lg {
            max-width: 720px;
        }

        .modal-sm {
            max-width: 400px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--gray-500);
            border-radius: var(--radius-sm);
            transition: all var(--transition);
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 24px;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
            flex-shrink: 0;
        }

        @media (max-width: 640px) {
            .modal {
                max-height: 100vh;
                border-radius: 0;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-body {
                padding: 16px;
            }

            .modal-footer {
                padding: 12px 16px;
            }

            .modal-footer .btn {
                flex: 1;
            }
        }

        /* ============================================
           SETTINGS PANELS
           ============================================ */
        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-title svg {
            width: 18px;
            height: 18px;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            gap: 16px;
        }

        .settings-item-info {
            flex: 1;
        }

        .settings-item-title {
            font-weight: 500;
            color: var(--gray-800);
            margin-bottom: 2px;
        }

        .settings-item-desc {
            font-size: 13px;
            color: var(--gray-500);
        }

        /* ============================================
           TEAM LIST
           ============================================ */
        .team-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .team-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            transition: all var(--transition);
        }

        .team-item:hover {
            background: var(--gray-100);
        }

        .team-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .team-avatar-owner {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .team-avatar-employee {
            background: var(--info-light);
            color: var(--info);
        }

        .team-info {
            flex: 1;
        }

        .team-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 2px;
        }

        .team-email {
            font-size: 13px;
            color: var(--gray-500);
        }

        .team-actions {
            display: flex;
            gap: 8px;
        }

        /* ============================================
           ADMIN PANEL
           ============================================ */
        .admin-section {
            margin-bottom: 32px;
        }

        .admin-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gray-800);
        }

        .admin-title svg {
            width: 22px;
            height: 22px;
            color: var(--primary);
        }

        .company-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .company-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
            gap: 16px;
            transition: all var(--transition);
        }

        .company-item:hover {
            background: var(--gray-100);
        }

        .company-info h4 {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }

        .company-info p {
            font-size: 13px;
            color: var(--gray-500);
        }

        .company-meta {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 6px;
        }

        .company-actions {
            display: flex;
            gap: 8px;
        }

        .credentials-box {
            background: var(--primary-bg);
            border: 1px solid var(--primary-light);
            border-radius: var(--radius-sm);
            padding: 20px;
            margin-top: 20px;
        }

        .credentials-title {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .credentials-title svg {
            width: 20px;
            height: 20px;
        }

        .credentials-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--primary-light);
        }

        .credentials-item:last-of-type {
            border-bottom: none;
        }

        .credentials-label {
            color: var(--gray-600);
            font-size: 14px;
        }

        .credentials-value {
            font-weight: 600;
            font-family: 'SF Mono', Consolas, monospace;
            color: var(--gray-800);
        }

        .credentials-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        /* ============================================
           CHARTS
           ============================================ */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .chart-legend {
            display: flex;
            gap: 16px;
            font-size: 13px;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chart-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* ============================================
           TOAST
           ============================================ */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            background: var(--gray-800);
            color: white;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transform: translateX(100%);
            transition: all var(--transition-slow);
            max-width: 360px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .toast-success {
            background: var(--primary);
        }

        .toast-error {
            background: var(--danger);
        }

        .toast-warning {
            background: var(--warning);
        }

        .toast-info {
            background: var(--info);
        }

        @media (max-width: 640px) {
            .toast-container {
                bottom: 16px;
                right: 16px;
                left: 16px;
            }

            .toast {
                max-width: none;
            }
        }

        /* ============================================
           DROPDOWN
           ============================================ */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--gray-200);
            min-width: 180px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition);
            z-index: 100;
        }

        .dropdown.open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            font-size: 14px;
            color: var(--gray-700);
            cursor: pointer;
            transition: all var(--transition);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        .dropdown-item:hover {
            background: var(--gray-50);
        }

        .dropdown-item svg {
            width: 16px;
            height: 16px;
            color: var(--gray-500);
        }

        .dropdown-item-danger {
            color: var(--danger);
        }

        .dropdown-item-danger svg {
            color: var(--danger);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        /* ============================================
           MISC
           ============================================ */
        .divider {
            height: 1px;
            background: var(--gray-200);
            margin: 24px 0;
        }

        .hidden {
            display: none !important;
        }

        .text-muted {
            color: var(--gray-500);
        }

        .text-success {
            color: var(--primary);
        }

        .text-danger {
            color: var(--danger);
        }

        .text-warning {
            color: var(--warning);
        }

        .text-center {
            text-align: center;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gap-sm { gap: 8px; }
        .gap-md { gap: 16px; }
        .gap-lg { gap: 24px; }

        .mt-sm { margin-top: 8px; }
        .mt-md { margin-top: 16px; }
        .mt-lg { margin-top: 24px; }

        .mb-sm { margin-bottom: 8px; }
        .mb-md { margin-bottom: 16px; }
        .mb-lg { margin-bottom: 24px; }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-primary {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning-dark);
        }

        .badge-info {
            background: var(--info-light);
            color: var(--info);
        }

        .badge-gray {
            background: var(--gray-200);
            color: var(--gray-600);
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, var(--gray-200) 25%, var(--gray-100) 50%, var(--gray-200) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-text-lg {
            height: 24px;
        }

        .skeleton-text-sm {
            height: 12px;
        }

        /* Tabs within cards */
        .inner-tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
        }

        .inner-tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all var(--transition);
            font-family: inherit;
        }

        .inner-tab:hover {
            color: var(--gray-800);
        }

        .inner-tab.active {
            background: white;
            color: var(--gray-900);
            box-shadow: var(--shadow-sm);
        }

        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: var(--gray-800);
            color: white;
            font-size: 12px;
            white-space: nowrap;
            border-radius: var(--radius-xs);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition);
            margin-bottom: 8px;
            z-index: 100;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* GPT Export Section */
        .gpt-export-box {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 20px;
            text-align: center;
        }

        .gpt-export-box p {
            color: var(--gray-600);
            margin-bottom: 12px;
        }

        .gpt-export-preview {
            background: var(--gray-800);
            color: #fff;
            padding: 16px;
            border-radius: var(--radius-sm);
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 12px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 3v18h18"/>
                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
            </svg>
            <span>TALKO Statistics</span>
        </div>
        <div class="spinner"></div>
        <div class="loading-text">...</div>
    </div>

    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3v18h18"/>
                        <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                    </svg>
                    <span>TALKO Statistics</span>
                </div>
                <p class="auth-subtitle">   ,    </p>

                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="showAuthTab('login')"></button>
                    <button class="auth-tab" onclick="showAuthTab('register')"></button>
                </div>

                <div class="auth-error" id="authError">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    <span id="authErrorText"></span>
                </div>

                <!-- Login Form -->
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required placeholder="email@example.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label"></label>
                        <input type="password" class="form-input" id="loginPassword" required placeholder="" autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                        <span></span>
                    </button>
                </form>

                <!-- Register Form -->
                <form id="registerForm" style="display:none" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="registerEmail" required placeholder="email@example.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label"></label>
                        <input type="password" class="form-input" id="registerPassword" required placeholder=" 6 " minlength="6" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label class="form-label"> '</label>
                        <input type="text" class="form-input" id="registerName" required placeholder=" ">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="registerBtn">
                        <span></span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <a href="#" class="logo">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                        </svg>
                        <div class="logo-text">
                            <span class="logo-name">TALKO</span>
                            <span class="logo-subtitle">Statistics</span>
                        </div>
                    </a>
                    <div class="company-selector" id="companySelector">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9 22 9 12 15 12 15 22"/>
                        </svg>
                        <span class="company-name" id="companyName">...</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <button class="btn btn-ghost btn-icon notification-btn" data-tooltip="" id="notificationBtn" style="display:none">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                            </svg>
                            <span class="notification-badge" id="notificationBadge" style="display:none"></span>
                        </button>
                    </div>
                    <div class="user-menu" id="userMenu">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-info">
                            <span class="user-name" id="userName"></span>
                            <span class="user-role" id="userRoleText"></span>
                        </div>
                    </div>
                    <button class="btn btn-ghost btn-icon" onclick="logout()" data-tooltip="">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-container">
            <div class="nav-tabs" id="navTabs">
                <button class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="9"/>
                        <rect x="14" y="3" width="7" height="5"/>
                        <rect x="14" y="12" width="7" height="9"/>
                        <rect x="3" y="16" width="7" height="5"/>
                    </svg>
                    <span></span>
                </button>
                <button class="nav-tab" data-tab="weekly" onclick="switchTab('weekly')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span></span>
                </button>
                <button class="nav-tab" data-tab="monthly" onclick="switchTab('monthly')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 2v4"/>
                        <path d="M16 2v4"/>
                        <rect width="18" height="18" x="3" y="4" rx="2"/>
                        <path d="M3 10h18"/>
                        <path d="M8 14h.01"/>
                        <path d="M12 14h.01"/>
                        <path d="M16 14h.01"/>
                    </svg>
                    <span></span>
                </button>
                <button class="nav-tab" data-tab="charts" onclick="switchTab('charts')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    <span></span>
                </button>
                <button class="nav-tab" data-tab="ai" onclick="switchTab('ai')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <span>AI </span>
                </button>
                <button class="nav-tab" data-tab="settings" onclick="switchTab('settings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span></span>
                </button>
                <button class="nav-tab" data-tab="admin" onclick="switchTab('admin')" id="adminTab" style="display:none">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    <span></span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Panel -->
            <div class="tab-panel active" id="dashboardPanel">
                <!-- Stats Grid -->
                <div class="stats-grid" id="statsGrid">
                    <!-- Dynamic stats cards will be inserted here -->
                </div>

                <!-- Red Flags Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon card-icon-danger">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                                    <line x1="4" y1="22" x2="4" y2="15"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="card-title">Red Flags</h3>
                                <p class="card-subtitle"> ,   </p>
                            </div>
                        </div>
                        <span class="badge badge-danger" id="redFlagsCount" style="display:none">0</span>
                    </div>
                    <div class="card-body">
                        <div class="red-flags-container" id="redFlagsContainer">
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                <h3 class="empty-state-title"> !</h3>
                                <p class="empty-state-text">   </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick AI Analysis -->
                <div class="card ai-card">
                    <div class="ai-header">
                        <span class="ai-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            AI
                        </span>
                        <span class="ai-title"> </span>
                        <div class="ai-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshDashboardAi()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="23 4 23 10 17 10"/>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                                </svg>
                                
                            </button>
                        </div>
                    </div>
                    <div class="ai-body">
                        <div class="ai-content" id="dashboardAiContent">
                            <div class="ai-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                                <p>    AI-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly Panel -->
            <div class="tab-panel" id="weeklyPanel">
                <div class="page-header">
                    <div>
                        <h1 class="page-title"> </h1>
                        <p class="page-subtitle">   </p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-secondary" onclick="exportExcel('weekly')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            
                        </button>
                        <button class="btn btn-primary" onclick="showAddMetricModal('weekly')" id="addWeeklyBtn" style="display:none">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                             
                        </button>
                    </div>
                </div>

                <div class="card card-flush">
                    <div class="card-body">
                        <div class="period-selector" id="weeklyPeriodNav">
                            <!-- Period navigation will be inserted here -->
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="weeklyTable">
                            <thead>
                                <tr id="weeklyTableHead"></tr>
                            </thead>
                            <tbody id="weeklyTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Monthly Panel -->
            <div class="tab-panel" id="monthlyPanel">
                <div class="page-header">
                    <div>
                        <h1 class="page-title"> </h1>
                        <p class="page-subtitle">  </p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-secondary" onclick="exportExcel('monthly')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            
                        </button>
                        <button class="btn btn-primary" onclick="showAddMetricModal('monthly')" id="addMonthlyBtn" style="display:none">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                             
                        </button>
                    </div>
                </div>

                <div class="card card-flush">
                    <div class="card-body">
                        <div class="period-selector" id="monthlyPeriodNav">
                            <!-- Period navigation will be inserted here -->
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="monthlyTable">
                            <thead>
                                <tr id="monthlyTableHead"></tr>
                            </thead>
                            <tbody id="monthlyTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Charts Panel -->
            <div class="tab-panel" id="chartsPanel">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">  </h1>
                        <p class="page-subtitle">  </p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> </h3>
                        <select class="form-select" style="width:200px" id="chartMetricSelect" onchange="updateChart()">
                            <option value=""> </option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"> </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Panel -->
            <div class="tab-panel" id="aiPanel">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">AI  </h1>
                        <p class="page-subtitle">    </p>
                    </div>
                </div>

                <div class="card ai-card">
                    <div class="ai-header">
                        <span class="ai-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            AI
                        </span>
                        <span class="ai-title"> </span>
                        <div class="ai-actions">
                            <button class="btn btn-primary" onclick="runFullAiAnalysis()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"/>
                                </svg>
                                 
                            </button>
                        </div>
                    </div>
                    <div class="ai-body">
                        <div class="ai-content" id="fullAiContent" style="min-height:400px">
                            <div class="ai-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                                <p> " "    </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GPT Export -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon card-icon-info">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="card-title">  GPT</h3>
                                <p class="card-subtitle">     ChatGPT</p>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="generateGptExport()">
                            
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="gpt-export-box" id="gptExportBox">
                            <p> ""   </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Panel -->
            <div class="tab-panel" id="settingsPanel">
                <div class="page-header">
                    <div>
                        <h1 class="page-title"></h1>
                        <p class="page-subtitle">   </p>
                    </div>
                </div>

                <!-- Metrics Management (Owner only) -->
                <div class="card" id="metricsManagementCard" style="display:none">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon card-icon-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="card-title"> </h3>
                                <p class="card-subtitle">   </p>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showAddMetricModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/>
                                <line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                             
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="settings-list" id="metricsListSettings">
                            <!-- Metrics will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Team Management (Owner only) -->
                <div class="card" id="teamManagementCard" style="display:none">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon card-icon-info">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="card-title"></h3>
                                <p class="card-subtitle">  </p>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="showInviteModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <line x1="20" y1="8" x2="20" y2="14"/>
                                <line x1="23" y1="11" x2="17" y2="11"/>
                            </svg>
                            
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="team-list" id="teamList">
                            <!-- Team members will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Visibility Settings (Owner only) -->
                <div class="card" id="visibilityCard" style="display:none">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon card-icon-warning">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="card-title"> </h3>
                                <p class="card-subtitle">   </p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="settings-section">
                            <div class="settings-item">
                                <div class="settings-item-info">
                                    <div class="settings-item-title">  </div>
                                    <div class="settings-item-desc">      ""</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="hideFinancials" onchange="saveVisibilitySettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="settings-item">
                                <div class="settings-item-info">
                                    <div class="settings-item-title">  </div>
                                    <div class="settings-item-desc">     </div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="onlyOwnMetrics" onchange="saveVisibilitySettings()" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Import/Export -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon card-icon-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="card-title"> / </h3>
                                <p class="card-subtitle">  Excel </p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="btn-group" style="flex-wrap:wrap">
                            <button class="btn btn-secondary" onclick="exportAllExcel()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                  
                            </button>
                            <label class="btn btn-secondary" style="cursor:pointer">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                  Excel
                                <input type="file" accept=".xlsx,.xls" onchange="importExcel(event)" style="display:none">
                            </label>
                            <button class="btn btn-secondary" onclick="downloadTemplate()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                </svg>
                                 Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Panel -->
            <div class="tab-panel" id="adminPanel">
                <div class="page-header">
                    <div>
                        <h1 class="page-title"> -</h1>
                        <p class="page-subtitle">   </p>
                    </div>
                </div>

                <!-- Create Company -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon card-icon-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                    <polyline points="9 22 9 12 15 12 15 22"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="card-title">  </h3>
                                <p class="card-subtitle">    </p>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="createCompanyForm" onsubmit="adminCreateCompany(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Email </label>
                                    <input type="email" class="form-input" id="newOwnerEmail" required placeholder="owner@company.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label"> </label>
                                    <input type="text" class="form-input" id="newOwnerPassword" required placeholder=". 6 " minlength="6">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">' </label>
                                    <input type="text" class="form-input" id="newOwnerName" required placeholder=" ">
                                </div>
                                <div class="form-group">
                                    <label class="form-label"> </label>
                                    <input type="text" class="form-input" id="newCompanyName" required placeholder="  '">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                 
                            </button>
                        </form>

                        <div class="credentials-box" id="credentialsBox" style="display:none">
                            <div class="credentials-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                 !   :
                            </div>
                            <div class="credentials-item">
                                <span class="credentials-label">Email:</span>
                                <span class="credentials-value" id="createdEmail">-</span>
                            </div>
                            <div class="credentials-item">
                                <span class="credentials-label">:</span>
                                <span class="credentials-value" id="createdPassword">-</span>
                            </div>
                            <div class="credentials-item">
                                <span class="credentials-label">:</span>
                                <span class="credentials-value" id="createdCompany">-</span>
                            </div>
                            <div class="credentials-actions">
                                <button class="btn btn-primary" onclick="copyCredentials()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                    
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Companies List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-header-left">
                            <div class="card-icon card-icon-info">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="card-title"> </h3>
                                <p class="card-subtitle" id="companiesCount">...</p>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="loadAdminCompanies()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"/>
                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                            </svg>
                            
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="company-list" id="adminCompanyList">
                            <div class="empty-state" style="padding:40px">
                                <div class="spinner"></div>
                                <p class="mt-md"> ...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Metric Modal -->
    <div class="modal-overlay" id="addMetricModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"> </h3>
                <button class="modal-close" onclick="closeModal('addMetricModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="addMetricForm" onsubmit="addMetric(event)">
                    <div class="form-group">
                        <label class="form-label"> </label>
                        <input type="text" class="form-input" id="metricName" required placeholder=" ">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"></label>
                            <select class="form-select" id="metricPeriod">
                                <option value="weekly"></option>
                                <option value="monthly"></option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label"></label>
                            <select class="form-select" id="metricImportance">
                                <option value="critical">  ()</option>
                                <option value="high"> </option>
                                <option value="medium" selected> </option>
                                <option value="low"> </option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"> <span class="form-label-optional">( )</span></label>
                            <input type="number" class="form-input" id="metricPlan" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label"> </label>
                            <input type="text" class="form-input" id="metricUnit" placeholder=", , %">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"></label>
                        <select class="form-select" id="metricResponsible">
                            <option value=""> </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"> <span class="form-label-optional">(')</span></label>
                        <textarea class="form-textarea" id="metricDescription" placeholder="   "></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addMetricModal')"></button>
                <button class="btn btn-primary" onclick="document.getElementById('addMetricForm').requestSubmit()">
                     
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Metric Modal -->
    <div class="modal-overlay" id="editMetricModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"> </h3>
                <button class="modal-close" onclick="closeModal('editMetricModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="editMetricForm" onsubmit="updateMetric(event)">
                    <input type="hidden" id="editMetricId">
                    <div class="form-group">
                        <label class="form-label"> </label>
                        <input type="text" class="form-input" id="editMetricName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label"></label>
                            <input type="number" class="form-input" id="editMetricPlan">
                        </div>
                        <div class="form-group">
                            <label class="form-label"> </label>
                            <input type="text" class="form-input" id="editMetricUnit">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label"></label>
                        <select class="form-select" id="editMetricImportance">
                            <option value="critical"> </option>
                            <option value="high"> </option>
                            <option value="medium"> </option>
                            <option value="low"> </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"></label>
                        <select class="form-select" id="editMetricResponsible">
                            <option value=""> </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label"></label>
                        <textarea class="form-textarea" id="editMetricDescription"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteCurrentMetric()" style="margin-right:auto">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"/>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                    
                </button>
                <button class="btn btn-secondary" onclick="closeModal('editMetricModal')"></button>
                <button class="btn btn-primary" onclick="document.getElementById('editMetricForm').requestSubmit()">
                    
                </button>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div class="modal-overlay" id="inviteModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"> </h3>
                <button class="modal-close" onclick="closeModal('inviteModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="inviteForm" onsubmit="sendInvite(event)">
                    <div class="form-group">
                        <label class="form-label">Email </label>
                        <input type="email" class="form-input" id="inviteEmail" required placeholder="employee@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label"> </label>
                        <input type="text" class="form-input" id="invitePassword" required placeholder=". 6 " minlength="6">
                        <p class="form-hint">        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">'</label>
                        <input type="text" class="form-input" id="inviteName" required placeholder="' ">
                    </div>
                    <div class="form-group">
                        <label class="form-label"></label>
                        <select class="form-select" id="inviteRole">
                            <option value="employee"></option>
                            <option value="manager"></option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('inviteModal')"></button>
                <button class="btn btn-primary" onclick="document.getElementById('inviteForm').requestSubmit()">
                     
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle"></h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmText"> ?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')"></button>
                <button class="btn btn-danger" id="confirmBtn" onclick="confirmAction()"></button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- JavaScript -->
    <script>
        // ============================================
        // FIREBASE CONFIG
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCxgVgTCRRD9LcmYmKxdAqL2MB9WLQT73w",
            authDomain: "statstrackerai.firebaseapp.com",
            projectId: "statstrackerai",
            storageBucket: "statstrackerai.appspot.com",
            messagingSenderId: "432156501167",
            appId: "1:432156501167:web:e21b99e5424df8c88f1b9e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // GLOBAL STATE
        // ============================================
        let currentUser = null;
        let currentCompanyId = null;
        let currentUserRole = null;
        let currentUserProfile = null;
        let companyData = null;
        let companySettings = null;
        let metricsData = [];
        let teamMembers = [];
        let weeklyData = {};
        let monthlyData = {};
        let mainChart = null;
        let comparisonChart = null;
        let pendingConfirmAction = null;

        const SUPERADMIN_EMAIL = 'management.talco@gmail.com';

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showLoading(text = '...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = overlay.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = text;
            overlay.classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = '';
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
                error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
            };
            
            toast.innerHTML = `${icons[type] || icons.info}<span class="toast-message">${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function showConfirm(title, text, action) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmText').textContent = text;
            pendingConfirmAction = action;
            showModal('confirmModal');
        }

        function confirmAction() {
            closeModal('confirmModal');
            if (pendingConfirmAction) {
                pendingConfirmAction();
                pendingConfirmAction = null;
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '-';
            return new Intl.NumberFormat('uk-UA').format(num);
        }

        function formatDate(date) {
            return date.toLocaleDateString('uk-UA', { day: '2-digit', month: '2-digit' });
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'register' && i === 1));
            });
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('authError').classList.remove('show');
        }

        function showAuthError(message) {
            const el = document.getElementById('authError');
            document.getElementById('authErrorText').textContent = message;
            el.classList.add('show');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            try {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner spinner-sm"></div>';
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                btn.disabled = false;
                btn.innerHTML = '<span></span>';
                showAuthError(getErrorMessage(error.code));
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const name = document.getElementById('registerName').value;
            const btn = document.getElementById('registerBtn');

            try {
                btn.disabled = true;
                btn.innerHTML = '<div class="spinner spinner-sm"></div>';
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const companyId = await findUserCompany(userCredential.user.uid, email, name);
                
                if (!companyId) {
                    btn.disabled = false;
                    btn.innerHTML = '<span></span>';
                    await auth.signOut();
                    showAuthError('     email.   .');
                }
            } catch (error) {
                btn.disabled = false;
                btn.innerHTML = '<span></span>';
                showAuthError(getErrorMessage(error.code));
            }
        }

        function getErrorMessage(code) {
            const messages = {
                'auth/user-not-found': '  ',
                'auth/wrong-password': ' ',
                'auth/email-already-in-use': ' email  ',
                'auth/weak-password': '   (. 6 )',
                'auth/invalid-email': '  email',
                'auth/too-many-requests': ' .  ',
                'auth/invalid-credential': ' email  '
            };
            return messages[code] || ' ';
        }

        async function logout() {
            await auth.signOut();
            location.reload();
        }

        // ============================================
        // FIND USER COMPANY (INVITE SYSTEM)
        // ============================================
        async function findUserCompany(userId, email, name = '') {
            // 1. Check existing user record
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists && userDoc.data().companyId) {
                return userDoc.data().companyId;
            }

            // 2. Find pending invite
            const invitesQuery = await db.collection('invites')
                .where('email', '==', email.toLowerCase())
                .where('accepted', '==', false)
                .limit(1)
                .get();

            if (!invitesQuery.empty) {
                const invite = invitesQuery.docs[0];
                const inviteData = invite.data();
                const companyId = inviteData.companyId;
                const isOwnerInvite = inviteData.role === 'owner';
                const userName = name || inviteData.ownerName || email.split('@')[0];
                const userRole = inviteData.role || 'employee';

                // 3. Create company user profile
                await db.collection('companies').doc(companyId).collection('users').doc(userId).set({
                    name: userName,
                    email: email.toLowerCase(),
                    role: userRole,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 4. Create global user record
                await db.collection('users').doc(userId).set({
                    email: email.toLowerCase(),
                    companyId: companyId,
                    role: userRole,
                    name: userName
                });

                // 5. Update company ownerId if owner invite
                if (isOwnerInvite) {
                    await db.collection('companies').doc(companyId).update({
                        ownerId: userId
                    });
                }

                // 6. Mark invite as accepted
                await invite.ref.update({ 
                    accepted: true, 
                    acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: userId
                });

                return companyId;
            }

            return null;
        }

        // ============================================
        // AUTH STATE LISTENER
        // ============================================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                showLoading(' ...');
                
                try {
                    let companyId = await findUserCompany(user.uid, user.email);
                    
                    if (!companyId) {
                        if (user.email === SUPERADMIN_EMAIL) {
                            currentCompanyId = null;
                            currentUserRole = 'superadmin';
                            currentUserProfile = { name: '', email: user.email };
                            showApp();
                            hideLoading();
                            return;
                        }
                        
                        hideLoading();
                        await auth.signOut();
                        showAuthError('  .   .');
                        return;
                    }

                    currentCompanyId = companyId;
                    await loadAllData();
                    showApp();
                    hideLoading();
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    hideLoading();
                    showToast('  : ' + error.message, 'error');
                }
            } else {
                currentUser = null;
                currentCompanyId = null;
                showAuthScreen();
                hideLoading();
            }
        });

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadAllData() {
            await Promise.all([
                loadUserData(),
                loadCompanyData(),
                loadCompanySettings(),
                loadMetrics(),
                loadTeam()
            ]);
            
            // Load stats after metrics are loaded
            const weeklyPeriods = getWeeklyPeriods();
            const monthlyPeriods = getMonthlyPeriods();
            await Promise.all([
                loadStatsData('weekly', weeklyPeriods.map(p => p.key)),
                loadStatsData('monthly', monthlyPeriods.map(p => p.key))
            ]);
        }

        async function loadUserData() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const data = userDoc.data();
                currentUserRole = data.role || 'employee';
            }

            if (currentCompanyId) {
                const profileDoc = await db.collection('companies').doc(currentCompanyId)
                    .collection('users').doc(currentUser.uid).get();
                if (profileDoc.exists) {
                    currentUserProfile = profileDoc.data();
                    currentUserRole = currentUserProfile.role || currentUserRole;
                }
            }
        }

        async function loadCompanyData() {
            if (!currentCompanyId) return;
            
            const companyDoc = await db.collection('companies').doc(currentCompanyId).get();
            if (companyDoc.exists) {
                companyData = companyDoc.data();
                if (companyData.ownerId === currentUser.uid) {
                    currentUserRole = 'owner';
                }
            }
        }

        async function loadCompanySettings() {
            if (!currentCompanyId) return;
            
            const settingsDoc = await db.collection('companies').doc(currentCompanyId)
                .collection('settings').doc('visibility').get();
            
            if (settingsDoc.exists) {
                companySettings = settingsDoc.data();
            } else {
                companySettings = {
                    hideFinancials: false,
                    onlyOwnMetrics: true
                };
            }
        }

        async function loadMetrics() {
            if (!currentCompanyId) return;
            
            const snapshot = await db.collection('companies').doc(currentCompanyId)
                .collection('metrics').orderBy('order', 'asc').get();
            
            let metrics = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            // Filter for employees
            if (currentUserRole === 'employee') {
                if (companySettings?.onlyOwnMetrics) {
                    metrics = metrics.filter(m => 
                        !m.responsibleId || m.responsibleId === currentUser.uid
                    );
                }
                if (companySettings?.hideFinancials) {
                    metrics = metrics.filter(m => m.importance !== 'critical');
                }
            }

            metricsData = metrics;
        }

        async function loadTeam() {
            if (!currentCompanyId) return;
            
            const snapshot = await db.collection('companies').doc(currentCompanyId)
                .collection('users').get();
            
            teamMembers = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
        }

        async function loadStatsData(type, periods) {
            if (!currentCompanyId) return;
            
            const data = {};
            const metrics = metricsData.filter(m => m.period === type);
            
            for (const period of periods) {
                const periodData = {};
                
                for (const metric of metrics) {
                    const docId = `${metric.id}_${period}`;
                    const doc = await db.collection('companies').doc(currentCompanyId)
                        .collection('stats').doc(docId).get();
                    
                    if (doc.exists) {
                        periodData[metric.id] = doc.data();
                    }
                }
                
                data[period] = periodData;
            }
            
            if (type === 'weekly') {
                weeklyData = data;
            } else {
                monthlyData = data;
            }
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('show');
        }

        function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('show');
            
            // Update header
            const userName = currentUserProfile?.name || currentUser.email.split('@')[0];
            document.getElementById('userName').textContent = userName;
            document.getElementById('userAvatar').textContent = getInitials(userName);
            document.getElementById('userRoleText').textContent = getRoleLabel(currentUserRole);
            document.getElementById('companyName').textContent = companyData?.name || '-';
            
            // Show/hide elements based on role
            const isOwner = currentUserRole === 'owner';
            const isSuperadmin = currentUser.email === SUPERADMIN_EMAIL;
            
            document.getElementById('addWeeklyBtn').style.display = isOwner ? 'flex' : 'none';
            document.getElementById('addMonthlyBtn').style.display = isOwner ? 'flex' : 'none';
            document.getElementById('metricsManagementCard').style.display = isOwner ? 'block' : 'none';
            document.getElementById('teamManagementCard').style.display = isOwner ? 'block' : 'none';
            document.getElementById('visibilityCard').style.display = isOwner ? 'block' : 'none';
            document.getElementById('adminTab').style.display = isSuperadmin ? 'flex' : 'none';
            
            // Load visibility settings
            if (isOwner && companySettings) {
                document.getElementById('hideFinancials').checked = companySettings.hideFinancials || false;
                document.getElementById('onlyOwnMetrics').checked = companySettings.onlyOwnMetrics !== false;
            }
            
            // Render
            renderDashboard();
            renderTables();
            renderMetricsList();
            renderTeamList();
            initCharts();
            updateChartMetricSelect();
            
            if (isSuperadmin) {
                loadAdminCompanies();
            }
        }

        function getRoleLabel(role) {
            const labels = {
                'owner': '',
                'manager': '',
                'employee': '',
                'superadmin': ''
            };
            return labels[role] || role;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tabId);
            });
            
            document.querySelectorAll('.tab-panel').forEach(p => {
                p.classList.toggle('active', p.id === `${tabId}Panel`);
            });

            // Special actions for tabs
            if (tabId === 'charts') {
                setTimeout(() => {
                    if (mainChart) mainChart.update();
                    if (comparisonChart) comparisonChart.update();
                }, 100);
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function renderDashboard() {
            renderStatsGrid();
            checkRedFlags();
            generateDashboardAi();
        }

        function renderStatsGrid() {
            const grid = document.getElementById('statsGrid');
            
            // Calculate stats
            const weeklyMetrics = metricsData.filter(m => m.period === 'weekly');
            const monthlyMetrics = metricsData.filter(m => m.period === 'monthly');
            
            const currentWeek = getWeeklyPeriods(1)[0]?.key;
            const currentMonth = getMonthlyPeriods(1)[0]?.key;
            
            let totalMetrics = metricsData.length;
            let filledThisWeek = 0;
            let filledThisMonth = 0;
            let planAchievement = [];
            
            weeklyMetrics.forEach(m => {
                const val = weeklyData[currentWeek]?.[m.id]?.value;
                if (val !== null && val !== undefined) filledThisWeek++;
                if (m.plan && val) {
                    planAchievement.push((val / m.plan) * 100);
                }
            });
            
            monthlyMetrics.forEach(m => {
                const val = monthlyData[currentMonth]?.[m.id]?.value;
                if (val !== null && val !== undefined) filledThisMonth++;
                if (m.plan && val) {
                    planAchievement.push((val / m.plan) * 100);
                }
            });
            
            const avgPlan = planAchievement.length ? 
                Math.round(planAchievement.reduce((a, b) => a + b, 0) / planAchievement.length) : 0;
            
            grid.innerHTML = `
                <div class="stat-card stat-card-primary">
                    <div class="stat-header">
                        <div class="stat-icon stat-icon-primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value">${totalMetrics}</div>
                    <div class="stat-label"> </div>
                    <div class="stat-footer">
                        <span>${weeklyMetrics.length} </span>
                        <span></span>
                        <span>${monthlyMetrics.length} </span>
                    </div>
                </div>
                
                <div class="stat-card stat-card-info">
                    <div class="stat-header">
                        <div class="stat-icon stat-icon-info">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                        </div>
                        <span class="stat-trend ${filledThisWeek === weeklyMetrics.length ? 'stat-trend-up' : 'stat-trend-neutral'}">
                            ${filledThisWeek}/${weeklyMetrics.length}
                        </span>
                    </div>
                    <div class="stat-value">${Math.round((filledThisWeek / (weeklyMetrics.length || 1)) * 100)}%</div>
                    <div class="stat-label">  </div>
                    <div class="stat-footer">
                        <div class="stat-progress">
                            <div class="stat-progress-bar stat-progress-primary" style="width:${(filledThisWeek / (weeklyMetrics.length || 1)) * 100}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card stat-card-${avgPlan >= 100 ? 'primary' : avgPlan >= 80 ? 'warning' : 'danger'}">
                    <div class="stat-header">
                        <div class="stat-icon stat-icon-${avgPlan >= 100 ? 'primary' : avgPlan >= 80 ? 'warning' : 'danger'}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                        </div>
                        <span class="stat-trend ${avgPlan >= 100 ? 'stat-trend-up' : avgPlan >= 80 ? 'stat-trend-neutral' : 'stat-trend-down'}">
                            ${avgPlan >= 100 ? '' : avgPlan >= 80 ? '' : ''}
                        </span>
                    </div>
                    <div class="stat-value">${avgPlan}%</div>
                    <div class="stat-label"> </div>
                    <div class="stat-footer">
                        <div class="stat-progress">
                            <div class="stat-progress-bar stat-progress-${avgPlan >= 100 ? 'primary' : avgPlan >= 80 ? 'warning' : 'danger'}" style="width:${Math.min(avgPlan, 100)}%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card stat-card-warning">
                    <div class="stat-header">
                        <div class="stat-icon stat-icon-warning">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                    </div>
                    <div class="stat-value">${teamMembers.length}</div>
                    <div class="stat-label"> </div>
                    <div class="stat-footer">
                        <span>${teamMembers.filter(m => m.role === 'owner').length} </span>
                        <span></span>
                        <span>${teamMembers.filter(m => m.role !== 'owner').length} </span>
                    </div>
                </div>
            `;
        }

        function checkRedFlags() {
            const container = document.getElementById('redFlagsContainer');
            const countBadge = document.getElementById('redFlagsCount');
            const flags = [];
            
            const weeklyPeriods = getWeeklyPeriods(4);
            const monthlyPeriods = getMonthlyPeriods(3);
            
            // Check weekly metrics
            metricsData.filter(m => m.period === 'weekly').forEach(metric => {
                const values = weeklyPeriods.map(p => weeklyData[p.key]?.[metric.id]?.value);
                
                // Consecutive decline
                let declineCount = 0;
                for (let i = 1; i < values.length; i++) {
                    if (values[i] !== null && values[i-1] !== null && values[i] < values[i-1]) {
                        declineCount++;
                    } else {
                        declineCount = 0;
                    }
                }
                
                if (declineCount >= 2) {
                    flags.push({
                        type: 'danger',
                        metric: metric.name,
                        title: ` ${declineCount}  `,
                        text: ` "${metric.name}"   ${declineCount} .  .`,
                        importance: metric.importance
                    });
                }
                
                // Low plan execution
                const lastValue = values[values.length - 1];
                if (metric.plan && lastValue !== null && lastValue !== undefined) {
                    const percent = (lastValue / metric.plan) * 100;
                    if (percent < 50 && metric.importance === 'critical') {
                        flags.push({
                            type: 'danger',
                            metric: metric.name,
                            title: `  : ${Math.round(percent)}%`,
                            text: `: ${metric.plan}, : ${lastValue}.     .`,
                            importance: metric.importance
                        });
                    } else if (percent < 70) {
                        flags.push({
                            type: 'warning',
                            metric: metric.name,
                            title: `  : ${Math.round(percent)}%`,
                            text: ` "${metric.name}"   .   .`,
                            importance: metric.importance
                        });
                    }
                }
                
                // Missing data
                const missingCount = values.filter(v => v === null || v === undefined).length;
                if (missingCount >= 2 && metric.importance !== 'low') {
                    flags.push({
                        type: 'warning',
                        metric: metric.name,
                        title: ' ',
                        text: `  ${weeklyPeriods.length}    ${missingCount}   "${metric.name}".`,
                        importance: metric.importance
                    });
                }
            });
            
            // Sort by importance
            const importanceOrder = { critical: 0, high: 1, medium: 2, low: 3 };
            flags.sort((a, b) => (importanceOrder[a.importance] || 3) - (importanceOrder[b.importance] || 3));
            
            if (flags.length > 0) {
                countBadge.textContent = flags.length;
                countBadge.style.display = 'inline-flex';
                
                container.innerHTML = flags.map(flag => `
                    <div class="red-flag ${flag.type === 'warning' ? 'warning-flag' : ''}">
                        <div class="red-flag-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${flag.type === 'danger' 
                                    ? '<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>'
                                    : '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>'
                                }
                            </svg>
                        </div>
                        <div class="red-flag-content">
                            <div class="red-flag-title">${flag.title}</div>
                            <div class="red-flag-text">${flag.text}</div>
                            <div class="red-flag-meta">
                                <span>: ${flag.metric}</span>
                                <span>: ${getImportanceLabel(flag.importance)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                countBadge.style.display = 'none';
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        <h3 class="empty-state-title"> !</h3>
                        <p class="empty-state-text">   .   .</p>
                    </div>
                `;
            }
        }

        function getImportanceLabel(importance) {
            const labels = {
                critical: ' ',
                high: ' ',
                medium: ' ',
                low: ' '
            };
            return labels[importance] || importance;
        }

        // ============================================
        // PERIOD HELPERS
        // ============================================
        function getWeeklyPeriods(count = 8) {
            const periods = [];
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(now.setDate(diff));
            
            for (let i = count - 1; i >= 0; i--) {
                const weekStart = new Date(monday);
                weekStart.setDate(monday.getDate() - (i * 7));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                const weekNum = getWeekNumber(weekStart);
                const key = `${weekStart.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
                const label = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
                
                periods.push({ key, label, start: weekStart, end: weekEnd, weekNum });
            }
            
            return periods;
        }

        function getMonthlyPeriods(count = 12) {
            const periods = [];
            const now = new Date();
            
            for (let i = count - 1; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const label = date.toLocaleDateString('uk-UA', { month: 'long', year: 'numeric' });
                const shortLabel = date.toLocaleDateString('uk-UA', { month: 'short' });
                
                periods.push({ key, label, shortLabel, date });
            }
            
            return periods;
        }

        // ============================================
        // TABLES RENDERING
        // ============================================
        function renderTables() {
            renderWeeklyTable();
            renderMonthlyTable();
        }

        async function renderWeeklyTable() {
            const periods = getWeeklyPeriods();
            const metrics = metricsData.filter(m => m.period === 'weekly');
            const isOwner = currentUserRole === 'owner';
            
            // Header
            const thead = document.getElementById('weeklyTableHead');
            thead.innerHTML = `
                <th style="min-width:200px"></th>
                ${periods.map(p => `<th style="min-width:100px">${p.label}</th>`).join('')}
                <th style="min-width:80px"></th>
                ${isOwner ? '<th style="min-width:60px"></th>' : ''}
            `;
            
            // Body
            const tbody = document.getElementById('weeklyTableBody');
            
            if (!metrics.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${periods.length + 3}" class="text-center" style="padding:60px">
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                                <h3 class="empty-state-title">  </h3>
                                <p class="empty-state-text">     </p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = metrics.map(metric => {
                const values = periods.map(p => weeklyData[p.key]?.[metric.id]?.value);
                const trend = calculateTrend(values);
                const canEdit = isOwner || metric.responsibleId === currentUser.uid || !metric.responsibleId;
                const responsible = teamMembers.find(m => m.id === metric.responsibleId);
                
                return `
                    <tr>
                        <td>
                            <div class="cell-metric">
                                <span class="importance-dot importance-${metric.importance}"></span>
                                <div class="metric-info">
                                    <div class="metric-name">${metric.name}</div>
                                    <div class="metric-meta">
                                        ${metric.plan ? `<span>: ${formatNumber(metric.plan)}${metric.unit ? ' ' + metric.unit : ''}</span>` : ''}
                                        ${responsible ? `<span class="metric-responsible"> ${responsible.name}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </td>
                        ${periods.map((p, i) => {
                            const value = values[i];
                            const percent = metric.plan && value ? Math.round((value / metric.plan) * 100) : null;
                            const percentClass = percent >= 100 ? 'percent-success' : percent >= 80 ? 'percent-warning' : 'percent-danger';
                            
                            return `
                                <td>
                                    <div class="cell-value">
                                        ${canEdit ? `
                                            <input type="number" class="stats-input" value="${value !== null && value !== undefined ? value : ''}" 
                                                onchange="saveStatValue('${metric.id}', '${p.key}', this.value)"
                                                placeholder="-">
                                        ` : `
                                            <span class="value-main">${value !== null && value !== undefined ? formatNumber(value) : '-'}</span>
                                        `}
                                        ${percent !== null ? `<span class="percent-badge ${percentClass}">${percent}%</span>` : ''}
                                    </div>
                                </td>
                            `;
                        }).join('')}
                        <td>
                            <span class="trend-badge ${trend > 0 ? 'trend-up' : trend < 0 ? 'trend-down' : 'trend-neutral'}">
                                ${trend > 0 ? '' : trend < 0 ? '' : ''} ${Math.abs(trend)}%
                            </span>
                        </td>
                        ${isOwner ? `
                            <td>
                                <div class="cell-actions">
                                    <button class="btn btn-ghost btn-icon-sm" onclick="showEditMetricModal('${metric.id}')" data-tooltip="">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        ` : ''}
                    </tr>
                `;
            }).join('');
        }

        async function renderMonthlyTable() {
            const periods = getMonthlyPeriods();
            const metrics = metricsData.filter(m => m.period === 'monthly');
            const isOwner = currentUserRole === 'owner';
            
            const thead = document.getElementById('monthlyTableHead');
            thead.innerHTML = `
                <th style="min-width:200px"></th>
                ${periods.map(p => `<th style="min-width:100px">${p.shortLabel}</th>`).join('')}
                <th style="min-width:80px"></th>
                ${isOwner ? '<th style="min-width:60px"></th>' : ''}
            `;
            
            const tbody = document.getElementById('monthlyTableBody');
            
            if (!metrics.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${periods.length + 3}" class="text-center" style="padding:60px">
                            <div class="empty-state">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M8 2v4"/><path d="M16 2v4"/>
                                    <rect width="18" height="18" x="3" y="4" rx="2"/>
                                    <path d="M3 10h18"/>
                                </svg>
                                <h3 class="empty-state-title">  </h3>
                                <p class="empty-state-text">     </p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = metrics.map(metric => {
                const values = periods.map(p => monthlyData[p.key]?.[metric.id]?.value);
                const trend = calculateTrend(values);
                const canEdit = isOwner || metric.responsibleId === currentUser.uid || !metric.responsibleId;
                const responsible = teamMembers.find(m => m.id === metric.responsibleId);
                
                return `
                    <tr>
                        <td>
                            <div class="cell-metric">
                                <span class="importance-dot importance-${metric.importance}"></span>
                                <div class="metric-info">
                                    <div class="metric-name">${metric.name}</div>
                                    <div class="metric-meta">
                                        ${metric.plan ? `<span>: ${formatNumber(metric.plan)}${metric.unit ? ' ' + metric.unit : ''}</span>` : ''}
                                        ${responsible ? `<span class="metric-responsible"> ${responsible.name}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </td>
                        ${periods.map((p, i) => {
                            const value = values[i];
                            const percent = metric.plan && value ? Math.round((value / metric.plan) * 100) : null;
                            const percentClass = percent >= 100 ? 'percent-success' : percent >= 80 ? 'percent-warning' : 'percent-danger';
                            
                            return `
                                <td>
                                    <div class="cell-value">
                                        ${canEdit ? `
                                            <input type="number" class="stats-input" value="${value !== null && value !== undefined ? value : ''}" 
                                                onchange="saveStatValue('${metric.id}', '${p.key}', this.value)"
                                                placeholder="-">
                                        ` : `
                                            <span class="value-main">${value !== null && value !== undefined ? formatNumber(value) : '-'}</span>
                                        `}
                                        ${percent !== null ? `<span class="percent-badge ${percentClass}">${percent}%</span>` : ''}
                                    </div>
                                </td>
                            `;
                        }).join('')}
                        <td>
                            <span class="trend-badge ${trend > 0 ? 'trend-up' : trend < 0 ? 'trend-down' : 'trend-neutral'}">
                                ${trend > 0 ? '' : trend < 0 ? '' : ''} ${Math.abs(trend)}%
                            </span>
                        </td>
                        ${isOwner ? `
                            <td>
                                <div class="cell-actions">
                                    <button class="btn btn-ghost btn-icon-sm" onclick="showEditMetricModal('${metric.id}')" data-tooltip="">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        ` : ''}
                    </tr>
                `;
            }).join('');
        }

        function calculateTrend(values) {
            const validValues = values.filter(v => v !== null && v !== undefined);
            if (validValues.length < 2) return 0;
            
            const last = validValues[validValues.length - 1];
            const prev = validValues[validValues.length - 2];
            
            if (prev === 0) return last > 0 ? 100 : 0;
            return Math.round(((last - prev) / prev) * 100);
        }

        // ============================================
        // SAVE STAT VALUE
        // ============================================
        const saveStatValue = debounce(async function(metricId, period, value) {
            const docId = `${metricId}_${period}`;
            
            try {
                const numValue = value !== '' ? parseFloat(value) : null;
                
                await db.collection('companies').doc(currentCompanyId).collection('stats').doc(docId).set({
                    metricId,
                    period,
                    value: numValue,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                }, { merge: true });
                
                // Update local data
                const metric = metricsData.find(m => m.id === metricId);
                if (metric) {
                    const data = metric.period === 'weekly' ? weeklyData : monthlyData;
                    if (!data[period]) data[period] = {};
                    data[period][metricId] = { value: numValue };
                }
                
                showToast('', 'success');
                
                // Update dashboard
                renderDashboard();
                
            } catch (error) {
                console.error('Error saving stat:', error);
                showToast(' ', 'error');
            }
        }, 600);

        // ============================================
        // METRICS MANAGEMENT
        // ============================================
        function showAddMetricModal(period = 'weekly') {
            document.getElementById('addMetricForm').reset();
            document.getElementById('metricPeriod').value = period;
            updateResponsibleSelect('metricResponsible');
            showModal('addMetricModal');
        }

        function updateResponsibleSelect(selectId) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = '<option value=""> </option>';
            
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.name || member.email} (${getRoleLabel(member.role)})`;
                select.appendChild(option);
            });
            
            if (currentValue) select.value = currentValue;
        }

        async function addMetric(e) {
            e.preventDefault();
            
            const data = {
                name: document.getElementById('metricName').value,
                period: document.getElementById('metricPeriod').value,
                importance: document.getElementById('metricImportance').value,
                plan: document.getElementById('metricPlan').value ? parseFloat(document.getElementById('metricPlan').value) : null,
                unit: document.getElementById('metricUnit').value || null,
                responsibleId: document.getElementById('metricResponsible').value || null,
                description: document.getElementById('metricDescription').value || null,
                order: metricsData.length,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid
            };
            
            try {
                await db.collection('companies').doc(currentCompanyId).collection('metrics').add(data);
                
                closeModal('addMetricModal');
                showToast(' ');
                
                await loadMetrics();
                renderTables();
                renderMetricsList();
                renderDashboard();
                updateChartMetricSelect();
                
            } catch (error) {
                console.error('Error adding metric:', error);
                showToast(' : ' + error.message, 'error');
            }
        }

        function showEditMetricModal(metricId) {
            const metric = metricsData.find(m => m.id === metricId);
            if (!metric) return;
            
            document.getElementById('editMetricId').value = metricId;
            document.getElementById('editMetricName').value = metric.name;
            document.getElementById('editMetricPlan').value = metric.plan || '';
            document.getElementById('editMetricUnit').value = metric.unit || '';
            document.getElementById('editMetricImportance').value = metric.importance || 'medium';
            document.getElementById('editMetricDescription').value = metric.description || '';
            
            updateResponsibleSelect('editMetricResponsible');
            document.getElementById('editMetricResponsible').value = metric.responsibleId || '';
            
            showModal('editMetricModal');
        }

        async function updateMetric(e) {
            e.preventDefault();
            
            const metricId = document.getElementById('editMetricId').value;
            const data = {
                name: document.getElementById('editMetricName').value,
                plan: document.getElementById('editMetricPlan').value ? parseFloat(document.getElementById('editMetricPlan').value) : null,
                unit: document.getElementById('editMetricUnit').value || null,
                importance: document.getElementById('editMetricImportance').value,
                responsibleId: document.getElementById('editMetricResponsible').value || null,
                description: document.getElementById('editMetricDescription').value || null,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('companies').doc(currentCompanyId).collection('metrics').doc(metricId).update(data);
                
                closeModal('editMetricModal');
                showToast(' ');
                
                await loadMetrics();
                renderTables();
                renderMetricsList();
                renderDashboard();
                
            } catch (error) {
                console.error('Error updating metric:', error);
                showToast(' : ' + error.message, 'error');
            }
        }

        async function deleteCurrentMetric() {
            const metricId = document.getElementById('editMetricId').value;
            const metric = metricsData.find(m => m.id === metricId);
            
            showConfirm(
                ' ?',
                `     "${metric?.name}"?       .`,
                async () => {
                    try {
                        await db.collection('companies').doc(currentCompanyId).collection('metrics').doc(metricId).delete();
                        
                        closeModal('editMetricModal');
                        showToast(' ');
                        
                        await loadMetrics();
                        renderTables();
                        renderMetricsList();
                        renderDashboard();
                        updateChartMetricSelect();
                        
                    } catch (error) {
                        console.error('Error deleting metric:', error);
                        showToast(' : ' + error.message, 'error');
                    }
                }
            );
        }

        function renderMetricsList() {
            const container = document.getElementById('metricsListSettings');
            
            if (!metricsData.length) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:40px">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"/>
                            <line x1="12" y1="20" x2="12" y2="4"/>
                            <line x1="6" y1="20" x2="6" y2="14"/>
                        </svg>
                        <h3 class="empty-state-title"> </h3>
                        <p class="empty-state-text">     </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = metricsData.map(metric => {
                const responsible = teamMembers.find(m => m.id === metric.responsibleId);
                return `
                    <div class="settings-item" style="cursor:pointer" onclick="showEditMetricModal('${metric.id}')">
                        <div style="display:flex;align-items:center;gap:12px">
                            <span class="importance-dot importance-${metric.importance}"></span>
                            <div class="settings-item-info">
                                <div class="settings-item-title">${metric.name}</div>
                                <div class="settings-item-desc">
                                    ${metric.period === 'weekly' ? '' : ''}
                                    ${metric.plan ? `  : ${formatNumber(metric.plan)}${metric.unit ? ' ' + metric.unit : ''}` : ''}
                                    ${responsible ? `  ${responsible.name}` : ''}
                                </div>
                            </div>
                        </div>
                        <span class="badge badge-${metric.period === 'weekly' ? 'info' : 'warning'}">
                            ${metric.period === 'weekly' ? '' : ''}
                        </span>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // TEAM MANAGEMENT
        // ============================================
        function renderTeamList() {
            const container = document.getElementById('teamList');
            
            if (!teamMembers.length) {
                container.innerHTML = `
                    <div class="empty-state" style="padding:40px">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <h3 class="empty-state-title"> </h3>
                        <p class="empty-state-text">    </p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = teamMembers.map(member => `
                <div class="team-item">
                    <div class="team-avatar team-avatar-${member.role === 'owner' ? 'owner' : 'employee'}">
                        ${getInitials(member.name || member.email)}
                    </div>
                    <div class="team-info">
                        <div class="team-name">${member.name || ' '}</div>
                        <div class="team-email">${member.email}</div>
                    </div>
                    <span class="role-badge role-${member.role}">${getRoleLabel(member.role)}</span>
                    ${member.role !== 'owner' && currentUserRole === 'owner' ? `
                        <div class="team-actions">
                            <button class="btn btn-ghost btn-icon-sm" onclick="editTeamMember('${member.id}')" data-tooltip="">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="btn btn-ghost btn-icon-sm" onclick="removeTeamMember('${member.id}', '${member.name}')" data-tooltip="">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function showInviteModal() {
            document.getElementById('inviteForm').reset();
            // Generate random password
            const chars = 'abcdefghjkmnpqrstuvwxyzABCDEFGHJKMNPQRSTUVWXYZ23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('invitePassword').value = password;
            showModal('inviteModal');
        }

        async function sendInvite(e) {
            e.preventDefault();
            
            const email = document.getElementById('inviteEmail').value.toLowerCase().trim();
            const password = document.getElementById('invitePassword').value;
            const name = document.getElementById('inviteName').value.trim();
            const role = document.getElementById('inviteRole').value;
            
            // Check if already in team
            if (teamMembers.find(m => m.email === email)) {
                showToast(' email    ', 'error');
                return;
            }
            
            try {
                showLoading(' ...');
                
                // Create invite record
                await db.collection('invites').add({
                    email: email,
                    companyId: currentCompanyId,
                    role: role,
                    ownerName: name,
                    tempPassword: password,
                    invitedBy: currentUser.uid,
                    accepted: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Create Firebase Auth user
                const tempApp = firebase.initializeApp(firebaseConfig, 'temp-invite-' + Date.now());
                try {
                    await tempApp.auth().createUserWithEmailAndPassword(email, password);
                } finally {
                    await tempApp.delete();
                }
                
                hideLoading();
                closeModal('inviteModal');
                
                // Show credentials to copy
                const inviteText = `   TALKO Statistics!

: ${companyData?.name || ''}
Email: ${email}
: ${password}

 : ${window.location.origin}`;
                
                try {
                    await navigator.clipboard.writeText(inviteText);
                    showToast('     !', 'success');
                } catch {
                    showToast(' ! Email: ' + email + ', : ' + password, 'success');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Error sending invite:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast(' email    ', 'error');
                } else {
                    showToast(': ' + error.message, 'error');
                }
            }
        }

        async function removeTeamMember(memberId, memberName) {
            showConfirm(
                ' ?',
                `    "${memberName}"  ?       .`,
                async () => {
                    try {
                        // Remove from company users
                        await db.collection('companies').doc(currentCompanyId)
                            .collection('users').doc(memberId).delete();
                        
                        // Update global user record
                        await db.collection('users').doc(memberId).update({
                            companyId: firebase.firestore.FieldValue.delete(),
                            role: firebase.firestore.FieldValue.delete()
                        });
                        
                        showToast(' ');
                        await loadTeam();
                        renderTeamList();
                        
                    } catch (error) {
                        console.error('Error removing team member:', error);
                        showToast(' ', 'error');
                    }
                }
            );
        }

        // ============================================
        // VISIBILITY SETTINGS
        // ============================================
        async function saveVisibilitySettings() {
            const settings = {
                hideFinancials: document.getElementById('hideFinancials').checked,
                onlyOwnMetrics: document.getElementById('onlyOwnMetrics').checked,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                await db.collection('companies').doc(currentCompanyId)
                    .collection('settings').doc('visibility').set(settings, { merge: true });
                
                companySettings = settings;
                showToast(' ');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast(' ', 'error');
            }
        }

        // ============================================
        // CHARTS
        // ============================================
        function initCharts() {
            const mainCtx = document.getElementById('mainChart')?.getContext('2d');
            const comparisonCtx = document.getElementById('comparisonChart')?.getContext('2d');
            
            if (mainCtx) {
                mainChart = new Chart(mainCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            }
            
            if (comparisonCtx) {
                comparisonChart = new Chart(comparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                renderComparisonChart();
            }
        }

        function updateChartMetricSelect() {
            const select = document.getElementById('chartMetricSelect');
            if (!select) return;
            
            select.innerHTML = '<option value=""> </option>';
            
            metricsData.forEach(metric => {
                const option = document.createElement('option');
                option.value = metric.id;
                option.textContent = `${metric.name} (${metric.period === 'weekly' ? '' : ''})`;
                select.appendChild(option);
            });
        }

        function updateChart() {
            const metricId = document.getElementById('chartMetricSelect').value;
            if (!metricId || !mainChart) return;
            
            const metric = metricsData.find(m => m.id === metricId);
            if (!metric) return;
            
            const isWeekly = metric.period === 'weekly';
            const periods = isWeekly ? getWeeklyPeriods(12) : getMonthlyPeriods(12);
            const data = isWeekly ? weeklyData : monthlyData;
            
            const values = periods.map(p => data[p.key]?.[metricId]?.value || null);
            const planValues = metric.plan ? periods.map(() => metric.plan) : null;
            
            mainChart.data.labels = periods.map(p => isWeekly ? p.label : p.shortLabel);
            mainChart.data.datasets = [
                {
                    label: metric.name,
                    data: values,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ];
            
            if (planValues) {
                mainChart.data.datasets.push({
                    label: '',
                    data: planValues,
                    borderColor: '#9ca3af',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                });
            }
            
            mainChart.update();
        }

        function renderComparisonChart() {
            if (!comparisonChart) return;
            
            const weeklyMetrics = metricsData.filter(m => m.period === 'weekly' && m.plan);
            if (!weeklyMetrics.length) {
                comparisonChart.data.labels = [];
                comparisonChart.data.datasets = [];
                comparisonChart.update();
                return;
            }
            
            const currentWeek = getWeeklyPeriods(1)[0]?.key;
            const prevWeek = getWeeklyPeriods(2)[0]?.key;
            
            const labels = weeklyMetrics.slice(0, 6).map(m => m.name.length > 15 ? m.name.slice(0, 15) + '...' : m.name);
            const currentValues = weeklyMetrics.slice(0, 6).map(m => weeklyData[currentWeek]?.[m.id]?.value || 0);
            const prevValues = weeklyMetrics.slice(0, 6).map(m => weeklyData[prevWeek]?.[m.id]?.value || 0);
            const planValues = weeklyMetrics.slice(0, 6).map(m => m.plan || 0);
            
            comparisonChart.data.labels = labels;
            comparisonChart.data.datasets = [
                {
                    label: ' ',
                    data: currentValues,
                    backgroundColor: '#22c55e'
                },
                {
                    label: ' ',
                    data: prevValues,
                    backgroundColor: '#93c5fd'
                },
                {
                    label: '',
                    data: planValues,
                    backgroundColor: '#e5e7eb'
                }
            ];
            
            comparisonChart.update();
        }

        // ============================================
        // AI ANALYSIS
        // ============================================
        function generateDashboardAi() {
            const container = document.getElementById('dashboardAiContent');
            
            if (!metricsData.length) {
                container.innerHTML = `
                    <div class="ai-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <p>    AI-</p>
                    </div>
                `;
                return;
            }
            
            const analysis = generateLocalAnalysis();
            container.innerHTML = analysis;
        }

        function refreshDashboardAi() {
            generateDashboardAi();
            showToast(' ', 'info');
        }

        function runFullAiAnalysis() {
            const container = document.getElementById('fullAiContent');
            
            container.innerHTML = `
                <div class="ai-loading">
                    <div class="spinner"></div>
                    <p class="ai-loading-text"> ...</p>
                </div>
            `;
            
            setTimeout(() => {
                const analysis = generateFullAnalysis();
                container.innerHTML = analysis;
            }, 1500);
        }

        function generateLocalAnalysis() {
            const weeklyPeriods = getWeeklyPeriods(4);
            const weeklyMetrics = metricsData.filter(m => m.period === 'weekly');
            
            let insights = [];
            let issues = [];
            
            // Analyze each metric
            weeklyMetrics.forEach(metric => {
                const values = weeklyPeriods.map(p => weeklyData[p.key]?.[metric.id]?.value);
                const validValues = values.filter(v => v !== null && v !== undefined);
                
                if (validValues.length >= 2) {
                    const trend = calculateTrend(values);
                    const last = validValues[validValues.length - 1];
                    
                    if (trend > 20) {
                        insights.push(` "${metric.name}"   ${trend}% -  !`);
                    } else if (trend < -20) {
                        issues.push(` "${metric.name}"   ${Math.abs(trend)}% -  `);
                    }
                    
                    if (metric.plan) {
                        const percent = (last / metric.plan) * 100;
                        if (percent >= 120) {
                            insights.push(` "${metric.name}"    ${Math.round(percent - 100)}%`);
                        } else if (percent < 70) {
                            issues.push(` "${metric.name}"    ${Math.round(percent)}%`);
                        }
                    }
                }
            });
            
            let html = '';
            
            if (issues.length > 0) {
                html += `<div class="ai-section">
                    <div class="ai-section-title">  </div>
                    <div class="ai-section-content">${issues.join('<br>')}</div>
                </div>`;
            }
            
            if (insights.length > 0) {
                html += `<div class="ai-section">
                    <div class="ai-section-title">  </div>
                    <div class="ai-section-content">${insights.join('<br>')}</div>
                </div>`;
            }
            
            if (!issues.length && !insights.length) {
                html = `<div class="ai-section">
                    <div class="ai-section-title"> </div>
                    <div class="ai-section-content">
                            .         .
                    </div>
                </div>`;
            }
            
            return html;
        }

        function generateFullAnalysis() {
            const weeklyPeriods = getWeeklyPeriods(8);
            const monthlyPeriods = getMonthlyPeriods(6);
            const weeklyMetrics = metricsData.filter(m => m.period === 'weekly');
            const monthlyMetrics = metricsData.filter(m => m.period === 'monthly');
            
            let html = '';
            
            // Executive Summary
            html += `<div class="ai-section">
                <div class="ai-section-title">  </div>
                <div class="ai-section-content">
                    <strong>:</strong> ${companyData?.name || ' '}<br>
                    <strong> :</strong> ${metricsData.length} (${weeklyMetrics.length} , ${monthlyMetrics.length} )<br>
                    <strong> :</strong> ${weeklyPeriods[0]?.label} - ${weeklyPeriods[weeklyPeriods.length-1]?.label}<br>
                    <strong> :</strong> ${teamMembers.length}
                </div>
            </div>`;
            
            // Critical Metrics
            const criticalMetrics = metricsData.filter(m => m.importance === 'critical');
            if (criticalMetrics.length > 0) {
                html += `<div class="ai-section">
                    <div class="ai-section-title">  </div>
                    <div class="ai-section-content">`;
                
                criticalMetrics.forEach(metric => {
                    const periods = metric.period === 'weekly' ? weeklyPeriods : monthlyPeriods;
                    const data = metric.period === 'weekly' ? weeklyData : monthlyData;
                    const values = periods.map(p => data[p.key]?.[metric.id]?.value);
                    const lastValue = values.filter(v => v !== null && v !== undefined).pop();
                    const trend = calculateTrend(values);
                    const planPercent = metric.plan && lastValue ? Math.round((lastValue / metric.plan) * 100) : null;
                    
                    html += `<div class="ai-recommendation">
                        <div class="ai-recommendation-number">${criticalMetrics.indexOf(metric) + 1}</div>
                        <div>
                            <strong>${metric.name}</strong><br>
                             : ${lastValue !== undefined ? formatNumber(lastValue) : ' '}
                            ${metric.plan ? ` (: ${formatNumber(metric.plan)})` : ''}<br>
                            ${planPercent ? `: ${planPercent}% ` : ''}
                            ${trend !== 0 ? `: ${trend > 0 ? '' : ''} ${Math.abs(trend)}%` : ''}
                        </div>
                    </div>`;
                });
                
                html += `</div></div>`;
            }
            
            // Trends Analysis
            html += `<div class="ai-section">
                <div class="ai-section-title">  </div>
                <div class="ai-section-content">`;
            
            let growingMetrics = [];
            let fallingMetrics = [];
            let stableMetrics = [];
            
            weeklyMetrics.forEach(metric => {
                const values = weeklyPeriods.map(p => weeklyData[p.key]?.[metric.id]?.value);
                const trend = calculateTrend(values);
                
                if (trend > 10) growingMetrics.push({ name: metric.name, trend });
                else if (trend < -10) fallingMetrics.push({ name: metric.name, trend });
                else stableMetrics.push({ name: metric.name, trend });
            });
            
            if (growingMetrics.length > 0) {
                html += `<strong> :</strong> ${growingMetrics.map(m => `${m.name} (+${m.trend}%)`).join(', ')}<br><br>`;
            }
            if (fallingMetrics.length > 0) {
                html += `<strong> :</strong> ${fallingMetrics.map(m => `${m.name} (${m.trend}%)`).join(', ')}<br><br>`;
            }
            if (stableMetrics.length > 0) {
                html += `<strong> :</strong> ${stableMetrics.map(m => m.name).join(', ')}`;
            }
            
            html += `</div></div>`;
            
            // Recommendations
            html += `<div class="ai-section">
                <div class="ai-section-title"> </div>
                <div class="ai-section-content">`;
            
            let recommendations = [];
            
            if (fallingMetrics.length > 0) {
                recommendations.push(`   ,  : ${fallingMetrics.map(m => m.name).join(', ')}.      .`);
            }
            
            const lowPlanExecution = weeklyMetrics.filter(m => {
                if (!m.plan) return false;
                const lastValue = weeklyPeriods.map(p => weeklyData[p.key]?.[m.id]?.value).filter(v => v !== null && v !== undefined).pop();
                return lastValue && (lastValue / m.plan) < 0.8;
            });
            
            if (lowPlanExecution.length > 0) {
                recommendations.push(`     (<80%): ${lowPlanExecution.map(m => m.name).join(', ')}.    .`);
            }
            
            const unassignedMetrics = metricsData.filter(m => !m.responsibleId);
            if (unassignedMetrics.length > 0) {
                recommendations.push(`${unassignedMetrics.length}   .     .`);
            }
            
            if (recommendations.length === 0) {
                recommendations.push('  .       .');
            }
            
            recommendations.forEach((rec, i) => {
                html += `<div class="ai-recommendation">
                    <div class="ai-recommendation-number">${i + 1}</div>
                    <div>${rec}</div>
                </div>`;
            });
            
            html += `</div></div>`;
            
            // Data Quality
            const totalDataPoints = weeklyMetrics.length * weeklyPeriods.length + monthlyMetrics.length * monthlyPeriods.length;
            let filledDataPoints = 0;
            
            weeklyMetrics.forEach(m => {
                weeklyPeriods.forEach(p => {
                    if (weeklyData[p.key]?.[m.id]?.value !== undefined) filledDataPoints++;
                });
            });
            monthlyMetrics.forEach(m => {
                monthlyPeriods.forEach(p => {
                    if (monthlyData[p.key]?.[m.id]?.value !== undefined) filledDataPoints++;
                });
            });
            
            const dataQuality = totalDataPoints > 0 ? Math.round((filledDataPoints / totalDataPoints) * 100) : 0;
            
            html += `<div class="ai-section">
                <div class="ai-section-title">  </div>
                <div class="ai-section-content">
                    <strong>:</strong> ${dataQuality}% (${filledDataPoints}  ${totalDataPoints} )<br>
                    ${dataQuality < 50 ? '       .' : dataQuality < 80 ? '   ,     .' : '   !'}
                </div>
            </div>`;
            
            return html;
        }

        // ============================================
        // GPT EXPORT
        // ============================================
        function generateGptExport() {
            const container = document.getElementById('gptExportBox');
            
            const weeklyPeriods = getWeeklyPeriods(4);
            const monthlyPeriods = getMonthlyPeriods(3);
            
            let text = ` -\n`;
            text += `: ${companyData?.name || ' '}\n`;
            text += `: ${new Date().toLocaleDateString('uk-UA')}\n\n`;
            
            text += `===   ===\n`;
            metricsData.filter(m => m.period === 'weekly').forEach(metric => {
                text += `\n${metric.name}`;
                if (metric.plan) text += ` (: ${metric.plan})`;
                text += `:\n`;
                
                weeklyPeriods.forEach(p => {
                    const value = weeklyData[p.key]?.[metric.id]?.value;
                    text += `  ${p.label}: ${value !== undefined ? value : '-'}\n`;
                });
            });
            
            text += `\n===   ===\n`;
            metricsData.filter(m => m.period === 'monthly').forEach(metric => {
                text += `\n${metric.name}`;
                if (metric.plan) text += ` (: ${metric.plan})`;
                text += `:\n`;
                
                monthlyPeriods.forEach(p => {
                    const value = monthlyData[p.key]?.[metric.id]?.value;
                    text += `  ${p.label}: ${value !== undefined ? value : '-'}\n`;
                });
            });
            
            text += `\n===    ===\n`;
            text += `1.   \n`;
            text += `2.   \n`;
            text += `3.   \n`;
            text += `4.      \n`;
            
            container.innerHTML = `
                <p>      ChatGPT  :</p>
                <div class="gpt-export-preview">${text}</div>
                <button class="btn btn-primary mt-md" onclick="copyGptExport()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    
                </button>
            `;
        }

        function copyGptExport() {
            const preview = document.querySelector('.gpt-export-preview');
            if (preview) {
                navigator.clipboard.writeText(preview.textContent)
                    .then(() => showToast('  !'))
                    .catch(() => showToast(' ', 'error'));
            }
        }

        // ============================================
        // EXCEL EXPORT / IMPORT
        // ============================================
        function exportExcel(type) {
            const periods = type === 'weekly' ? getWeeklyPeriods(12) : getMonthlyPeriods(12);
            const metrics = metricsData.filter(m => m.period === type);
            const data = type === 'weekly' ? weeklyData : monthlyData;
            
            if (!metrics.length) {
                showToast('   ', 'warning');
                return;
            }
            
            const wsData = [
                ['', '', '', ...periods.map(p => type === 'weekly' ? p.label : p.shortLabel)]
            ];
            
            metrics.forEach(metric => {
                const row = [
                    metric.name,
                    metric.plan || '',
                    metric.unit || ''
                ];
                periods.forEach(p => {
                    row.push(data[p.key]?.[metric.id]?.value ?? '');
                });
                wsData.push(row);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 30 },
                { wch: 10 },
                { wch: 10 },
                ...periods.map(() => ({ wch: 15 }))
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, type === 'weekly' ? '' : '');
            
            const fileName = `talko_${type}_${companyData?.name || 'data'}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast(' : ' + fileName);
        }

        function exportAllExcel() {
            const wb = XLSX.utils.book_new();
            
            // Weekly sheet
            const weeklyPeriods = getWeeklyPeriods(12);
            const weeklyMetrics = metricsData.filter(m => m.period === 'weekly');
            
            if (weeklyMetrics.length) {
                const weeklyWsData = [
                    ['', '', '', '', ...weeklyPeriods.map(p => p.label)]
                ];
                
                weeklyMetrics.forEach(metric => {
                    const row = [
                        metric.name,
                        metric.plan || '',
                        metric.unit || '',
                        metric.importance || 'medium'
                    ];
                    weeklyPeriods.forEach(p => {
                        row.push(weeklyData[p.key]?.[metric.id]?.value ?? '');
                    });
                    weeklyWsData.push(row);
                });
                
                const weeklyWs = XLSX.utils.aoa_to_sheet(weeklyWsData);
                weeklyWs['!cols'] = [{ wch: 30 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, ...weeklyPeriods.map(() => ({ wch: 18 }))];
                XLSX.utils.book_append_sheet(wb, weeklyWs, '');
            }
            
            // Monthly sheet
            const monthlyPeriods = getMonthlyPeriods(12);
            const monthlyMetrics = metricsData.filter(m => m.period === 'monthly');
            
            if (monthlyMetrics.length) {
                const monthlyWsData = [
                    ['', '', '', '', ...monthlyPeriods.map(p => p.label)]
                ];
                
                monthlyMetrics.forEach(metric => {
                    const row = [
                        metric.name,
                        metric.plan || '',
                        metric.unit || '',
                        metric.importance || 'medium'
                    ];
                    monthlyPeriods.forEach(p => {
                        row.push(monthlyData[p.key]?.[metric.id]?.value ?? '');
                    });
                    monthlyWsData.push(row);
                });
                
                const monthlyWs = XLSX.utils.aoa_to_sheet(monthlyWsData);
                monthlyWs['!cols'] = [{ wch: 30 }, { wch: 10 }, { wch: 10 }, { wch: 12 }, ...monthlyPeriods.map(() => ({ wch: 15 }))];
                XLSX.utils.book_append_sheet(wb, monthlyWs, '');
            }
            
            // Team sheet
            if (teamMembers.length) {
                const teamWsData = [
                    ['\'', 'Email', '']
                ];
                teamMembers.forEach(member => {
                    teamWsData.push([member.name || '', member.email, getRoleLabel(member.role)]);
                });
                
                const teamWs = XLSX.utils.aoa_to_sheet(teamWsData);
                teamWs['!cols'] = [{ wch: 25 }, { wch: 30 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, teamWs, '');
            }
            
            const fileName = `talko_all_${companyData?.name || 'data'}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('  ');
        }

        function downloadTemplate() {
            const wb = XLSX.utils.book_new();
            
            // Weekly template
            const weeklyPeriods = getWeeklyPeriods(8);
            const weeklyWsData = [
                ['', '', '', ...weeklyPeriods.map(p => p.label)],
                [':  ', '100', '', '', '', '', '', '', '', '', ''],
                [': ', '30', '%', '', '', '', '', '', '', '', '']
            ];
            
            const weeklyWs = XLSX.utils.aoa_to_sheet(weeklyWsData);
            weeklyWs['!cols'] = [{ wch: 30 }, { wch: 10 }, { wch: 10 }, ...weeklyPeriods.map(() => ({ wch: 18 }))];
            XLSX.utils.book_append_sheet(wb, weeklyWs, '');
            
            // Monthly template
            const monthlyPeriods = getMonthlyPeriods(6);
            const monthlyWsData = [
                ['', '', '', ...monthlyPeriods.map(p => p.label)],
                [': ', '100000', '', '', '', '', '', '', ''],
                [':  ', '50', '', '', '', '', '', '', '']
            ];
            
            const monthlyWs = XLSX.utils.aoa_to_sheet(monthlyWsData);
            monthlyWs['!cols'] = [{ wch: 30 }, { wch: 10 }, { wch: 10 }, ...monthlyPeriods.map(() => ({ wch: 15 }))];
            XLSX.utils.book_append_sheet(wb, monthlyWs, '');
            
            XLSX.writeFile(wb, 'talko_template.xlsx');
            showToast(' ');
        }

        async function importExcel(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            showLoading(' ...');
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    let importedMetrics = 0;
                    let importedValues = 0;
                    
                    for (const sheetName of workbook.SheetNames) {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        
                        if (jsonData.length < 2) continue;
                        
                        const headers = jsonData[0];
                        const isWeekly = sheetName.toLowerCase().includes('') || sheetName.toLowerCase().includes('week');
                        const type = isWeekly ? 'weekly' : 'monthly';
                        
                        // Find period columns (skip first 3: name, plan, unit)
                        const periodStartIndex = headers.findIndex(h => 
                            h && (h.toString().includes('-') || h.toString().includes('/'))
                        );
                        
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const metricName = row[0]?.toString()?.trim();
                            
                            if (!metricName || metricName.startsWith('')) continue;
                            
                            // Find or create metric
                            let metric = metricsData.find(m => m.name === metricName && m.period === type);
                            
                            if (!metric) {
                                const metricData = {
                                    name: metricName,
                                    period: type,
                                    importance: 'medium',
                                    plan: row[1] ? parseFloat(row[1]) : null,
                                    unit: row[2] || null,
                                    order: metricsData.length,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                };
                                
                                const docRef = await db.collection('companies').doc(currentCompanyId)
                                    .collection('metrics').add(metricData);
                                
                                metric = { id: docRef.id, ...metricData };
                                metricsData.push(metric);
                                importedMetrics++;
                            }
                            
                            // Import values
                            const periods = type === 'weekly' ? getWeeklyPeriods(12) : getMonthlyPeriods(12);
                            const startCol = periodStartIndex > 0 ? periodStartIndex : 3;
                            
                            for (let j = startCol; j < row.length && (j - startCol) < periods.length; j++) {
                                const value = row[j];
                                if (value !== null && value !== undefined && value !== '') {
                                    const periodIndex = j - startCol;
                                    if (periodIndex < periods.length) {
                                        const period = periods[periodIndex];
                                        const docId = `${metric.id}_${period.key}`;
                                        
                                        await db.collection('companies').doc(currentCompanyId)
                                            .collection('stats').doc(docId).set({
                                                metricId: metric.id,
                                                period: period.key,
                                                value: parseFloat(value),
                                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                            }, { merge: true });
                                        
                                        importedValues++;
                                    }
                                }
                            }
                        }
                    }
                    
                    hideLoading();
                    showToast(`: ${importedMetrics} , ${importedValues} `);
                    
                    // Reload all data
                    await loadAllData();
                    renderTables();
                    renderMetricsList();
                    renderDashboard();
                    updateChartMetricSelect();
                    
                } catch (error) {
                    hideLoading();
                    console.error('Import error:', error);
                    showToast(' : ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        }

        // ============================================
        // ADMIN PANEL
        // ============================================
        async function loadAdminCompanies() {
            const container = document.getElementById('adminCompanyList');
            const countEl = document.getElementById('companiesCount');
            
            try {
                const snapshot = await db.collection('companies').orderBy('createdAt', 'desc').get();
                const companies = [];
                
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    
                    // Get user count
                    const usersSnapshot = await db.collection('companies').doc(doc.id)
                        .collection('users').get();
                    
                    // Get metrics count
                    const metricsSnapshot = await db.collection('companies').doc(doc.id)
                        .collection('metrics').get();
                    
                    companies.push({
                        id: doc.id,
                        ...data,
                        usersCount: usersSnapshot.size,
                        metricsCount: metricsSnapshot.size
                    });
                }
                
                countEl.textContent = `${companies.length} `;
                
                if (!companies.length) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding:40px">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9 22 9 12 15 12 15 22"/>
                            </svg>
                            <h3 class="empty-state-title"> </h3>
                            <p class="empty-state-text">      </p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = companies.map(company => `
                    <div class="company-item">
                        <div class="company-info">
                            <h4>${company.name}</h4>
                            <p>${company.ownerEmail || 'Email  '}</p>
                            <div class="company-meta">
                                <span> ${company.usersCount} </span>
                                <span> ${company.metricsCount} </span>
                                <span> ${company.createdAt?.toDate?.()?.toLocaleDateString('uk-UA') || ''}</span>
                            </div>
                        </div>
                        <div class="company-actions">
                            <button class="btn btn-secondary btn-sm" onclick="viewCompanyAsAdmin('${company.id}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteCompanyAdmin('${company.id}', '${company.name}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                                
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading companies:', error);
                container.innerHTML = `<p class="text-danger" style="padding:20px"> : ${error.message}</p>`;
            }
        }

        async function adminCreateCompany(e) {
            e.preventDefault();
            
            const email = document.getElementById('newOwnerEmail').value.toLowerCase().trim();
            const password = document.getElementById('newOwnerPassword').value;
            const ownerName = document.getElementById('newOwnerName').value.trim();
            const companyName = document.getElementById('newCompanyName').value.trim();
            
            try {
                showLoading(' ...');
                
                // 1. Create company document
                const companyRef = await db.collection('companies').add({
                    name: companyName,
                    ownerEmail: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                });
                
                // 2. Create owner invite
                await db.collection('invites').add({
                    email: email,
                    companyId: companyRef.id,
                    role: 'owner',
                    ownerName: ownerName,
                    tempPassword: password,
                    invitedBy: currentUser.uid,
                    accepted: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 3. Create Firebase Auth user
                const tempApp = firebase.initializeApp(firebaseConfig, 'temp-admin-' + Date.now());
                try {
                    await tempApp.auth().createUserWithEmailAndPassword(email, password);
                } finally {
                    await tempApp.delete();
                }
                
                // 4. Create default metrics
                const defaultMetrics = [
                    { name: ' ', period: 'weekly', importance: 'high', plan: 50, unit: '' },
                    { name: ' ', period: 'weekly', importance: 'medium', plan: 100, unit: '' },
                    { name: '  ', period: 'weekly', importance: 'critical', plan: 30, unit: '%' },
                    { name: '', period: 'monthly', importance: 'critical', plan: 100000, unit: '' },
                    { name: ' ', period: 'monthly', importance: 'high', plan: 20, unit: '' }
                ];
                
                for (let i = 0; i < defaultMetrics.length; i++) {
                    await db.collection('companies').doc(companyRef.id).collection('metrics').add({
                        ...defaultMetrics[i],
                        order: i,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                hideLoading();
                
                // Show credentials
                document.getElementById('createdEmail').textContent = email;
                document.getElementById('createdPassword').textContent = password;
                document.getElementById('createdCompany').textContent = companyName;
                document.getElementById('credentialsBox').style.display = 'block';
                
                document.getElementById('createCompanyForm').reset();
                loadAdminCompanies();
                
                showToast('  !');
                
            } catch (error) {
                hideLoading();
                console.error('Error creating company:', error);
                
                if (error.code === 'auth/email-already-in-use') {
                    showToast(' email  ', 'error');
                } else {
                    showToast(' : ' + error.message, 'error');
                }
            }
        }

        function copyCredentials() {
            const email = document.getElementById('createdEmail').textContent;
            const password = document.getElementById('createdPassword').textContent;
            const company = document.getElementById('createdCompany').textContent;
            
            const text = `    TALKO Statistics!

 : ${company}
 Email: ${email}
 : ${password}

 : ${window.location.origin}

     .`;
            
            navigator.clipboard.writeText(text)
                .then(() => showToast(' !'))
                .catch(() => showToast(' ', 'error'));
        }

        async function viewCompanyAsAdmin(companyId) {
            showLoading('  ...');
            
            try {
                currentCompanyId = companyId;
                await loadAllData();
                
                document.getElementById('companyName').textContent = companyData?.name || '';
                
                renderDashboard();
                renderTables();
                renderMetricsList();
                renderTeamList();
                updateChartMetricSelect();
                
                switchTab('dashboard');
                hideLoading();
                showToast('  : ' + (companyData?.name || companyId));
                
            } catch (error) {
                hideLoading();
                console.error('Error viewing company:', error);
                showToast(': ' + error.message, 'error');
            }
        }

        async function deleteCompanyAdmin(companyId, companyName) {
            showConfirm(
                ' ?',
                `    "${companyName}"    ?    !`,
                async () => {
                    try {
                        showLoading(' ...');
                        
                        // Delete all subcollections
                        const collections = ['metrics', 'users', 'stats', 'settings'];
                        
                        for (const collName of collections) {
                            const snapshot = await db.collection('companies').doc(companyId)
                                .collection(collName).get();
                            
                            for (const doc of snapshot.docs) {
                                await doc.ref.delete();
                            }
                        }
                        
                        // Delete company document
                        await db.collection('companies').doc(companyId).delete();
                        
                        // Delete related invites
                        const invitesSnapshot = await db.collection('invites')
                            .where('companyId', '==', companyId).get();
                        
                        for (const doc of invitesSnapshot.docs) {
                            await doc.ref.delete();
                        }
                        
                        // Delete user records
                        const usersSnapshot = await db.collection('users')
                            .where('companyId', '==', companyId).get();
                        
                        for (const doc of usersSnapshot.docs) {
                            await doc.ref.delete();
                        }
                        
                        hideLoading();
                        loadAdminCompanies();
                        showToast(' ');
                        
                    } catch (error) {
                        hideLoading();
                        console.error('Error deleting company:', error);
                        showToast(' : ' + error.message, 'error');
                    }
                }
            );
        }

        // ============================================
        // KEYBOARD SHORTCUTS
        // ============================================
        document.addEventListener('keydown', (e) => {
            // Close modals on Escape
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.show').forEach(modal => {
                    modal.classList.remove('show');
                });
                document.body.style.overflow = '';
            }
            
            // Quick navigation with Alt+Number
            if (e.altKey && !e.ctrlKey && !e.shiftKey) {
                const tabs = ['dashboard', 'weekly', 'monthly', 'charts', 'ai', 'settings'];
                const num = parseInt(e.key);
                if (num >= 1 && num <= tabs.length) {
                    e.preventDefault();
                    switchTab(tabs[num - 1]);
                }
            }
        });

        // Click outside modal to close
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        });

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // Check for invite link
            const urlParams = new URLSearchParams(window.location.search);
            const inviteId = urlParams.get('invite');
            
            if (inviteId) {
                db.collection('invites').doc(inviteId).get().then(doc => {
                    if (doc.exists && !doc.data().accepted) {
                        const data = doc.data();
                        document.getElementById('registerEmail').value = data.email || '';
                        document.getElementById('registerName').value = data.ownerName || '';
                        showAuthTab('register');
                    }
                }).catch(console.error);
            }
            
            // Auto-hide loading after timeout
            setTimeout(() => {
                if (!currentUser) {
                    hideLoading();
                }
            }, 5000);
        });

        // Handle online/offline
        window.addEventListener('online', () => {
            showToast('\' ', 'success');
        });

        window.addEventListener('offline', () => {
            showToast(' \'  ', 'warning');
        });

        // Warn before leaving with unsaved changes
        let hasUnsavedChanges = false;
        
        document.querySelectorAll('.stats-input').forEach(input => {
            input.addEventListener('change', () => {
                hasUnsavedChanges = true;
                setTimeout(() => { hasUnsavedChanges = false; }, 2000);
            });
        });

        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Service Worker Registration (optional PWA support)
        if ('serviceWorker' in navigator) {
            // Can be enabled for PWA
            // navigator.serviceWorker.register('/sw.js');
        }

        console.log('%c TALKO Statistics ', 'background: #22c55e; color: white; font-size: 20px; padding: 10px;');
        console.log('%c  2.0 |  2024 TALKO System ', 'color: #6b7280; font-size: 12px;');
    </script>
</body>
</html>
