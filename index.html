<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#22c55e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Трекер статистики Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js" defer></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        };
    </script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html, body { font-family: 'Inter', system-ui, sans-serif; -webkit-font-smoothing: antialiased; overscroll-behavior: none; }
        
        /* Safe area для notched devices */
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-slide-down { animation: slideDown 0.2s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-bounce { animation: bounce 0.6s ease-in-out; }
        
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        /* Toast */
        .toast-container { position: fixed; top: calc(12px + var(--sat)); left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; width: calc(100% - 32px); max-width: 400px; }
        .toast { padding: 14px 18px; border-radius: 14px; font-weight: 600; font-size: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; pointer-events: auto; animation: slideDown 0.3s ease-out; background: #fff; }
        .toast-success { border-left: 4px solid #22c55e; }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-info { border-left: 4px solid #3b82f6; }
        .toast-warning { border-left: 4px solid #f59e0b; }
        
        /* Cards */
        .card { background: white; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06); }
        
        /* Inputs - більші для мобільного */
        .input-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 16px; transition: all 0.2s; min-height: 52px; }
        .input-field:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1); }
        .input-field:disabled { background: #f9fafb; cursor: not-allowed; }
        
        .textarea-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 15px; transition: all 0.2s; resize: vertical; min-height: 100px; line-height: 1.5; }
        .textarea-field:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1); }
        
        /* Buttons - великі touch targets */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 22px; font-weight: 600; font-size: 15px; border-radius: 14px; transition: all 0.2s; cursor: pointer; border: none; min-height: 52px; -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4); }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover:not(:disabled) { background: #e5e7eb; }
        .btn-ghost { background: transparent; color: #6b7280; }
        .btn-ghost:hover:not(:disabled) { background: #f3f4f6; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3); }
        .btn-ai:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4); }
        .btn-icon { width: 52px; height: 52px; padding: 0; border-radius: 14px; }
        .btn-sm { padding: 10px 16px; font-size: 14px; min-height: 44px; border-radius: 12px; }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-amber { background: #fef3c7; color: #92400e; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-purple { background: #f3e8ff; color: #6b21a8; }
        .badge-white { background: rgba(255,255,255,0.9); color: #374151; }
        .badge-primary { background: #dcfce7; color: #166534; }
        
        /* Progress */
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease-out; }
        
        /* Modal - оптимізовано для мобільного */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9000; animation: fadeIn 0.2s ease-out; }
        .modal-content { position: fixed; background: white; z-index: 9001; overflow-y: auto; overscroll-behavior: contain; }
        @media (min-width: 640px) { 
            .modal-content { top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 24px; width: 90%; max-height: 90vh; animation: scaleIn 0.3s ease-out; } 
        }
        @media (max-width: 639px) { 
            .modal-content { 
                bottom: 0; left: 0; right: 0; 
                border-radius: 24px 24px 0 0; 
                max-height: calc(95vh - var(--sat)); 
                animation: slideUp 0.3s ease-out;
                padding-bottom: calc(20px + var(--sab));
            } 
        }
        .sheet-handle { width: 40px; height: 5px; background: #d1d5db; border-radius: 10px; margin: 10px auto 20px; }
        
        /* Stats Card - мобільна картка (компактна як Excel) */
        .stats-card { 
            background: white; 
            border-radius: 12px; 
            padding: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.04); 
            border: 1px solid #e5e7eb;
            margin-bottom: 8px;
        }
        .stats-card:active { transform: scale(0.995); background: #fafafa; }
        
        /* Mobile Excel Table */
        .mobile-excel-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 11px;
            min-width: max-content;
        }
        .mobile-excel-table th { 
            background: #f3f4f6; 
            padding: 4px 2px; 
            font-weight: 600; 
            font-size: 9px;
            color: #6b7280; 
            border: 1px solid #e5e7eb;
            text-align: center;
            min-width: 45px;
            vertical-align: middle;
        }
        .mobile-excel-table th.wrap-header {
            min-width: 40px;
            max-width: 55px;
            vertical-align: middle;
            padding: 4px 2px;
            font-size: 8px;
            line-height: 1.15;
            word-wrap: break-word;
            white-space: normal;
        }
        .mobile-excel-table th.sticky-col { 
            position: sticky; 
            left: 0; 
            z-index: 2; 
            background: #f3f4f6;
            min-width: 70px;
            vertical-align: middle;
        }
        .mobile-excel-table td { 
            padding: 2px; 
            border: 1px solid #e5e7eb; 
            text-align: center;
        }
        .mobile-excel-table td.sticky-col { 
            position: sticky; 
            left: 0; 
            z-index: 1; 
            background: inherit;
        }
        .mobile-date-select {
            width: 100%;
            font-size: 9px;
            padding: 2px;
            border: none;
            background: transparent;
            text-align: center;
        }
        .mobile-cell-input {
            width: 100%;
            min-width: 35px;
            font-size: 11px;
            padding: 3px 2px;
            border: none;
            background: transparent;
            text-align: center;
            font-weight: 500;
        }
        .mobile-cell-input:focus {
            outline: 2px solid #22c55e;
            border-radius: 2px;
        }
        
        /* Stats Table - десктоп */
        .stats-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        .stats-table th { background: #f9fafb; padding: 4px 6px; text-align: center; font-weight: 600; font-size: 9px; color: #6b7280; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; z-index: 10; vertical-align: middle; }
        .stats-table td { padding: 3px 4px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; font-size: 12px; text-align: center; }
        
        /* Wrap headers for stats table */
        .stats-table th.wrap-header {
            vertical-align: middle;
            padding: 4px 3px;
            text-align: center;
            position: relative;
            text-transform: none;
            letter-spacing: 0;
            line-height: 1.2;
        }
        .stats-table .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2px;
        }
        .stats-table .header-name {
            font-size: 9px;
            font-weight: 600;
            color: #374151;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            text-align: center;
            line-height: 1.15;
        }
        .stats-table .header-responsible {
            font-size: 8px;
            color: #22c55e;
            font-weight: 500;
            background: #f0fdf4;
            padding: 1px 4px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .stats-table .header-edit-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            padding: 2px;
            color: #9ca3af;
            border-radius: 3px;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .stats-table th:hover .header-edit-btn {
            opacity: 1;
        }
        .stats-table .header-edit-btn:hover {
            background: #e5e7eb;
            color: #4b5563;
        }
        .stats-table tbody tr:nth-child(odd) td { background: #ffffff; }
        .stats-table tbody tr:nth-child(even) td { background: #f9fafb; }
        .stats-table tr:hover td { background: #f0fdf4 !important; }
        .stats-table .sticky-col { position: sticky; left: 0; z-index: 5; box-shadow: 2px 0 4px rgba(0,0,0,0.05); }
        .stats-table tbody tr:nth-child(odd) .sticky-col { background: #ffffff; }
        .stats-table tbody tr:nth-child(even) .sticky-col { background: #f9fafb; }
        .stats-table tr:hover .sticky-col { background: #f0fdf4 !important; }
        .stats-table th[draggable="true"] { cursor: grab; user-select: none; }
        .stats-table th[draggable="true"]:active { cursor: grabbing; }
        .stats-table th.drag-over { background: #dcfce7 !important; box-shadow: inset 0 0 0 2px #22c55e; }
        .target-row { background: linear-gradient(90deg, #fef3c7 0%, #fefce8 100%); }
        .target-row td { border-bottom: 2px solid #fcd34d; }
        .target-row .sticky-col { background: linear-gradient(90deg, #fef3c7 0%, #fefce8 100%); }
        
        /* Bottom Navigation - мобільна навігація */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 16px calc(8px + var(--sab));
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            color: #9ca3af;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .bottom-nav-item:active { transform: scale(0.95); }
        .bottom-nav-item.active { color: #22c55e; background: #f0fdf4; }
        .bottom-nav-item svg { width: 24px; height: 24px; }
        
        /* FAB - floating action button */
        .fab { 
            position: fixed; 
            bottom: calc(80px + var(--sab)); 
            right: 20px; 
            width: 60px; 
            height: 60px; 
            border-radius: 18px; 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
            color: white; 
            border: none; 
            box-shadow: 0 6px 24px rgba(34, 197, 94, 0.4); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            z-index: 99;
        }
        .fab:active { transform: scale(0.92); }
        .fab svg { width: 28px; height: 28px; }
        
        /* Quick actions - швидкі дії */
        .quick-actions {
            position: fixed;
            bottom: calc(150px + var(--sab));
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 98;
        }
        .quick-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transition: all 0.2s;
        }
        .quick-action-btn:active { transform: scale(0.92); }
        
        /* Period badge */
        .period-badge { font-size: 11px; padding: 4px 8px; border-radius: 8px; background: #e0e7ff; color: #3730a3; font-weight: 600; }
        
        /* Status dots */
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
        .status-filled { background: #22c55e; }
        .status-pending { background: #f59e0b; }
        .status-overdue { background: #ef4444; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); }
        
        /* AI Result */
        .ai-result { background: linear-gradient(135deg, #faf5ff 0%, #f0f9ff 100%); border: 1px solid #e9d5ff; border-radius: 20px; padding: 20px; }
        
        /* Support button - в правому верхньому куті */
        .support-btn {
            position: fixed;
            top: 80px;
            right: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            text-decoration: none;
            transition: all 0.2s;
            z-index: 100;
        }
        .support-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
        .support-btn:active {
            transform: scale(0.96);
        }
        @media (max-width: 640px) {
            .support-btn {
                top: auto;
                bottom: calc(80px + var(--sab));
                right: 16px;
                padding: 12px;
                border-radius: 50%;
            }
            .support-btn span { display: none; }
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .desktop-only { display: none !important; }
            body { padding-bottom: calc(70px + var(--sab)); }
            .btn { min-height: 52px; }
            .btn-icon { width: 52px; height: 52px; }
            .input-field { min-height: 52px; font-size: 16px; }
            .card { border-radius: 20px; }
            
            /* Покращений scroll */
            .scroll-container { 
                -webkit-overflow-scrolling: touch; 
                scroll-behavior: smooth;
                overscroll-behavior: contain;
            }
            
            /* Більші touch targets для value inputs */
            .value-input {
                min-height: 48px;
                font-size: 18px;
                font-weight: 600;
                text-align: center;
                border-radius: 12px;
            }
        }
        @media (min-width: 641px) { 
            .mobile-only { display: none !important; } 
            .bottom-nav { display: none; }
        }
        
        /* Checkbox items */
        .checkbox-item { display: flex; align-items: center; gap: 14px; padding: 14px; background: #f9fafb; border-radius: 14px; cursor: pointer; transition: all 0.2s; }
        .checkbox-item:active { background: #f3f4f6; transform: scale(0.98); }
        .checkbox-item input[type="checkbox"] { width: 22px; height: 22px; accent-color: #22c55e; cursor: pointer; }
        
        /* Select field */
        .select-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 16px; transition: all 0.2s; cursor: pointer; min-height: 52px; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 44px; }
        .select-field:focus { outline: none; border-color: #22c55e; }
        
        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            text-align: center;
        }
        .empty-state-icon {
            width: 80px;
            height: 80px;
            border-radius: 24px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        /* Pull to refresh indicator */
        .pull-indicator {
            position: fixed;
            top: calc(var(--sat) + 60px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #22c55e;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script>
function _extends() { return _extends = Object.assign ? Object.assign.bind() : function (n) { for (var e = 1; e < arguments.length; e++) { var t = arguments[e]; for (var r in t) ({}).hasOwnProperty.call(t, r) && (n[r] = t[r]); } return n; }, _extends.apply(null, arguments); }
const {
  useState,
  useEffect,
  useRef,
  useCallback,
  useMemo,
  createContext,
  useContext,
  memo
} = React;

// ==================== CONSTANTS ====================
const CONSTANTS = {
  SAVE_DEBOUNCE_MS: 1500,
  SAVE_IMMEDIATE_THRESHOLD: 500,
  MAX_BACKUPS: 5,
  MAX_USERS_LOAD: 100,
  MAX_HISTORY_ITEMS: 50,
  TOAST_DURATION: { success: 2500, error: 5000, info: 3000, warning: 4000 },
  FORMATS: ['number', 'percent', 'uah', 'usd', 'eur'],
  PERIODS: ['weekly', 'monthly', 'daily'],
  IMPORTANCE_LEVELS: ['critical', 'high', 'medium', 'low'],
  MAX_INPUT_LENGTH: 200
};

// ==================== SECURITY UTILS ====================
const SecurityUtils = {
  // Санітизація тексту для XSS захисту
  sanitize: (str) => {
    if (str == null) return '';
    return String(str)
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#x27;')
      .replace(/\//g, '&#x2F;')
      .substring(0, CONSTANTS.MAX_INPUT_LENGTH);
  },
  
  // Безпечне отримання значення
  safeString: (val, fallback = '') => {
    if (val == null) return fallback;
    return String(val).substring(0, CONSTANTS.MAX_INPUT_LENGTH);
  },
  
  // Безпечне число
  safeNumber: (val, fallback = 0) => {
    const num = parseFloat(val);
    return isNaN(num) ? fallback : num;
  }
};

// ==================== VALIDATION UTILS ====================
const ValidationUtils = {
  // Валідація колонки
  validateColumn: (col) => {
    if (!col || typeof col !== 'object') return null;
    return {
      id: SecurityUtils.safeString(col.id, Date.now().toString()),
      name: SecurityUtils.safeString(col.name, 'Без назви'),
      responsible: SecurityUtils.safeString(col.responsible, ''),
      period: CONSTANTS.PERIODS.includes(col?.period) ? col.period : 'weekly',
      format: CONSTANTS.FORMATS.includes(col?.format) ? col.format : 'number',
      importance: CONSTANTS.IMPORTANCE_LEVELS.includes(col?.importance) ? col.importance : 'medium',
      inverted: Boolean(col?.inverted),
      visibleToEmployees: Array.isArray(col?.visibleToEmployees) ? col.visibleToEmployees : []
    };
  },
  
  // Валідація рядка
  validateRow: (row) => {
    if (!row || typeof row !== 'object') return null;
    return {
      id: SecurityUtils.safeString(row.id, Date.now().toString()),
      isTarget: Boolean(row?.isTarget),
      periodType: CONSTANTS.PERIODS.includes(row?.periodType) ? row.periodType : 'weekly',
      date: SecurityUtils.safeString(row.date, ''),
      values: row?.values && typeof row.values === 'object' ? { ...row.values } : {},
      targets: row?.targets && typeof row.targets === 'object' ? { ...row.targets } : {},
      comments: row?.comments && typeof row.comments === 'object' ? { ...row.comments } : {}
    };
  },
  
  // Валідація масиву колонок
  validateColumns: (columns) => {
    if (!Array.isArray(columns)) return [];
    return columns.map(ValidationUtils.validateColumn).filter(Boolean);
  },
  
  // Валідація масиву рядків
  validateRows: (rows) => {
    if (!Array.isArray(rows)) return [];
    return rows.map(ValidationUtils.validateRow).filter(Boolean);
  }
};

// ==================== ERROR BOUNDARY ====================
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }
  
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }
  
  componentDidCatch(error, errorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      const { fallback, title = 'Щось пішло не так' } = this.props;
      
      if (fallback) return fallback;
      
      return React.createElement('div', {
        className: 'p-4 bg-red-50 border border-red-200 rounded-xl text-center'
      },
        React.createElement('div', { className: 'text-red-500 mb-2' },
          React.createElement('svg', { 
            className: 'w-8 h-8 mx-auto', 
            fill: 'none', 
            viewBox: '0 0 24 24', 
            stroke: 'currentColor' 
          },
            React.createElement('path', { 
              strokeLinecap: 'round', 
              strokeLinejoin: 'round', 
              strokeWidth: 2, 
              d: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' 
            })
          )
        ),
        React.createElement('p', { className: 'font-medium text-gray-800' }, title),
        React.createElement('p', { className: 'text-sm text-gray-500 mt-1' }, 'Спробуйте оновити сторінку'),
        React.createElement('button', {
          onClick: () => this.setState({ hasError: false, error: null }),
          className: 'mt-3 px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition-colors'
        }, 'Спробувати знову')
      );
    }
    
    return this.props.children;
  }
}

// Спеціалізований ErrorBoundary для графіків
class ChartErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }
  
  static getDerivedStateFromError() {
    return { hasError: true };
  }
  
  componentDidCatch(error, errorInfo) {
    console.error('Chart error:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return React.createElement('div', {
        className: 'flex flex-col items-center justify-center p-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200'
      },
        React.createElement('svg', { 
          className: 'w-12 h-12 text-gray-300 mb-3', 
          fill: 'none', 
          viewBox: '0 0 24 24', 
          stroke: 'currentColor' 
        },
          React.createElement('path', { 
            strokeLinecap: 'round', 
            strokeLinejoin: 'round', 
            strokeWidth: 1.5, 
            d: 'M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z' 
          })
        ),
        React.createElement('p', { className: 'text-gray-500 font-medium' }, 'Не вдалося завантажити графік'),
        React.createElement('button', {
          onClick: () => this.setState({ hasError: false }),
          className: 'mt-3 text-sm text-primary-600 hover:text-primary-700 font-medium'
        }, 'Спробувати знову')
      );
    }
    
    return this.props.children;
  }
}

// ==================== CONFIGURATION ====================
const firebaseConfig = {
  apiKey: "AIzaSyA850ceFuupxSBL9WwoKovkDzIshPAl_W8",
  authDomain: "stats-tracker-ai.firebaseapp.com",
  projectId: "stats-tracker-ai",
  storageBucket: "stats-tracker-ai.firebasestorage.app",
  messagingSenderId: "373376418182",
  appId: "1:373376418182:web:1b4cf979f73a8e6271ec07"
};

// OpenAI API Key (встановіть ліміт $20 в OpenAI Dashboard!)
const OPENAI_API_KEY = null; // Ключ зберігається в Cloudflare Worker
const OPENAI_MODEL = "gpt-4o";
const SUPPORT_URL = "https://chatgpt.com/g/g-693bf67a13e48191940632f9d6bedb63-talko-statistics-ai-support";
const GPT_BOTTLENECK_URL = "https://chatgpt.com/g/g-6856346cb4c481918bb7e00d87b59d9c-ai-alex-talko-bottleneck-analysis";

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
db.enablePersistence().catch(console.log);

// ==================== SVG ICONS ====================
const Icons = {
  Menu: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("line", {
    x1: "4",
    x2: "20",
    y1: "12",
    y2: "12"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "4",
    x2: "20",
    y1: "6",
    y2: "6"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "4",
    x2: "20",
    y1: "18",
    y2: "18"
  })),
  Close: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M18 6 6 18"
  }), /*#__PURE__*/React.createElement("path", {
    d: "m6 6 12 12"
  })),
  Plus: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M5 12h14"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 5v14"
  })),
  Trash: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M3 6h18"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"
  })),
  MessageSquare: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
  })),
  Edit: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"
  })),
  Check: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M20 6 9 17l-5-5"
  })),
  Copy: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("rect", {
    width: "14",
    height: "14",
    x: "8",
    y: "8",
    rx: "2",
    ry: "2"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"
  })),
  Undo: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M3 7v6h6"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"
  })),
  BarChart: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("line", {
    x1: "12",
    x2: "12",
    y1: "20",
    y2: "10"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "18",
    x2: "18",
    y1: "20",
    y2: "4"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "6",
    x2: "6",
    y1: "20",
    y2: "16"
  })),
  Target: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "10"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "6"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "2"
  })),
  Calendar: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M8 2v4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M16 2v4"
  }), /*#__PURE__*/React.createElement("rect", {
    width: "18",
    height: "18",
    x: "3",
    y: "4",
    rx: "2"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M3 10h18"
  })),
  DollarSign: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("line", {
    x1: "12",
    x2: "12",
    y1: "2",
    y2: "22"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
  })),
  Gift: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("rect", {
    x: "3",
    y: "8",
    width: "18",
    height: "4",
    rx: "1"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 8v13"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"
  })),
  Search: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "11",
    cy: "11",
    r: "8"
  }), /*#__PURE__*/React.createElement("path", {
    d: "m21 21-4.3-4.3"
  })),
  Minus: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M5 12h14"
  })),
  ArrowRight: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M5 12h14"
  }), /*#__PURE__*/React.createElement("path", {
    d: "m12 5 7 7-7 7"
  })),
  TrendingUp: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("polyline", {
    points: "22 7 13.5 15.5 8.5 10.5 2 17"
  }), /*#__PURE__*/React.createElement("polyline", {
    points: "16 7 22 7 22 13"
  })),
  TrendingDown: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("polyline", {
    points: "22 17 13.5 8.5 8.5 13.5 2 7"
  }), /*#__PURE__*/React.createElement("polyline", {
    points: "16 17 22 17 22 11"
  })),
  Download: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
  }), /*#__PURE__*/React.createElement("polyline", {
    points: "7 10 12 15 17 10"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "12",
    x2: "12",
    y1: "15",
    y2: "3"
  })),
  Upload: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"
  }), /*#__PURE__*/React.createElement("polyline", {
    points: "17 8 12 3 7 8"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "12",
    x2: "12",
    y1: "3",
    y2: "15"
  })),
  User: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "7",
    r: "4"
  })),
  Users: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "9",
    cy: "7",
    r: "4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M22 21v-2a4 4 0 0 0-3-3.87"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M16 3.13a4 4 0 0 1 0 7.75"
  })),
  UserPlus: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "9",
    cy: "7",
    r: "4"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "19",
    x2: "19",
    y1: "8",
    y2: "14"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "22",
    x2: "16",
    y1: "11",
    y2: "11"
  })),
  Crown: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"
  })),
  LogOut: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"
  }), /*#__PURE__*/React.createElement("polyline", {
    points: "16 17 21 12 16 7"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "21",
    x2: "9",
    y1: "12",
    y2: "12"
  })),
  Mail: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("rect", {
    width: "20",
    height: "16",
    x: "2",
    y: "4",
    rx: "2"
  }), /*#__PURE__*/React.createElement("path", {
    d: "m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"
  })),
  Lock: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("rect", {
    width: "18",
    height: "11",
    x: "3",
    y: "11",
    rx: "2",
    ry: "2"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M7 11V7a5 5 0 0 1 10 0v4"
  })),
  Eye: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "3"
  })),
  EyeOff: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M14.084 14.158a3 3 0 0 1-4.242-4.242"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"
  }), /*#__PURE__*/React.createElement("path", {
    d: "m2 2 20 20"
  })),
  Settings: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "3"
  })),
  AlertCircle: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "10"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "12",
    x2: "12",
    y1: "8",
    y2: "12"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "12",
    x2: "12.01",
    y1: "16",
    y2: "16"
  })),
  AlertTriangle: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "12",
    x2: "12",
    y1: "9",
    y2: "13"
  }), /*#__PURE__*/React.createElement("line", {
    x1: "12",
    x2: "12.01",
    y1: "17",
    y2: "17"
  })),
  CheckCircle: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "10"
  }), /*#__PURE__*/React.createElement("path", {
    d: "m9 12 2 2 4-4"
  })),
  Info: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "10"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 16v-4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 8h.01"
  })),
  Loader: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round",
    className: "animate-spin"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M21 12a9 9 0 1 1-6.219-8.56"
  })),
  MessageCircle: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M7.9 20A9 9 0 1 0 4 16.1L2 22Z"
  })),
  Link: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
  })),
  Sparkles: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M5 3v4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M19 17v4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M3 5h4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M17 19h4"
  })),
  Globe: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "10"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M2 12h20"
  })),
  ArrowLeftRight: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M8 3 4 7l4 4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M4 7h16"
  }), /*#__PURE__*/React.createElement("path", {
    d: "m16 21 4-4-4-4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M20 17H4"
  })),
  ChevronUp: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "m18 15-6-6-6 6"
  })),
  ChevronDown: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "m6 9 6 6 6-6"
  })),
  ChevronLeft: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "m15 18-6-6 6-6"
  })),
  ChevronRight: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "m9 18 6-6-6-6"
  })),
  Building: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("rect", {
    width: "16",
    height: "20",
    x: "4",
    y: "2",
    rx: "2",
    ry: "2"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M9 22v-4h6v4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M8 6h.01"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M16 6h.01"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 6h.01"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 10h.01"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 14h.01"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M16 10h.01"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M16 14h.01"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M8 10h.01"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M8 14h.01"
  })),
  Brain: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M17.599 6.5a3 3 0 0 0 .399-1.375"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M6.003 5.125A3 3 0 0 0 6.401 6.5"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M3.477 10.896a4 4 0 0 1 .585-.396"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M19.938 10.5a4 4 0 0 1 .585.396"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M6 18a4 4 0 0 1-1.967-.516"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M19.967 17.484A4 4 0 0 1 18 18"
  })),
  Clock: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "10"
  }), /*#__PURE__*/React.createElement("polyline", {
    points: "12 6 12 12 16 14"
  })),
  Activity: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M22 12h-4l-3 9L9 3l-3 9H2"
  })),
  Cloud: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"
  })),
  Save: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M7 3v4a1 1 0 0 0 1 1h7"
  })),
  History: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M3 3v5h5"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 7v5l4 2"
  })),
  HelpCircle: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "10"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M12 17h.01"
  })),
  Star: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("polygon", {
    points: "12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
  })),
  Circle: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "12",
    cy: "12",
    r: "10"
  })),
  FileText: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M14 2v4a2 2 0 0 0 2 2h4"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M10 9H8"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M16 13H8"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M16 17H8"
  })),
  RefreshCw: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M21 3v5h-5"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M8 16H3v5"
  })),
  Shield: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"
  })),
  GripVertical: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("circle", {
    cx: "9",
    cy: "12",
    r: "1"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "9",
    cy: "5",
    r: "1"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "9",
    cy: "19",
    r: "1"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "15",
    cy: "12",
    r: "1"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "15",
    cy: "5",
    r: "1"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "15",
    cy: "19",
    r: "1"
  })),
  GitBranch: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("line", {
    x1: "6",
    x2: "6",
    y1: "3",
    y2: "15"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "18",
    cy: "6",
    r: "3"
  }), /*#__PURE__*/React.createElement("circle", {
    cx: "6",
    cy: "18",
    r: "3"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M18 9a9 9 0 0 1-9 9"
  })),
  CheckSquare: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("rect", {
    width: "18",
    height: "18",
    x: "3",
    y: "3",
    rx: "2"
  }), /*#__PURE__*/React.createElement("path", {
    d: "m9 12 2 2 4-4"
  })),
  ExternalLink: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("path", {
    d: "M15 3h6v6"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M10 14 21 3"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
  })),
  Play: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("polygon", {
    points: "6 3 20 12 6 21 6 3"
  })),
  Database: p => /*#__PURE__*/React.createElement("svg", _extends({
    xmlns: "http://www.w3.org/2000/svg",
    viewBox: "0 0 24 24",
    fill: "none",
    stroke: "currentColor",
    strokeWidth: "2",
    strokeLinecap: "round",
    strokeLinejoin: "round"
  }, p), /*#__PURE__*/React.createElement("ellipse", {
    cx: "12",
    cy: "5",
    rx: "9",
    ry: "3"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M3 5V19A9 3 0 0 0 21 19V5"
  }), /*#__PURE__*/React.createElement("path", {
    d: "M3 12A9 3 0 0 0 21 12"
  }))
};

// ==================== TRANSLATIONS ====================
const translations = {
  uk: {
    appName: 'Трекер статистики',
    loading: 'Завантаження...',
    login: 'Вхід',
    register: 'Реєстрація',
    email: 'Email',
    password: 'Пароль',
    loginBtn: 'Увійти',
    registerBtn: 'Зареєструватися',
    logout: 'Вийти',
    noAccount: 'Немає акаунту?',
    hasAccount: 'Вже є акаунт?',
    companyName: 'Назва компанії',
    companyPlaceholder: 'Наприклад: Клініка "Здоров\'я"',
    owner: 'Власник',
    employee: 'Співробітник',
    menu: 'Меню',
    dashboard: 'Дашборд',
    statistics: 'Статистика',
    team: 'Команда',
    settings: 'Налаштування',
    add: 'Додати',
    save: 'Зберегти',
    cancel: 'Скасувати',
    delete: 'Видалити',
    edit: 'Редагувати',
    close: 'Закрити',
    confirm: 'Підтвердити',
    copy: 'Копіювати',
    undo: 'Відмінити',
    addStats: 'Додати показник',
    addRow: 'Додати запис',
    statsName: 'Назва показника',
    responsible: 'Відповідальний',
    date: 'Дата',
    target: 'Ціль',
    value: 'Значення',
    progress: 'Прогрес',
    comment: 'Коментар',
    addComment: 'Додати коментар',
    period: 'Періодичність',
    periodDaily: 'Щодня',
    periodWeekly: 'Щотижня',
    periodMonthly: 'Щомісяця',
    periodCustom: 'Довільно',
    search: 'Пошук...',
    noData: 'Даних поки немає',
    teamManagement: 'Управління командою',
    addEmployee: 'Додати співробітника',
    employeeEmail: 'Email співробітника',
    employeeName: "Ім'я співробітника",
    employees: 'Співробітники',
    noEmployees: 'Співробітників ще немає',
    removeEmployee: 'Видалити співробітника',
    visibleColumns: 'Доступ до показників',
    pendingInvite: 'Очікує',
    activeEmployee: 'Активний',
    inviteLink: 'Посилання для входу',
    linkCopied: 'Скопійовано!',
    joinWorkspace: 'Приєднатися',
    enterInviteCode: 'Код запрошення',
    joinBtn: 'Приєднатися',
    export: 'Експорт',
    import: 'Імпорт',
    exportExcel: 'Експорт Excel',
    importExcel: 'Імпорт Excel',
    saving: 'Збереження...',
    saved: 'Збережено',
    saveError: 'Помилка',
    columns: 'Показників',
    periods: 'Записів',
    values: 'Значень',
    support: 'Підтримка',
    confirmDelete: 'Видалити?',
    confirmClear: 'Очистити всі дані?',
    aiAnalysis: 'AI Аналіз',
    aiSettings: 'Налаштування AI',
    businessContext: 'Контекст бізнесу',
    businessContextPlaceholder: 'Опишіть ваш бізнес: галузь, послуги, середній чек, кількість співробітників...',
    priorities: 'Пріоритети зараз',
    prioritiesPlaceholder: 'Що найважливіше зараз? Збільшення продажів, оптимізація витрат...',
    analysisPeriod: 'Період аналізу',
    additionalFocus: 'Додатковий фокус',
    additionalFocusPlaceholder: 'Наприклад: Чому впали продажі у п\'ятницю?',
    runAnalysis: 'Запустити аналіз',
    analyzing: 'Аналізую...',
    lastWeeks: 'тижнів',
    aiResult: 'Результат аналізу',
    saveAnalysis: 'Зберегти',
    analysisHistory: 'Історія аналізів',
    overview: 'Загальна картина',
    bottleneck: 'Вузьке місце',
    recommendations: 'Рекомендації',
    weekPlan: 'План на тиждень',
    filled: 'Заповнено',
    pending: 'Очікує',
    overdue: 'Прострочено',
    editColumn: 'Редагувати показник',
    columnSettings: 'Налаштування показника',
    valueFormat: 'Формат значення',
    formatNumber: 'Число',
    formatPercent: 'Відсотки %',
    formatUAH: 'Гривні ₴',
    formatUSD: 'Долари $',
    formatEUR: 'Євро €',
    importance: 'Важливість',
    importanceCritical: 'Критично (впливає на гроші)',
    importanceHigh: 'Висока',
    importanceMedium: 'Середня',
    importanceLow: 'Низька (допоміжний)'
  },
  ru: {
    appName: 'Трекер статистики',
    loading: 'Загрузка...',
    login: 'Вход',
    register: 'Регистрация',
    email: 'Email',
    password: 'Пароль',
    loginBtn: 'Войти',
    registerBtn: 'Зарегистрироваться',
    logout: 'Выйти',
    noAccount: 'Нет аккаунта?',
    hasAccount: 'Уже есть аккаунт?',
    companyName: 'Название компании',
    companyPlaceholder: 'Например: Клиника "Здоровье"',
    owner: 'Владелец',
    employee: 'Сотрудник',
    menu: 'Меню',
    add: 'Добавить',
    save: 'Сохранить',
    cancel: 'Отмена',
    delete: 'Удалить',
    addStats: 'Добавить показатель',
    addRow: 'Добавить запись',
    statsName: 'Название показателя',
    responsible: 'Ответственный',
    date: 'Дата',
    target: 'Цель',
    value: 'Значение',
    comment: 'Комментарий',
    period: 'Периодичность',
    periodDaily: 'Ежедневно',
    periodWeekly: 'Еженедельно',
    periodMonthly: 'Ежемесячно',
    periodCustom: 'Произвольно',
    teamManagement: 'Управление командой',
    addEmployee: 'Добавить сотрудника',
    aiAnalysis: 'AI Анализ',
    businessContext: 'Контекст бизнеса',
    priorities: 'Приоритеты',
    runAnalysis: 'Запустить анализ',
    overview: 'Общая картина',
    bottleneck: 'Узкое место',
    recommendations: 'Рекомендации',
    weekPlan: 'План на неделю',
    valueFormat: 'Формат значения',
    formatNumber: 'Число',
    formatPercent: 'Проценты %',
    formatUAH: 'Гривны ₴',
    formatUSD: 'Доллары $',
    formatEUR: 'Евро €'
  }
};

// ==================== FORMAT VALUE ====================
const formatValue = (value, format) => {
  if (value === '' || value === null || value === undefined || value === '-') return '-';
  const num = parseFloat(value);
  if (isNaN(num)) return value;
  switch (format) {
    case 'percent':
      return `${num.toLocaleString('uk-UA')}%`;
    case 'uah':
      return `${num.toLocaleString('uk-UA')} ₴`;
    case 'usd':
      return `$${num.toLocaleString('en-US')}`;
    case 'eur':
      return `€${num.toLocaleString('de-DE')}`;
    case 'number':
    default:
      return num.toLocaleString('uk-UA');
  }
};

// ==================== WEEK HELPERS ====================
// weekStartDay: 0=Нд, 1=Пн, 2=Вт, 3=Ср, 4=Чт, 5=Пт, 6=Сб
const DAYS_SHORT = ['Нд', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
const DAYS_FULL = ['Неділя', 'Понеділок', 'Вівторок', 'Середа', 'Четвер', 'П\'ятниця', 'Субота'];

// Отримуємо день початку тижня з localStorage або дефолт (1 = Понеділок)
const getStoredWeekStartDay = () => {
  try {
    const stored = localStorage.getItem('weekStartDay');
    return stored !== null ? parseInt(stored) : 1;
  } catch {
    return 1;
  }
};
const getWeekRange = (date, startDay = null) => {
  const actualStartDay = startDay !== null ? startDay : getStoredWeekStartDay();
  const d = new Date(date);
  if (isNaN(d.getTime())) return null;
  const day = d.getDay(); // 0=Нд, 1=Пн, ...

  // Різниця до початку тижня
  let diff = day - actualStartDay;
  if (diff < 0) diff += 7;
  const weekStart = new Date(d);
  weekStart.setDate(d.getDate() - diff);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  return {
    start: weekStart,
    end: weekEnd
  };
};
const formatWeekLabel = (date, startDay = null) => {
  const actualStartDay = startDay !== null ? startDay : getStoredWeekStartDay();
  const range = getWeekRange(date, actualStartDay);
  if (!range) return 'Невірна дата';
  const {
    start,
    end
  } = range;
  const formatDay = d => d.getDate().toString().padStart(2, '0');
  const formatMonth = d => (d.getMonth() + 1).toString().padStart(2, '0');
  const year = end.getFullYear().toString().slice(-2);
  if (start.getMonth() === end.getMonth()) {
    return `${formatDay(start)}-${formatDay(end)}.${formatMonth(end)}.${year}`;
  } else {
    return `${formatDay(start)}.${formatMonth(start)}-${formatDay(end)}.${formatMonth(end)}.${year}`;
  }
};
const getWeekKey = (date, startDay = null) => {
  const actualStartDay = startDay !== null ? startDay : getStoredWeekStartDay();
  const range = getWeekRange(date, actualStartDay);
  if (!range) return null;
  return range.start.toISOString().split('T')[0];
};
const generateWeeks = (countBack = 52, countForward = 4, startDay = null) => {
  const actualStartDay = startDay !== null ? startDay : getStoredWeekStartDay();
  const weeks = [];
  const today = new Date();

  // Майбутні тижні
  for (let i = countForward; i > 0; i--) {
    const d = new Date(today);
    d.setDate(today.getDate() + i * 7);
    const range = getWeekRange(d, actualStartDay);
    if (!range) continue;
    const {
      start,
      end
    } = range;
    weeks.push({
      key: start.toISOString().split('T')[0],
      label: formatWeekLabel(d, actualStartDay),
      start: start,
      end: end,
      isCurrent: false,
      isFuture: true
    });
  }

  // Поточний та минулі тижні
  for (let i = 0; i < countBack; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() - i * 7);
    const range = getWeekRange(d, actualStartDay);
    if (!range) continue;
    const {
      start,
      end
    } = range;
    weeks.push({
      key: start.toISOString().split('T')[0],
      label: formatWeekLabel(d, actualStartDay),
      start: start,
      end: end,
      isCurrent: i === 0,
      isFuture: false
    });
  }
  return weeks;
};

// Глобальні кеші (ініціалізуються з localStorage)
const getInitialWeekStartDay = () => {
  try {
    const stored = localStorage.getItem('weekStartDay');
    return stored !== null ? parseInt(stored) : 1;
  } catch {
    return 1;
  }
};

// ==================== MONTH HELPERS ====================
const getMonthKeyFromDate = date => {
  const d = new Date(date);
  if (isNaN(d.getTime())) return null;
  const year = d.getFullYear();
  const month = (d.getMonth() + 1).toString().padStart(2, '0');
  return `${year}-${month}`;
};
const formatMonthLabel = monthKey => {
  if (!monthKey) return 'Невірний місяць';
  const [year, month] = monthKey.split('-');
  const monthNames = ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'];
  return `${monthNames[parseInt(month) - 1]} ${year}`;
};
const generateMonths = (countBack = 24, countForward = 3) => {
  const months = [];
  const today = new Date();

  // Майбутні місяці
  for (let i = countForward; i > 0; i--) {
    const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
    const key = getMonthKeyFromDate(d);
    months.push({
      key: key,
      label: formatMonthLabel(key),
      isCurrent: false,
      isFuture: true
    });
  }

  // Поточний та минулі місяці
  for (let i = 0; i < countBack; i++) {
    const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
    const key = getMonthKeyFromDate(d);
    months.push({
      key: key,
      label: formatMonthLabel(key),
      isCurrent: i === 0,
      isFuture: false
    });
  }
  return months;
};

// Глобальні кеші (ініціалізуються після визначення функцій)
let WEEKS_CACHE = generateWeeks(52, 52, getInitialWeekStartDay());
let MONTHS_CACHE = generateMonths(24, 12);
const updateWeeksCache = startDay => {
  WEEKS_CACHE = generateWeeks(52, 52, startDay);
};
const isWeekFilled = (weekKey, rows) => {
  return rows.some(row => {
    if (row.isTarget || !row.date) return false;
    const rowWeekKey = getWeekKey(row.date);
    return rowWeekKey === weekKey;
  });
};
const isMonthFilled = (monthKey, rows) => {
  return rows.some(row => {
    if (row.isTarget || !row.date || row.periodType !== 'monthly') return false;
    return row.date === monthKey;
  });
};

// ==================== TOAST ====================
const ToastContext = createContext();
const ToastProvider = ({
  children
}) => {
  const [toasts, setToasts] = useState([]);
  const addToast = useCallback((message, type = 'info', customDuration = null) => {
    const id = Date.now() + Math.random();
    const duration = customDuration || CONSTANTS.TOAST_DURATION[type] || 3000;
    setToasts(prev => [...prev.slice(-4), { // Максимум 5 тостів
      id,
      message: SecurityUtils.safeString(message, 'Повідомлення'),
      type
    }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), duration);
  }, []);
  const toast = useMemo(() => ({
    success: (msg, duration) => addToast(msg, 'success', duration),
    error: (msg, duration) => addToast(msg, 'error', duration),
    info: (msg, duration) => addToast(msg, 'info', duration),
    warning: (msg, duration) => addToast(msg, 'warning', duration)
  }), [addToast]);
  return /*#__PURE__*/React.createElement(ToastContext.Provider, {
    value: toast
  }, children, /*#__PURE__*/React.createElement("div", {
    className: "toast-container"
  }, toasts.map(t => /*#__PURE__*/React.createElement("div", {
    key: t.id,
    className: `toast toast-${t.type}`
  }, t.type === 'success' && /*#__PURE__*/React.createElement(Icons.CheckCircle, {
    className: "w-5 h-5 text-green-500"
  }), t.type === 'error' && /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-5 h-5 text-red-500"
  }), t.type === 'info' && /*#__PURE__*/React.createElement(Icons.Info, {
    className: "w-5 h-5 text-blue-500"
  }), t.type === 'warning' && /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-5 h-5 text-amber-500"
  }), /*#__PURE__*/React.createElement("span", null, t.message)))));
};
const useToast = () => useContext(ToastContext);

// ==================== LOADING COMPONENTS ====================
const Spinner = memo(({ size = 'md', className = '' }) => {
  const sizeClass = size === 'sm' ? 'w-4 h-4' : size === 'lg' ? 'w-8 h-8' : 'w-5 h-5';
  return React.createElement('svg', {
    className: `animate-spin ${sizeClass} ${className}`,
    fill: 'none',
    viewBox: '0 0 24 24'
  },
    React.createElement('circle', {
      className: 'opacity-25',
      cx: '12',
      cy: '12',
      r: '10',
      stroke: 'currentColor',
      strokeWidth: '4'
    }),
    React.createElement('path', {
      className: 'opacity-75',
      fill: 'currentColor',
      d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z'
    })
  );
});

const LoadingButton = memo(({ 
  children, 
  loading = false, 
  disabled = false, 
  className = '', 
  onClick,
  loadingText = null,
  ...props 
}) => {
  return React.createElement('button', {
    className: `${className} ${loading ? 'cursor-wait' : ''}`,
    disabled: disabled || loading,
    onClick: loading ? undefined : onClick,
    ...props
  },
    loading ? React.createElement(React.Fragment, null,
      React.createElement(Spinner, { size: 'sm', className: 'mr-2' }),
      loadingText || children
    ) : children
  );
});

// Skeleton loader для таблиці
const TableSkeleton = memo(({ rows = 5, cols = 4 }) => {
  return React.createElement('div', { className: 'space-y-2 p-4' },
    Array.from({ length: rows }).map((_, i) => 
      React.createElement('div', { key: i, className: 'flex gap-2' },
        Array.from({ length: cols }).map((_, j) => 
          React.createElement('div', { 
            key: j, 
            className: 'skeleton h-10 rounded-lg flex-1',
            style: { animationDelay: `${(i * cols + j) * 50}ms` }
          })
        )
      )
    )
  );
});

// AI Progress Indicator з етапами
const AIProgressIndicator = memo(({ stage = 0, stages = [] }) => {
  const defaultStages = [
    { label: 'Збір даних', icon: '📊' },
    { label: 'Аналіз трендів', icon: '📈' },
    { label: 'Пошук проблем', icon: '🔍' },
    { label: 'Генерація рішень', icon: '💡' }
  ];
  const stageList = stages.length > 0 ? stages : defaultStages;
  const progress = Math.min(((stage + 1) / stageList.length) * 100, 100);
  
  return React.createElement('div', { className: 'bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border border-purple-100' },
    React.createElement('div', { className: 'flex items-center gap-3 mb-3' },
      React.createElement(Spinner, { size: 'sm', className: 'text-purple-600' }),
      React.createElement('span', { className: 'font-medium text-purple-800' }, 
        stageList[Math.min(stage, stageList.length - 1)]?.label || 'Обробка...'
      ),
      React.createElement('span', { className: 'text-lg' }, 
        stageList[Math.min(stage, stageList.length - 1)]?.icon || '⏳'
      )
    ),
    React.createElement('div', { className: 'h-2 bg-purple-100 rounded-full overflow-hidden' },
      React.createElement('div', { 
        className: 'h-full bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full transition-all duration-500',
        style: { width: `${progress}%` }
      })
    ),
    React.createElement('div', { className: 'flex justify-between mt-2' },
      stageList.map((s, i) => 
        React.createElement('div', { 
          key: i, 
          className: `text-xs ${i <= stage ? 'text-purple-600 font-medium' : 'text-gray-400'}`
        }, s.icon)
      )
    )
  );
});

// Overlay для блокування UI під час операцій
const OperationOverlay = memo(({ isVisible, message = 'Обробка...', children }) => {
  if (!isVisible) return children;
  
  return React.createElement('div', { className: 'relative' },
    children,
    React.createElement('div', { 
      className: 'absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-10 rounded-xl'
    },
      React.createElement('div', { className: 'flex flex-col items-center gap-2' },
        React.createElement(Spinner, { size: 'lg', className: 'text-primary-500' }),
        React.createElement('span', { className: 'text-sm font-medium text-gray-600' }, message)
      )
    )
  );
});

// ==================== MODAL ====================
const Modal = ({
  isOpen,
  onClose,
  title,
  children,
  size = 'md'
}) => {
  useEffect(() => {
    if (isOpen) document.body.style.overflow = 'hidden';
    return () => {
      document.body.style.overflow = '';
    };
  }, [isOpen]);
  if (!isOpen) return null;
  const sizeClass = size === 'lg' ? 'sm:max-w-lg' : size === 'xl' ? 'sm:max-w-2xl' : size === '2xl' ? 'sm:max-w-4xl' : size === 'full' ? 'sm:max-w-[95vw] sm:w-[95vw]' : 'sm:max-w-md';
  const heightClass = size === 'full' ? 'h-[calc(85vh-80px)]' : size === '2xl' ? 'max-h-[85vh]' : 'max-h-[70vh]';
  const isFullScreen = size === 'full';
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "modal-overlay",
    onClick: onClose
  }), /*#__PURE__*/React.createElement("div", {
    className: `modal-content ${sizeClass}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "sm:hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "sheet-handle"
  })), /*#__PURE__*/React.createElement("div", {
    className: `p-5 ${isFullScreen ? 'h-[90vh] flex flex-col' : ''}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900"
  }, title), /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "btn btn-ghost btn-icon"
  }, /*#__PURE__*/React.createElement(Icons.Close, {
    className: "w-5 h-5"
  }))), /*#__PURE__*/React.createElement("div", {
    className: `${isFullScreen ? 'flex-1 min-h-0' : heightClass} overflow-y-auto`
  }, children))));
};

// ==================== CONFIRM DIALOG ====================
const ConfirmDialog = ({
  isOpen,
  onClose,
  onConfirm,
  title,
  message
}) => {
  if (!isOpen) return null;
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "modal-overlay",
    onClick: onClose
  }), /*#__PURE__*/React.createElement("div", {
    className: "modal-content"
  }, /*#__PURE__*/React.createElement("div", {
    className: "sm:hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "sheet-handle"
  })), /*#__PURE__*/React.createElement("div", {
    className: "p-6 text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-14 h-14 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center"
  }, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-7 h-7 text-red-500"
  })), /*#__PURE__*/React.createElement("h3", {
    className: "text-lg font-bold text-gray-900 mb-2"
  }, title), message && /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 mb-6"
  }, message), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: onClose,
    className: "btn btn-secondary flex-1"
  }, "\u0421\u043A\u0430\u0441\u0443\u0432\u0430\u0442\u0438"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      onConfirm();
      onClose();
    },
    className: "btn btn-danger flex-1"
  }, "\u041F\u0456\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u0438")))));
};

// ==================== PROGRESS BAR ====================
const ProgressBar = memo(({
  value
}) => {
  const safeValue = SecurityUtils.safeNumber(value, 0);
  const getColor = () => {
    if (safeValue >= 100) return 'bg-green-500';
    if (safeValue >= 80) return 'bg-blue-500';
    if (safeValue >= 50) return 'bg-amber-500';
    return 'bg-red-500';
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "progress-bar"
  }, /*#__PURE__*/React.createElement("div", {
    className: `progress-fill ${getColor()}`,
    style: {
      width: `${Math.min(Math.max(safeValue, 0), 100)}%`
    }
  }));
});

// ==================== MINI PROGRESS BAR (для комірок) ====================
const MiniProgressBar = memo(({ value, inverted = false }) => {
  const safeValue = Math.min(Math.max(SecurityUtils.safeNumber(value, 0), 0), 100);
  
  const getColor = () => {
    if (inverted) {
      // Для inverted: високий % = добре (зелений)
      if (safeValue >= 100) return 'bg-emerald-500';
      if (safeValue >= 50) return 'bg-amber-500';
      return 'bg-red-500';
    }
    // Звичайний
    if (safeValue >= 100) return 'bg-emerald-500';
    if (safeValue >= 80) return 'bg-blue-500';
    if (safeValue >= 50) return 'bg-amber-500';
    return 'bg-red-500';
  };
  
  return React.createElement('div', {
    className: 'flex items-center gap-1 min-w-[60px]'
  },
    React.createElement('div', {
      className: 'flex-1 h-1.5 bg-gray-200 rounded-full overflow-hidden'
    },
      React.createElement('div', {
        className: `h-full rounded-full transition-all ${getColor()}`,
        style: { width: `${safeValue}%` }
      })
    ),
    React.createElement('span', {
      className: 'text-[10px] font-medium text-gray-600 w-8 text-right'
    }, safeValue >= 100 ? '✓' : `${safeValue}%`)
  );
});

// ==================== SPARKLINE (міні-графік тренду) ====================
const Sparkline = memo(({ data, width = 50, height = 16, color = '#22c55e' }) => {
  if (!data || data.length < 2) return null;
  
  // Нормалізуємо дані
  const values = data.map(v => parseFloat(v) || 0);
  const min = Math.min(...values);
  const max = Math.max(...values);
  const range = max - min || 1;
  
  // Визначаємо колір по тренду (останнє vs перше)
  const trend = values[values.length - 1] - values[0];
  const lineColor = trend >= 0 ? '#22c55e' : '#ef4444';
  
  // Будуємо path
  const points = values.map((v, i) => {
    const x = (i / (values.length - 1)) * width;
    const y = height - ((v - min) / range) * (height - 2) - 1;
    return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
  }).join(' ');
  
  return React.createElement('svg', {
    width: width,
    height: height,
    className: 'inline-block'
  },
    React.createElement('path', {
      d: points,
      fill: 'none',
      stroke: lineColor,
      strokeWidth: 1.5,
      strokeLinecap: 'round',
      strokeLinejoin: 'round'
    }),
    // Точка на останньому значенні
    React.createElement('circle', {
      cx: width,
      cy: height - ((values[values.length - 1] - min) / range) * (height - 2) - 1,
      r: 2,
      fill: lineColor
    })
  );
});

// ==================== PERIOD COMPARISON ====================
const PeriodComparison = memo(({ columns, rows, periodType = 'weekly', t }) => {
  const [period1, setPeriod1] = useState('');
  const [period2, setPeriod2] = useState('');
  
  // Отримуємо унікальні періоди
  const periods = useMemo(() => {
    const uniquePeriods = new Set();
    rows.filter(r => !r.isTarget && r.periodType === periodType)
      .forEach(r => uniquePeriods.add(r.date));
    return Array.from(uniquePeriods).sort().reverse();
  }, [rows, periodType]);
  
  // Автоматично вибираємо поточний та такий же минулого року
  useEffect(() => {
    if (periods.length >= 2) {
      setPeriod1(periods[0]); // Останній
      // Шукаємо такий же період минулого року
      const current = periods[0];
      if (periodType === 'weekly' && current) {
        // Формат: 2025-W03 → 2024-W03
        const lastYear = current.replace(/^(\d{4})/, (_, y) => String(Number(y) - 1));
        if (periods.includes(lastYear)) {
          setPeriod2(lastYear);
        } else {
          setPeriod2(periods[1] || '');
        }
      } else if (periodType === 'monthly' && current) {
        // Формат: 2025-01 → 2024-01
        const lastYear = current.replace(/^(\d{4})/, (_, y) => String(Number(y) - 1));
        if (periods.includes(lastYear)) {
          setPeriod2(lastYear);
        } else {
          setPeriod2(periods[1] || '');
        }
      } else {
        setPeriod2(periods[1] || '');
      }
    }
  }, [periods, periodType]);
  
  // Отримуємо дані для вибраних періодів
  const getData = (periodKey) => {
    return rows.find(r => !r.isTarget && r.date === periodKey && r.periodType === periodType);
  };
  
  const data1 = getData(period1);
  const data2 = getData(period2);
  
  // Форматуємо період для відображення
  const formatPeriod = (key) => {
    if (!key) return '—';
    if (periodType === 'monthly') {
      const [year, month] = key.split('-');
      const months = ['Січ', 'Лют', 'Бер', 'Кві', 'Тра', 'Чер', 'Лип', 'Сер', 'Вер', 'Жов', 'Лис', 'Гру'];
      return `${months[parseInt(month) - 1]} ${year}`;
    }
    return key;
  };
  
  // Розраховуємо зміну
  const getChange = (colId) => {
    const v1 = parseFloat(data1?.values?.[colId] || 0);
    const v2 = parseFloat(data2?.values?.[colId] || 0);
    if (v2 === 0) return null;
    const change = ((v1 - v2) / Math.abs(v2)) * 100;
    return Math.round(change);
  };
  
  const filteredColumns = columns.filter(c => c.period === periodType);
  
  if (periods.length < 2) {
    return React.createElement('div', { className: 'text-center py-8 text-gray-500' },
      React.createElement(Icons.BarChart, { className: 'w-12 h-12 mx-auto mb-2 text-gray-300' }),
      React.createElement('p', null, 'Потрібно мінімум 2 періоди для порівняння')
    );
  }
  
  return React.createElement('div', { className: 'space-y-4' },
    // Селектори періодів
    React.createElement('div', { className: 'flex items-center gap-4 flex-wrap' },
      React.createElement('div', { className: 'flex items-center gap-2' },
        React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, 'Період 1:'),
        React.createElement('select', {
          value: period1,
          onChange: e => setPeriod1(e.target.value),
          className: 'px-3 py-1.5 border rounded-lg text-sm focus:border-primary-400'
        }, periods.map(p => 
          React.createElement('option', { key: p, value: p }, formatPeriod(p))
        ))
      ),
      React.createElement('span', { className: 'text-gray-400' }, 'vs'),
      React.createElement('div', { className: 'flex items-center gap-2' },
        React.createElement('label', { className: 'text-sm font-medium text-gray-700' }, 'Період 2:'),
        React.createElement('select', {
          value: period2,
          onChange: e => setPeriod2(e.target.value),
          className: 'px-3 py-1.5 border rounded-lg text-sm focus:border-primary-400'
        }, periods.map(p => 
          React.createElement('option', { key: p, value: p }, formatPeriod(p))
        ))
      )
    ),
    // Таблиця порівняння
    React.createElement('div', { className: 'overflow-x-auto' },
      React.createElement('table', { className: 'w-full text-sm' },
        React.createElement('thead', null,
          React.createElement('tr', { className: 'border-b' },
            React.createElement('th', { className: 'text-left py-2 px-3 font-medium' }, 'Показник'),
            React.createElement('th', { className: 'text-right py-2 px-3 font-medium text-primary-600' }, formatPeriod(period1)),
            React.createElement('th', { className: 'text-right py-2 px-3 font-medium text-gray-500' }, formatPeriod(period2)),
            React.createElement('th', { className: 'text-right py-2 px-3 font-medium' }, 'Зміна')
          )
        ),
        React.createElement('tbody', null,
          filteredColumns.map(col => {
            const v1 = data1?.values?.[col.id] || '—';
            const v2 = data2?.values?.[col.id] || '—';
            const change = getChange(col.id);
            const changeClass = change === null ? 'text-gray-400' : 
              (col.inverted ? (change <= 0 ? 'text-emerald-600' : 'text-red-600') :
              (change >= 0 ? 'text-emerald-600' : 'text-red-600'));
            
            return React.createElement('tr', { key: col.id, className: 'border-b hover:bg-gray-50' },
              React.createElement('td', { className: 'py-2 px-3' },
                React.createElement('div', { className: 'font-medium' }, col.name),
                col.responsible && React.createElement('div', { className: 'text-xs text-gray-500' }, col.responsible)
              ),
              React.createElement('td', { className: 'text-right py-2 px-3 font-semibold' }, v1),
              React.createElement('td', { className: 'text-right py-2 px-3 text-gray-500' }, v2),
              React.createElement('td', { className: `text-right py-2 px-3 font-semibold ${changeClass}` },
                change === null ? '—' : (change >= 0 ? '+' : '') + change + '%'
              )
            );
          })
        )
      )
    )
  );
});

// ==================== FORMULA COLUMNS ====================
// Підтримувані операції: +, -, *, /, ()
// Формат: {col1} + {col2} або {Назва показника} * 0.2
const FormulaEngine = {
  // Парсимо формулу і знаходимо залежності
  parse: (formula, columns) => {
    if (!formula) return null;
    const deps = [];
    const regex = /\{([^}]+)\}/g;
    let match;
    while ((match = regex.exec(formula)) !== null) {
      const ref = match[1];
      // Шукаємо колонку по ID або назві
      const col = columns.find(c => c.id === ref || c.name.toLowerCase() === ref.toLowerCase());
      if (col) deps.push(col.id);
    }
    return { formula, deps };
  },
  
  // Обчислюємо значення формули
  calculate: (formula, columns, rowValues) => {
    if (!formula) return null;
    try {
      let expr = formula;
      const regex = /\{([^}]+)\}/g;
      expr = expr.replace(regex, (_, ref) => {
        const col = columns.find(c => c.id === ref || c.name.toLowerCase() === ref.toLowerCase());
        if (!col) return '0';
        const val = parseFloat(String(rowValues?.[col.id] || '0').replace(',', '.'));
        return isNaN(val) ? '0' : val;
      });
      // Безпечне обчислення (тільки числа та операції)
      if (!/^[\d\s+\-*/().]+$/.test(expr)) return null;
      const result = Function('"use strict"; return (' + expr + ')')();
      return isNaN(result) ? null : Math.round(result * 100) / 100;
    } catch (e) {
      console.error('Formula error:', e);
      return null;
    }
  }
};

// Компонент для налаштування формули колонки
const FormulaEditor = memo(({ column, columns, onSave, onClose }) => {
  const [formula, setFormula] = useState(column.formula || '');
  const [preview, setPreview] = useState(null);
  
  // Доступні колонки для вставки
  const availableColumns = columns.filter(c => c.id !== column.id && !c.formula);
  
  // Тестовий розрахунок
  useEffect(() => {
    if (formula) {
      const testValues = {};
      availableColumns.forEach(c => { testValues[c.id] = 10; });
      const result = FormulaEngine.calculate(formula, columns, testValues);
      setPreview(result);
    } else {
      setPreview(null);
    }
  }, [formula, columns, availableColumns]);
  
  const insertColumn = (col) => {
    setFormula(f => f + `{${col.name}}`);
  };
  
  return React.createElement('div', { className: 'space-y-4' },
    React.createElement('div', null,
      React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Формула'),
      React.createElement('input', {
        type: 'text',
        value: formula,
        onChange: e => setFormula(e.target.value),
        placeholder: 'Наприклад: {Дохід} - {Витрати}',
        className: 'w-full px-3 py-2 border rounded-lg focus:border-primary-400'
      }),
      React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 
        'Використовуйте {Назва показника} для посилання. Операції: + - * / ( )'
      )
    ),
    availableColumns.length > 0 && React.createElement('div', null,
      React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'Вставити показник:'),
      React.createElement('div', { className: 'flex flex-wrap gap-1' },
        availableColumns.slice(0, 10).map(col => 
          React.createElement('button', {
            key: col.id,
            onClick: () => insertColumn(col),
            className: 'px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded'
          }, col.name)
        )
      )
    ),
    preview !== null && React.createElement('div', { className: 'p-3 bg-blue-50 rounded-lg' },
      React.createElement('span', { className: 'text-sm text-blue-700' }, 
        'Тестовий результат (всі значення = 10): ', 
        React.createElement('strong', null, preview)
      )
    ),
    React.createElement('div', { className: 'flex gap-2' },
      React.createElement('button', {
        onClick: () => onSave(formula),
        className: 'btn btn-primary flex-1'
      }, 'Зберегти'),
      React.createElement('button', {
        onClick: () => { setFormula(''); onSave(''); },
        className: 'btn btn-ghost text-red-500'
      }, 'Очистити'),
      React.createElement('button', {
        onClick: onClose,
        className: 'btn btn-secondary'
      }, 'Скасувати')
    )
  );
});

// ==================== ALERTS PANEL ====================
// Автоматичне виявлення проблемних трендів
const AlertsPanel = memo(({ columns, rows, targetRow, periodType = 'weekly' }) => {
  const alerts = useMemo(() => {
    const result = [];
    const filteredRows = rows
      .filter(r => !r.isTarget && r.periodType === periodType)
      .sort((a, b) => b.date?.localeCompare(a.date)); // Новіші спочатку
    
    if (filteredRows.length < 3) return result;
    
    columns.filter(c => c.period === periodType).forEach(col => {
      const values = filteredRows.slice(0, 5).map(r => ({
        date: r.date,
        value: parseFloat(String(r.values?.[col.id] || '').replace(',', '.')) || 0,
        target: parseFloat(String(r.targets?.[col.id] || targetRow?.values?.[col.id] || '').replace(',', '.')) || 0
      }));
      
      // Перевірка 1: Падіння 3+ періоди поспіль
      if (values.length >= 3) {
        let consecutiveDrops = 0;
        for (let i = 0; i < values.length - 1; i++) {
          const current = values[i].value;
          const previous = values[i + 1].value;
          if (col.inverted) {
            // Для inverted: зростання = погано
            if (current > previous) consecutiveDrops++;
            else break;
          } else {
            // Звичайний: падіння = погано
            if (current < previous) consecutiveDrops++;
            else break;
          }
        }
        if (consecutiveDrops >= 3) {
          result.push({
            type: 'trend_down',
            severity: 'high',
            column: col,
            message: `${col.name} ${col.inverted ? 'зростає' : 'падає'} ${consecutiveDrops} ${periodType === 'weekly' ? 'тижні' : 'місяці'} поспіль`,
            values: values.slice(0, consecutiveDrops + 1)
          });
        }
      }
      
      // Перевірка 2: Значно нижче цілі (< 50%)
      if (values[0]?.target > 0) {
        const latestProgress = col.inverted 
          ? (values[0].value <= 0 ? 100 : Math.round((1 - values[0].value / values[0].target) * 100))
          : Math.round((values[0].value / values[0].target) * 100);
        
        if (latestProgress < 50) {
          result.push({
            type: 'below_target',
            severity: latestProgress < 25 ? 'critical' : 'medium',
            column: col,
            message: `${col.name}: виконання лише ${latestProgress}% від цілі`,
            progress: latestProgress
          });
        }
      }
      
      // Перевірка 3: Різке падіння (> 30% за період)
      if (values.length >= 2 && values[1].value > 0) {
        const change = ((values[0].value - values[1].value) / values[1].value) * 100;
        const threshold = col.inverted ? 30 : -30; // Для inverted: зростання на 30% = погано
        
        if ((col.inverted && change > 30) || (!col.inverted && change < -30)) {
          result.push({
            type: 'sharp_change',
            severity: 'medium',
            column: col,
            message: `${col.name}: різка зміна ${change > 0 ? '+' : ''}${Math.round(change)}% за останній період`,
            change: Math.round(change)
          });
        }
      }
    });
    
    // Сортуємо по severity
    const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
    return result.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
  }, [columns, rows, targetRow, periodType]);
  
  if (alerts.length === 0) {
    return React.createElement('div', { className: 'text-center py-6' },
      React.createElement('div', { className: 'w-12 h-12 mx-auto mb-3 bg-emerald-100 rounded-full flex items-center justify-center' },
        React.createElement(Icons.CheckCircle, { className: 'w-6 h-6 text-emerald-600' })
      ),
      React.createElement('p', { className: 'text-gray-600 font-medium' }, 'Все добре!'),
      React.createElement('p', { className: 'text-sm text-gray-500' }, 'Критичних проблем не виявлено')
    );
  }
  
  const getSeverityStyle = (severity) => {
    switch (severity) {
      case 'critical': return 'bg-red-50 border-red-200 text-red-800';
      case 'high': return 'bg-orange-50 border-orange-200 text-orange-800';
      case 'medium': return 'bg-amber-50 border-amber-200 text-amber-800';
      default: return 'bg-blue-50 border-blue-200 text-blue-800';
    }
  };
  
  const getIcon = (type) => {
    switch (type) {
      case 'trend_down': return Icons.TrendingDown || Icons.ArrowDown;
      case 'below_target': return Icons.Target;
      case 'sharp_change': return Icons.AlertTriangle;
      default: return Icons.AlertCircle;
    }
  };
  
  return React.createElement('div', { className: 'space-y-2' },
    React.createElement('div', { className: 'flex items-center gap-2 mb-3' },
      React.createElement(Icons.AlertCircle, { className: 'w-5 h-5 text-amber-500' }),
      React.createElement('span', { className: 'font-semibold' }, `Знайдено ${alerts.length} ${alerts.length === 1 ? 'проблему' : 'проблем'}`)
    ),
    alerts.map((alert, idx) => {
      const IconComponent = getIcon(alert.type);
      return React.createElement('div', {
        key: idx,
        className: `p-3 rounded-lg border ${getSeverityStyle(alert.severity)}`
      },
        React.createElement('div', { className: 'flex items-start gap-2' },
          React.createElement(IconComponent, { className: 'w-4 h-4 mt-0.5 flex-shrink-0' }),
          React.createElement('div', null,
            React.createElement('p', { className: 'font-medium text-sm' }, alert.message),
            alert.column.responsible && React.createElement('p', { className: 'text-xs opacity-75 mt-0.5' }, 
              'Відповідальний: ', alert.column.responsible
            )
          )
        )
      );
    })
  );
});

// ==================== CELL COMMENT ====================
const CellComment = memo(({ rowId, colId, comment, onSave, onClose }) => {
  const [text, setText] = useState(comment || '');
  const textareaRef = React.useRef(null);
  
  useEffect(() => {
    textareaRef.current?.focus();
    textareaRef.current?.select();
  }, []);
  
  const handleSave = () => {
    onSave(rowId, colId, text.trim());
    onClose();
  };
  
  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && e.ctrlKey) {
      handleSave();
    }
    if (e.key === 'Escape') {
      onClose();
    }
  };
  
  return React.createElement('div', {
    className: 'absolute left-0 top-full mt-1 z-50 bg-white rounded-xl shadow-xl border p-3 min-w-[200px] max-w-[300px]'
  },
    React.createElement('div', { className: 'flex items-center gap-2 mb-2' },
      React.createElement(Icons.MessageSquare, { className: 'w-4 h-4 text-blue-500' }),
      React.createElement('span', { className: 'text-sm font-medium text-gray-700' }, 'Коментар')
    ),
    React.createElement('textarea', {
      ref: textareaRef,
      value: text,
      onChange: e => setText(e.target.value),
      onKeyDown: handleKeyDown,
      placeholder: 'Чому такий результат?',
      className: 'w-full px-3 py-2 text-sm border rounded-lg focus:border-blue-400 resize-none',
      rows: 3
    }),
    React.createElement('div', { className: 'flex items-center justify-between mt-2' },
      React.createElement('span', { className: 'text-xs text-gray-400' }, 'Ctrl+Enter для збереження'),
      React.createElement('div', { className: 'flex gap-1' },
        comment && React.createElement('button', {
          onClick: () => { onSave(rowId, colId, ''); onClose(); },
          className: 'px-2 py-1 text-xs text-red-500 hover:bg-red-50 rounded'
        }, 'Видалити'),
        React.createElement('button', {
          onClick: onClose,
          className: 'px-2 py-1 text-xs text-gray-500 hover:bg-gray-100 rounded'
        }, 'Скасувати'),
        React.createElement('button', {
          onClick: handleSave,
          className: 'px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600'
        }, 'Зберегти')
      )
    )
  );
});

// ==================== DATE PICKER CALENDAR ====================
const DatePickerCalendar = ({
  selectedDate,
  onSelect,
  weekStartDay = 1,
  periodType = 'weekly'
}) => {
  const [viewDate, setViewDate] = useState(() => selectedDate ? new Date(selectedDate) : new Date());
  const MONTH_NAMES = ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'];
  const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
  const getFirstDayOfMonth = (year, month) => {
    const day = new Date(year, month, 1).getDay();
    // Зсув відносно дня початку тижня
    return (day - weekStartDay + 7) % 7;
  };
  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();
  const daysInMonth = getDaysInMonth(year, month);
  const firstDay = getFirstDayOfMonth(year, month);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  // Генеруємо дні для відображення
  const days = [];
  // Порожні клітинки до першого дня
  for (let i = 0; i < firstDay; i++) {
    days.push(null);
  }
  // Дні місяця
  for (let d = 1; d <= daysInMonth; d++) {
    days.push(new Date(year, month, d));
  }

  // Заголовки днів тижня з урахуванням weekStartDay
  const dayHeaders = [];
  for (let i = 0; i < 7; i++) {
    dayHeaders.push(DAYS_SHORT[(weekStartDay + i) % 7]);
  }

  // Визначаємо який тиждень обраний
  const getWeekRangeForDate = date => {
    if (!date) return null;
    return getWeekRange(date, weekStartDay);
  };

  // Перевіряємо чи дата в тому ж тижні що й обрана
  const isSameWeek = date => {
    if (!selectedDate || !date) return false;
    const selectedRange = getWeekRangeForDate(new Date(selectedDate));
    const dateRange = getWeekRangeForDate(date);
    if (!selectedRange || !dateRange) return false;
    return selectedRange.start.getTime() === dateRange.start.getTime();
  };

  // Для місячного режиму - перевіряємо чи той самий місяць
  const isSameMonth = date => {
    if (!selectedDate || !date) return false;
    const sel = new Date(selectedDate);
    return sel.getFullYear() === date.getFullYear() && sel.getMonth() === date.getMonth();
  };
  const handleDateClick = date => {
    if (!date) return;
    if (periodType === 'monthly') {
      // Для місяців - повертаємо ключ місяця
      const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
      onSelect(monthKey, date);
    } else {
      // Для тижнів - повертаємо ключ тижня
      const weekKey = getWeekKey(date, weekStartDay);
      onSelect(weekKey, date);
    }
  };
  const prevMonth = () => setViewDate(new Date(year, month - 1, 1));
  const nextMonth = () => setViewDate(new Date(year, month + 1, 1));
  const goToToday = () => setViewDate(new Date());
  return /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-xl border border-gray-200 p-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: prevMonth,
    className: "p-2 hover:bg-gray-100 rounded-lg"
  }, /*#__PURE__*/React.createElement(Icons.ChevronLeft, {
    className: "w-5 h-5 text-gray-600"
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-bold text-gray-900"
  }, MONTH_NAMES[month], " ", year), /*#__PURE__*/React.createElement("button", {
    onClick: goToToday,
    className: "text-xs text-primary-600 hover:underline"
  }, "\u0421\u044C\u043E\u0433\u043E\u0434\u043D\u0456")), /*#__PURE__*/React.createElement("button", {
    onClick: nextMonth,
    className: "p-2 hover:bg-gray-100 rounded-lg"
  }, /*#__PURE__*/React.createElement(Icons.ChevronRight, {
    className: "w-5 h-5 text-gray-600"
  }))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-7 gap-1 mb-1"
  }, dayHeaders.map((day, i) => /*#__PURE__*/React.createElement("div", {
    key: i,
    className: "text-center text-xs font-medium text-gray-500 py-1"
  }, day))), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-7 gap-1"
  }, days.map((date, i) => {
    if (!date) return /*#__PURE__*/React.createElement("div", {
      key: i,
      className: "p-2"
    });
    const isToday = date.getTime() === today.getTime();
    const isSelected = periodType === 'monthly' ? isSameMonth(date) : isSameWeek(date);
    const isWeekStart = date.getDay() === weekStartDay;
    return /*#__PURE__*/React.createElement("button", {
      key: i,
      onClick: () => handleDateClick(date),
      className: `
                                        p-2 text-sm rounded-lg transition-all relative
                                        ${isSelected ? 'bg-primary-500 text-white font-bold' : 'hover:bg-gray-100'}
                                        ${isToday && !isSelected ? 'ring-2 ring-primary-500 font-bold' : ''}
                                        ${isWeekStart && !isSelected ? 'bg-gray-50' : ''}
                                    `
    }, date.getDate());
  })), periodType === 'weekly' && /*#__PURE__*/React.createElement("div", {
    className: "mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500"
  }, /*#__PURE__*/React.createElement("span", {
    className: "inline-block w-3 h-3 bg-gray-50 rounded mr-1"
  }), "\u041F\u043E\u0447\u0430\u0442\u043E\u043A \u0442\u0438\u0436\u043D\u044F: ", /*#__PURE__*/React.createElement("b", null, DAYS_FULL[weekStartDay])));
};

// ==================== AUTH FORM ====================
const AuthForm = ({
  t,
  onAuth,
  isLoading
}) => {
  const [isRegister, setIsRegister] = useState(false);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [inviteCode, setInviteCode] = useState('');
  const [inviteData, setInviteData] = useState(null);
  const [inviteLoading, setInviteLoading] = useState(false);
  const [inviteError, setInviteError] = useState('');
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('invite');
    if (code) {
      setInviteCode(code);
      setIsRegister(true);
      loadInviteData(code);
    }
  }, []);
  const loadInviteData = async code => {
    setInviteLoading(true);
    setInviteError('');
    try {
      const inviteDoc = await db.collection('invites').doc(code).get();
      if (!inviteDoc.exists) {
        setInviteError('Запрошення не знайдено');
        return;
      }
      const data = inviteDoc.data();
      if (data.used) {
        setInviteError('Це запрошення вже використано');
        return;
      }
      setInviteData(data);
      console.log('Invite loaded:', data);
    } catch (error) {
      console.error('Error loading invite:', error);
      setInviteError('Помилка завантаження запрошення');
    } finally {
      setInviteLoading(false);
    }
  };
  const handleSubmit = e => {
    e.preventDefault();
    onAuth(email, password, isRegister, inviteCode);
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "min-h-screen flex items-center justify-center bg-gradient-to-br from-primary-50 via-white to-green-50 p-4",
    style: {
      paddingTop: 'calc(env(safe-area-inset-top) + 16px)',
      paddingBottom: 'calc(env(safe-area-inset-bottom) + 16px)'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-full max-w-sm animate-fade-in"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center mb-8"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-20 h-20 mx-auto mb-5 rounded-3xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-xl shadow-primary-500/30"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-10 h-10 text-white"
  })), /*#__PURE__*/React.createElement("h1", {
    className: "text-2xl font-bold text-gray-900"
  }, t.appName), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 mt-2"
  }, inviteData ? 'Приєднайтесь до команди' : isRegister ? t.register : t.login)), inviteCode && /*#__PURE__*/React.createElement("div", {
    className: "mb-5"
  }, inviteLoading && /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gray-50 rounded-2xl flex items-center justify-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Loader, {
    className: "w-5 h-5 text-primary-500"
  }), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-600"
  }, "\u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F...")), inviteError && /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-red-50 border border-red-200 rounded-2xl"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-red-700"
  }, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-5 h-5"
  }), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, inviteError)), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      window.history.replaceState({}, '', window.location.pathname);
      window.location.reload();
    },
    className: "mt-3 text-sm text-red-600 underline"
  }, "\u0423\u0432\u0456\u0439\u0442\u0438 \u0431\u0435\u0437 \u0437\u0430\u043F\u0440\u043E\u0448\u0435\u043D\u043D\u044F")), inviteData && !inviteError && /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-2xl"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3 mb-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-12 h-12 rounded-xl bg-green-500 flex items-center justify-center"
  }, /*#__PURE__*/React.createElement(Icons.UserPlus, {
    className: "w-6 h-6 text-white"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    className: "font-bold text-green-900"
  }, "\u0417\u0430\u043F\u0440\u043E\u0448\u0435\u043D\u043D\u044F \u0434\u043B\u044F:"), /*#__PURE__*/React.createElement("p", {
    className: "text-green-700 font-medium"
  }, inviteData.name || 'Співробітник'))), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-green-600 mt-2 bg-green-100 p-2 rounded-lg"
  }, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-4 h-4 text-amber-500 flex-shrink-0"
  }), " \u0412\u0432\u0435\u0434\u0456\u0442\u044C ", /*#__PURE__*/React.createElement("b", null, "\u0432\u0430\u0448\u0443 \u043F\u043E\u0448\u0442\u0443"), " \u0442\u0430 \u043F\u0440\u0438\u0434\u0443\u043C\u0430\u0439\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C"))), /*#__PURE__*/React.createElement("form", {
    onSubmit: handleSubmit,
    className: "card p-6 space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700 mb-2"
  }, t.email), /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement(Icons.Mail, {
    className: "absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
  }), /*#__PURE__*/React.createElement("input", {
    type: "email",
    value: email,
    onChange: e => setEmail(e.target.value),
    className: "input-field pl-12",
    placeholder: "your@email.com",
    required: true,
    autoComplete: "email",
    disabled: inviteLoading || !!inviteError
  }))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-semibold text-gray-700 mb-2"
  }, t.password), /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement(Icons.Lock, {
    className: "absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"
  }), /*#__PURE__*/React.createElement("input", {
    type: showPassword ? 'text' : 'password',
    value: password,
    onChange: e => setPassword(e.target.value),
    className: "input-field pl-12 pr-14",
    placeholder: "\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",
    required: true,
    minLength: 6,
    autoComplete: isRegister ? 'new-password' : 'current-password',
    disabled: inviteLoading || !!inviteError
  }), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setShowPassword(!showPassword),
    className: "absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600"
  }, showPassword ? /*#__PURE__*/React.createElement(Icons.EyeOff, {
    className: "w-5 h-5"
  }) : /*#__PURE__*/React.createElement(Icons.Eye, {
    className: "w-5 h-5"
  }))), isRegister && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, "\u041C\u0456\u043D\u0456\u043C\u0443\u043C 6 \u0441\u0438\u043C\u0432\u043E\u043B\u0456\u0432")), /*#__PURE__*/React.createElement("button", {
    type: "submit",
    className: "btn btn-primary w-full text-base",
    disabled: isLoading || inviteLoading || !!inviteError
  }, isLoading ? /*#__PURE__*/React.createElement(Icons.Loader, {
    className: "w-5 h-5"
  }) : inviteData ? 'Приєднатись' : isRegister ? t.registerBtn : t.loginBtn)), !inviteCode && /*#__PURE__*/React.createElement("p", {
    className: "text-center mt-6 text-sm text-gray-600"
  }, isRegister ? t.hasAccount : t.noAccount, ' ', /*#__PURE__*/React.createElement("button", {
    onClick: () => setIsRegister(!isRegister),
    className: "text-primary-600 font-bold hover:underline"
  }, isRegister ? t.login : t.register)), !inviteCode && isRegister && /*#__PURE__*/React.createElement("p", {
    className: "text-center mt-4 text-xs text-gray-500 bg-amber-50 p-3 rounded-xl"
  }, /*#__PURE__*/React.createElement(Icons.Info, {
    className: "w-4 h-4 inline mr-1 text-amber-500"
  }), "\u0420\u0435\u0454\u0441\u0442\u0440\u0430\u0446\u0456\u044F \u043C\u043E\u0436\u043B\u0438\u0432\u0430 \u0442\u0456\u043B\u044C\u043A\u0438 \u0437\u0430 \u0437\u0430\u043F\u0440\u043E\u0448\u0435\u043D\u043D\u044F\u043C \u0432\u0456\u0434 \u0432\u043B\u0430\u0441\u043D\u0438\u043A\u0430")));
};

// ==================== PERIOD HELPERS ====================
const getPeriodLabel = (period, t) => {
  const labels = {
    daily: t.periodDaily,
    weekly: t.periodWeekly,
    monthly: t.periodMonthly,
    custom: t.periodCustom
  };
  return labels[period] || labels['weekly'] || 'Щотижня';
};
const getWeekNumber = date => {
  const d = new Date(date);
  d.setHours(0, 0, 0, 0);
  d.setDate(d.getDate() + 4 - (d.getDay() || 7));
  const yearStart = new Date(d.getFullYear(), 0, 1);
  return Math.ceil(((d - yearStart) / 86400000 + 1) / 7);
};
const getMonthKey = date => {
  const d = new Date(date);
  return `${d.getFullYear()}-${d.getMonth()}`;
};
const isFilledForPeriod = (rows, colId, period) => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const todayStr = today.toISOString().split('T')[0];
  const todayWeek = getWeekNumber(today);
  const todayMonth = getMonthKey(today);
  for (const row of rows) {
    if (row.isTarget || !row.values?.[colId]) continue;
    const val = row.values[colId];
    if (!val && val !== 0) continue;
    const rowDate = new Date(row.date);
    rowDate.setHours(0, 0, 0, 0);
    if (period === 'daily' && row.date === todayStr) return true;
    if (period === 'weekly' && getWeekNumber(rowDate) === todayWeek) return true;
    if (period === 'monthly' && getMonthKey(rowDate) === todayMonth) return true;
    if (period === 'custom') return true;
  }
  return false;
};

// ==================== STATS CARD (MOBILE) ====================
const StatsCardComponent = ({
  row,
  columns,
  onDelete,
  onDateChange,
  onValueChange,
  onTargetChange,
  onCommentChange,
  editable,
  isEven,
  t,
  allRows,
  periodType = 'weekly'
}) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [activeComment, setActiveComment] = useState(null);
  const [showTargets, setShowTargets] = useState(false);

  // Використовуємо відповідний кеш
  const periods = periodType === 'monthly' ? MONTHS_CACHE : WEEKS_CACHE;

  // Indexed Set для O(1) lookup
  const filledPeriodsSet = useMemo(() => {
    if (!allRows) return new Set();
    const set = new Set();
    allRows.forEach(r => {
      if (!r.isTarget && r.date && r.id !== row.id && r.periodType === periodType) {
        if (periodType === 'monthly') {
          set.add(r.date);
        } else {
          const key = getWeekKey(r.date);
          if (key) set.add(key);
        }
      }
    });
    return set;
  }, [allRows, row.id, periodType]);
  const getPeriodStatus = periodKey => {
    return filledPeriodsSet.has(periodKey) ? 'filled' : 'empty';
  };
  const getCurrentPeriodKey = () => {
    if (!row.date) return '';
    return periodType === 'monthly' ? row.date : getWeekKey(row.date);
  };
  const calculateProgress = colId => {
    const col = columns.find(c => c.id === colId);
    const target = parseFloat(String(row.targets?.[colId] || '').replace(',', '.'));
    const value = parseFloat(String(row.values?.[colId] || '').replace(',', '.'));
    if (isNaN(value)) return null;

    // Для від'ємних показників (чим менше - тим краще)
    if (col?.inverted) {
      if (isNaN(target) || target === 0) {
        return value === 0 ? 100 : Math.round(-value * 25);
      }
      return Math.round((1 - value / target) * 100);
    }
    if (isNaN(target) || target === 0) return null;
    return Math.round(value / target * 100);
  };
  const getProgressColor = progress => {
    if (progress >= 100) return {
      bg: 'bg-green-500',
      text: 'text-green-600',
      light: 'bg-green-100'
    };
    if (progress >= 80) return {
      bg: 'bg-blue-500',
      text: 'text-blue-600',
      light: 'bg-blue-100'
    };
    if (progress >= 50) return {
      bg: 'bg-amber-500',
      text: 'text-amber-600',
      light: 'bg-amber-100'
    };
    return {
      bg: 'bg-red-500',
      text: 'text-red-600',
      light: 'bg-red-100'
    };
  };
  const displayCols = isExpanded ? columns : columns.slice(0, 3);
  const hasAnyTarget = columns.some(col => row.targets?.[col.id]);
  return /*#__PURE__*/React.createElement("div", {
    className: `stats-card ${isEven ? 'bg-gray-50/50' : ''}`,
    style: {
      borderLeft: periodType === 'monthly' ? '3px solid #3b82f6' : '3px solid #22c55e'
    }
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("select", {
    value: getCurrentPeriodKey(),
    onChange: e => onDateChange(e.target.value),
    disabled: !editable,
    className: "font-semibold text-sm text-gray-900 bg-white border border-gray-200 rounded px-2 py-1 focus:ring-1 focus:ring-primary-200 max-w-[150px]"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, periodType === 'monthly' ? 'Місяць' : 'Тиждень'), periods.filter(p => p.isFuture).length > 0 && /*#__PURE__*/React.createElement("optgroup", {
    label: "\u2192 \u041C\u0430\u0439\u0431\u0443\u0442\u043D\u0456"
  }, periods.filter(p => p.isFuture).map(period => /*#__PURE__*/React.createElement("option", {
    key: period.key,
    value: period.key
  }, period.label))), periods.filter(p => p.isCurrent).map(period => /*#__PURE__*/React.createElement("option", {
    key: period.key,
    value: period.key
  }, "\u25CF ", period.label)), /*#__PURE__*/React.createElement("optgroup", {
    label: "\u2190 \u041C\u0438\u043D\u0443\u043B\u0456"
  }, periods.filter(p => !p.isCurrent && !p.isFuture).map(period => /*#__PURE__*/React.createElement("option", {
    key: period.key,
    value: period.key
  }, period.label)))), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-400"
  }, columns.length, " \u043F\u043E\u043A\u0430\u0437.")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowTargets(!showTargets),
    className: `w-7 h-7 rounded flex items-center justify-center ${showTargets || hasAnyTarget ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-400'}`,
    title: "\u041F\u043B\u0430\u043D"
  }, /*#__PURE__*/React.createElement(Icons.Target, {
    className: "w-3.5 h-3.5"
  })), editable && /*#__PURE__*/React.createElement("button", {
    onClick: onDelete,
    className: "w-7 h-7 rounded bg-red-50 flex items-center justify-center"
  }, /*#__PURE__*/React.createElement(Icons.Trash, {
    className: "w-3.5 h-3.5 text-red-400"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "space-y-1"
  }, displayCols.map(col => {
    const progress = calculateProgress(col.id);
    const colors = progress !== null ? getProgressColor(progress) : null;
    const hasComment = row.comments?.[col.id];
    const hasTarget = row.targets?.[col.id];
    return /*#__PURE__*/React.createElement("div", {
      key: col.id,
      className: "flex items-center gap-2 py-1 border-b border-gray-100 last:border-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("span", {
      className: "text-xs text-gray-700 truncate block"
    }, col.name)), (showTargets || hasTarget) && /*#__PURE__*/React.createElement("input", {
      type: "text",
      inputMode: "decimal",
      value: row.targets?.[col.id] || '',
      onChange: e => onTargetChange(col.id, e.target.value),
      className: "w-16 px-1.5 py-0.5 bg-amber-50 border border-amber-200 rounded text-center text-xs font-medium text-amber-700",
      placeholder: "\u041F\u043B\u0430\u043D"
    }), /*#__PURE__*/React.createElement("div", {
      className: "relative"
    }, /*#__PURE__*/React.createElement("input", {
      type: "text",
      inputMode: "decimal",
      value: row.values?.[col.id] || '',
      onChange: e => onValueChange(col.id, e.target.value),
      className: `w-20 px-1.5 py-0.5 bg-white border rounded text-center text-xs font-semibold ${progress !== null ? progress >= 100 ? 'border-green-300 text-green-700' : progress >= 50 ? 'border-amber-300 text-amber-700' : 'border-red-300 text-red-700' : 'border-gray-200 text-gray-900'}`,
      placeholder: "0"
    }), col.format === 'percent' && /*#__PURE__*/React.createElement("span", {
      className: "absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]"
    }, "%"), col.format === 'uah' && /*#__PURE__*/React.createElement("span", {
      className: "absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 text-[10px]"
    }, "\u20B4")), progress !== null && /*#__PURE__*/React.createElement("span", {
      className: `text-[10px] font-bold w-8 text-right ${colors.text}`
    }, progress, "%"));
  })), columns.length > 3 && /*#__PURE__*/React.createElement("button", {
    onClick: () => setIsExpanded(!isExpanded),
    className: "w-full mt-2 py-1.5 text-xs font-medium text-primary-600 bg-primary-50 hover:bg-primary-100 rounded flex items-center justify-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.ChevronDown, {
    className: `w-3.5 h-3.5 transition-transform ${isExpanded ? 'rotate-180' : ''}`
  }), isExpanded ? 'Згорнути' : `+${columns.length - 3}`));
};

// #2: React.memo для уникнення зайвих ре-рендерів
const StatsCard = React.memo(StatsCardComponent);

// ==================== VIRTUALIZED ROWS ====================
// Легка віртуалізація для таблиць з 50+ рядків
const useVirtualization = (items, containerRef, rowHeight = 40, overscan = 5) => {
  const [scrollTop, setScrollTop] = useState(0);
  const [containerHeight, setContainerHeight] = useState(600);
  
  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;
    
    const handleScroll = () => {
      setScrollTop(container.scrollTop);
    };
    
    const handleResize = () => {
      setContainerHeight(container.clientHeight);
    };
    
    // Ініціалізація
    handleResize();
    
    container.addEventListener('scroll', handleScroll, { passive: true });
    window.addEventListener('resize', handleResize);
    
    return () => {
      container.removeEventListener('scroll', handleScroll);
      window.removeEventListener('resize', handleResize);
    };
  }, [containerRef]);
  
  const totalHeight = items.length * rowHeight;
  const startIndex = Math.max(0, Math.floor(scrollTop / rowHeight) - overscan);
  const endIndex = Math.min(
    items.length,
    Math.ceil((scrollTop + containerHeight) / rowHeight) + overscan
  );
  
  const visibleItems = items.slice(startIndex, endIndex);
  const offsetTop = startIndex * rowHeight;
  
  return {
    visibleItems,
    totalHeight,
    offsetTop,
    startIndex,
    endIndex,
    isVirtualized: items.length > 30 // Вмикаємо тільки для 30+ рядків
  };
};

// Мемоізований рядок таблиці
const VirtualTableRow = memo(({ 
  row, 
  columns, 
  periodType,
  periods,
  targetRow,
  editable,
  onDateChange,
  onValueChange,
  onDeleteRow,
  isDuplicate,
  getPeriodStatus,
  calculateProgress,
  formatValue,
  getWeekKey,
  editingTarget,
  setEditingTarget,
  onTargetSave
}) => {
  const currentPeriodKey = periodType === 'monthly' ? row.date : row.date ? getWeekKey(row.date) : null;
  const isRowDuplicate = isDuplicate(row.date);
  
  const getProgressClass = (p, isInverted) => {
    if (isInverted) {
      if (p >= 100) return 'bg-emerald-100 text-emerald-700';
      if (p >= 50) return 'bg-amber-100 text-amber-700';
      return 'bg-red-100 text-red-700';
    }
    if (p >= 100) return 'bg-emerald-100 text-emerald-700';
    if (p >= 80) return 'bg-blue-100 text-blue-700';
    if (p >= 50) return 'bg-amber-100 text-amber-700';
    return 'bg-red-100 text-red-700';
  };
  
  return React.createElement('tr', {
    className: isRowDuplicate ? 'bg-amber-50' : '',
    title: isRowDuplicate ? 'Дублікат періоду!' : ''
  },
    // Date cell
    React.createElement('td', { className: 'sticky-col' },
      isRowDuplicate && React.createElement('span', {
        className: 'text-amber-500 mr-1',
        title: 'Дублікат'
      }, '⚠'),
      React.createElement('select', {
        value: currentPeriodKey || '',
        onChange: e => onDateChange(row.id, e.target.value),
        className: `w-full px-1 py-0.5 text-xs border rounded focus:border-primary-400 cursor-pointer ${isRowDuplicate ? 'bg-amber-50 border-amber-300' : 'bg-white border-gray-200'}`
      },
        React.createElement('option', { value: '' }, '—'),
        // Future periods
        periods.filter(p => p.isFuture).length > 0 && React.createElement('optgroup', { label: '→ Майбутні' },
          periods.filter(p => p.isFuture).map(period => 
            React.createElement('option', { key: period.key, value: period.key }, period.label)
          )
        ),
        // Current period
        periods.filter(p => p.isCurrent).map(period => {
          const status = getPeriodStatus(period.key);
          const isCurrentRow = currentPeriodKey === period.key;
          return React.createElement('option', { key: period.key, value: period.key },
            '● ', period.label, ' (зараз) ', status === 'filled' && !isCurrentRow ? '✓' : ''
          );
        }),
        // Past periods
        React.createElement('optgroup', { label: '← Минулі (рік)' },
          periods.filter(p => !p.isCurrent && !p.isFuture).map(period => {
            const status = getPeriodStatus(period.key);
            const isCurrentRow = currentPeriodKey === period.key;
            return React.createElement('option', { key: period.key, value: period.key },
              period.label, ' ', status === 'filled' && !isCurrentRow ? '✓' : ''
            );
          })
        )
      )
    ),
    // Value cells
    ...columns.map(col => {
      const progress = calculateProgress(row, col.id, col);
      const value = row.values?.[col.id] || '';
      const hasComment = row.comments?.[col.id];
      const hasRowTarget = row.targets?.[col.id];
      
      return React.createElement('td', { key: col.id },
        React.createElement('div', { className: 'flex items-center gap-1 relative' },
          editable 
            ? React.createElement('input', {
                type: 'text',
                value: value,
                onChange: e => onValueChange(row.id, col.id, e.target.value),
                className: 'w-14 px-1 py-0.5 text-xs bg-transparent border border-transparent rounded focus:border-primary-400 focus:bg-white text-center',
                placeholder: '0'
              })
            : React.createElement('span', { className: 'text-xs' },
                formatValue(value, col.format, progress) || '-'
              ),
          progress !== null 
            ? React.createElement('div', {
                className: 'cursor-pointer hover:opacity-80',
                onClick: () => editable && setEditingTarget({ rowId: row.id, colId: col.id, value: row.targets?.[col.id] || '' }),
                title: `${progress}% від цілі. Клік для зміни`
              }, React.createElement(MiniProgressBar, { value: progress, inverted: col.inverted }))
            : editable && React.createElement('span', {
                className: 'text-[10px] px-1 py-0.5 rounded bg-gray-100 text-gray-400 cursor-pointer hover:bg-gray-200 flex items-center gap-0.5',
                onClick: () => setEditingTarget({ rowId: row.id, colId: col.id, value: '' }),
                title: 'Встановити ціль'
              }, React.createElement(Icons.Target, { className: 'w-3 h-3' })),
          hasRowTarget && !editingTarget && React.createElement('span', {
            className: 'w-1.5 h-1.5 bg-purple-500 rounded-full',
            title: `Ціль: ${hasRowTarget}`
          }),
          hasComment && React.createElement('span', {
            className: 'w-1.5 h-1.5 bg-blue-400 rounded-full',
            title: hasComment
          })
        )
      );
    }),
    // Delete button
    editable && React.createElement('td', null,
      React.createElement('button', {
        onClick: () => onDeleteRow(row.id),
        className: 'p-1 text-gray-400 hover:text-red-500'
      }, React.createElement(Icons.Trash, { className: 'w-3 h-3' }))
    )
  );
});

// ==================== STATS TABLE (DESKTOP) ====================
const ROWS_PER_PAGE = 50; // Кількість рядків на сторінці для великих таблиць

const StatsTable = ({
  columns,
  rows,
  targetRow,
  periodType = 'weekly',
  onDeleteRow,
  onDateChange,
  onValueChange,
  onTargetChange,
  onCommentChange,
  onEditColumn,
  onMoveColumn,
  onMoveRowUp,
  onMoveRowDown,
  editable,
  t,
  duplicateDates = []
}) => {
  const [draggedCol, setDraggedCol] = useState(null);
  const [dragOverCol, setDragOverCol] = useState(null);
  const [editingTarget, setEditingTarget] = useState(null); // {rowId, colId, value} - для редагування локальної цілі
  const [editingComment, setEditingComment] = useState(null); // {rowId, colId} - для редагування коментаря
  const [currentPage, setCurrentPage] = useState(0); // Пагінація для великих таблиць
  const [showAllRows, setShowAllRows] = useState(false); // Показати всі рядки

  // Фільтруємо рядки по періоду (без target)
  const filteredRows = useMemo(() => 
    rows.filter(r => !r.isTarget && r.periodType === periodType),
    [rows, periodType]
  );
  
  // Визначаємо чи потрібна пагінація
  const needsPagination = filteredRows.length > ROWS_PER_PAGE && !showAllRows;
  const totalPages = Math.ceil(filteredRows.length / ROWS_PER_PAGE);
  
  // Рядки для відображення
  const displayRows = useMemo(() => {
    if (!needsPagination) return filteredRows;
    const start = currentPage * ROWS_PER_PAGE;
    return filteredRows.slice(start, start + ROWS_PER_PAGE);
  }, [filteredRows, currentPage, needsPagination]);
  
  // Скидаємо сторінку при зміні типу періоду
  useEffect(() => {
    setCurrentPage(0);
  }, [periodType]);

  // Перевірка чи дата є дублікатом
  const isDuplicate = date => duplicateDates.includes(date);

  // Використовуємо відповідний кеш залежно від типу періоду
  const periods = periodType === 'monthly' ? MONTHS_CACHE : WEEKS_CACHE;

  // Indexed Set для O(1) lookup
  const filledPeriodsSet = useMemo(() => {
    const set = new Set();
    rows.forEach(r => {
      if (!r.isTarget && r.date) {
        if (periodType === 'monthly') {
          set.add(r.date); // Для місяців date вже є ключем
        } else {
          const key = getWeekKey(r.date);
          if (key) set.add(key);
        }
      }
    });
    return set;
  }, [rows, periodType]);

  // Розрахунок прогресу з підтримкою:
  // 1. Індивідуальних цілей на період (row.targets)
  // 2. Глобальних цілей (targetRow.values)
  // 3. Від'ємних показників (inverted)
  const calculateProgress = (row, colId, col) => {
    if (!row.values) return null;

    // Ціль: спочатку з row.targets, потім з targetRow.values
    const rowTarget = row.targets?.[colId];
    const globalTarget = targetRow?.values?.[colId];
    const target = parseFloat(String(rowTarget || globalTarget || '').replace(',', '.'));
    const value = parseFloat(String(row.values[colId] || '').replace(',', '.'));
    if (isNaN(value)) return null;

    // Для від'ємних показників (чим менше - тим краще)
    // Приклад: скасовані консультації, скарги, брак
    // Ціль = максимально допустиме значення
    // value <= 0 → 100% (ідеально)
    // value < target → пропорційно (добре)  
    // value >= target → 0% або менше (погано)
    if (col?.inverted) {
      // Якщо value = 0 або менше - ідеальний результат
      if (value <= 0) return 100;
      
      // Якщо немає цілі - показуємо скільки "поганого" є
      if (isNaN(target) || target === 0) {
        // Без цілі: кожна одиниця "поганого" = -10% від 100
        return Math.max(0, Math.round(100 - value * 10));
      }
      
      // Ціль може бути від'ємною (наприклад -5 означає "максимум 5 скасувань")
      const absTarget = Math.abs(target);
      
      // Формула: чим менше value відносно target - тим краще
      // value = 0 → 100%
      // value = absTarget → 0%
      // value > absTarget → 0% (не показуємо від'ємні)
      const progress = Math.round((1 - value / absTarget) * 100);
      return Math.max(0, Math.min(100, progress));
    }

    // Звичайний показник
    if (isNaN(target) || target === 0) return null;
    return Math.round(value / target * 100);
  };

  // Генерація кольору по імені відповідального (консистентний хеш)
  const getResponsibleColor = (name) => {
    if (!name) return null;
    const colors = [
      { bg: 'bg-blue-100', text: 'text-blue-700', dot: 'bg-blue-500' },
      { bg: 'bg-purple-100', text: 'text-purple-700', dot: 'bg-purple-500' },
      { bg: 'bg-pink-100', text: 'text-pink-700', dot: 'bg-pink-500' },
      { bg: 'bg-indigo-100', text: 'text-indigo-700', dot: 'bg-indigo-500' },
      { bg: 'bg-teal-100', text: 'text-teal-700', dot: 'bg-teal-500' },
      { bg: 'bg-orange-100', text: 'text-orange-700', dot: 'bg-orange-500' },
      { bg: 'bg-cyan-100', text: 'text-cyan-700', dot: 'bg-cyan-500' },
      { bg: 'bg-rose-100', text: 'text-rose-700', dot: 'bg-rose-500' },
    ];
    // Простий хеш від імені
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = ((hash << 5) - hash) + name.charCodeAt(i);
      hash = hash & hash;
    }
    return colors[Math.abs(hash) % colors.length];
  };

  // Отримання цілі для показу (row.targets або targetRow)
  const getTarget = (row, colId) => {
    return row.targets?.[colId] || targetRow?.values?.[colId] || '';
  };
  const getPeriodStatus = periodKey => {
    return filledPeriodsSet.has(periodKey) ? 'filled' : 'empty';
  };
  const getPeriodLabel = date => {
    if (!date) return periodType === 'monthly' ? 'Оберіть місяць' : 'Оберіть тиждень';
    return periodType === 'monthly' ? formatMonthLabel(date) : formatWeekLabel(date);
  };

  // Форматування значення з кольором
  const formatValue = (value, format, progress) => {
    if (!value && value !== 0) return null;
    const numValue = parseFloat(String(value).replace(',', '.').replace(/\s/g, ''));
    if (isNaN(numValue)) return value;

    // Форматування числа з роздільниками
    const formatted = new Intl.NumberFormat('uk-UA').format(numValue);

    // Колір на основі прогресу або типу
    let colorClass = 'text-gray-900';
    if (progress !== null) {
      if (progress >= 100) colorClass = 'text-emerald-600 font-semibold';else if (progress >= 80) colorClass = 'text-emerald-500';else if (progress >= 50) colorClass = 'text-amber-600';else colorClass = 'text-red-500';
    } else if (format === 'uah' || format === 'usd' || format === 'eur') {
      colorClass = 'text-emerald-600 font-semibold';
    }

    // Символ валюти/формату
    let prefix = '';
    let suffix = '';
    if (format === 'uah') prefix = '₴';
    if (format === 'usd') prefix = '$';
    if (format === 'eur') prefix = '€';
    if (format === 'percent') suffix = '%';
    return /*#__PURE__*/React.createElement("span", {
      className: colorClass
    }, prefix, formatted, suffix);
  };
  const getProgressBadge = progress => {
    if (progress === null) return null;
    let colorClass = 'badge-red';
    if (progress >= 100) colorClass = 'badge-green';else if (progress >= 80) colorClass = 'badge-blue';else if (progress >= 50) colorClass = 'badge-amber';
    return /*#__PURE__*/React.createElement("span", {
      className: `badge ${colorClass} ml-2`
    }, progress, "%");
  };
  const getColumnStatus = col => {
    const isFilled = isFilledForPeriod(rows, col.id, col.period);
    if (col.period === 'custom') return null;
    return isFilled ? 'filled' : 'pending';
  };
  
  // Handlers для drag колонок
  const handleDragStart = (e, colId) => {
    setDraggedCol(colId);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', colId);
  };
  const handleDragOver = (e, colId) => {
    e.preventDefault();
    if (draggedCol && draggedCol !== colId) {
      setDragOverCol(colId);
    }
  };
  const handleDragLeave = () => {
    setDragOverCol(null);
  };
  const handleDrop = (e, targetColId) => {
    e.preventDefault();
    if (draggedCol && draggedCol !== targetColId && onMoveColumn) {
      onMoveColumn(draggedCol, targetColId);
    }
    setDraggedCol(null);
    setDragOverCol(null);
  };
  const handleDragEnd = () => {
    setDraggedCol(null);
    setDragOverCol(null);
  };
  
  return /*#__PURE__*/React.createElement("div", {
    className: "card overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto"
  }, /*#__PURE__*/React.createElement("table", {
    className: "stats-table"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "sticky-col",
    style: {
      minWidth: 75,
      verticalAlign: 'middle'
    }
  }, periodType === 'monthly' ? 'Місяць' : 'Тиждень'), columns.map((col, idx) => {
    const status = getColumnStatus(col);
    const isDragging = draggedCol === col.id;
    const isDragOver = dragOverCol === col.id;
    return /*#__PURE__*/React.createElement("th", {
      key: col.id,
      style: {
        minWidth: 50,
        maxWidth: 70
      },
      draggable: editable,
      onDragStart: e => handleDragStart(e, col.id),
      onDragOver: e => handleDragOver(e, col.id),
      onDragLeave: handleDragLeave,
      onDrop: e => handleDrop(e, col.id),
      onDragEnd: handleDragEnd,
      className: `wrap-header ${editable ? 'cursor-grab active:cursor-grabbing' : ''} ${isDragging ? 'opacity-50' : ''} ${isDragOver ? 'drag-over' : ''}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "header-content"
    }, status && /*#__PURE__*/React.createElement("span", {
      className: `status-dot ${status === 'filled' ? 'status-filled' : 'status-pending'}`
    }), /*#__PURE__*/React.createElement("span", {
      className: "header-name"
    }, col.inverted && /*#__PURE__*/React.createElement("span", {
      className: "text-red-500",
      title: "\u0412\u0456\u0434'\u0454\u043C\u043D\u0438\u0439 (\u0447\u0438\u043C \u043C\u0435\u043D\u0448\u0435 \u2014 \u0442\u0438\u043C \u043A\u0440\u0430\u0449\u0435)"
    }, "\u2193"), col.name, col.format && col.format !== 'number' && /*#__PURE__*/React.createElement("span", {
      className: "text-gray-400"
    }, " ", col.format === 'percent' ? '%' : col.format === 'uah' ? '₴' : col.format === 'usd' ? '$' : '€')), col.responsible && /*#__PURE__*/React.createElement("span", {
      className: `header-responsible flex items-center gap-1 ${getResponsibleColor(col.responsible)?.text || ''}`
    }, /*#__PURE__*/React.createElement("span", {
      className: `w-2 h-2 rounded-full ${getResponsibleColor(col.responsible)?.dot || 'bg-gray-400'}`
    }), col.responsible)), editable && /*#__PURE__*/React.createElement("button", {
      onClick: () => onEditColumn(col),
      className: "header-edit-btn"
    }, /*#__PURE__*/React.createElement(Icons.Settings, {
      className: "w-3 h-3"
    })));
  }), editable && /*#__PURE__*/React.createElement("th", {
    style: {
      width: 30
    }
  }))), /*#__PURE__*/React.createElement("tbody", null, targetRow && /*#__PURE__*/React.createElement("tr", {
    className: "target-row"
  }, /*#__PURE__*/React.createElement("td", {
    className: "sticky-col text-amber-700"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1 text-xs font-bold"
  }, /*#__PURE__*/React.createElement(Icons.Target, {
    className: "w-3 h-3"
  }), "\u0426\u0456\u043B\u044C")), columns.map(col => /*#__PURE__*/React.createElement("td", {
    key: col.id
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: targetRow.values?.[col.id] || '',
    onChange: e => onValueChange(targetRow.id, col.id, e.target.value),
    disabled: !editable,
    className: "w-14 px-1 py-0.5 text-xs font-bold bg-transparent border border-transparent rounded focus:border-amber-400 focus:bg-white text-center",
    placeholder: "\u2014"
  }))), editable && /*#__PURE__*/React.createElement("td", null)), displayRows.map((row, rowIndex) => {
    const currentPeriodKey = periodType === 'monthly' ? row.date : row.date ? getWeekKey(row.date) : null;
    const isRowDuplicate = isDuplicate(row.date);
    const isFirst = rowIndex === 0;
    const isLast = rowIndex === displayRows.length - 1;
    return /*#__PURE__*/React.createElement("tr", {
      key: row.id,
      className: isRowDuplicate ? 'bg-amber-50' : '',
      title: isRowDuplicate ? 'Дублікат періоду!' : ''
    }, /*#__PURE__*/React.createElement("td", {
      className: "sticky-col"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1"
    }, editable && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => onMoveRowUp?.(row.id, periodType),
      disabled: isFirst,
      className: `p-0.5 rounded ${isFirst ? 'text-gray-200' : 'text-gray-400 hover:text-primary-500 hover:bg-primary-50'}`,
      title: "Вгору"
    }, /*#__PURE__*/React.createElement(Icons.ChevronUp, { className: "w-3 h-3" })), /*#__PURE__*/React.createElement("button", {
      onClick: () => onMoveRowDown?.(row.id, periodType),
      disabled: isLast,
      className: `p-0.5 rounded ${isLast ? 'text-gray-200' : 'text-gray-400 hover:text-primary-500 hover:bg-primary-50'}`,
      title: "Вниз"
    }, /*#__PURE__*/React.createElement(Icons.ChevronDown, { className: "w-3 h-3" }))), isRowDuplicate && /*#__PURE__*/React.createElement("span", {
      className: "text-amber-500",
      title: "\u0414\u0443\u0431\u043B\u0456\u043A\u0430\u0442"
    }, "\u26A0"), /*#__PURE__*/React.createElement("select", {
      value: currentPeriodKey || '',
      onChange: e => onDateChange(row.id, e.target.value),
      className: `flex-1 px-1 py-0.5 text-xs border rounded focus:border-primary-400 cursor-pointer ${isRowDuplicate ? 'bg-amber-50 border-amber-300' : 'bg-white border-gray-200'}`
    }, /*#__PURE__*/React.createElement("option", {
      value: ""
    }, "\u2014"), periods.filter(p => p.isFuture).length > 0 && /*#__PURE__*/React.createElement("optgroup", {
      label: "\u2192 \u041C\u0430\u0439\u0431\u0443\u0442\u043D\u0456"
    }, periods.filter(p => p.isFuture).map(period => /*#__PURE__*/React.createElement("option", {
      key: period.key,
      value: period.key
    }, period.label))), periods.filter(p => p.isCurrent).map(period => {
      const status = getPeriodStatus(period.key);
      const isCurrentRow = currentPeriodKey === period.key;
      return /*#__PURE__*/React.createElement("option", {
        key: period.key,
        value: period.key
      }, "\u25CF ", period.label, " (\u0437\u0430\u0440\u0430\u0437) ", status === 'filled' && !isCurrentRow ? '✓' : '');
    }), /*#__PURE__*/React.createElement("optgroup", {
      label: "\u2190 \u041C\u0438\u043D\u0443\u043B\u0456 (\u0440\u0456\u043A)"
    }, periods.filter(p => !p.isCurrent && !p.isFuture).map(period => {
      const status = getPeriodStatus(period.key);
      const isCurrentRow = currentPeriodKey === period.key;
      return /*#__PURE__*/React.createElement("option", {
        key: period.key,
        value: period.key
      }, period.label, " ", status === 'filled' && !isCurrentRow ? '✓' : '');
    }))))), columns.map(col => {
      const progress = calculateProgress(row, col.id, col);
      const value = row.values?.[col.id] || '';
      const hasComment = row.comments?.[col.id];
      const hasRowTarget = row.targets?.[col.id];

      // Кольори з урахуванням inverted
      const getProgressClass = (p, isInverted) => {
        if (isInverted) {
          // Для від'ємних: 100+ = добре, 0-99 = погано
          if (p >= 100) return 'bg-emerald-100 text-emerald-700';
          if (p >= 50) return 'bg-amber-100 text-amber-700';
          return 'bg-red-100 text-red-700';
        }
        // Звичайні показники
        if (p >= 100) return 'bg-emerald-100 text-emerald-700';
        if (p >= 80) return 'bg-blue-100 text-blue-700';
        if (p >= 50) return 'bg-amber-100 text-amber-700';
        return 'bg-red-100 text-red-700';
      };
      // Генеруємо tooltip з детальною інформацією
      const getTooltip = () => {
        const parts = [];
        parts.push(`${col.name}: ${value || '—'}`);
        if (col.responsible) parts.push(`Відповідальний: ${col.responsible}`);
        if (hasRowTarget) parts.push(`Ціль періоду: ${hasRowTarget}`);
        else if (targetRow?.values?.[col.id]) parts.push(`Глобальна ціль: ${targetRow.values[col.id]}`);
        if (progress !== null) parts.push(`Виконання: ${progress}%`);
        if (hasComment) parts.push(`Коментар: ${hasComment}`);
        return parts.join('\n');
      };
      
      return /*#__PURE__*/React.createElement("td", {
        key: col.id,
        title: getTooltip()
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-1 relative group"
      }, editable ? /*#__PURE__*/React.createElement("input", {
        type: "text",
        value: value,
        onChange: e => onValueChange(row.id, col.id, e.target.value),
        className: "w-14 px-1 py-0.5 text-xs bg-transparent border border-transparent rounded focus:border-primary-400 focus:bg-white text-center",
        placeholder: "0"
      }) : /*#__PURE__*/React.createElement("span", {
        className: "text-xs"
      }, formatValue(value, col.format, progress) || '-'), editingTarget?.rowId === row.id && editingTarget?.colId === col.id && /*#__PURE__*/React.createElement("div", {
        className: "absolute left-0 top-full mt-1 z-50 bg-white rounded-lg shadow-xl border p-2 min-w-[120px]"
      }, /*#__PURE__*/React.createElement("div", {
        className: "text-[10px] text-gray-500 mb-1"
      }, "\u0426\u0456\u043B\u044C \u0434\u043B\u044F \u0446\u044C\u043E\u0433\u043E \u043F\u0435\u0440\u0456\u043E\u0434\u0443:"), /*#__PURE__*/React.createElement("input", {
        type: "text",
        autoFocus: true,
        value: editingTarget.value,
        onChange: e => setEditingTarget({
          ...editingTarget,
          value: e.target.value
        }),
        onBlur: () => {
          if (editingTarget.value !== (row.targets?.[col.id] || '')) {
            onTargetChange?.(row.id, col.id, editingTarget.value);
          }
          setEditingTarget(null);
        },
        onKeyDown: e => {
          if (e.key === 'Enter') {
            if (editingTarget.value !== (row.targets?.[col.id] || '')) {
              onTargetChange?.(row.id, col.id, editingTarget.value);
            }
            setEditingTarget(null);
          }
          if (e.key === 'Escape') setEditingTarget(null);
        },
        className: "w-full px-2 py-1 text-xs border rounded focus:border-primary-400",
        placeholder: targetRow?.values?.[col.id] || '0'
      }), /*#__PURE__*/React.createElement("div", {
        className: "text-[9px] text-gray-400 mt-1"
      }, "\u0413\u043B\u043E\u0431\u0430\u043B\u044C\u043D\u0430: ", targetRow?.values?.[col.id] || '—')), progress !== null ? /*#__PURE__*/React.createElement("div", {
        className: "cursor-pointer hover:opacity-80",
        onClick: () => editable && setEditingTarget({
          rowId: row.id,
          colId: col.id,
          value: row.targets?.[col.id] || ''
        }),
        title: `${progress}% від цілі. Клік для зміни`
      }, /*#__PURE__*/React.createElement(MiniProgressBar, { value: progress, inverted: col.inverted })) : editable && /*#__PURE__*/React.createElement("span", {
        className: "text-[10px] px-1 py-0.5 rounded bg-gray-100 text-gray-400 cursor-pointer hover:bg-gray-200 flex items-center gap-0.5",
        onClick: () => setEditingTarget({
          rowId: row.id,
          colId: col.id,
          value: row.targets?.[col.id] || ''
        }),
        title: "\u041A\u043B\u0456\u043A \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043D\u044F \u0446\u0456\u043B\u0456"
      }, /*#__PURE__*/React.createElement(Icons.Target, { className: "w-3 h-3" })), hasRowTarget && !editingTarget && /*#__PURE__*/React.createElement("span", {
        className: "w-1.5 h-1.5 bg-purple-500 rounded-full",
        title: `Ціль періоду: ${hasRowTarget}`
      }), hasComment ? /*#__PURE__*/React.createElement("button", {
        onClick: () => editable && setEditingComment({ rowId: row.id, colId: col.id }),
        className: "w-4 h-4 bg-blue-100 hover:bg-blue-200 rounded-full flex items-center justify-center cursor-pointer transition-colors",
        title: hasComment
      }, /*#__PURE__*/React.createElement(Icons.MessageSquare, { className: "w-2.5 h-2.5 text-blue-600" })) : editable && /*#__PURE__*/React.createElement("button", {
        onClick: () => setEditingComment({ rowId: row.id, colId: col.id }),
        className: "w-4 h-4 opacity-0 group-hover:opacity-100 hover:bg-gray-100 rounded-full flex items-center justify-center transition-all",
        title: "Додати коментар"
      }, /*#__PURE__*/React.createElement(Icons.MessageSquare, { className: "w-2.5 h-2.5 text-gray-400" })), editingComment?.rowId === row.id && editingComment?.colId === col.id && /*#__PURE__*/React.createElement(CellComment, {
        rowId: row.id,
        colId: col.id,
        comment: hasComment,
        onSave: onCommentChange,
        onClose: () => setEditingComment(null)
      })));
    }), editable && /*#__PURE__*/React.createElement("td", null, /*#__PURE__*/React.createElement("button", {
      onClick: () => onDeleteRow(row.id),
      className: "p-1 text-gray-400 hover:text-red-500"
    }, /*#__PURE__*/React.createElement(Icons.Trash, {
      className: "w-3 h-3"
    }))));
  })))), needsPagination && /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between p-3 bg-gray-50 border-t"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "Показано ", displayRows.length, " з ", filteredRows.length, " записів"), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setCurrentPage(p => Math.max(0, p - 1)),
    disabled: currentPage === 0,
    className: "btn btn-sm btn-ghost"
  }, /*#__PURE__*/React.createElement(Icons.ChevronLeft, { className: "w-4 h-4" })), /*#__PURE__*/React.createElement("span", {
    className: "text-xs font-medium"
  }, currentPage + 1, " / ", totalPages), /*#__PURE__*/React.createElement("button", {
    onClick: () => setCurrentPage(p => Math.min(totalPages - 1, p + 1)),
    disabled: currentPage >= totalPages - 1,
    className: "btn btn-sm btn-ghost"
  }, /*#__PURE__*/React.createElement(Icons.ChevronRight, { className: "w-4 h-4" })), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAllRows(true),
    className: "btn btn-sm btn-secondary text-xs"
  }, "Показати всі"))), filteredRows.length > ROWS_PER_PAGE && showAllRows && /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-center p-2 bg-amber-50 border-t"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-amber-700 mr-2"
  }, "Показано всі ", filteredRows.length, " записів"), /*#__PURE__*/React.createElement("button", {
    onClick: () => { setShowAllRows(false); setCurrentPage(0); },
    className: "text-xs text-amber-600 underline hover:text-amber-800"
  }, "Увімкнути пагінацію")));
};

// Мемоізована версія StatsTable
const MemoizedStatsTable = memo(StatsTable);

// ==================== AI ANALYSIS (INTERACTIVE CHAT) ====================
const AIAnalysis = ({
  columns,
  rows,
  targetRow,
  aiSettings,
  language,
  onSaveAnalysis,
  savedAnalyses,
  onUpdateAiSettings,
  t
}) => {
  const toast = useToast();
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [aiStage, setAiStage] = useState(0); // Етап AI аналізу для прогрес-бару
  const [period, setPeriod] = useState(5);
  const [additionalFocus, setAdditionalFocus] = useState('');
  const [showHistory, setShowHistory] = useState(false);

  // AI stages для прогрес-індикатора
  const AI_STAGES = [
    { label: 'Збір даних', icon: '📊' },
    { label: 'Аналіз трендів', icon: '📈' },
    { label: 'Пошук вузьких місць', icon: '🔍' },
    { label: 'Генерація рекомендацій', icon: '💡' }
  ];

  // Chat state
  const [step, setStep] = useState(0); // 0=start, 1=bottleneck, 2=solutions, 3=plan, 4=orders
  const [messages, setMessages] = useState([]);
  const [analysisData, setAnalysisData] = useState(null);
  const [selectedSolution, setSelectedSolution] = useState(null);
  const [customSolution, setCustomSolution] = useState('');
  const [showCustomInput, setShowCustomInput] = useState(false);
  const [orders, setOrders] = useState([]); // Розпорядження
  const [currentPlan, setCurrentPlan] = useState(''); // Зберігаємо план для генерації розпоряджень
  const chatEndRef = React.useRef(null);

  // Scroll to bottom on new messages
  React.useEffect(() => {
    chatEndRef.current?.scrollIntoView({
      behavior: 'smooth'
    });
  }, [messages]);
  const WORKER_URL = 'https://openai-proxy.management-talco.workers.dev/';
  const getColumnsInfo = () => {
    const periodLabels = {
      'daily': 'щоденно',
      'weekly': 'щотижня',
      'monthly': 'щомісяця',
      'custom': 'довільно'
    };
    const formatLabels = {
      'number': 'число',
      'percent': 'відсотки (%)',
      'uah': 'гривні (₴)',
      'usd': 'долари ($)',
      'eur': 'євро (€)'
    };
    const importanceLabels = {
      'critical': 'КРИТИЧНИЙ (впливає на гроші)',
      'high': 'Високий',
      'medium': 'Середній',
      'low': 'Низький (допоміжний)'
    };
    return columns.map(col => ({
      name: col.name,
      period: periodLabels[col.period] || col.period,
      periodType: col.period === 'monthly' ? 'monthly' : 'weekly',
      responsible: col.responsible || 'не вказано',
      format: formatLabels[col.format] || 'число',
      formatType: col.format || 'number',
      importance: col.importance || 'medium',
      importanceLabel: importanceLabels[col.importance] || 'Середній'
    }));
  };
  const formatValueForAI = (value, format) => {
    if (!value || value === '-') return '-';
    const num = parseFloat(String(value).replace(',', '.').replace(/\s/g, ''));
    if (isNaN(num)) return value;
    const formatted = new Intl.NumberFormat('uk-UA').format(num);
    switch (format) {
      case 'percent':
        return `${formatted}%`;
      case 'uah':
        return `${formatted} ₴`;
      case 'usd':
        return `$${formatted}`;
      case 'eur':
        return `€${formatted}`;
      default:
        return formatted;
    }
  };
  const formatDateForAI = (date, periodType) => {
    if (!date) return '-';
    if (periodType === 'monthly') {
      return formatMonthLabel(date); // "Грудень 2024"
    } else {
      return formatWeekLabel(date); // "09-15.12.24"
    }
  };
  const getTableData = () => {
    const weeksAgo = new Date();
    weeksAgo.setDate(weeksAgo.getDate() - period * 7);

    // Розділяємо колонки по періоду
    const weeklyColumns = columns.filter(c => c.period !== 'monthly');
    const monthlyColumns = columns.filter(c => c.period === 'monthly');

    // Фільтруємо і сортуємо тижневі рядки
    const weeklyRows = rows.filter(r => !r.isTarget && r.periodType !== 'monthly' && r.date).filter(r => {
      const rowDate = new Date(r.date);
      return !isNaN(rowDate.getTime()) && rowDate >= weeksAgo;
    }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Новіші зверху

    // Фільтруємо і сортуємо місячні рядки (за останні N місяців)
    const monthsAgo = Math.ceil(period / 4); // Приблизно
    const monthlyRows = rows.filter(r => !r.isTarget && r.periodType === 'monthly' && r.date).sort((a, b) => b.date.localeCompare(a.date)) // "2024-12" > "2024-11"
    .slice(0, monthsAgo + 2); // Беремо кілька останніх місяців

    // Форматуємо тижневі дані
    const weeklyData = weeklyRows.map(row => {
      const rowData = {
        'Період': formatDateForAI(row.date, 'weekly')
      };
      weeklyColumns.forEach(col => {
        const fact = row.values?.[col.id];
        const plan = row.targets?.[col.id] || targetRow?.values?.[col.id];
        const factFormatted = formatValueForAI(fact, col.format);
        const planFormatted = formatValueForAI(plan, col.format);
        let diff = '-';
        if (parseFloat(fact) && parseFloat(plan)) {
          diff = Math.round(parseFloat(fact) / parseFloat(plan) * 100) + '%';
        }
        rowData[col.name] = `${factFormatted} (план: ${planFormatted}, виконання: ${diff})`;
      });
      return rowData;
    });

    // Форматуємо місячні дані
    const monthlyData = monthlyRows.map(row => {
      const rowData = {
        'Період': formatDateForAI(row.date, 'monthly')
      };
      monthlyColumns.forEach(col => {
        const fact = row.values?.[col.id];
        const plan = row.targets?.[col.id] || targetRow?.values?.[col.id];
        const factFormatted = formatValueForAI(fact, col.format);
        const planFormatted = formatValueForAI(plan, col.format);
        let diff = '-';
        if (parseFloat(fact) && parseFloat(plan)) {
          diff = Math.round(parseFloat(fact) / parseFloat(plan) * 100) + '%';
        }
        rowData[col.name] = `${factFormatted} (план: ${planFormatted}, виконання: ${diff})`;
      });
      return rowData;
    });
    return {
      weekly: {
        columns: weeklyColumns,
        data: weeklyData,
        rows: weeklyRows
      },
      monthly: {
        columns: monthlyColumns,
        data: monthlyData,
        rows: monthlyRows
      }
    };
  };

  // === НОВЕ: Аналіз трендів та червоних прапорців ===
  const analyzeMetrics = tableData => {
    const results = {
      weekly: [],
      monthly: [],
      redFlags: [],
      periodComparison: []
    };
    const parseNum = val => {
      if (!val) return null;
      const num = parseFloat(String(val).replace(',', '.').replace(/\s/g, ''));
      return isNaN(num) ? null : num;
    };

    // Аналіз тижневих показників
    tableData.weekly.columns.forEach(col => {
      const values = tableData.weekly.rows.map(r => ({
        date: r.date,
        dateLabel: formatDateForAI(r.date, 'weekly'),
        fact: parseNum(r.values?.[col.id]),
        plan: parseNum(r.targets?.[col.id]) || parseNum(targetRow?.values?.[col.id])
      })).filter(v => v.fact !== null);
      if (values.length < 2) return;

      // Розрахунки
      const facts = values.map(v => v.fact);
      const latest = facts[0];
      const previous = facts[1];
      const oldest = facts[facts.length - 1];
      const avg = facts.reduce((a, b) => a + b, 0) / facts.length;
      const min = Math.min(...facts);
      const max = Math.max(...facts);

      // Тренд (останній vs попередній) - захист від ділення на 0
      const weekChange = previous && previous !== 0 ? Math.round((latest - previous) / previous * 100) : 0;

      // Тренд за весь період - захист від ділення на 0
      const periodChange = oldest && oldest !== 0 ? Math.round((latest - oldest) / oldest * 100) : 0;

      // Напрямок тренду (падає 3+ рази поспіль?)
      let consecutiveDrops = 0;
      for (let i = 0; i < facts.length - 1; i++) {
        if (facts[i] < facts[i + 1]) consecutiveDrops++;else break;
      }

      // Виконання плану - захист від ділення на 0
      const planExecutions = values.filter(v => v.plan && v.plan !== 0).map(v => Math.round(v.fact / v.plan * 100));
      const avgPlanExecution = planExecutions.length ? Math.round(planExecutions.reduce((a, b) => a + b, 0) / planExecutions.length) : null;
      const latestPlanExecution = values[0]?.plan && values[0].plan !== 0 ? Math.round(values[0].fact / values[0].plan * 100) : null;
      const isInverted = col.inverted || false;

      // Визначення напрямку (з урахуванням inverted)
      let direction = 'стабільно';
      if (isInverted) {
        // Для inverted: зростання = погано, падіння = добре
        if (periodChange > 10) direction = 'зростає ⚠️';else if (periodChange < -10) direction = 'падає ✓';
      } else {
        if (periodChange > 10) direction = 'зростає';else if (periodChange < -10) direction = 'падає';
      }
      const metric = {
        name: col.name,
        responsible: col.responsible || 'не вказано',
        format: col.format,
        importance: col.importance || 'medium',
        inverted: isInverted,
        // Від'ємний показник (чим менше - тим краще)
        latest: {
          value: latest,
          date: values[0]?.dateLabel
        },
        previous: {
          value: previous,
          date: values[1]?.dateLabel
        },
        weekChange: weekChange,
        periodChange: periodChange,
        direction: direction,
        avg: Math.round(avg * 10) / 10,
        min: {
          value: min,
          date: values.find(v => v.fact === min)?.dateLabel
        },
        max: {
          value: max,
          date: values.find(v => v.fact === max)?.dateLabel
        },
        avgPlanExecution: avgPlanExecution,
        latestPlanExecution: latestPlanExecution,
        consecutiveDrops: consecutiveDrops
      };
      results.weekly.push(metric);

      // === ЧЕРВОНІ ПРАПОРЦІ (з урахуванням importance та inverted) ===
      const importanceMultiplier = {
        critical: 4,
        high: 3,
        medium: 2,
        low: 1
      };
      const colImportance = col.importance || 'medium';

      // 1. Падає/зростає 3+ періоди поспіль
      // Для inverted: зростання = погано, падіння = добре
      // Для звичайних: зростання = добре, падіння = погано
      let consecutiveRises = 0;
      for (let i = 0; i < facts.length - 1; i++) {
        if (facts[i] > facts[i + 1]) consecutiveRises++;else break;
      }
      if (isInverted) {
        // Для inverted: зростання поспіль = проблема
        if (consecutiveRises >= 3) {
          results.redFlags.push({
            type: 'consecutive_rise_inverted',
            severity: 'high',
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * 3,
            metric: col.name,
            message: `↓${col.name}: зростає ${consecutiveRises} тижні поспіль (це погано!)`,
            details: `${formatValueForAI(oldest, col.format)} → ${formatValueForAI(latest, col.format)}`
          });
        }
      } else {
        // Для звичайних: падіння поспіль = проблема
        if (consecutiveDrops >= 3) {
          results.redFlags.push({
            type: 'consecutive_drop',
            severity: 'high',
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * 3,
            metric: col.name,
            message: `${col.name}: падає ${consecutiveDrops} тижні поспіль`,
            details: `${formatValueForAI(oldest, col.format)} → ${formatValueForAI(latest, col.format)} (${periodChange > 0 ? '+' : ''}${periodChange}%)`
          });
        }
      }

      // 2. Виконання плану
      // Для inverted: план = максимально допустиме, виконання = (1 - value/plan) * 100
      if (latestPlanExecution !== null) {
        if (isInverted) {
          const invertedExecution = values[0]?.plan ? Math.round((1 - latest / values[0].plan) * 100) : null;
          if (invertedExecution !== null && invertedExecution < 0) {
            // Перевищили допустимий ліміт
            results.redFlags.push({
              type: 'over_limit_inverted',
              severity: 'critical',
              importance: colImportance,
              importanceScore: importanceMultiplier[colImportance] * 4,
              metric: col.name,
              message: `↓${col.name}: перевищено ліміт! ${latest} при максимумі ${values[0]?.plan}`,
              details: `Перевищення: ${Math.abs(invertedExecution)}%`
            });
          }
        } else if (latestPlanExecution < 70) {
          const sev = latestPlanExecution < 50 ? 'critical' : 'high';
          results.redFlags.push({
            type: 'low_execution',
            severity: sev,
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * (sev === 'critical' ? 4 : 3),
            metric: col.name,
            message: `${col.name}: виконання плану лише ${latestPlanExecution}%`,
            details: `Факт: ${formatValueForAI(latest, col.format)}, План: ${formatValueForAI(values[0]?.plan, col.format)}`
          });
        }
      }

      // 3. Різка зміна за тиждень
      // Для inverted: різке зростання = погано
      // Для звичайних: різке падіння = погано
      if (isInverted) {
        if (weekChange > 30) {
          // Зросло більше 30%
          results.redFlags.push({
            type: 'sharp_rise_inverted',
            severity: 'critical',
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * 4,
            metric: col.name,
            message: `↓${col.name}: різке зростання +${weekChange}% за тиждень (це погано!)`,
            details: `${values[1]?.dateLabel}: ${formatValueForAI(previous, col.format)} → ${values[0]?.dateLabel}: ${formatValueForAI(latest, col.format)}`
          });
        }
      } else {
        if (weekChange < -20) {
          const sev = weekChange < -30 ? 'critical' : 'high';
          results.redFlags.push({
            type: 'sharp_drop',
            severity: sev,
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * (sev === 'critical' ? 4 : 3),
            metric: col.name,
            message: `${col.name}: різке падіння ${weekChange}% за тиждень`,
            details: `${values[1]?.dateLabel}: ${formatValueForAI(previous, col.format)} → ${values[0]?.dateLabel}: ${formatValueForAI(latest, col.format)}`
          });
        }
      }

      // 4. Новий екстремум
      // Для inverted: новий максимум = погано
      // Для звичайних: новий мінімум = погано
      if (isInverted) {
        const prevMax = Math.max(...facts.slice(1));
        if (latest > prevMax && facts.length > 2) {
          results.redFlags.push({
            type: 'new_maximum_inverted',
            severity: 'medium',
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * 2,
            metric: col.name,
            message: `↓${col.name}: новий максимум за період (це погано!)`,
            details: `${formatValueForAI(latest, col.format)} — найвище значення за ${facts.length} тижнів`
          });
        }
      } else {
        const prevMin = Math.min(...facts.slice(1));
        if (latest < prevMin && facts.length > 2) {
          results.redFlags.push({
            type: 'new_minimum',
            severity: 'medium',
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * 2,
            metric: col.name,
            message: `${col.name}: новий мінімум за період`,
            details: `${formatValueForAI(latest, col.format)} — найнижче значення за ${facts.length} тижнів`
          });
        }
      }

      // === ПОРІВНЯННЯ ПЕРІОДІВ ===
      results.periodComparison.push({
        metric: col.name,
        type: 'weekly',
        importance: colImportance,
        inverted: isInverted,
        current: {
          period: values[0]?.dateLabel,
          value: formatValueForAI(latest, col.format),
          planExecution: latestPlanExecution ? `${latestPlanExecution}%` : '-'
        },
        previous: {
          period: values[1]?.dateLabel,
          value: formatValueForAI(previous, col.format),
          planExecution: values[1]?.plan && values[1].plan !== 0 ? `${Math.round(previous / values[1].plan * 100)}%` : '-'
        },
        change: `${weekChange > 0 ? '+' : ''}${weekChange}%`,
        // Для inverted: зростання = погано (down), падіння = добре (up)
        trend: isInverted ? weekChange > 5 ? 'down' : weekChange < -5 ? 'up' : 'stable' : weekChange > 5 ? 'up' : weekChange < -5 ? 'down' : 'stable'
      });
    });

    // Аналіз місячних показників (аналогічно)
    tableData.monthly.columns.forEach(col => {
      const values = tableData.monthly.rows.map(r => ({
        date: r.date,
        dateLabel: formatDateForAI(r.date, 'monthly'),
        fact: parseNum(r.values?.[col.id]),
        plan: parseNum(r.targets?.[col.id]) || parseNum(targetRow?.values?.[col.id])
      })).filter(v => v.fact !== null);
      if (values.length < 2) return;
      const facts = values.map(v => v.fact);
      const latest = facts[0];
      const previous = facts[1];
      const avg = facts.reduce((a, b) => a + b, 0) / facts.length;
      const isInverted = col.inverted || false;

      // Захист від ділення на 0
      const monthChange = previous && previous !== 0 ? Math.round((latest - previous) / previous * 100) : 0;
      const latestPlanExecution = values[0]?.plan && values[0].plan !== 0 ? Math.round(values[0].fact / values[0].plan * 100) : null;
      let direction = 'стабільно';
      if (isInverted) {
        // Для inverted: зростання = погано, падіння = добре
        if (monthChange > 10) direction = 'зростає ⚠️';else if (monthChange < -10) direction = 'падає ✓';
      } else {
        if (monthChange > 10) direction = 'зростає';else if (monthChange < -10) direction = 'падає';
      }
      const metric = {
        name: col.name,
        responsible: col.responsible || 'не вказано',
        format: col.format,
        importance: col.importance || 'medium',
        inverted: isInverted,
        latest: {
          value: latest,
          date: values[0]?.dateLabel
        },
        previous: {
          value: previous,
          date: values[1]?.dateLabel
        },
        monthChange: monthChange,
        direction: direction,
        avg: Math.round(avg * 10) / 10,
        latestPlanExecution: latestPlanExecution
      };
      results.monthly.push(metric);

      // Червоні прапорці для місячних (з importance та inverted)
      const importanceMultiplier = {
        critical: 4,
        high: 3,
        medium: 2,
        low: 1
      };
      const colImportance = col.importance || 'medium';

      // Виконання плану
      if (latestPlanExecution !== null) {
        if (isInverted) {
          const invertedExecution = values[0]?.plan ? Math.round((1 - latest / values[0].plan) * 100) : null;
          if (invertedExecution !== null && invertedExecution < 0) {
            results.redFlags.push({
              type: 'over_limit_inverted',
              severity: 'critical',
              importance: colImportance,
              importanceScore: importanceMultiplier[colImportance] * 4,
              metric: col.name,
              message: `↓${col.name}: перевищено місячний ліміт! ${latest} при максимумі ${values[0]?.plan}`,
              details: `Перевищення: ${Math.abs(invertedExecution)}%`
            });
          }
        } else if (latestPlanExecution < 70) {
          const sev = latestPlanExecution < 50 ? 'critical' : 'high';
          results.redFlags.push({
            type: 'low_execution',
            severity: sev,
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * (sev === 'critical' ? 4 : 3),
            metric: col.name,
            message: `${col.name}: виконання плану лише ${latestPlanExecution}%`,
            details: `Факт: ${formatValueForAI(latest, col.format)}, План: ${formatValueForAI(values[0]?.plan, col.format)}`
          });
        }
      }

      // Різка зміна за місяць
      if (isInverted) {
        if (monthChange > 25) {
          results.redFlags.push({
            type: 'monthly_rise_inverted',
            severity: 'critical',
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * 4,
            metric: col.name,
            message: `↓${col.name}: зростання +${monthChange}% за місяць (це погано!)`,
            details: `${values[1]?.dateLabel}: ${formatValueForAI(previous, col.format)} → ${values[0]?.dateLabel}: ${formatValueForAI(latest, col.format)}`
          });
        }
      } else {
        if (monthChange < -15) {
          const sev = monthChange < -25 ? 'critical' : 'high';
          results.redFlags.push({
            type: 'monthly_drop',
            severity: sev,
            importance: colImportance,
            importanceScore: importanceMultiplier[colImportance] * (sev === 'critical' ? 4 : 3),
            metric: col.name,
            message: `${col.name}: падіння ${monthChange}% за місяць`,
            details: `${values[1]?.dateLabel}: ${formatValueForAI(previous, col.format)} → ${values[0]?.dateLabel}: ${formatValueForAI(latest, col.format)}`
          });
        }
      }
      results.periodComparison.push({
        metric: col.name,
        type: 'monthly',
        importance: colImportance,
        inverted: isInverted,
        current: {
          period: values[0]?.dateLabel,
          value: formatValueForAI(latest, col.format),
          planExecution: latestPlanExecution ? `${latestPlanExecution}%` : '-'
        },
        previous: {
          period: values[1]?.dateLabel,
          value: formatValueForAI(previous, col.format),
          planExecution: values[1]?.plan && values[1].plan !== 0 ? `${Math.round(previous / values[1].plan * 100)}%` : '-'
        },
        change: `${monthChange > 0 ? '+' : ''}${monthChange}%`,
        trend: isInverted ? monthChange > 5 ? 'down' : monthChange < -5 ? 'up' : 'stable' : monthChange > 5 ? 'up' : monthChange < -5 ? 'down' : 'stable'
      });
    });

    // Сортуємо червоні прапорці по importanceScore (більший = важливіший)
    results.redFlags.sort((a, b) => (b.importanceScore || 0) - (a.importanceScore || 0));
    return results;
  };

  // === ДЕТЕКЦІЯ ОБМЕЖЕНЬ АНАЛІЗУ ===
  const detectLimitations = (tableData, analysis) => {
    const limitations = [];
    const now = new Date();
    const currentMonth = now.getMonth();

    // 1. Сезонність
    const seasonalMonths = [11, 0, 6, 7]; // Грудень, Січень, Липень, Серпень
    if (seasonalMonths.includes(currentMonth)) {
      const monthNames = {
        11: 'грудень',
        0: 'січень',
        6: 'липень',
        7: 'серпень'
      };
      limitations.push({
        type: 'seasonality',
        iconName: 'Calendar',
        title: 'Можлива сезонність',
        description: `${monthNames[currentMonth].charAt(0).toUpperCase() + monthNames[currentMonth].slice(1)} — це сезонний місяць. Падіння може бути нормою для цього періоду.`,
        question: 'Чи є у вас сезонний бізнес?',
        action: 'check_seasonality'
      });
    }

    // 2. Свята
    const holidays = [{
      month: 11,
      days: [24, 25, 31],
      name: 'Новорічні свята'
    }, {
      month: 0,
      days: [1, 7],
      name: 'Новорічні/Різдво'
    }, {
      month: 2,
      days: [8],
      name: '8 Березня'
    }, {
      month: 4,
      days: [1, 9],
      name: 'Травневі свята'
    }, {
      month: 7,
      days: [24],
      name: 'День Незалежності'
    }];
    const today = now.getDate();
    const nearHoliday = holidays.find(h => h.month === currentMonth && h.days.some(d => Math.abs(d - today) <= 7));
    if (nearHoliday) {
      limitations.push({
        type: 'holidays',
        iconName: 'Gift',
        title: 'Період свят',
        description: `Зараз ${nearHoliday.name}. Активність клієнтів може бути нижчою.`,
        question: 'Чи впливають свята на ваш бізнес?',
        action: 'check_holidays'
      });
    }

    // 3. Мало даних
    const weeklyCount = tableData.weekly?.rows?.length || 0;
    const monthlyCount = tableData.monthly?.rows?.length || 0;
    if (weeklyCount < 6 && weeklyCount > 0) {
      limitations.push({
        type: 'insufficient_data',
        iconName: 'BarChart',
        title: 'Мало тижневих даних',
        description: `Лише ${weeklyCount} тижнів. Для точного аналізу трендів потрібно 6-8 тижнів.`,
        question: 'Чи потрібен аналіз з такою вибіркою?',
        action: 'proceed_anyway'
      });
    }
    if (monthlyCount < 3 && monthlyCount > 0) {
      limitations.push({
        type: 'insufficient_monthly',
        iconName: 'BarChart',
        title: 'Мало місячних даних',
        description: `Лише ${monthlyCount} місяці. Для аналізу трендів потрібно 3+ місяці.`,
        question: 'Чи достатньо цих даних?',
        action: 'proceed_anyway'
      });
    }

    // 4. Пропущені значення
    let missingValues = 0;
    tableData.weekly?.rows?.forEach(row => {
      tableData.weekly?.columns?.forEach(col => {
        if (!row.values?.[col.id]) missingValues++;
      });
    });
    if (missingValues > 3) {
      limitations.push({
        type: 'missing_values',
        iconName: 'AlertTriangle',
        title: 'Пропущені значення',
        description: `${missingValues} значень не заповнені. Це може спотворити аналіз.`,
        question: 'Продовжити з неповними даними?',
        action: 'proceed_anyway'
      });
    }

    // 5. Зовнішні фактори (якщо є валютні показники)
    const hasCurrency = tableData.weekly?.columns?.some(c => c.format === 'usd' || c.format === 'eur') || tableData.monthly?.columns?.some(c => c.format === 'usd' || c.format === 'eur');
    if (hasCurrency) {
      limitations.push({
        type: 'currency',
        iconName: 'DollarSign',
        title: 'Валютні показники',
        description: 'Є показники в іноземній валюті. Курс міг вплинути на результати.',
        question: 'Врахувати зміни курсу?',
        action: 'check_currency'
      });
    }

    // 6. Аномалії (різкі стрибки)
    const anomalies = analysis.redFlags?.filter(f => f.type === 'sharp_drop' && Math.abs(parseInt(f.message.match(/-?\d+/)?.[0] || 0)) > 40);
    if (anomalies?.length > 0) {
      limitations.push({
        type: 'anomaly',
        iconName: 'Search',
        title: 'Аномальні дані',
        description: `Є різкі зміни >40%. Це може бути помилка введення або реальна подія.`,
        question: 'Перевірити коректність даних?',
        action: 'check_anomaly'
      });
    }
    return limitations;
  };
  const callAI = async prompt => {
    const response = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: OPENAI_MODEL,
        messages: [{
          role: 'user',
          content: prompt
        }],
        max_tokens: 2000,
        temperature: 0.7
      })
    });
    if (!response.ok) throw new Error('API Error');
    const data = await response.json();
    return data.choices[0].message.content;
  };
  const addMessage = (type, content, buttons = null) => {
    setMessages(prev => [...prev, {
      type,
      content,
      buttons,
      time: new Date()
    }]);
  };

  // ЕТАП 1: Визначення вузького місця
  const startAnalysis = async () => {
    if (!aiSettings.businessContext) {
      toast.warning('Заповніть контекст бізнесу');
      return;
    }
    if (rows.filter(r => !r.isTarget).length < 2) {
      toast.warning('Додайте більше даних (мінімум 2 записи)');
      return;
    }
    setStep(1);
    setMessages([]);
    setIsAnalyzing(true);
    setAiStage(0); // Збір даних
    addMessage('system', 'Аналізую ваші дані... Це займе 1-2 хвилини.');
    
    // Етап 1: Збір даних
    const tableData = getTableData();
    const columnsInfo = getColumnsInfo();
    setAiStage(1); // Аналіз трендів
    
    const analysis = analyzeMetrics(tableData);
    setAnalysisData({
      tableData,
      analysis
    });
    
    setAiStage(2); // Пошук вузьких місць

    // === ФОРМУЄМО БЛОК ТРЕНДІВ ===
    let trendsBlock = '';
    if (analysis.weekly.length > 0) {
      trendsBlock += '\n### ТИЖНЕВІ ПОКАЗНИКИ — ТРЕНДИ:\n';
      analysis.weekly.forEach(m => {
        const arrow = m.direction === 'зростає' ? '↑' : m.direction === 'падає' ? '↓' : '→';
        trendsBlock += `\n**${m.name}** (відповідальний: ${m.responsible}):\n`;
        trendsBlock += `- Останній тиждень (${m.latest.date}): ${formatValueForAI(m.latest.value, m.format)}\n`;
        trendsBlock += `- Попередній (${m.previous.date}): ${formatValueForAI(m.previous.value, m.format)}\n`;
        trendsBlock += `- Зміна за тиждень: ${m.weekChange > 0 ? '+' : ''}${m.weekChange}% ${arrow}\n`;
        trendsBlock += `- Тренд за період: ${m.direction} (${m.periodChange > 0 ? '+' : ''}${m.periodChange}%)\n`;
        trendsBlock += `- Середнє: ${formatValueForAI(m.avg, m.format)}, Мін: ${formatValueForAI(m.min.value, m.format)} (${m.min.date}), Макс: ${formatValueForAI(m.max.value, m.format)} (${m.max.date})\n`;
        if (m.latestPlanExecution) {
          trendsBlock += `- Виконання плану: ${m.latestPlanExecution}% (середнє: ${m.avgPlanExecution}%)\n`;
        }
      });
    }
    if (analysis.monthly.length > 0) {
      trendsBlock += '\n\n### МІСЯЧНІ ПОКАЗНИКИ — ТРЕНДИ:\n';
      analysis.monthly.forEach(m => {
        const arrow = m.direction === 'зростає' ? '↑' : m.direction === 'падає' ? '↓' : '→';
        trendsBlock += `\n**${m.name}** (відповідальний: ${m.responsible}):\n`;
        trendsBlock += `- Останній місяць (${m.latest.date}): ${formatValueForAI(m.latest.value, m.format)}\n`;
        trendsBlock += `- Попередній (${m.previous.date}): ${formatValueForAI(m.previous.value, m.format)}\n`;
        trendsBlock += `- Зміна: ${m.monthChange > 0 ? '+' : ''}${m.monthChange}% ${arrow}\n`;
        if (m.latestPlanExecution) {
          trendsBlock += `- Виконання плану: ${m.latestPlanExecution}%\n`;
        }
      });
    }

    // === ФОРМУЄМО БЛОК ЧЕРВОНИХ ПРАПОРЦІВ ===
    let redFlagsBlock = '';
    if (analysis.redFlags.length > 0) {
      redFlagsBlock = '\n\n### [!] КРИТИЧНІ ПРОБЛЕМИ (автоматично виявлені):\n';
      analysis.redFlags.forEach((flag, idx) => {
        const icon = flag.severity === 'critical' ? '[!!!]' : flag.severity === 'high' ? '[!!]' : '[!]';
        redFlagsBlock += `${idx + 1}. ${icon} ${flag.message}\n   └ ${flag.details}\n`;
      });
    }

    // === ФОРМУЄМО БЛОК ПОРІВНЯННЯ ===
    let comparisonBlock = '\n\n### ПОРІВНЯННЯ ПЕРІОДІВ:\n';
    comparisonBlock += '| Показник | Важливість | Поточний | Попередній | Зміна |\n';
    comparisonBlock += '|----------|-----------|----------|------------|-------|\n';
    // Сортуємо по важливості
    const importanceOrder = {
      critical: 0,
      high: 1,
      medium: 2,
      low: 3
    };
    const sortedComparison = [...analysis.periodComparison].sort((a, b) => importanceOrder[a.importance || 'medium'] - importanceOrder[b.importance || 'medium']);
    sortedComparison.forEach(c => {
      const impIcon = {
        critical: '[КРИТ]',
        high: '[ВИС]',
        medium: '[СЕР]',
        low: '[НИЗ]'
      }[c.importance || 'medium'];
      const trendIcon = {
        up: '[+]',
        down: '[-]',
        stable: '[=]'
      }[c.trend] || '[=]';
      comparisonBlock += `| ${c.metric} | ${impIcon} | ${c.current.value} (${c.current.planExecution}) | ${c.previous.value} | ${c.change} ${trendIcon} |\n`;
    });

    // === ДЕТЕКЦІЯ ОБМЕЖЕНЬ ===
    const limitations = detectLimitations(tableData, analysis);

    // === ІСТОРІЯ АНАЛІЗІВ ===
    let historyBlock = '';
    if (savedAnalyses.length > 0) {
      const lastAnalysis = savedAnalyses[savedAnalyses.length - 1];
      const lastDate = new Date(lastAnalysis.date).toLocaleDateString('uk-UA');
      historyBlock = `\n\n### [ІСТОРІЯ] ПОПЕРЕДНІЙ АНАЛІЗ (${lastDate}):\n`;
      // Витягуємо вузьке місце з попереднього аналізу
      const prevBottleneck = lastAnalysis.content?.match(/## ВУЗЬКЕ МІСЦЕ: (.+)/)?.[1] || 'не визначено';
      historyBlock += `Минулого разу виявлено: "${prevBottleneck}"\n`;
      historyBlock += `Порівняй з поточною ситуацією — чи є прогрес?\n`;
    }

    // === БЛОК ВАЖЛИВОСТІ ПОКАЗНИКІВ ===
    let importanceBlock = '\n\n### [$$] ВАЖЛИВІСТЬ ПОКАЗНИКІВ:\n';
    const criticalMetrics = columnsInfo.filter(c => c.importance === 'critical');
    const highMetrics = columnsInfo.filter(c => c.importance === 'high');
    const invertedMetrics = columnsInfo.filter(c => c.inverted);
    if (criticalMetrics.length > 0) {
      importanceBlock += `КРИТИЧНІ (впливають на гроші): ${criticalMetrics.map(c => c.name).join(', ')}\n`;
    }
    if (highMetrics.length > 0) {
      importanceBlock += `ВИСОКІ: ${highMetrics.map(c => c.name).join(', ')}\n`;
    }
    if (invertedMetrics.length > 0) {
      importanceBlock += `\n⚠️ ВІД'ЄМНІ ПОКАЗНИКИ (чим менше - тим краще): ${invertedMetrics.map(c => c.name).join(', ')}\n`;
      importanceBlock += `Для цих показників: зростання = ПОГАНО, падіння = ДОБРЕ!\n`;
    }
    importanceBlock += `\nЗверни БІЛЬШЕ уваги на критичні показники!\n`;
    const prompt = `Ти — бізнес-консультант з 10+ років досвіду. На основі ГОТОВОГО аналізу визнач ГОЛОВНЕ вузьке місце.

КОНТЕКСТ БІЗНЕСУ:
${aiSettings.businessContext}

ПРІОРИТЕТИ ВЛАСНИКА:
${aiSettings.priorities || 'Не вказано'}

${additionalFocus ? `ОСОБЛИВИЙ ФОКУС: ${additionalFocus}\n` : ''}
=== ГОТОВИЙ АНАЛІЗ ДАНИХ ===
${importanceBlock}
${redFlagsBlock}
${trendsBlock}
${comparisonBlock}
${historyBlock}

=== ТВОЄ ЗАВДАННЯ ===

На основі готового аналізу вище, визнач ОДНЕ головне вузьке місце.
ПРІОРИТЕТ: показники з важливістю [КРИТ] КРИТИЧНІ важливіші за інші!
Не рахуй тренди сам — вони вже пораховані.

Дай відповідь українською СТРОГО у форматі:

## ВУЗЬКЕ МІСЦЕ: [назва проблеми/функції]

### ФАКТИ (бери з аналізу вище):
- [цифра 1 + період + зміна]
- [цифра 2 + період + зміна]
- [цифра 3 + період + зміна]

### ЧОМУ ЦЕ КРИТИЧНО:
[1-2 речення: як це впливає на бізнес прямо зараз]

### ПРИЧИННО-НАСЛІДКОВИЙ ЗВ'ЯЗОК:
[Ланцюжок: проблема → наслідок 1 → наслідок 2 → втрати]

### ВТРАТИ:
Через це ви втрачаєте приблизно [сума] грн на [період]. Розрахунок: [як порахував].

### ПРОГНОЗ:
Якщо не виправити протягом [термін], то [конкретний наслідок з цифрами].

### САМОПЕРЕВІРКА:
- Достовірність: [чи всі цифри з наданих даних?]
- Логіка: [чи логічний причинно-наслідковий зв'язок?]
- Можливі похибки: [що могло вплинути на аналіз?]

ВАЖЛИВО: Використовуй ТІЛЬКИ цифри з готового аналізу. Не вигадуй і не рахуй сам.`;
    
    setAiStage(3); // Генерація рекомендацій
    
    try {
      let response = await callAI(prompt);

      // === ВАЛІДАЦІЯ ВІДПОВІДІ ===
      const hasRequiredSections = response.includes('## ВУЗЬКЕ МІСЦЕ:') && response.includes('### ФАКТИ') && response.includes('### ВТРАТИ');
      if (!hasRequiredSections) {
        // Перепитуємо AI
        addMessage('system', 'Уточнюю формат відповіді...');
        response = await callAI(`Твоя попередня відповідь була не в правильному форматі. Переформатуй її СТРОГО за шаблоном:

## ВУЗЬКЕ МІСЦЕ: [назва]

### ФАКТИ:
- [факт 1]
- [факт 2]

### ЧОМУ ЦЕ КРИТИЧНО:
[текст]

### ПРИЧИННО-НАСЛІДКОВИЙ ЗВ'ЯЗОК:
[текст]

### ВТРАТИ:
[текст з сумою]

### ПРОГНОЗ:
[текст]

### САМОПЕРЕВІРКА:
- Достовірність: [...]
- Логіка: [...]
- Можливі похибки: [...]

Ось твоя попередня відповідь для переформатування:
${response}`);
      }
      addMessage('ai', response);

      // === ПОКАЗУЄМО ОБМЕЖЕННЯ ===
      if (limitations.length > 0) {
        let limitationsText = '\n\n---\n\n**МОЖЛИВІ ОБМЕЖЕННЯ АНАЛІЗУ:**\n';
        limitations.forEach(l => {
          limitationsText += `\n[!] **${l.title}**\n${l.description}\n`;
        });
        addMessage('warning', limitationsText);

        // Кнопки для обмежень
        const limitationButtons = limitations.slice(0, 3).map(l => ({
          text: l.title,
          action: l.action,
          icon: l.iconName || 'AlertCircle'
        }));
        limitationButtons.push({
          text: 'Все ок, продовжити',
          action: 'understood',
          icon: 'CheckCircle'
        });
        addMessage('buttons', null, limitationButtons);
      } else {
        addMessage('buttons', null, [{
          text: 'Так, зрозуміло. Що робити?',
          action: 'understood',
          icon: 'CheckCircle'
        }, {
          text: 'Поясни детальніше',
          action: 'explain_more',
          icon: 'HelpCircle'
        }, {
          text: 'Глибший аналіз в ChatGPT',
          action: 'open_gpt_bottleneck',
          icon: 'Brain'
        }]);
      }
    } catch (error) {
      addMessage('error', 'Помилка аналізу: ' + error.message);
    }
    setIsAnalyzing(false);
    setAiStage(0); // Скидаємо прогрес
  };

  // === ДОДАТКОВИЙ АНАЛІЗ (сезонність, валюта тощо) ===
  const runAdditionalAnalysis = async type => {
    setIsAnalyzing(true);
    addMessage('user', `Врахувати: ${type}`);
    addMessage('system', 'Проводжу додатковий аналіз...');
    const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
    let additionalPrompt = '';
    switch (type) {
      case 'check_seasonality':
        additionalPrompt = `Проаналізуй попередній аналіз з урахуванням СЕЗОННОСТІ.
                        
Поточний місяць може бути сезонно низьким. Перерахуй:
1. Чи нормальне падіння для цього періоду?
2. Як виглядали б результати порівняно з цим же періодом минулого року?
3. Скоригуй оцінку втрат з урахуванням сезонності.

Попередній аналіз:
${previousContext}`;
        break;
      case 'check_holidays':
        additionalPrompt = `Проаналізуй попередній аналіз з урахуванням СВЯТКОВОГО ПЕРІОДУ.
                        
Зараз період свят — активність може бути нижчою. Оціни:
1. Наскільки падіння пов'язане зі святами?
2. Чи варто чекати відновлення після свят?
3. Які дії доцільні саме зараз?

Попередній аналіз:
${previousContext}`;
        break;
      case 'check_currency':
        additionalPrompt = `Проаналізуй попередній аналіз з урахуванням КУРСУ ВАЛЮТ.
                        
Є показники в іноземній валюті. Оціни:
1. Як зміна курсу могла вплинути на показники?
2. Чи коректно порівнювати періоди без урахування курсу?
3. Скоригуй висновки якщо потрібно.

Попередній аналіз:
${previousContext}`;
        break;
      case 'check_anomaly':
        additionalPrompt = `Перевір дані на АНОМАЛІЇ та помилки.
                        
Є різкі зміни показників (>40%). Проаналізуй:
1. Чи може це бути помилка введення даних?
2. Чи була конкретна подія що спричинила зміну?
3. Чи потрібно виключити цей період з аналізу?

Попередній аналіз:
${previousContext}`;
        break;
      default:
        additionalPrompt = previousContext;
    }
    try {
      const response = await callAI(additionalPrompt);
      addMessage('ai', response);
      addMessage('buttons', null, [{
        text: 'Зрозуміло. Що робити?',
        action: 'understood',
        icon: 'CheckCircle'
      }, {
        text: 'Продовжити без змін',
        action: 'understood',
        icon: 'ArrowRight'
      }]);
    } catch (error) {
      addMessage('error', 'Помилка: ' + error.message);
    }
    setIsAnalyzing(false);
  };

  // ЕТАП 2: Варіанти рішення
  const showSolutions = async (needMoreExplanation = false) => {
    setStep(2);
    setIsAnalyzing(true);
    if (needMoreExplanation) {
      addMessage('user', 'Поясни детальніше');
      addMessage('system', 'Готую розгорнуте пояснення...');
    } else {
      addMessage('user', 'Так, зрозуміло. Що робити?');
      addMessage('system', 'Готую варіанти рішення...');
    }
    const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
    const prompt = needMoreExplanation ? `Поясни детальніше причинно-наслідковий зв'язок вузького місця. Використовуй аналогії та приклади. Покажи як кожен крок впливає на наступний. Не використовуй емоджі.

Попередній аналіз:
${previousContext}

Дай розгорнуте пояснення українською, потім запитай чи зрозуміло.` : `На основі виявленого вузького місця, запропонуй 3 ВАРІАНТИ РІШЕННЯ з ROI аналізом.

Попередній аналіз:
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Дай відповідь українською СТРОГО у форматі (без емоджі):

## ТРИ ВАРІАНТИ РІШЕННЯ

### ВАРІАНТ 1: [Назва]
- Суть: [1 речення]
- Плюси: [2-3 пункти]
- Мінуси: [1-2 пункти]
- Термін: [скільки днів]
- Вартість: [сума грн]
- ROI: вкладаєш [X] → отримуєш [Y] (1:[ratio])

### ВАРІАНТ 2: [Назва]
- Суть: [1 речення]
- Плюси: [2-3 пункти]
- Мінуси: [1-2 пункти]
- Термін: [скільки днів]
- Вартість: [сума грн]
- ROI: вкладаєш [X] → отримуєш [Y] (1:[ratio])

### ВАРІАНТ 3: [Назва]
- Суть: [1 речення]
- Плюси: [2-3 пункти]
- Мінуси: [1-2 пункти]
- Термін: [скільки днів]
- Вартість: [сума грн]
- ROI: вкладаєш [X] → отримуєш [Y] (1:[ratio])

---

### РЕКОМЕНДАЦІЯ:
Варіант [номер], тому що [чому саме цей варіант дає найкращий ROI для вашої ситуації].`;
    try {
      const response = await callAI(prompt);
      addMessage('ai', response);
      if (needMoreExplanation) {
        addMessage('buttons', null, [{
          text: 'Тепер зрозуміло. Що робити?',
          action: 'understood',
          icon: 'CheckCircle'
        }, {
          text: 'Ще раз поясни',
          action: 'explain_more',
          icon: 'HelpCircle'
        }]);
      } else {
        addMessage('buttons', null, [{
          text: 'Варіант 1',
          action: 'solution_1',
          icon: 'Circle'
        }, {
          text: 'Варіант 2',
          action: 'solution_2',
          icon: 'Circle'
        }, {
          text: 'Варіант 3',
          action: 'solution_3',
          icon: 'Circle'
        }, {
          text: 'Рекомендований',
          action: 'solution_recommended',
          icon: 'Star'
        }, {
          text: 'Свій варіант',
          action: 'custom_solution',
          icon: 'Edit'
        }]);
      }
    } catch (error) {
      addMessage('error', 'Помилка: ' + error.message);
    }
    setIsAnalyzing(false);
  };

  // ЕТАП 3: План дій
  const createPlan = async solutionNum => {
    setStep(3);
    setSelectedSolution(solutionNum);
    setIsAnalyzing(true);
    const solutionText = solutionNum === 'recommended' ? 'рекомендований варіант' : `варіант ${solutionNum}`;
    addMessage('user', `Обираю ${solutionText}`);
    addMessage('system', 'Складаю програму розширення вузького місця...');
    const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
    const columnsInfo = getColumnsInfo();

    // Збираємо унікальних відповідальних
    const responsibles = [...new Set(columnsInfo.map(c => c.responsible).filter(r => r && r !== 'не вказано'))];
    const prompt = `Склади ПРОГРАМУ РОЗШИРЕННЯ ВУЗЬКОГО МІСЦЯ на основі обраного рішення.

Обрано: ${solutionText}

Попередній контекст (вузьке місце та варіанти):
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Відповідальні за показники:
${columnsInfo.map(c => `- ${c.name}: ${c.responsible}`).join('\n')}

Доступні виконавці: ${responsibles.length > 0 ? responsibles.join(', ') : 'Власник'}

Дай відповідь українською СТРОГО у такому форматі:

## ПРОГРАМА РОЗШИРЕННЯ ВУЗЬКОГО МІСЦЯ

### ВХІД:
- Вузьке місце: [назва функції/процесу]
- Зараз: [поточна метрика з даних]
- Ціль: [цільова метрика]

### ДІАГНОЗ
- Корінь: [1 речення — чому виникло вузьке місце]
- Блокер: [що конкретно заважає зараз]

### ПРОГРАМА

**Першочергові** (без них не рухаємось):
1. [Завдання] → Хто: [імя з виконавців] → Коли: день 1-2 → Готово коли: [критерій]
2. [Завдання] → Хто: [імя з виконавців] → Коли: день 2-3 → Готово коли: [критерій]

**Життєво важливі** (усунути блокери):
3. [Завдання] → Хто: [імя з виконавців] → Коли: день 3-5 → Готово коли: [критерій]
4. [Завдання] → Хто: [імя з виконавців] → Коли: день 4-6 → Готово коли: [критерій]

**Робочі** (конкретні кроки):
5. [Завдання] → Хто: [імя з виконавців] → Коли: день 5-7 → Готово коли: [критерій]
6. [Завдання] → Хто: [імя з виконавців] → Коли: день 6-8 → Готово коли: [критерій]

**Виробничі** (вимірюваний результат):
7. [Кількість + що зробити] → Хто: [імя з виконавців] → Коли: день 7-10 → Готово коли: [число]

### КОНТРОЛЬ
- Перевірка: день 10
- Успіх: [було X] → [стало Y]
- Якщо ні: [конкретна дія]

ПРАВИЛА яких дотримуйся:
- Призначай завдання ТІЛЬКИ людям з "Доступні виконавці"
- Першочергові завжди перші
- 1 завдання = 1 дія, 1 людина, 1 дедлайн
- Без "Готово коли" — завдання неповне
- Максимум 7-10 завдань
- Дедлайни в днях від старту`;
    try {
      const response = await callAI(prompt);
      setCurrentPlan(response); // Зберігаємо план
      addMessage('ai', response);
      addMessage('buttons', null, [{
        text: 'Сформувати розпорядження',
        action: 'generate_orders',
        icon: 'FileText'
      }, {
        text: 'Зберегти план',
        action: 'save',
        icon: 'Save'
      }, {
        text: 'Скопіювати',
        action: 'copy',
        icon: 'Copy'
      }, {
        text: 'Почати спочатку',
        action: 'restart',
        icon: 'RefreshCw'
      }]);
    } catch (error) {
      addMessage('error', 'Помилка: ' + error.message);
    }
    setIsAnalyzing(false);
  };

  // ЕТАП 3 (власний варіант): План дій для custom solution
  const createCustomPlan = async customText => {
    setStep(3);
    setSelectedSolution('custom');
    setIsAnalyzing(true);
    addMessage('user', `Мій варіант: ${customText}`);
    addMessage('system', 'Аналізую ваш варіант та складаю програму...');
    const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
    const columnsInfo = getColumnsInfo();
    const responsibles = [...new Set(columnsInfo.map(c => c.responsible).filter(r => r && r !== 'не вказано'))];
    const prompt = `Користувач запропонував ВЛАСНИЙ ВАРІАНТ рішення. Спочатку оціни його, потім склади програму.

ВАРІАНТ КОРИСТУВАЧА:
${customText}

Попередній контекст (вузьке місце):
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Доступні виконавці: ${responsibles.length > 0 ? responsibles.join(', ') : 'Власник'}

Дай відповідь українською СТРОГО у такому форматі:

## ОЦІНКА ВАШОГО ВАРІАНТУ

### Сильні сторони:
- [пункт 1]
- [пункт 2]

### Можливі ризики:
- [пункт 1]
- [пункт 2]

### Рекомендація:
[як покращити або на що звернути увагу]

---

## ПРОГРАМА РОЗШИРЕННЯ ВУЗЬКОГО МІСЦЯ

### ВХІД:
- Вузьке місце: [назва функції/процесу]
- Зараз: [поточна метрика]
- Ціль: [цільова метрика]

### ДІАГНОЗ
- Корінь: [1 речення — чому виникло вузьке місце]
- Блокер: [що конкретно заважає зараз]

### ПРОГРАМА

**Першочергові** (без них не рухаємось):
1. [Завдання] → Хто: [імя з виконавців] → Коли: день 1-2 → Готово коли: [критерій]
2. [Завдання] → Хто: [імя з виконавців] → Коли: день 2-3 → Готово коли: [критерій]

**Життєво важливі** (усунути блокери):
3. [Завдання] → Хто: [імя з виконавців] → Коли: день 3-5 → Готово коли: [критерій]

**Робочі** (конкретні кроки):
4. [Завдання] → Хто: [імя з виконавців] → Коли: день 5-7 → Готово коли: [критерій]
5. [Завдання] → Хто: [імя з виконавців] → Коли: день 6-8 → Готово коли: [критерій]

**Виробничі** (вимірюваний результат):
6. [Кількість + що зробити] → Хто: [імя з виконавців] → Коли: день 7-10 → Готово коли: [число]

### КОНТРОЛЬ
- Перевірка: день 10
- Успіх: [було X] → [стало Y]
- Якщо ні: [конкретна дія]

ПРАВИЛО: Призначай завдання ТІЛЬКИ людям з "Доступні виконавці".`;
    try {
      const response = await callAI(prompt);
      setCurrentPlan(response); // Зберігаємо план
      addMessage('ai', response);
      addMessage('buttons', null, [{
        text: 'Сформувати розпорядження',
        action: 'generate_orders',
        icon: 'FileText'
      }, {
        text: 'Зберегти план',
        action: 'save',
        icon: 'Save'
      }, {
        text: 'Скопіювати',
        action: 'copy',
        icon: 'Copy'
      }, {
        text: 'Почати спочатку',
        action: 'restart',
        icon: 'RefreshCw'
      }]);
    } catch (error) {
      addMessage('error', 'Помилка: ' + error.message);
    }
    setIsAnalyzing(false);
    setCustomSolution('');
  };

  // ЕТАП 4: Генерація розпоряджень
  const generateOrders = async () => {
    setStep(4);
    setIsAnalyzing(true);
    setOrders([]);
    addMessage('user', 'Сформувати розпорядження');
    addMessage('system', 'Генерую розпорядження для кожного завдання...');
    const today = new Date();
    const formatDate = daysFromNow => {
      const d = new Date(today);
      d.setDate(d.getDate() + daysFromNow);
      return d.toLocaleDateString('uk-UA');
    };
    const prompt = `Сформуй розпорядження для виконавців на основі програми дій.

ПРОГРАМА ДІЙ:
${currentPlan}

КОНТЕКСТ БІЗНЕСУ:
${aiSettings.businessContext}

Сьогодні: ${today.toLocaleDateString('uk-UA')}

══════════════════════════════════════════════════
ШАБЛОН РОЗПОРЯДЖЕННЯ (TALKO SYSTEM FORMAT)
══════════════════════════════════════════════════

---РОЗПОРЯДЖЕННЯ---
РОЗПОРЯДЖЕННЯ (TALKO SYSTEM FORMAT)

КОМУ: [Посада + ПІБ відповідального, наприклад: Старший адміністратор клініки]
ДАТА: [дата створення]
ВІД КОГО: [Посада + ПІБ керівника, який видає розпорядження]
РОЗПОРЯДЖЕННЯ №: [номер]
ТЕРМІН ВИКОНАННЯ: [конкретна дата або час]

ДЛЯ ІНФОРМАЦІЇ:
[Коротке пояснення контексту — чому видається розпорядження, що змінилося, кого це стосується]

ЗАВДАННЯ:
1. [Перше конкретне завдання у форматі «дія + результат»]
2. [Друге завдання]
3. [Третє завдання, якщо потрібно]

ОЧІКУВАНИЙ ПРОДУКТ (РЕЗУЛЬТАТ):
• [Що саме має бути готовим у результаті виконання — документ, звіт, таблиця, акт, фото, тощо]
• [Кому і як це передається — на email, у систему, у чат звітності]

ЗВІТ ПРО ВИКОНАННЯ:
[Дедлайн подання звіту, формат звіту, куди надсилати, хто перевіряє]

ПІДПИС: _______________
---КІНЕЦЬ---

══════════════════════════════════════════════════
ПРИКЛАД ЗАПОВНЕНОГО РОЗПОРЯДЖЕННЯ:
══════════════════════════════════════════════════

---РОЗПОРЯДЖЕННЯ---
РОЗПОРЯДЖЕННЯ (TALKO SYSTEM FORMAT)

КОМУ: Старший адміністратор клініки [ПІБ]
ДАТА: ${today.toLocaleDateString('uk-UA')}
ВІД КОГО: Директор клініки [ПІБ]
РОЗПОРЯДЖЕННЯ №: 1
ТЕРМІН ВИКОНАННЯ: до 17:00 ${formatDate(3)}

ДЛЯ ІНФОРМАЦІЇ:
Необхідно підготувати комплект матеріалів для роботи з бонусними пропозиціями клініки: фінансова логіка, скрипт комунікації та друкована пам'ятка для персоналу.

ЗАВДАННЯ:
1. Сформувати Excel-таблицю з 5 варіантами бонусів для клініки
Формат таблиці:
– назва бонусу
– умови надання
– вартість для компанії

2. Підготувати текстовий скрипт у Word для використання персоналом
Вміст:
– 5 ключових фраз презентації бонусів
– 3 готові відповіді на типові заперечення
Обсяг — 1 сторінка.

3. Розробити картку-пам'ятку формату А5
Призначення — швидке використання персоналом під час роботи з клієнтами.

ОЧІКУВАНИЙ ПРОДУКТ (РЕЗУЛЬТАТ):
• Excel-файл «Бонуси_клініка.xlsx» з 5 повністю заповненими рядками
• Word-файл «Скрипт_бонуси.docx» обсягом 1 сторінка
• Графічний макет PNG для друку формату А5

ЗВІТ ПРО ВИКОНАННЯ:
Усі файли надіслати в чат "Звітність" до 17:00. Факт виконання перевіряється за наявністю файлів та відповідністю вимогам, описаним у розділі «Очікуваний продукт».

ПІДПИС: _______________
---КІНЕЦЬ---

══════════════════════════════════════════════════
ВИМОГИ:
══════════════════════════════════════════════════
1. Використовуй ТОЧНО цю структуру шаблону для кожного розпорядження
2. Завдання мають бути КОНКРЕТНИМИ з підпунктами через "–"
3. ОЧІКУВАНИЙ ПРОДУКТ — файли з назвами в лапках «Назва.xlsx»
4. Терміни: до 17:00 ${formatDate(1)}, до 17:00 ${formatDate(2)}, до 17:00 ${formatDate(3)}
5. Якщо ПІБ невідоме — пиши [ПІБ]
6. Створи 5-10 розпоряджень (по одному на кожне завдання з програми)

Розділяй маркерами ---РОЗПОРЯДЖЕННЯ--- та ---КІНЕЦЬ---`;
    try {
      const response = await callAI(prompt);

      // Парсимо розпорядження
      const orderTexts = response.split('---РОЗПОРЯДЖЕННЯ---').filter(t => t.trim());
      const parsedOrders = orderTexts.map((text, idx) => {
        const cleanText = text.replace('---КІНЕЦЬ---', '').trim();

        // Парсимо поля
        const getField = name => {
          const match = cleanText.match(new RegExp(`${name}:\\s*(.+?)(?=\\n[А-ЯІЇЄҐA-Z•]|\\n\\n|$)`, 's'));
          return match ? match[1].trim() : '';
        };
        return {
          id: idx + 1,
          to: getField('КОМУ'),
          date: getField('ДАТА') || today.toLocaleDateString('uk-UA'),
          from: getField('ВІД КОГО') || 'Керівник',
          number: getField('РОЗПОРЯДЖЕННЯ №') || getField('НОМЕР') || String(idx + 1),
          deadline: getField('ТЕРМІН ВИКОНАННЯ'),
          info: getField('ДЛЯ ІНФОРМАЦІЇ'),
          tasks: getField('ЗАВДАННЯ'),
          result: getField('ОЧІКУВАНИЙ ПРОДУКТ \\(РЕЗУЛЬТАТ\\)') || getField('ОЧІКУВАНИЙ ПРОДУКТ'),
          report: getField('ЗВІТ ПРО ВИКОНАННЯ'),
          fullText: cleanText
        };
      });
      setOrders(parsedOrders);
      addMessage('ai', `Сформовано ${parsedOrders.length} розпоряджень. Ви можете переглянути кожне та вивантажити в Excel.`);
      addMessage('orders_list', null);
      addMessage('buttons', null, [{
        text: 'Зберегти все',
        action: 'save',
        icon: 'Save'
      }, {
        text: 'Вивантажити в Excel',
        action: 'export_excel',
        icon: 'Download'
      }, {
        text: 'Скопіювати всі',
        action: 'copy_orders',
        icon: 'Copy'
      }, {
        text: 'Почати спочатку',
        action: 'restart',
        icon: 'RefreshCw'
      }]);
    } catch (error) {
      addMessage('error', 'Помилка генерації: ' + error.message);
    }
    setIsAnalyzing(false);
  };

  // Експорт в Excel
  const exportOrdersToCSV = ordersData => {
    const headers = ['№', 'Кому', 'Дата', 'Від кого', 'Термін', 'Для інформації', 'Завдання', 'Очікуваний продукт', 'Звіт'];
    const csvRows = ordersData.map(o => [o.number, o.to, o.date, o.from, o.deadline, (o.info || '').replace(/\n/g, ' '), (o.tasks || '').replace(/\n/g, ' '), (o.result || '').replace(/\n/g, ' '), (o.report || '').replace(/\n/g, ' ')]);
    const BOM = '\uFEFF';
    return BOM + [headers, ...csvRows].map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(';')).join('\n');
  };
  const downloadCSV = (csvContent, filename) => {
    const blob = new Blob([csvContent], {
      type: 'text/csv;charset=utf-8;'
    });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    toast.success('Файл завантажено!');
  };
  const exportToExcel = () => {
    if (orders.length === 0) {
      toast.warning('Немає розпоряджень для експорту');
      return;
    }
    const csvContent = exportOrdersToCSV(orders);
    downloadCSV(csvContent, `rozporyadzhennya_${new Date().toISOString().split('T')[0]}.csv`);
  };

  // Обробка кнопок
  const handleButton = action => {
    switch (action) {
      case 'understood':
        showSolutions(false);
        break;
      case 'explain_more':
        showSolutions(true);
        break;
      case 'check_seasonality':
      case 'check_holidays':
      case 'check_currency':
      case 'check_anomaly':
      case 'proceed_anyway':
        runAdditionalAnalysis(action);
        break;
      case 'solution_1':
        createPlan('1');
        break;
      case 'solution_2':
        createPlan('2');
        break;
      case 'solution_3':
        createPlan('3');
        break;
      case 'solution_recommended':
        createPlan('recommended');
        break;
      case 'custom_solution':
        setShowCustomInput(true);
        addMessage('system', 'Опишіть ваш варіант рішення:');
        addMessage('custom_input', null);
        break;
      case 'submit_custom':
        if (customSolution.trim()) {
          createCustomPlan(customSolution);
          setShowCustomInput(false);
        }
        break;
      case 'generate_orders':
        generateOrders();
        break;
      case 'export_excel':
        // Експорт розпоряджень в Excel
        if (orders.length > 0) {
          const ordersData = orders.map(o => ({
            '№': o.number,
            'КОМУ': o.to,
            'ДАТА': o.date,
            'ВІД КОГО': o.from,
            'ТЕРМІН ВИКОНАННЯ': o.deadline,
            'ДЛЯ ІНФОРМАЦІЇ': o.info,
            'ЗАВДАННЯ': o.tasks,
            'ОЧІКУВАНИЙ ПРОДУКТ (РЕЗУЛЬТАТ)': o.result,
            'ЗВІТ ПРО ВИКОНАННЯ': o.report
          }));
          const ws = XLSX.utils.json_to_sheet(ordersData);
          ws['!cols'] = [{
            wch: 5
          }, {
            wch: 30
          }, {
            wch: 12
          }, {
            wch: 25
          }, {
            wch: 15
          }, {
            wch: 40
          }, {
            wch: 50
          }, {
            wch: 40
          }, {
            wch: 35
          }];
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Розпорядження');
          XLSX.writeFile(wb, `Розпорядження_${new Date().toLocaleDateString('uk-UA').replace(/\./g, '-')}.xlsx`);
          toast.success('Розпорядження експортовано в Excel!');
        } else {
          exportToExcel();
        }
        break;
      case 'copy_orders':
        const allOrdersText = orders.map(o => o.fullText).join('\n\n========================================\n\n');
        navigator.clipboard.writeText(allOrdersText);
        toast.success('Всі розпорядження скопійовано!');
        break;
      case 'save':
        const fullText = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n\n---\n\n');
        onSaveAnalysis({
          text: fullText,
          content: fullText,
          date: new Date().toISOString(),
          period,
          orders: orders.length > 0 ? orders : null
        });
        break;
      case 'copy':
        const textToCopy = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n\n---\n\n');
        navigator.clipboard.writeText(textToCopy);
        toast.success('Скопійовано!');
        break;
      case 'restart':
        setStep(0);
        setMessages([]);
        setSelectedSolution(null);
        setShowCustomInput(false);
        setCustomSolution('');
        setOrders([]);
        setCurrentPlan('');
        break;
      case 'open_gpt_bottleneck':
        window.open(GPT_BOTTLENECK_URL, '_blank');
        toast.success('Відкрито ChatGPT. Скопіюйте дані з Excel для глибшого аналізу.');
        break;
    }
  };

  // Рендер повідомлення
  const renderMessage = (msg, idx) => {
    if (msg.type === 'buttons') {
      return /*#__PURE__*/React.createElement("div", {
        key: idx,
        className: "flex flex-wrap gap-2 my-4"
      }, msg.buttons.map((btn, i) => {
        const IconComponent = btn.icon ? Icons[btn.icon] : null;
        return /*#__PURE__*/React.createElement("button", {
          key: i,
          onClick: () => handleButton(btn.action),
          disabled: isAnalyzing,
          className: "btn btn-secondary text-sm flex items-center gap-2"
        }, IconComponent && /*#__PURE__*/React.createElement(IconComponent, {
          className: "w-4 h-4"
        }), btn.text);
      }));
    }
    if (msg.type === 'custom_input') {
      return /*#__PURE__*/React.createElement("div", {
        key: idx,
        className: "my-4 p-4 bg-amber-50 border border-amber-200 rounded-2xl"
      }, /*#__PURE__*/React.createElement("textarea", {
        value: customSolution,
        onChange: e => setCustomSolution(e.target.value),
        placeholder: "\u041E\u043F\u0438\u0448\u0456\u0442\u044C \u0432\u0430\u0448 \u0432\u0430\u0440\u0456\u0430\u043D\u0442 \u0440\u0456\u0448\u0435\u043D\u043D\u044F... \u041D\u0430\u043F\u0440\u0438\u043A\u043B\u0430\u0434: \u0425\u043E\u0447\u0443 \u043D\u0430\u0439\u043D\u044F\u0442\u0438 \u0449\u0435 \u043E\u0434\u043D\u043E\u0433\u043E \u043C\u0435\u043D\u0435\u0434\u0436\u0435\u0440\u0430 \u0437 \u043F\u0440\u043E\u0434\u0430\u0436\u0456\u0432 \u0442\u0430 \u043D\u0430\u043B\u0430\u0448\u0442\u0443\u0432\u0430\u0442\u0438 \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u043D\u0443 \u0432\u043E\u0440\u043E\u043D\u043A\u0443 \u0432 CRM",
        className: "w-full p-3 border border-amber-300 rounded-xl text-sm resize-none focus:outline-none focus:ring-2 focus:ring-amber-400",
        rows: 4,
        disabled: isAnalyzing
      }), /*#__PURE__*/React.createElement("div", {
        className: "flex gap-2 mt-3"
      }, /*#__PURE__*/React.createElement("button", {
        onClick: () => handleButton('submit_custom'),
        disabled: isAnalyzing || !customSolution.trim(),
        className: "btn btn-primary text-sm flex items-center gap-2"
      }, isAnalyzing ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.Loader, {
        className: "w-4 h-4"
      }), " \u0410\u043D\u0430\u043B\u0456\u0437\u0443\u044E...") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.FileText, {
        className: "w-4 h-4"
      }), " \u0421\u043A\u043B\u0430\u0441\u0442\u0438 \u043F\u043B\u0430\u043D")), /*#__PURE__*/React.createElement("button", {
        onClick: () => {
          setShowCustomInput(false);
          setMessages(prev => prev.filter(m => m.type !== 'custom_input' && m.content !== 'Опишіть ваш варіант рішення:'));
        },
        disabled: isAnalyzing,
        className: "btn btn-ghost text-sm"
      }, "\u0421\u043A\u0430\u0441\u0443\u0432\u0430\u0442\u0438")));
    }

    // Рендер списку розпоряджень
    if (msg.type === 'orders_list') {
      return /*#__PURE__*/React.createElement("div", {
        key: idx,
        className: "my-4 space-y-3"
      }, /*#__PURE__*/React.createElement("div", {
        className: "flex items-center gap-2 text-sm font-medium text-gray-700"
      }, /*#__PURE__*/React.createElement(Icons.FileText, {
        className: "w-4 h-4"
      }), /*#__PURE__*/React.createElement("span", null, "\u0420\u043E\u0437\u043F\u043E\u0440\u044F\u0434\u0436\u0435\u043D\u043D\u044F (", orders.length, ")")), orders.map((order, i) => /*#__PURE__*/React.createElement("details", {
        key: i,
        className: "group bg-white border border-gray-200 rounded-xl overflow-hidden"
      }, /*#__PURE__*/React.createElement("summary", {
        className: "flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-50 transition-colors"
      }, /*#__PURE__*/React.createElement("div", {
        className: "w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-primary-600 text-white flex items-center justify-center font-bold text-sm"
      }, order.number), /*#__PURE__*/React.createElement("div", {
        className: "flex-1 min-w-0"
      }, /*#__PURE__*/React.createElement("p", {
        className: "font-medium text-gray-900 truncate"
      }, order.to || 'Відповідальний'), /*#__PURE__*/React.createElement("p", {
        className: "text-xs text-gray-500"
      }, "\u0422\u0435\u0440\u043C\u0456\u043D: ", order.deadline || 'Не вказано')), /*#__PURE__*/React.createElement(Icons.ChevronDown, {
        className: "w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform"
      })), /*#__PURE__*/React.createElement("div", {
        className: "p-4 pt-0 border-t border-gray-100 bg-gray-50"
      }, /*#__PURE__*/React.createElement("div", {
        className: "space-y-3 text-sm"
      }, /*#__PURE__*/React.createElement("div", {
        className: "grid grid-cols-2 gap-2 text-xs"
      }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
        className: "text-gray-500"
      }, "\u0414\u0430\u0442\u0430:"), " ", order.date), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("span", {
        className: "text-gray-500"
      }, "\u0412\u0456\u0434:"), " ", order.from)), order.info && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
        className: "text-xs font-medium text-gray-500 mb-1"
      }, "\u0414\u041B\u042F \u0406\u041D\u0424\u041E\u0420\u041C\u0410\u0426\u0406\u0407:"), /*#__PURE__*/React.createElement("p", {
        className: "text-gray-700"
      }, order.info)), order.tasks && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
        className: "text-xs font-medium text-gray-500 mb-1"
      }, "\u0417\u0410\u0412\u0414\u0410\u041D\u041D\u042F:"), /*#__PURE__*/React.createElement("p", {
        className: "text-gray-700 whitespace-pre-wrap"
      }, order.tasks)), order.result && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
        className: "text-xs font-medium text-gray-500 mb-1"
      }, "\u041E\u0427\u0406\u041A\u0423\u0412\u0410\u041D\u0418\u0419 \u041F\u0420\u041E\u0414\u0423\u041A\u0422 (\u0420\u0415\u0417\u0423\u041B\u042C\u0422\u0410\u0422):"), /*#__PURE__*/React.createElement("p", {
        className: "text-gray-700 whitespace-pre-wrap"
      }, order.result)), order.report && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
        className: "text-xs font-medium text-gray-500 mb-1"
      }, "\u0417\u0412\u0406\u0422 \u041F\u0420\u041E \u0412\u0418\u041A\u041E\u041D\u0410\u041D\u041D\u042F:"), /*#__PURE__*/React.createElement("p", {
        className: "text-gray-700"
      }, order.report)), /*#__PURE__*/React.createElement("button", {
        onClick: () => {
          navigator.clipboard.writeText(order.fullText);
          toast.success(`Розпорядження №${order.number} скопійовано!`);
        },
        className: "text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1"
      }, /*#__PURE__*/React.createElement(Icons.Copy, {
        className: "w-3 h-3"
      }), " \u0421\u043A\u043E\u043F\u0456\u044E\u0432\u0430\u0442\u0438"))))));
    }
    const styles = {
      system: 'bg-blue-50 border-blue-200 text-blue-800',
      ai: 'bg-gradient-to-br from-purple-50 to-indigo-50 border-purple-200 text-gray-800',
      user: 'bg-green-50 border-green-200 text-green-800 ml-auto',
      error: 'bg-red-50 border-red-200 text-red-800',
      warning: 'bg-amber-50 border-amber-200 text-amber-800'
    };
    const typeIcons = {
      system: Icons.Settings,
      ai: Icons.Brain,
      user: Icons.User,
      error: Icons.AlertCircle,
      warning: Icons.AlertTriangle
    };
    const TypeIcon = typeIcons[msg.type];
    return /*#__PURE__*/React.createElement("div", {
      key: idx,
      className: `p-4 rounded-2xl border ${styles[msg.type]} animate-fade-in`
    }, msg.type === 'system' && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 mb-2"
    }, /*#__PURE__*/React.createElement(Icons.Loader, {
      className: `w-4 h-4 ${isAnalyzing ? 'animate-spin' : ''}`
    }), /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-sm"
    }, "\u0421\u0438\u0441\u0442\u0435\u043C\u0430")), msg.type === 'ai' && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 mb-2"
    }, /*#__PURE__*/React.createElement(Icons.Brain, {
      className: "w-4 h-4 text-purple-600"
    }), /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-sm text-purple-700"
    }, "AI \u041A\u043E\u043D\u0441\u0443\u043B\u044C\u0442\u0430\u043D\u0442")), msg.type === 'warning' && /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2 mb-2"
    }, /*#__PURE__*/React.createElement(Icons.AlertTriangle, {
      className: "w-4 h-4 text-amber-600"
    }), /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-sm text-amber-700"
    }, "\u0423\u0432\u0430\u0433\u0430")), /*#__PURE__*/React.createElement("div", {
      className: "whitespace-pre-wrap text-sm leading-relaxed"
    }, msg.content));
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, step === 0 && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3 mb-4"
  }, /*#__PURE__*/React.createElement("label", {
    className: "text-sm font-medium text-gray-700"
  }, t.analysisPeriod, ":"), /*#__PURE__*/React.createElement("select", {
    value: period,
    onChange: e => setPeriod(Number(e.target.value)),
    className: "select-field w-auto"
  }, /*#__PURE__*/React.createElement("option", {
    value: 3
  }, "3 ", t.lastWeeks), /*#__PURE__*/React.createElement("option", {
    value: 5
  }, "5 ", t.lastWeeks), /*#__PURE__*/React.createElement("option", {
    value: 7
  }, "7 ", t.lastWeeks), /*#__PURE__*/React.createElement("option", {
    value: 10
  }, "10 ", t.lastWeeks))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.additionalFocus), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: additionalFocus,
    onChange: e => setAdditionalFocus(e.target.value),
    className: "input-field",
    placeholder: t.additionalFocusPlaceholder
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: startAnalysis,
    disabled: isAnalyzing,
    className: "btn btn-ai flex-1"
  }, isAnalyzing ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.Loader, {
    className: "w-5 h-5"
  }), t.analyzing) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.Brain, {
    className: "w-5 h-5"
  }), t.runAnalysis)), savedAnalyses?.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowHistory(!showHistory),
    className: "btn btn-secondary"
  }, /*#__PURE__*/React.createElement(Icons.History, {
    className: "w-5 h-5"
  }))), showHistory && savedAnalyses?.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 p-4 bg-gray-50 rounded-xl"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-gray-700 mb-2"
  }, t.analysisHistory), savedAnalyses.slice(0, 5).map((analysis, i) => /*#__PURE__*/React.createElement("details", {
    key: i,
    className: "group bg-white rounded-lg overflow-hidden border border-gray-100"
  }, /*#__PURE__*/React.createElement("summary", {
    className: "p-3 cursor-pointer hover:bg-gray-50 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-sm font-medium text-gray-900"
  }, new Date(analysis.date).toLocaleDateString('uk-UA')), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", null, analysis.period, " \u0442\u0438\u0436\u043D\u0456\u0432"), analysis.orders?.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "text-primary-600"
  }, "\u2022 ", analysis.orders.length, " \u0440\u043E\u0437\u043F\u043E\u0440\u044F\u0434\u0436\u0435\u043D\u044C"))), /*#__PURE__*/React.createElement(Icons.ChevronDown, {
    className: "w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform"
  })), /*#__PURE__*/React.createElement("div", {
    className: "p-3 pt-0 border-t border-gray-100 bg-gray-50"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-600 whitespace-pre-wrap max-h-40 overflow-y-auto"
  }, analysis.text?.substring(0, 500), "..."), analysis.orders?.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mt-2 flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const csv = exportOrdersToCSV(analysis.orders);
      downloadCSV(csv, `rozporyadzhennya_${new Date(analysis.date).toISOString().split('T')[0]}.csv`);
    },
    className: "text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.Download, {
    className: "w-3 h-3"
  }), " Excel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      navigator.clipboard.writeText(analysis.orders.map(o => o.fullText).join('\n\n===\n\n'));
      toast.success('Скопійовано!');
    },
    className: "text-xs text-gray-600 hover:text-gray-700 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.Copy, {
    className: "w-3 h-3"
  }), " \u041A\u043E\u043F\u0456\u044E\u0432\u0430\u0442\u0438")))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl border border-purple-100"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-bold text-purple-900 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Brain, {
    className: "w-5 h-5"
  }), " \u042F\u043A \u043F\u0440\u0430\u0446\u044E\u0454 AI-\u043A\u043E\u043D\u0441\u0443\u043B\u044C\u0442\u0430\u043D\u0442:"), /*#__PURE__*/React.createElement("ol", {
    className: "text-sm text-purple-800 space-y-1"
  }, /*#__PURE__*/React.createElement("li", null, /*#__PURE__*/React.createElement("strong", null, "1."), " \u0412\u0438\u0437\u043D\u0430\u0447\u0430\u044E \u0432\u0443\u0437\u044C\u043A\u0435 \u043C\u0456\u0441\u0446\u0435 \u0442\u0430 \u043F\u043E\u044F\u0441\u043D\u044E \u043F\u0440\u0438\u0447\u0438\u043D\u0438"), /*#__PURE__*/React.createElement("li", null, /*#__PURE__*/React.createElement("strong", null, "2."), " \u0417\u0430\u043F\u0440\u043E\u043F\u043E\u043D\u0443\u044E 3 \u0432\u0430\u0440\u0456\u0430\u043D\u0442\u0438 \u0440\u0456\u0448\u0435\u043D\u043D\u044F \u0437 ROI"), /*#__PURE__*/React.createElement("li", null, /*#__PURE__*/React.createElement("strong", null, "3."), " \u0421\u043A\u043B\u0430\u0434\u0443 \u043F\u0440\u043E\u0433\u0440\u0430\u043C\u0443 \u0434\u0456\u0439 \u0437 \u043A\u043E\u043D\u043A\u0440\u0435\u0442\u043D\u0438\u043C\u0438 \u0437\u0430\u0432\u0434\u0430\u043D\u043D\u044F\u043C\u0438"), /*#__PURE__*/React.createElement("li", null, /*#__PURE__*/React.createElement("strong", null, "4."), " \u0421\u0444\u043E\u0440\u043C\u0443\u044E \u0440\u043E\u0437\u043F\u043E\u0440\u044F\u0434\u0436\u0435\u043D\u043D\u044F \u0434\u043B\u044F \u043A\u043E\u043C\u0430\u043D\u0434\u0438 (Excel)")), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-purple-600 mt-2 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.Clock, {
    className: "w-3 h-3"
  }), " \u0412\u0435\u0441\u044C \u043F\u0440\u043E\u0446\u0435\u0441 \u0437\u0430\u0439\u043C\u0430\u0454 5-7 \u0445\u0432\u0438\u043B\u0438\u043D"))), step > 0 && /*#__PURE__*/React.createElement("div", {
    className: "space-y-3 overflow-y-auto pr-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 p-3 bg-gray-100 rounded-xl sticky top-0 z-10"
  }, /*#__PURE__*/React.createElement("div", {
    className: `w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${step >= 1 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`
  }, "1"), /*#__PURE__*/React.createElement("div", {
    className: `flex-1 h-1 rounded ${step >= 2 ? 'bg-purple-500' : 'bg-gray-300'}`
  }), /*#__PURE__*/React.createElement("div", {
    className: `w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${step >= 2 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`
  }, "2"), /*#__PURE__*/React.createElement("div", {
    className: `flex-1 h-1 rounded ${step >= 3 ? 'bg-purple-500' : 'bg-gray-300'}`
  }), /*#__PURE__*/React.createElement("div", {
    className: `w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${step >= 3 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`
  }, "3"), /*#__PURE__*/React.createElement("div", {
    className: `flex-1 h-1 rounded ${step >= 4 ? 'bg-purple-500' : 'bg-gray-300'}`
  }), /*#__PURE__*/React.createElement("div", {
    className: `w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${step >= 4 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`
  }, "4")), isAnalyzing && /*#__PURE__*/React.createElement(AIProgressIndicator, {
    stage: aiStage,
    stages: AI_STAGES
  }), messages.map((msg, idx) => renderMessage(msg, idx)), /*#__PURE__*/React.createElement("div", {
    ref: chatEndRef
  })));
};

// ==================== PLANS VIEW ====================
const PlansView = ({
  savedAnalyses,
  onDelete,
  onExportExcel,
  toast,
  t
}) => {
  const [expandedPlan, setExpandedPlan] = useState(null);
  const [expandedOrder, setExpandedOrder] = useState(null);
  const exportOrdersToCSV = ordersData => {
    const headers = ['№', 'Кому', 'Дата', 'Від кого', 'Термін', 'Для інформації', 'Завдання', 'Очікуваний продукт', 'Звіт'];
    const csvRows = ordersData.map(o => [o.number, o.to, o.date, o.from, o.deadline, (o.info || '').replace(/\n/g, ' '), (o.tasks || '').replace(/\n/g, ' '), (o.result || '').replace(/\n/g, ' '), (o.report || '').replace(/\n/g, ' ')]);
    const BOM = '\uFEFF';
    return BOM + [headers, ...csvRows].map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(';')).join('\n');
  };
  const downloadCSV = (csvContent, filename) => {
    const blob = new Blob([csvContent], {
      type: 'text/csv;charset=utf-8;'
    });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    toast.success('Файл завантажено!');
  };
  if (!savedAnalyses?.length) {
    return /*#__PURE__*/React.createElement("div", {
      className: "text-center py-16"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-20 h-20 mx-auto mb-6 rounded-3xl bg-gradient-to-br from-purple-100 to-indigo-100 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement(Icons.FileText, {
      className: "w-10 h-10 text-purple-400"
    })), /*#__PURE__*/React.createElement("h3", {
      className: "text-xl font-bold text-gray-900 mb-2"
    }, "\u041F\u043B\u0430\u043D\u0456\u0432 \u0449\u0435 \u043D\u0435\u043C\u0430\u0454"), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-500 mb-6"
    }, "\u0417\u0430\u043F\u0443\u0441\u0442\u0456\u0442\u044C AI-\u0430\u043D\u0430\u043B\u0456\u0437 \u0449\u043E\u0431 \u043E\u0442\u0440\u0438\u043C\u0430\u0442\u0438 \u043F\u0435\u0440\u0448\u0438\u0439 \u043F\u043B\u0430\u043D"));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-4"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-xl font-bold text-gray-900 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.FileText, {
    className: "w-6 h-6 text-primary-600"
  }), "\u0417\u0431\u0435\u0440\u0435\u0436\u0435\u043D\u0456 \u043F\u043B\u0430\u043D\u0438"), /*#__PURE__*/React.createElement("span", {
    className: "badge badge-primary"
  }, savedAnalyses.length)), savedAnalyses.map((analysis, idx) => /*#__PURE__*/React.createElement("div", {
    key: idx,
    className: "card overflow-hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 cursor-pointer hover:bg-gray-50 transition-colors",
    onClick: () => setExpandedPlan(expandedPlan === idx ? null : idx)
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-500 text-white flex items-center justify-center font-bold"
  }, idx + 1), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-gray-900"
  }, new Date(analysis.date).toLocaleDateString('uk-UA', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  })), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500 flex items-center gap-3"
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.Calendar, {
    className: "w-3 h-3"
  }), analysis.period, " \u0442\u0438\u0436\u043D\u0456\u0432"), analysis.orders?.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-1 text-primary-600"
  }, /*#__PURE__*/React.createElement(Icons.FileText, {
    className: "w-3 h-3"
  }), analysis.orders.length, " \u0440\u043E\u0437\u043F\u043E\u0440\u044F\u0434\u0436\u0435\u043D\u044C"))), /*#__PURE__*/React.createElement(Icons.ChevronDown, {
    className: `w-5 h-5 text-gray-400 transition-transform ${expandedPlan === idx ? 'rotate-180' : ''}`
  }))), expandedPlan === idx && /*#__PURE__*/React.createElement("div", {
    className: "border-t border-gray-100"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gray-50 flex flex-wrap gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      navigator.clipboard.writeText(analysis.text);
      toast.success('План скопійовано!');
    },
    className: "btn btn-secondary text-sm flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Copy, {
    className: "w-4 h-4"
  }), " \u041A\u043E\u043F\u0456\u044E\u0432\u0430\u0442\u0438 \u043F\u043B\u0430\u043D"), analysis.orders?.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      const csv = exportOrdersToCSV(analysis.orders);
      downloadCSV(csv, `rozporyadzhennya_${new Date(analysis.date).toISOString().split('T')[0]}.csv`);
    },
    className: "btn btn-primary text-sm flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Download, {
    className: "w-4 h-4"
  }), " Excel \u0440\u043E\u0437\u043F\u043E\u0440\u044F\u0434\u0436\u0435\u043D\u044C"), /*#__PURE__*/React.createElement("button", {
    onClick: () => onDelete(idx),
    className: "btn btn-ghost text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Trash, {
    className: "w-4 h-4"
  }), " \u0412\u0438\u0434\u0430\u043B\u0438\u0442\u0438")), /*#__PURE__*/React.createElement("div", {
    className: "p-4"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-gray-700 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Brain, {
    className: "w-4 h-4 text-purple-600"
  }), "\u041F\u0440\u043E\u0433\u0440\u0430\u043C\u0430 \u0434\u0456\u0439"), /*#__PURE__*/React.createElement("div", {
    className: "bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-4 text-sm text-gray-700 whitespace-pre-wrap max-h-80 overflow-y-auto"
  }, analysis.text)), analysis.orders?.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "p-4 border-t border-gray-100"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-gray-700 mb-3 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.FileText, {
    className: "w-4 h-4 text-primary-600"
  }), "\u0420\u043E\u0437\u043F\u043E\u0440\u044F\u0434\u0436\u0435\u043D\u043D\u044F (", analysis.orders.length, ")"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, analysis.orders.map((order, orderIdx) => /*#__PURE__*/React.createElement("details", {
    key: orderIdx,
    className: "group bg-white border border-gray-200 rounded-xl overflow-hidden"
  }, /*#__PURE__*/React.createElement("summary", {
    className: "flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 transition-colors"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-primary-600 text-white flex items-center justify-center font-bold text-sm"
  }, order.number), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-medium text-gray-900 truncate text-sm"
  }, order.to || 'Відповідальний'), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, "\u0422\u0435\u0440\u043C\u0456\u043D: ", order.deadline || 'Не вказано')), /*#__PURE__*/React.createElement(Icons.ChevronDown, {
    className: "w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform"
  })), /*#__PURE__*/React.createElement("div", {
    className: "p-3 pt-0 border-t border-gray-100 bg-gray-50 text-sm space-y-2"
  }, order.tasks && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-medium text-gray-500"
  }, "\u0417\u0410\u0412\u0414\u0410\u041D\u041D\u042F:"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-700 whitespace-pre-wrap"
  }, order.tasks)), order.result && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-medium text-gray-500"
  }, "\u041F\u0420\u041E\u0414\u0423\u041A\u0422:"), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-700 whitespace-pre-wrap"
  }, order.result)), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      navigator.clipboard.writeText(order.fullText);
      toast.success(`Розпорядження №${order.number} скопійовано!`);
    },
    className: "text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.Copy, {
    className: "w-3 h-3"
  }), " \u0421\u043A\u043E\u043F\u0456\u044E\u0432\u0430\u0442\u0438"))))))))));
};

// ==================== TRENDS CHART ====================
const TrendsChart = ({
  columns,
  rows,
  periodType = 'weekly',
  t
}) => {
  const chartRef = React.useRef(null);
  const chartInstance = React.useRef(null);
  const [selectedColumns, setSelectedColumns] = useState([]);
  const [chartType, setChartType] = useState('line');

  // Фільтруємо колонки по періоду
  const periodColumns = useMemo(() => columns.filter(c => c.period === periodType), [columns, periodType]);
  const periodRows = useMemo(() => rows.filter(r => !r.isTarget && r.periodType === periodType).sort((a, b) => a.date?.localeCompare(b.date)), [rows, periodType]);

  // Ініціалізуємо вибрані колонки (перші 3) - тільки коли змінюється periodType
  useEffect(() => {
    if (periodColumns.length > 0) {
      setSelectedColumns(periodColumns.slice(0, 3).map(c => c.id));
    } else {
      setSelectedColumns([]);
    }
  }, [periodType, columns.length]);

  // Кольори для графіків
  const colors = [{
    bg: 'rgba(34, 197, 94, 0.2)',
    border: '#22c55e'
  }, {
    bg: 'rgba(59, 130, 246, 0.2)',
    border: '#3b82f6'
  }, {
    bg: 'rgba(239, 68, 68, 0.2)',
    border: '#ef4444'
  }, {
    bg: 'rgba(168, 85, 247, 0.2)',
    border: '#a855f7'
  }, {
    bg: 'rgba(245, 158, 11, 0.2)',
    border: '#f59e0b'
  }, {
    bg: 'rgba(20, 184, 166, 0.2)',
    border: '#14b8a6'
  }];

  // Форматування дати для лейблів
  const formatLabel = date => {
    if (!date) return '';
    if (periodType === 'monthly') {
      const [year, month] = date.split('-');
      const months = ['Січ', 'Лют', 'Бер', 'Кві', 'Тра', 'Чер', 'Лип', 'Сер', 'Вер', 'Жов', 'Лис', 'Гру'];
      return `${months[parseInt(month) - 1]} ${year.slice(2)}`;
    }
    // Тижневий формат
    const d = new Date(date);
    return `${d.getDate().toString().padStart(2, '0')}.${(d.getMonth() + 1).toString().padStart(2, '0')}`;
  };

  // Створюємо/оновлюємо графік
  useEffect(() => {
    if (!chartRef.current || selectedColumns.length === 0 || periodRows.length === 0) return;

    // Знищуємо попередній графік
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }
    const labels = periodRows.map(r => formatLabel(r.date));
    const datasets = selectedColumns.map((colId, idx) => {
      const col = periodColumns.find(c => c.id === colId);
      const color = colors[idx % colors.length];
      return {
        label: col?.name || colId,
        data: periodRows.map(r => parseFloat(r.values?.[colId]) || 0),
        backgroundColor: color.bg,
        borderColor: color.border,
        borderWidth: 2,
        tension: 0.3,
        fill: chartType === 'line',
        pointRadius: 4,
        pointHoverRadius: 6
      };
    });
    chartInstance.current = new Chart(chartRef.current, {
      type: chartType === 'bar' ? 'bar' : 'line',
      data: {
        labels,
        datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              font: {
                family: 'Inter'
              },
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: '#1f2937',
            titleFont: {
              family: 'Inter'
            },
            bodyFont: {
              family: 'Inter'
            },
            padding: 12,
            cornerRadius: 8
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: '#f3f4f6'
            },
            ticks: {
              font: {
                family: 'Inter'
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                family: 'Inter'
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });

    // Cleanup при демонтуванні
    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
        chartInstance.current = null;
      }
    };
  }, [selectedColumns, periodRows, chartType]);
  const toggleColumn = colId => {
    if (selectedColumns.includes(colId)) {
      setSelectedColumns(selectedColumns.filter(id => id !== colId));
    } else if (selectedColumns.length < 6) {
      setSelectedColumns([...selectedColumns, colId]);
    }
  };
  if (periodColumns.length === 0) {
    return /*#__PURE__*/React.createElement("div", {
      className: "text-center py-8 text-gray-500"
    }, /*#__PURE__*/React.createElement(Icons.BarChart, {
      className: "w-12 h-12 mx-auto mb-3 text-gray-300"
    }), /*#__PURE__*/React.createElement("p", null, "\u041D\u0435\u043C\u0430\u0454 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432 \u0434\u043B\u044F ", periodType === 'weekly' ? 'тижневого' : 'місячного', " \u0433\u0440\u0430\u0444\u0456\u043A\u0443"));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "flex flex-col h-full gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, periodColumns.map((col, idx) => /*#__PURE__*/React.createElement("button", {
    key: col.id,
    onClick: () => toggleColumn(col.id),
    className: `px-3 py-1.5 rounded-full text-xs font-medium transition-all ${selectedColumns.includes(col.id) ? 'text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`,
    style: selectedColumns.includes(col.id) ? {
      backgroundColor: colors[selectedColumns.indexOf(col.id) % colors.length].border
    } : {},
    title: col.inverted ? "Від'ємний показник (чим менше - тим краще)" : col.name
  }, col.inverted && /*#__PURE__*/React.createElement("span", {
    className: "mr-1"
  }, "\u2193"), col.name))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setChartType('line'),
    className: `px-3 py-1.5 rounded-lg text-xs font-medium ${chartType === 'line' ? 'bg-primary-500 text-white' : 'bg-gray-100 text-gray-600'}`
  }, /*#__PURE__*/React.createElement(Icons.TrendingUp, {
    className: "w-3.5 h-3.5"
  }), " \u041B\u0456\u043D\u0456\u0439\u043D\u0438\u0439"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setChartType('bar'),
    className: `px-3 py-1.5 rounded-lg text-xs font-medium flex items-center gap-1 ${chartType === 'bar' ? 'bg-primary-500 text-white' : 'bg-gray-100 text-gray-600'}`
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-3.5 h-3.5"
  }), " \u0421\u0442\u043E\u0432\u043F\u0447\u0438\u043A\u043E\u0432\u0438\u0439")), /*#__PURE__*/React.createElement("div", {
    className: "bg-white rounded-2xl p-4 border border-gray-100 flex-1 min-h-[300px] sm:min-h-[400px] md:min-h-[500px]"
  }, selectedColumns.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "h-full flex items-center justify-center text-gray-400"
  }, "\u0412\u0438\u0431\u0435\u0440\u0456\u0442\u044C \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0438 \u0434\u043B\u044F \u0432\u0456\u0434\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u043D\u044F") : /*#__PURE__*/React.createElement("canvas", {
    ref: chartRef
  })), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400 text-center"
  }, "\u0412\u0438\u0431\u0435\u0440\u0456\u0442\u044C \u0434\u043E 6 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432 \u0434\u043B\u044F \u043F\u043E\u0440\u0456\u0432\u043D\u044F\u043D\u043D\u044F \u0442\u0440\u0435\u043D\u0434\u0456\u0432"));
};

// ==================== PDF EXPORT ====================
const PDFExport = ({
  columns,
  rows,
  companyName,
  aiSettings,
  t
}) => {
  const [isGenerating, setIsGenerating] = useState(false);
  const [reportType, setReportType] = useState('full'); // full, weekly, monthly
  const [includeCharts, setIncludeCharts] = useState(true);
  const generatePDF = async () => {
    setIsGenerating(true);
    try {
      const {
        jsPDF
      } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      // Шрифт (без кирилиці краще, але спробуємо)
      doc.setFont('helvetica');
      let y = 20;
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 15;
      const contentWidth = pageWidth - margin * 2;

      // Заголовок
      doc.setFontSize(20);
      doc.setTextColor(34, 197, 94);
      doc.text(companyName || 'Stats Report', margin, y);
      y += 10;

      // Дата звіту
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text(`Report: ${new Date().toLocaleDateString('uk-UA')}`, margin, y);
      y += 15;

      // Фільтруємо дані по типу звіту
      const weeklyColumns = columns.filter(c => c.period === 'weekly');
      const monthlyColumns = columns.filter(c => c.period === 'monthly');
      const weeklyRows = rows.filter(r => !r.isTarget && r.periodType === 'weekly').sort((a, b) => b.date?.localeCompare(a.date));
      const monthlyRows = rows.filter(r => !r.isTarget && r.periodType === 'monthly').sort((a, b) => b.date?.localeCompare(a.date));

      // Тижневі дані
      if ((reportType === 'full' || reportType === 'weekly') && weeklyColumns.length > 0 && weeklyRows.length > 0) {
        doc.setFontSize(14);
        doc.setTextColor(30, 30, 30);
        doc.text('Weekly Statistics', margin, y);
        y += 8;

        // Таблиця
        const weeklyHeaders = ['Period', ...weeklyColumns.slice(0, 6).map(c => c.inverted ? `↓${c.name.substring(0, 10)}` : c.name.substring(0, 12))];
        const weeklyData = weeklyRows.slice(0, 10).map(row => {
          const period = row.date || '-';
          const values = weeklyColumns.slice(0, 6).map(col => {
            const val = row.values?.[col.id];
            return val !== undefined ? val.toString() : '-';
          });
          return [period, ...values];
        });
        doc.autoTable({
          startY: y,
          head: [weeklyHeaders],
          body: weeklyData,
          margin: {
            left: margin,
            right: margin
          },
          styles: {
            fontSize: 8,
            cellPadding: 2
          },
          headStyles: {
            fillColor: [34, 197, 94],
            textColor: 255
          },
          alternateRowStyles: {
            fillColor: [245, 247, 250]
          }
        });
        y = doc.lastAutoTable.finalY + 15;
      }

      // Місячні дані
      if ((reportType === 'full' || reportType === 'monthly') && monthlyColumns.length > 0 && monthlyRows.length > 0) {
        // Перевірка чи потрібна нова сторінка
        if (y > 250) {
          doc.addPage();
          y = 20;
        }
        doc.setFontSize(14);
        doc.setTextColor(30, 30, 30);
        doc.text('Monthly Statistics', margin, y);
        y += 8;
        const monthlyHeaders = ['Period', ...monthlyColumns.slice(0, 6).map(c => c.inverted ? `↓${c.name.substring(0, 10)}` : c.name.substring(0, 12))];
        const monthlyData = monthlyRows.slice(0, 12).map(row => {
          const period = row.date || '-';
          const values = monthlyColumns.slice(0, 6).map(col => {
            const val = row.values?.[col.id];
            return val !== undefined ? val.toString() : '-';
          });
          return [period, ...values];
        });
        doc.autoTable({
          startY: y,
          head: [monthlyHeaders],
          body: monthlyData,
          margin: {
            left: margin,
            right: margin
          },
          styles: {
            fontSize: 8,
            cellPadding: 2
          },
          headStyles: {
            fillColor: [59, 130, 246],
            textColor: 255
          },
          alternateRowStyles: {
            fillColor: [245, 247, 250]
          }
        });
        y = doc.lastAutoTable.finalY + 15;
      }

      // Підсумок
      if (y > 250) {
        doc.addPage();
        y = 20;
      }
      doc.setFontSize(12);
      doc.setTextColor(30, 30, 30);
      doc.text('Summary', margin, y);
      y += 8;
      doc.setFontSize(9);
      doc.setTextColor(80, 80, 80);
      doc.text(`Total indicators: ${columns.length}`, margin, y);
      y += 5;
      doc.text(`Weekly: ${weeklyColumns.length} indicators, ${weeklyRows.length} periods`, margin, y);
      y += 5;
      doc.text(`Monthly: ${monthlyColumns.length} indicators, ${monthlyRows.length} periods`, margin, y);
      y += 10;

      // Футер
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Page ${i} of ${pageCount} | Generated by Stats Tracker`, pageWidth / 2, doc.internal.pageSize.getHeight() - 10, {
          align: 'center'
        });
      }

      // Зберігаємо
      const fileName = `${companyName || 'stats'}_report_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
    } catch (error) {
      console.error('PDF generation error:', error);
      alert('Error generating PDF');
    } finally {
      setIsGenerating(false);
    }
  };
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, "\u0422\u0438\u043F \u0437\u0432\u0456\u0442\u0443"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, [{
    id: 'full',
    label: 'Повний',
    desc: 'Тижневі + місячні',
    icon: 'FileText'
  }, {
    id: 'weekly',
    label: 'Тижневий',
    desc: 'Тільки тижневі',
    icon: 'Calendar'
  }, {
    id: 'monthly',
    label: 'Місячний',
    desc: 'Тільки місячні',
    icon: 'BarChart'
  }].map(type => {
    const IconComponent = Icons[type.icon];
    return /*#__PURE__*/React.createElement("button", {
      key: type.id,
      onClick: () => setReportType(type.id),
      className: `flex-1 p-3 rounded-xl border-2 transition-all ${reportType === type.id ? 'border-primary-500 bg-primary-50' : 'border-gray-200 hover:border-gray-300'}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-medium text-sm flex items-center justify-center gap-1"
    }, /*#__PURE__*/React.createElement(IconComponent, {
      className: "w-4 h-4"
    }), type.label), /*#__PURE__*/React.createElement("div", {
      className: "text-xs text-gray-500"
    }, type.desc));
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: generatePDF,
    disabled: isGenerating,
    className: "btn btn-primary w-full"
  }, isGenerating ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.Loader, {
    className: "w-4 h-4 animate-spin"
  }), "\u0413\u0435\u043D\u0435\u0440\u0430\u0446\u0456\u044F...") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.FileText, {
    className: "w-4 h-4"
  }), "\u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0438\u0442\u0438 PDF")), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400 text-center"
  }, "PDF \u0431\u0443\u0434\u0435 \u043C\u0456\u0441\u0442\u0438\u0442\u0438 \u0442\u0430\u0431\u043B\u0438\u0446\u0456 \u0437 \u0434\u0430\u043D\u0438\u043C\u0438 \u0442\u0430 \u043F\u0456\u0434\u0441\u0443\u043C\u043E\u043A"));
};

// ==================== CHANGE HISTORY ====================
const ChangeHistory = ({
  companyId,
  t
}) => {
  const [history, setHistory] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all'); // all, columns, rows, settings

  // Завантажуємо історію змін
  useEffect(() => {
    if (!companyId) return;
    const loadHistory = async () => {
      setLoading(true);
      try {
        const snapshot = await db.collection('companies').doc(companyId).collection('history').orderBy('timestamp', 'desc').limit(50).get();
        const historyData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setHistory(historyData);
      } catch (e) {
        console.error('Error loading history:', e);
      } finally {
        setLoading(false);
      }
    };
    loadHistory();
  }, [companyId]);
  const getActionIcon = action => {
    switch (action) {
      case 'create':
        return /*#__PURE__*/React.createElement(Icons.Plus, {
          className: "w-4 h-4 text-green-500"
        });
      case 'update':
        return /*#__PURE__*/React.createElement(Icons.Edit, {
          className: "w-4 h-4 text-blue-500"
        });
      case 'delete':
        return /*#__PURE__*/React.createElement(Icons.Trash, {
          className: "w-4 h-4 text-red-500"
        });
      case 'import':
        return /*#__PURE__*/React.createElement(Icons.Upload, {
          className: "w-4 h-4 text-purple-500"
        });
      case 'restore':
        return /*#__PURE__*/React.createElement(Icons.Undo, {
          className: "w-4 h-4 text-amber-500"
        });
      default:
        return /*#__PURE__*/React.createElement(Icons.Activity, {
          className: "w-4 h-4 text-gray-500"
        });
    }
  };
  const getActionLabel = action => {
    switch (action) {
      case 'create':
        return 'Створено';
      case 'update':
        return 'Оновлено';
      case 'delete':
        return 'Видалено';
      case 'import':
        return 'Імпорт';
      case 'restore':
        return 'Відновлено';
      default:
        return action;
    }
  };
  const formatTimestamp = timestamp => {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleString('uk-UA', {
      day: '2-digit',
      month: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  };
  const filteredHistory = filter === 'all' ? history : history.filter(h => h.type === filter);
  if (loading) {
    return /*#__PURE__*/React.createElement("div", {
      className: "text-center py-8"
    }, /*#__PURE__*/React.createElement(Icons.Loader, {
      className: "w-8 h-8 mx-auto text-gray-300 animate-spin"
    }), /*#__PURE__*/React.createElement("p", {
      className: "text-gray-500 mt-2"
    }, "\u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F \u0456\u0441\u0442\u043E\u0440\u0456\u0457..."));
  }
  return /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 overflow-x-auto pb-2"
  }, [{
    id: 'all',
    label: 'Всі'
  }, {
    id: 'columns',
    label: 'Показники'
  }, {
    id: 'rows',
    label: 'Записи'
  }, {
    id: 'settings',
    label: 'Налаштування'
  }].map(f => /*#__PURE__*/React.createElement("button", {
    key: f.id,
    onClick: () => setFilter(f.id),
    className: `px-3 py-1.5 rounded-full text-xs font-medium whitespace-nowrap ${filter === f.id ? 'bg-primary-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
  }, f.label))), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 max-h-96 overflow-y-auto"
  }, filteredHistory.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement(Icons.Clock, {
    className: "w-12 h-12 mx-auto mb-3 text-gray-300"
  }), /*#__PURE__*/React.createElement("p", null, "\u0406\u0441\u0442\u043E\u0440\u0456\u044F \u0437\u043C\u0456\u043D \u043F\u043E\u0440\u043E\u0436\u043D\u044F"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs mt-1"
  }, "\u0417\u043C\u0456\u043D\u0438 \u0431\u0443\u0434\u0443\u0442\u044C \u0432\u0456\u0434\u043E\u0431\u0440\u0430\u0436\u0430\u0442\u0438\u0441\u044F \u0442\u0443\u0442")) : filteredHistory.map(item => /*#__PURE__*/React.createElement("div", {
    key: item.id,
    className: "flex items-start gap-3 p-3 bg-gray-50 rounded-xl"
  }, /*#__PURE__*/React.createElement("div", {
    className: "mt-0.5"
  }, getActionIcon(item.action)), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-w-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium text-sm text-gray-900"
  }, getActionLabel(item.action)), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-400"
  }, item.type)), item.details && /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-600 mt-0.5 truncate"
  }, item.details), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mt-1 text-xs text-gray-400"
  }, /*#__PURE__*/React.createElement("span", null, formatTimestamp(item.timestamp)), item.userName && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("span", null, "\u2022"), /*#__PURE__*/React.createElement("span", null, item.userName))))))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400 text-center"
  }, "\u041F\u043E\u043A\u0430\u0437\u0430\u043D\u0456 \u043E\u0441\u0442\u0430\u043D\u043D\u0456 50 \u0437\u043C\u0456\u043D"));
};

// Функція для запису в історію (для використання в App)
const logChange = async (db, companyId, userId, userName, action, type, details) => {
  try {
    await db.collection('companies').doc(companyId).collection('history').add({
      action,
      type,
      details,
      userId,
      userName,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch (e) {
    console.error('Error logging change:', e);
  }
};

// ==================== MAIN APP ====================
const App = () => {
  const toast = useToast();

  // Auth state
  const [user, setUser] = useState(null);
  const [userProfile, setUserProfile] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [dataLoaded, setDataLoaded] = useState(false); // Флаг що дані завантажені

  // Data state
  const [columns, setColumns] = useState([]);
  const [rows, setRows] = useState([]);
  const [employees, setEmployees] = useState({});
  const [aiSettings, setAiSettings] = useState({
    businessContext: '',
    priorities: '',
    analysisPeriod: 5
  });
  const [weekStartDay, setWeekStartDayState] = useState(() => {
    try {
      const stored = localStorage.getItem('weekStartDay');
      return stored !== null ? parseInt(stored) : 1;
    } catch {
      return 1;
    }
  });
  const [, forceUpdate] = useState(0); // Для форсування ререндеру

  // Зберігаємо weekStartDay в localStorage і оновлюємо глобальний кеш
  const setWeekStartDay = day => {
    setWeekStartDayState(day);
    try {
      localStorage.setItem('weekStartDay', day.toString());
    } catch {}
    updateWeeksCache(day); // Оновлюємо глобальний кеш
    forceUpdate(n => n + 1); // Форсуємо ререндер
  };
  const [savedAnalyses, setSavedAnalyses] = useState([]);

  // UI state
  const [language, setLanguage] = useState('uk');
  const [saveStatus, setSaveStatus] = useState(null);
  const [showMenu, setShowMenu] = useState(false);
  const [activeTab, setActiveTab] = useState('stats');
  const [showQuickActions, setShowQuickActions] = useState(false);
  const [showAddStatsModal, setShowAddStatsModal] = useState(false);
  const [showAddPeriodModal, setShowAddPeriodModal] = useState(false);
  const [addPeriodType, setAddPeriodType] = useState('weekly');
  const [selectedAddPeriod, setSelectedAddPeriod] = useState('');
  const [showEditColumnModal, setShowEditColumnModal] = useState(false);
  const [showTeamModal, setShowTeamModal] = useState(false);
  const [showAddEmployeeModal, setShowAddEmployeeModal] = useState(false);
  const [showAIModal, setShowAIModal] = useState(false);
  const [showDemoModal, setShowDemoModal] = useState(false);
  const [showTrendsModal, setShowTrendsModal] = useState(false);
  const [showPDFModal, setShowPDFModal] = useState(false);
  const [showHistoryModal, setShowHistoryModal] = useState(false);
  const [showCompareModal, setShowCompareModal] = useState(false); // Порівняння періодів
  const [showAlertsModal, setShowAlertsModal] = useState(false); // Панель алертів
  const [trendsPeriodType, setTrendsPeriodType] = useState('weekly');
  const [comparePeriodType, setComparePeriodType] = useState('weekly'); // Тип періоду для порівняння
  const [showToolsDropdown, setShowToolsDropdown] = useState(false);
  const [confirmDialog, setConfirmDialog] = useState({
    isOpen: false
  });
  const [editingColumn, setEditingColumn] = useState(null);
  const [companyId, setCompanyId] = useState(null);
  const [companyName, setCompanyName] = useState('');

  // Search & Filter state
  const [searchQuery, setSearchQuery] = useState('');
  const [filterResponsible, setFilterResponsible] = useState('');
  const [showFilters, setShowFilters] = useState(false);

  // Form state
  const [newStatsName, setNewStatsName] = useState('');
  const [newStatsResponsible, setNewStatsResponsible] = useState('');
  const [newStatsPeriod, setNewStatsPeriod] = useState('weekly');
  const [newStatsTarget, setNewStatsTarget] = useState('');
  const [newStatsFormat, setNewStatsFormat] = useState('number'); // number, percent, uah, usd, eur
  const [newStatsImportance, setNewStatsImportance] = useState('medium'); // critical, high, medium, low
  const [newStatsInverted, setNewStatsInverted] = useState(false); // Від'ємний показник (чим менше тим краще)
  const [newEmployeeEmail, setNewEmployeeEmail] = useState('');
  const [newEmployeeName, setNewEmployeeName] = useState('');
  const [selectedColumns, setSelectedColumns] = useState([]);
  const [generatedInviteLink, setGeneratedInviteLink] = useState('');
  const saveTimeoutRef = useRef(null);
  const SUPER_ADMIN_EMAIL = 'management.talco@gmail.com';

  // Admin state
  const [showAdminPanel, setShowAdminPanel] = useState(false);
  const [adminCompanies, setAdminCompanies] = useState([]);
  const [newCompanyName, setNewCompanyName] = useState('');
  const [newOwnerEmail, setNewOwnerEmail] = useState('');
  const [newOwnerName, setNewOwnerName] = useState('');
  const [adminLoading, setAdminLoading] = useState(false);
  const t = useMemo(() => translations[language] || translations.uk, [language]);
  const isOwner = userProfile?.role === 'owner';
  const isSuperAdmin = user?.email === SUPER_ADMIN_EMAIL;
  const canEdit = isOwner || !companyId; // owner або демо режим (без companyId)
  const targetRow = rows.find(r => r.isTarget);
  const dataRows = rows.filter(r => !r.isTarget);

  // Унікальні відповідальні для фільтру
  const uniqueResponsibles = useMemo(() => {
    const responsibles = columns.map(c => c.responsible).filter(Boolean);
    return [...new Set(responsibles)].sort();
  }, [columns]);

  // Фільтрація колонок по пошуку та відповідальному
  const filterColumns = useCallback(cols => {
    return cols.filter(c => {
      // Фільтр по пошуку
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        const matchesName = c.name?.toLowerCase().includes(query);
        const matchesResponsible = c.responsible?.toLowerCase().includes(query);
        if (!matchesName && !matchesResponsible) return false;
      }
      // Фільтр по відповідальному
      if (filterResponsible && c.responsible !== filterResponsible) {
        return false;
      }
      return true;
    });
  }, [searchQuery, filterResponsible]);

  // Групування колонок по періоду з фільтрацією
  const weeklyColumns = useMemo(() => filterColumns(columns.filter(c => c.period === 'weekly' || c.period === 'daily')), [columns, filterColumns]);
  const monthlyColumns = useMemo(() => filterColumns(columns.filter(c => c.period === 'monthly')), [columns, filterColumns]);

  // Всі колонки (без фільтрації) для підрахунків
  const allWeeklyColumns = useMemo(() => columns.filter(c => c.period === 'weekly' || c.period === 'daily'), [columns]);
  const allMonthlyColumns = useMemo(() => columns.filter(c => c.period === 'monthly'), [columns]);

  // Групування рядків по типу періоду + СОРТУВАННЯ по даті (від нових до старих)
  const parseDate = dateStr => {
    if (!dateStr) return 0;
    // Спробуємо різні формати
    // ISO: 2025-01-13
    if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
      return new Date(dateStr).getTime();
    }
    // Monthly key: 2025-01
    if (/^\d{4}-\d{2}$/.test(dateStr)) {
      return new Date(dateStr + '-01').getTime();
    }
    // Fallback
    return new Date(dateStr).getTime() || 0;
  };
  
  // Сортування: спочатку по order (якщо є), потім по даті (новіші зверху)
  const sortRows = (a, b) => {
    // Якщо обидва мають order - сортуємо по order
    if (a.order !== undefined && b.order !== undefined) {
      return a.order - b.order;
    }
    // Якщо тільки один має order - він йде перший
    if (a.order !== undefined) return -1;
    if (b.order !== undefined) return 1;
    // Інакше сортуємо по даті (новіші зверху)
    return parseDate(b.date) - parseDate(a.date);
  };
  
  const weeklyRows = useMemo(() => dataRows.filter(r => r.periodType !== 'monthly').sort(sortRows), [dataRows]);
  const monthlyRows = useMemo(() => dataRows.filter(r => r.periodType === 'monthly').sort(sortRows), [dataRows]);

  // Виявлення дублікатів дат
  const duplicateDates = useMemo(() => {
    const weeklyDates = weeklyRows.map(r => r.date).filter(Boolean);
    const monthlyDates = monthlyRows.map(r => r.date).filter(Boolean);
    const findDuplicates = arr => arr.filter((item, index) => arr.indexOf(item) !== index);
    return {
      weekly: [...new Set(findDuplicates(weeklyDates))],
      monthly: [...new Set(findDuplicates(monthlyDates))]
    };
  }, [weeklyRows, monthlyRows]);

  // Автоматичне додавання поточного тижня/місяця при фокусі на вікно
  useEffect(() => {
    const checkAndAddCurrentPeriod = () => {
      if (!isOwner || columns.length === 0 || rows.length === 0) return;
      let needsUpdate = false;
      const updatedRows = [...rows];

      // Перевіряємо поточний тиждень
      const currentWeekKey = getWeekKey(new Date());
      const hasWeeklyColumns = columns.some(c => c.period === 'weekly' || c.period === 'daily');
      const hasCurrentWeek = rows.some(r => !r.isTarget && r.periodType === 'weekly' && r.date === currentWeekKey);
      if (hasWeeklyColumns && !hasCurrentWeek && currentWeekKey) {
        console.log('Auto-adding current week on focus:', currentWeekKey);
        updatedRows.push({
          id: 'auto-week-' + Date.now(),
          isTarget: false,
          periodType: 'weekly',
          date: currentWeekKey,
          values: {},
          targets: {},
          comments: {}
        });
        needsUpdate = true;
      }

      // Перевіряємо поточний місяць
      const currentMonthKey = getMonthKeyFromDate(new Date());
      const hasMonthlyColumns = columns.some(c => c.period === 'monthly');
      const hasCurrentMonth = rows.some(r => !r.isTarget && r.periodType === 'monthly' && r.date === currentMonthKey);
      if (hasMonthlyColumns && !hasCurrentMonth && currentMonthKey) {
        console.log('Auto-adding current month on focus:', currentMonthKey);
        updatedRows.push({
          id: 'auto-month-' + Date.now(),
          isTarget: false,
          periodType: 'monthly',
          date: currentMonthKey,
          values: {},
          targets: {},
          comments: {}
        });
        needsUpdate = true;
      }
      if (needsUpdate) {
        setRows(updatedRows);
      }
    };

    // Перевіряємо при фокусі на вікно
    window.addEventListener('focus', checkAndAddCurrentPeriod);

    // Перевіряємо кожні 10 хвилин (на випадок якщо вкладка відкрита довго)
    const interval = setInterval(checkAndAddCurrentPeriod, 10 * 60 * 1000);
    return () => {
      window.removeEventListener('focus', checkAndAddCurrentPeriod);
      clearInterval(interval);
    };
  }, [isOwner, columns, rows]);

  // Visible columns for employees
  const visibleColumns = useMemo(() => {
    if (isOwner || isSuperAdmin) return columns;
    // Для співробітника беремо його дані з employees
    const employeeData = employees[user?.uid];
    console.log('Employee visibility check:', {
      uid: user?.uid,
      employeeData,
      allEmployeeIds: Object.keys(employees),
      columnsCount: columns.length
    });
    if (!employeeData?.visibleColumns || employeeData.visibleColumns.length === 0) {
      // Якщо немає збережених колонок - показуємо всі (fallback)
      console.log('Employee columns not found, showing all columns');
      return columns;
    }
    const filtered = columns.filter(col => employeeData.visibleColumns.includes(col.id));
    console.log('Filtered columns for employee:', filtered.length);
    return filtered;
  }, [columns, isOwner, isSuperAdmin, employees, user]);

  // ==================== AUTH ====================
  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async authUser => {
      setUser(authUser);
      if (authUser) {
        // Якщо супер-адмін - завантажуємо список компаній
        if (authUser.email === SUPER_ADMIN_EMAIL) {
          // Скидаємо все для чистого стану
          setUserProfile(null);
          setCompanyId(null);
          setCompanyName('');
          setColumns([]);
          setRows([]);
          setDataLoaded(false);
          await loadAdminCompanies();
          // НЕ завантажуємо демо автоматично - тільки список компаній
          setAuthLoading(false);
        } else {
          await loadUserProfile(authUser.uid);
        }
      } else {
        setUserProfile(null);
        setAuthLoading(false);
      }
    });
    return () => unsubscribe();
  }, []);

  // Завантаження списку компаній для адміна
  const loadAdminCompanies = async () => {
    try {
      const snapshot = await db.collection('companies').orderBy('createdAt', 'desc').get();
      const companies = [];
      snapshot.forEach(doc => {
        companies.push({
          id: doc.id,
          ...doc.data()
        });
      });
      setAdminCompanies(companies);
      console.log('Admin companies loaded:', companies.length);
    } catch (error) {
      console.error('Error loading companies:', error);
    }
  };

  // Створення нової компанії (тільки супер-адмін)
  const createCompany = async () => {
    if (!newCompanyName.trim() || !newOwnerEmail.trim()) {
      toast.error('Вкажіть назву компанії та email власника');
      return;
    }
    setAdminLoading(true);
    try {
      // 1. Створюємо компанію
      const companyRef = await db.collection('companies').add({
        name: newCompanyName,
        ownerEmail: newOwnerEmail,
        ownerName: newOwnerName || newOwnerEmail.split('@')[0],
        columns: [],
        rows: [{
          id: 'target',
          isTarget: true,
          date: '',
          values: {},
          comments: {}
        }],
        aiSettings: {
          businessContext: '',
          priorities: '',
          analysisPeriod: 5
        },
        savedAnalyses: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log('Company created:', companyRef.id);

      // 2. Створюємо pending owner запис (буде активовано після створення в Firebase Auth)
      await db.collection('pendingOwners').doc(newOwnerEmail.toLowerCase()).set({
        companyId: companyRef.id,
        companyName: newCompanyName,
        ownerName: newOwnerName || newOwnerEmail.split('@')[0],
        email: newOwnerEmail,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      toast.success(`Компанію "${newCompanyName}" створено! Тепер створіть користувача ${newOwnerEmail} в Firebase Console.`);

      // Очищаємо форму
      setNewCompanyName('');
      setNewOwnerEmail('');
      setNewOwnerName('');

      // Оновлюємо список
      await loadAdminCompanies();
    } catch (error) {
      console.error('Error creating company:', error);
      toast.error('Помилка створення компанії: ' + error.message);
    } finally {
      setAdminLoading(false);
    }
  };

  // Видалення компанії (тільки супер-адмін)
  const deleteCompany = (companyId, companyName) => {
    setConfirmDialog({
      isOpen: true,
      title: `Видалити компанію "${companyName}"?`,
      message: 'Всі дані компанії буде видалено назавжди!',
      onConfirm: async () => {
        try {
          // Видаляємо всіх користувачів компанії
          const usersSnapshot = await db.collection('companies').doc(companyId).collection('users').get();
          const batch = db.batch();
          usersSnapshot.forEach(doc => batch.delete(doc.ref));
          await batch.commit();

          // Видаляємо компанію
          await db.collection('companies').doc(companyId).delete();
          toast.success('Компанію видалено');
          await loadAdminCompanies();
        } catch (error) {
          console.error('Error deleting company:', error);
          toast.error('Помилка видалення');
        }
      }
    });
  };
  const loadUserProfile = async userId => {
    console.log('loadUserProfile called with userId:', userId);
    try {
      const currentUser = auth.currentUser;
      const userEmail = currentUser?.email?.toLowerCase();
      console.log('Current user email:', userEmail);

      // 1. Спочатку шукаємо глобальний профіль користувача
      console.log('Fetching user doc...');
      const userDoc = await db.collection('users').doc(userId).get();
      console.log('User doc fetched, exists:', userDoc.exists);
      if (userDoc.exists) {
        const userData = userDoc.data();
        const userCompanyId = userData.companyId;
        console.log('User found:', {
          userId,
          companyId: userCompanyId
        });
        if (userCompanyId) {
          // 2. Завантажуємо дані компанії
          setCompanyId(userCompanyId);
          console.log('Calling loadCompanyData...');
          await loadCompanyData(userCompanyId, userId);
          console.log('loadCompanyData finished');
        }
      } else {
        // Можливо це новий owner - перевіряємо pendingOwners
        console.log('User not found, checking pendingOwners for:', userEmail);
        if (userEmail) {
          const pendingDoc = await db.collection('pendingOwners').doc(userEmail).get();
          if (pendingDoc.exists) {
            const pending = pendingDoc.data();
            console.log('Found pending owner:', pending);

            // Активуємо owner
            await activatePendingOwner(userId, userEmail, pending);
          } else {
            console.log('No pending owner found');
          }
        }
      }
    } catch (error) {
      console.error('Error loading profile:', error);
      toast.error('Помилка завантаження профілю');
    } finally {
      setAuthLoading(false);
    }
  };

  // Активація pending owner
  const activatePendingOwner = async (userId, email, pending) => {
    try {
      console.log('Activating pending owner:', {
        userId,
        email,
        pending
      });

      // 1. Додаємо в глобальний users
      await db.collection('users').doc(userId).set({
        email: email,
        companyId: pending.companyId,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // 2. Додаємо в companies/{companyId}/users як owner
      await db.collection('companies').doc(pending.companyId).collection('users').doc(userId).set({
        email: email,
        name: pending.ownerName || email.split('@')[0],
        role: 'owner',
        visibleColumns: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // 3. Видаляємо pending запис
      await db.collection('pendingOwners').doc(email).delete();
      toast.success(`Вітаємо! Ви власник компанії "${pending.companyName}"`);

      // 4. Завантажуємо дані компанії
      setCompanyId(pending.companyId);
      await loadCompanyData(pending.companyId, userId);
    } catch (error) {
      console.error('Error activating owner:', error);
      toast.error('Помилка активації: ' + error.message);
    }
  };
  const loadCompanyData = async (companyId, userId) => {
    try {
      console.log('Loading company:', companyId);

      // Скидаємо флаг поки дані завантажуються
      setDataLoaded(false);

      // 1. Завантажуємо дані компанії з timeout
      console.log('Fetching company doc...');
      
      let companyDoc;
      
      try {
        // Спочатку пробуємо з сервера (5 секунд timeout)
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('timeout')), 5000)
        );
        
        companyDoc = await Promise.race([
          db.collection('companies').doc(companyId).get(),
          timeoutPromise
        ]);
      } catch (e) {
        // Якщо timeout або помилка мережі - пробуємо з кешу
        console.log('Server fetch failed, trying cache...', e.message);
        try {
          companyDoc = await db.collection('companies').doc(companyId).get({ source: 'cache' });
          console.log('Loaded from cache');
          toast.info('Завантажено з кешу (офлайн режим)');
        } catch (cacheError) {
          console.log('Cache also failed:', cacheError.message);
          throw new Error('Не вдалося завантажити дані. Перевірте з\'єднання.');
        }
      }
      
      console.log('Company doc fetched, exists:', companyDoc.exists);
      if (!companyDoc.exists) {
        console.log('Company not found:', companyId);
        toast.error('Компанію не знайдено');
        setAuthLoading(false);
        return;
      }
      const companyData = companyDoc.data();
      setCompanyName(SecurityUtils.safeString(companyData.name, 'Компанія'));
      
      // ВАЛІДАЦІЯ: перевіряємо та очищаємо колонки
      const validatedColumns = ValidationUtils.validateColumns(companyData.columns);
      console.log('Validated columns:', validatedColumns.length, 'from', companyData.columns?.length || 0);
      setColumns(validatedColumns);

      // ВАЛІДАЦІЯ: перевіряємо та очищаємо рядки
      const validatedRows = ValidationUtils.validateRows(companyData.rows);
      
      // Міграція старих дат у формат тижнів
      const migratedRows = validatedRows.map(row => {
        if (row.isTarget || !row.date) return row;
        // Перевіряємо чи дата вже в форматі weekKey (YYYY-MM-DD понеділка)
        const weekKey = getWeekKey(row.date);
        if (weekKey && row.date !== weekKey) {
          // Міграція: конвертуємо будь-яку дату в початок тижня
          console.log('Migrating date:', row.date, '→', weekKey);
          return {
            ...row,
            date: weekKey
          };
        }
        return row;
      });

      // Перевіряємо чи є targetRow, якщо ні - створюємо
      const hasTargetRow = migratedRows.some(r => r.isTarget);
      if (!hasTargetRow) {
        console.log('Creating missing targetRow');
        migratedRows.unshift({
          id: 'target',
          isTarget: true,
          date: '',
          values: {},
          comments: {}
        });
      }

      // Автоматично додаємо поточний тиждень якщо його немає
      const currentWeekKey = getWeekKey(new Date());
      const weeklyColumns = validatedColumns.filter(c => c.period === 'weekly');
      const hasCurrentWeek = migratedRows.some(r => !r.isTarget && r.periodType === 'weekly' && r.date === currentWeekKey);
      if (weeklyColumns.length > 0 && !hasCurrentWeek && currentWeekKey) {
        console.log('Auto-adding current week:', currentWeekKey);
        migratedRows.push({
          id: 'auto-week-' + Date.now(),
          isTarget: false,
          periodType: 'weekly',
          date: currentWeekKey,
          values: {},
          targets: {},
          comments: {}
        });
      }

      // Автоматично додаємо поточний місяць якщо його немає
      const currentMonthKey = getMonthKeyFromDate(new Date());
      const monthlyColumns = validatedColumns.filter(c => c.period === 'monthly');
      const hasCurrentMonth = migratedRows.some(r => !r.isTarget && r.periodType === 'monthly' && r.date === currentMonthKey);
      if (monthlyColumns.length > 0 && !hasCurrentMonth && currentMonthKey) {
        console.log('Auto-adding current month:', currentMonthKey);
        migratedRows.push({
          id: 'auto-month-' + Date.now(),
          isTarget: false,
          periodType: 'monthly',
          date: currentMonthKey,
          values: {},
          targets: {},
          comments: {}
        });
      }
      setRows(migratedRows);
      
      // ВАЛІДАЦІЯ: aiSettings
      const validAiSettings = {
        businessContext: SecurityUtils.safeString(companyData.aiSettings?.businessContext, ''),
        priorities: SecurityUtils.safeString(companyData.aiSettings?.priorities, ''),
        analysisPeriod: SecurityUtils.safeNumber(companyData.aiSettings?.analysisPeriod, 5)
      };
      setAiSettings(validAiSettings);
      setSavedAnalyses(Array.isArray(companyData.savedAnalyses) ? companyData.savedAnalyses : []);

      // 2. Завантажуємо користувачів компанії (з лімітом!)
      const usersSnapshot = await db.collection('companies')
        .doc(companyId)
        .collection('users')
        .limit(CONSTANTS.MAX_USERS_LOAD)
        .get();
      const employeesData = {};
      usersSnapshot.forEach(doc => {
        employeesData[doc.id] = doc.data();
      });
      if (usersSnapshot.size >= CONSTANTS.MAX_USERS_LOAD) {
        console.warn('Users limit reached, some users may not be loaded');
      }
      setEmployees(employeesData);

      // 3. Встановлюємо профіль поточного користувача з завантажених даних
      const currentUserProfile = employeesData[userId];
      if (currentUserProfile) {
        console.log('User profile in company:', currentUserProfile);
        setUserProfile(currentUserProfile);
      } else {
        console.log('User not found in company users:', userId);
      }
      console.log('Company loaded:', {
        name: companyData.name,
        columnsCount: companyData.columns?.length,
        rowsCount: companyData.rows?.length,
        usersCount: Object.keys(employeesData).length
      });

      // Позначаємо що дані завантажені - тепер можна зберігати
      setDataLoaded(true);
      setAuthLoading(false);
      console.log('Data loaded flag set to true');
    } catch (error) {
      console.error('Error loading company:', error);
      console.error('Error details:', error.message, error.code);
      
      // Якщо timeout або мережева помилка - спробуємо з кешу
      if (error.message?.includes('timeout') || error.code === 'unavailable') {
        toast.error('Проблема з мережею. Спробуйте оновити сторінку.');
      } else {
        toast.error('Помилка завантаження: ' + error.message);
      }
      
      setAuthLoading(false);
      setDataLoaded(true); // Дозволяємо UI працювати
    }
  };
  const initializeDefaultData = () => {
    const defaultColumns = [{
      id: Date.now().toString(),
      name: 'Показник 1',
      responsible: '',
      period: 'weekly',
      visibleToEmployees: []
    }];
    const targetRow = {
      id: 'target',
      isTarget: true,
      date: '',
      values: {},
      comments: {}
    };
    const currentWeekKey = getWeekKey(new Date()) || new Date().toISOString().split('T')[0];
    const defaultRows = [targetRow, {
      id: Date.now().toString() + '-1',
      isTarget: false,
      date: currentWeekKey,
      values: {},
      comments: {}
    }];
    setColumns(defaultColumns);
    setRows(defaultRows);
  };

  // ==================== DEMO DATA ====================
  // Завантаження демо-даних для супер-адміна (тихо, без toast)
  // Завантаження демо для супер-адміна (тихо, без модалки)
  const loadSuperAdminDemo = () => {
    // Буде викликано після ініціалізації DEMO_DATA
    setTimeout(() => {
      loadDemoData('consulting');
      setUserProfile({
        role: 'owner',
        name: 'Super Admin'
      });
      console.log('Super Admin demo data loaded');
    }, 100);
  };

  // Демо-дані для різних типів бізнесу - 17 статистик кожна
  const DEMO_DATA = {
    consulting: {
      name: 'Консалтинг',
      icon: 'Target',
      companyName: 'TALKO Consulting',
      columns: [
      // Тижневі - 10 показників
      {
        id: 'col1',
        name: 'Консультацій',
        responsible: 'Олена',
        period: 'weekly',
        format: 'number',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col2',
        name: 'Лідів',
        responsible: 'Марія',
        period: 'weekly',
        format: 'number',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col3',
        name: 'Конверсія',
        responsible: 'Олена',
        period: 'weekly',
        format: 'percent',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col4',
        name: 'Угод',
        responsible: 'Олена',
        period: 'weekly',
        format: 'number',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col5',
        name: 'Дохід',
        responsible: 'Олександр',
        period: 'weekly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col6',
        name: 'Реклама',
        responsible: 'Ігор',
        period: 'weekly',
        format: 'usd',
        importance: 'medium',
        visibleToEmployees: []
      },
      // Неочевидні тижневі
      {
        id: 'col7',
        name: 'Дзвінків до угоди',
        responsible: 'Олена',
        period: 'weekly',
        format: 'number',
        importance: 'medium',
        inverted: true,
        visibleToEmployees: []
      }, {
        id: 'col8',
        name: 'Відмов',
        responsible: 'Олена',
        period: 'weekly',
        format: 'number',
        importance: 'high',
        inverted: true,
        visibleToEmployees: []
      }, {
        id: 'col9',
        name: 'Рекомендацій',
        responsible: 'Марія',
        period: 'weekly',
        format: 'number',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col10',
        name: 'Завантаженість',
        responsible: 'Олена',
        period: 'weekly',
        format: 'percent',
        importance: 'medium',
        visibleToEmployees: []
      },
      // Місячні - 7 показників
      {
        id: 'col11',
        name: 'Прибуток',
        responsible: 'Олександр',
        period: 'monthly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col12',
        name: 'Маркетинг',
        responsible: 'Ігор',
        period: 'monthly',
        format: 'uah',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col13',
        name: 'Окупність',
        responsible: 'Ігор',
        period: 'monthly',
        format: 'percent',
        importance: 'high',
        visibleToEmployees: []
      },
      // Неочевидні місячні
      {
        id: 'col14',
        name: 'Ціна клієнта',
        responsible: 'Ігор',
        period: 'monthly',
        format: 'uah',
        importance: 'critical',
        inverted: true,
        visibleToEmployees: []
      }, {
        id: 'col15',
        name: 'Дохід з клієнта',
        responsible: 'Олександр',
        period: 'monthly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col16',
        name: 'Повторні',
        responsible: 'Олена',
        period: 'monthly',
        format: 'percent',
        visibleToEmployees: []
      }, {
        id: 'col17',
        name: 'Оцінка сервісу',
        responsible: 'Марія',
        period: 'monthly',
        format: 'number',
        importance: 'high',
        visibleToEmployees: []
      }],
      weeklyData: [{
        values: {
          col1: '16',
          col2: '35',
          col3: '11',
          col4: '4',
          col5: '112000',
          col6: '780',
          col7: '4.2',
          col8: '3',
          col9: '2',
          col10: '72'
        },
        targets: {
          col1: '18',
          col2: '40',
          col3: '12',
          col4: '5',
          col5: '130000',
          col6: '800',
          col7: '3',
          col8: '2',
          col9: '3',
          col10: '80'
        }
      }, {
        values: {
          col1: '18',
          col2: '42',
          col3: '12',
          col4: '5',
          col5: '125000',
          col6: '850',
          col7: '3.8',
          col8: '2',
          col9: '3',
          col10: '78'
        },
        targets: {
          col1: '18',
          col2: '40',
          col3: '12',
          col4: '5',
          col5: '130000',
          col6: '800',
          col7: '3',
          col8: '2',
          col9: '3',
          col10: '80'
        }
      }, {
        values: {
          col1: '22',
          col2: '38',
          col3: '14',
          col4: '5',
          col5: '140000',
          col6: '920',
          col7: '3.5',
          col8: '2',
          col9: '4',
          col10: '85'
        },
        targets: {
          col1: '20',
          col2: '45',
          col3: '13',
          col4: '6',
          col5: '150000',
          col6: '850',
          col7: '3',
          col8: '2',
          col9: '4',
          col10: '82'
        }
      }, {
        values: {
          col1: '15',
          col2: '51',
          col3: '10',
          col4: '5',
          col5: '145000',
          col6: '1200',
          col7: '5.1',
          col8: '4',
          col9: '2',
          col10: '68'
        },
        targets: {
          col1: '20',
          col2: '45',
          col3: '13',
          col4: '6',
          col5: '150000',
          col6: '900',
          col7: '3',
          col8: '2',
          col9: '4',
          col10: '82'
        }
      }, {
        values: {
          col1: '19',
          col2: '67',
          col3: '9',
          col4: '6',
          col5: '168000',
          col6: '1100',
          col7: '4.8',
          col8: '5',
          col9: '3',
          col10: '75'
        },
        targets: {
          col1: '22',
          col2: '50',
          col3: '14',
          col4: '7',
          col5: '180000',
          col6: '950',
          col7: '3',
          col8: '2',
          col9: '5',
          col10: '85'
        }
      }, {
        values: {
          col1: '21',
          col2: '58',
          col3: '10',
          col4: '6',
          col5: '174000',
          col6: '950',
          col7: '4.2',
          col8: '3',
          col9: '4',
          col10: '82'
        },
        targets: {
          col1: '22',
          col2: '50',
          col3: '14',
          col4: '7',
          col5: '180000',
          col6: '950',
          col7: '3',
          col8: '2',
          col9: '5',
          col10: '85'
        }
      }, {
        values: {
          col1: '17',
          col2: '44',
          col3: '11',
          col4: '5',
          col5: '135000',
          col6: '880',
          col7: '4.5',
          col8: '4',
          col9: '2',
          col10: '70'
        },
        targets: {
          col1: '20',
          col2: '50',
          col3: '15',
          col4: '8',
          col5: '200000',
          col6: '900',
          col7: '3',
          col8: '2',
          col9: '5',
          col10: '85'
        }
      }, {
        values: {
          col1: '14',
          col2: '39',
          col3: '9',
          col4: '4',
          col5: '118000',
          col6: '920',
          col7: '5.2',
          col8: '5',
          col9: '1',
          col10: '65'
        },
        targets: {
          col1: '20',
          col2: '50',
          col3: '15',
          col4: '8',
          col5: '200000',
          col6: '900',
          col7: '3',
          col8: '2',
          col9: '5',
          col10: '85'
        }
      }],
      monthlyData: [{
        values: {
          col11: '420000',
          col12: '38000',
          col13: '340',
          col14: '8500',
          col15: '42000',
          col16: '18',
          col17: '72'
        },
        targets: {
          col11: '500000',
          col12: '40000',
          col13: '350',
          col14: '7000',
          col15: '50000',
          col16: '25',
          col17: '80'
        }
      }, {
        values: {
          col11: '480000',
          col12: '45000',
          col13: '320',
          col14: '9200',
          col15: '45000',
          col16: '21',
          col17: '75'
        },
        targets: {
          col11: '550000',
          col12: '42000',
          col13: '360',
          col14: '7500',
          col15: '52000',
          col16: '25',
          col17: '80'
        }
      }, {
        values: {
          col11: '520000',
          col12: '52000',
          col13: '280',
          col14: '10500',
          col15: '48000',
          col16: '19',
          col17: '68'
        },
        targets: {
          col11: '580000',
          col12: '45000',
          col13: '370',
          col14: '8000',
          col15: '55000',
          col16: '28',
          col17: '82'
        }
      }, {
        values: {
          col11: '410000',
          col12: '48000',
          col13: '250',
          col14: '11200',
          col15: '44000',
          col16: '15',
          col17: '65'
        },
        targets: {
          col11: '600000',
          col12: '45000',
          col13: '380',
          col14: '8000',
          col15: '58000',
          col16: '30',
          col17: '85'
        }
      }, {
        values: {
          col11: '380000',
          col12: '44000',
          col13: '230',
          col14: '12000',
          col15: '41000',
          col16: '12',
          col17: '62'
        },
        targets: {
          col11: '600000',
          col12: '45000',
          col13: '380',
          col14: '8000',
          col15: '60000',
          col16: '30',
          col17: '85'
        }
      }],
      context: `Консалтингова компанія "TALKO Consulting"
- Спеціалізація: бізнес-трансформація для МСБ
- Команда: 4 консультанти + 2 менеджери з продажів
- Середній чек: 28,000 грн за проект
- Цикл угоди: 2-3 тижні від ліда до контракту
- Основні канали: рекомендації (60%), реклама Facebook/Google (30%), вебінари (10%)
- Маркетинг бюджет: $800-1200/тиждень
- Ціна залучення клієнта зростає - треба оптимізувати
- Дохід з клієнта падає - мало повторних звернень
- Оцінка сервісу знижується - проблема з якістю`,
      priorities: `1. Знизити ціну клієнта з 12,000 до 8,000 грн (оптимізація воронки)
2. Підвищити повторні продажі (зараз 12%, ціль 30%)
3. Покращити оцінку сервісу з 62 до 85 балів
4. Зменшити кількість дзвінків до угоди з 5 до 3`
    },
    dental: {
      name: 'Стоматологія',
      icon: 'Heart',
      companyName: 'Клініка "Здорова Посмішка"',
      columns: [
      // Тижневі - 10 показників
      {
        id: 'col1',
        name: 'Первинок',
        responsible: 'Адмін',
        period: 'weekly',
        format: 'number',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col2',
        name: 'Записів',
        responsible: 'Адмін',
        period: 'weekly',
        format: 'number',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col3',
        name: 'Конверсія',
        responsible: 'Лікар',
        period: 'weekly',
        format: 'percent',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col4',
        name: 'Імплантацій',
        responsible: 'Хірург',
        period: 'weekly',
        format: 'number',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col5',
        name: 'Виручка',
        responsible: 'Директор',
        period: 'weekly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col6',
        name: 'Сер. чек',
        responsible: 'Директор',
        period: 'weekly',
        format: 'uah',
        importance: 'high',
        visibleToEmployees: []
      },
      // Неочевидні тижневі
      {
        id: 'col7',
        name: 'Неявки',
        responsible: 'Адмін',
        period: 'weekly',
        format: 'percent',
        importance: 'high',
        inverted: true,
        visibleToEmployees: []
      }, {
        id: 'col8',
        name: 'Послуг на візит',
        responsible: 'Лікар',
        period: 'weekly',
        format: 'number',
        importance: 'medium',
        visibleToEmployees: []
      }, {
        id: 'col9',
        name: 'Дохід на крісло',
        responsible: 'Директор',
        period: 'weekly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col10',
        name: 'Завантаженість',
        responsible: 'Адмін',
        period: 'weekly',
        format: 'percent',
        importance: 'high',
        visibleToEmployees: []
      },
      // Місячні - 7 показників
      {
        id: 'col11',
        name: 'Прибуток',
        responsible: 'Директор',
        period: 'monthly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col12',
        name: 'Реклама',
        responsible: 'Маркетолог',
        period: 'monthly',
        format: 'uah',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col13',
        name: 'Ціна ліда',
        responsible: 'Маркетолог',
        period: 'monthly',
        format: 'uah',
        importance: 'high',
        inverted: true,
        visibleToEmployees: []
      },
      // Неочевидні місячні
      {
        id: 'col14',
        name: 'Повторні',
        responsible: 'Адмін',
        period: 'monthly',
        format: 'percent',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col15',
        name: 'Рекомендації',
        responsible: 'Адмін',
        period: 'monthly',
        format: 'number',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col16',
        name: 'Відгуки',
        responsible: 'Маркетолог',
        period: 'monthly',
        format: 'number',
        importance: 'medium',
        visibleToEmployees: []
      }, {
        id: 'col17',
        name: 'Дохід з пацієнта',
        responsible: 'Директор',
        period: 'monthly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }],
      weeklyData: [{
        values: {
          col1: '26',
          col2: '20',
          col3: '77',
          col4: '4',
          col5: '195000',
          col6: '4400',
          col7: '8',
          col8: '2.1',
          col9: '48750',
          col10: '82'
        },
        targets: {
          col1: '25',
          col2: '18',
          col3: '70',
          col4: '3',
          col5: '180000',
          col6: '4000',
          col7: '5',
          col8: '2.5',
          col9: '45000',
          col10: '85'
        }
      }, {
        values: {
          col1: '24',
          col2: '18',
          col3: '75',
          col4: '3',
          col5: '185000',
          col6: '4200',
          col7: '6',
          col8: '2.3',
          col9: '46250',
          col10: '78'
        },
        targets: {
          col1: '25',
          col2: '18',
          col3: '70',
          col4: '3',
          col5: '180000',
          col6: '4000',
          col7: '5',
          col8: '2.5',
          col9: '45000',
          col10: '85'
        }
      }, {
        values: {
          col1: '28',
          col2: '15',
          col3: '54',
          col4: '2',
          col5: '156000',
          col6: '3800',
          col7: '12',
          col8: '1.8',
          col9: '39000',
          col10: '68'
        },
        targets: {
          col1: '28',
          col2: '20',
          col3: '70',
          col4: '4',
          col5: '200000',
          col6: '4200',
          col7: '5',
          col8: '2.5',
          col9: '50000',
          col10: '85'
        }
      }, {
        values: {
          col1: '31',
          col2: '19',
          col3: '61',
          col4: '4',
          col5: '198000',
          col6: '4100',
          col7: '9',
          col8: '2.0',
          col9: '49500',
          col10: '75'
        },
        targets: {
          col1: '28',
          col2: '20',
          col3: '70',
          col4: '4',
          col5: '200000',
          col6: '4200',
          col7: '5',
          col8: '2.5',
          col9: '50000',
          col10: '85'
        }
      }, {
        values: {
          col1: '22',
          col2: '12',
          col3: '55',
          col4: '2',
          col5: '142000',
          col6: '3600',
          col7: '15',
          col8: '1.7',
          col9: '35500',
          col10: '62'
        },
        targets: {
          col1: '30',
          col2: '21',
          col3: '70',
          col4: '4',
          col5: '210000',
          col6: '4300',
          col7: '5',
          col8: '2.5',
          col9: '52500',
          col10: '88'
        }
      }, {
        values: {
          col1: '35',
          col2: '17',
          col3: '49',
          col4: '3',
          col5: '168000',
          col6: '3900',
          col7: '11',
          col8: '1.9',
          col9: '42000',
          col10: '72'
        },
        targets: {
          col1: '30',
          col2: '21',
          col3: '70',
          col4: '4',
          col5: '210000',
          col6: '4300',
          col7: '5',
          col8: '2.5',
          col9: '52500',
          col10: '88'
        }
      }, {
        values: {
          col1: '29',
          col2: '14',
          col3: '48',
          col4: '2',
          col5: '145000',
          col6: '3700',
          col7: '14',
          col8: '1.6',
          col9: '36250',
          col10: '65'
        },
        targets: {
          col1: '30',
          col2: '22',
          col3: '70',
          col4: '4',
          col5: '220000',
          col6: '4500',
          col7: '5',
          col8: '2.5',
          col9: '55000',
          col10: '90'
        }
      }, {
        values: {
          col1: '27',
          col2: '13',
          col3: '48',
          col4: '2',
          col5: '138000',
          col6: '3650',
          col7: '16',
          col8: '1.5',
          col9: '34500',
          col10: '60'
        },
        targets: {
          col1: '30',
          col2: '22',
          col3: '70',
          col4: '4',
          col5: '220000',
          col6: '4500',
          col7: '5',
          col8: '2.5',
          col9: '55000',
          col10: '90'
        }
      }],
      monthlyData: [{
        values: {
          col11: '340000',
          col12: '32000',
          col13: '380',
          col14: '42',
          col15: '8',
          col16: '12',
          col17: '8500'
        },
        targets: {
          col11: '400000',
          col12: '35000',
          col13: '400',
          col14: '55',
          col15: '15',
          col16: '20',
          col17: '12000'
        }
      }, {
        values: {
          col11: '380000',
          col12: '35000',
          col13: '420',
          col14: '45',
          col15: '11',
          col16: '15',
          col17: '9200'
        },
        targets: {
          col11: '450000',
          col12: '35000',
          col13: '380',
          col14: '55',
          col15: '15',
          col16: '20',
          col17: '12000'
        }
      }, {
        values: {
          col11: '420000',
          col12: '42000',
          col13: '480',
          col14: '38',
          col15: '7',
          col16: '9',
          col17: '7800'
        },
        targets: {
          col11: '480000',
          col12: '38000',
          col13: '360',
          col14: '58',
          col15: '18',
          col16: '22',
          col17: '13000'
        }
      }, {
        values: {
          col11: '350000',
          col12: '38000',
          col13: '520',
          col14: '35',
          col15: '5',
          col16: '6',
          col17: '7200'
        },
        targets: {
          col11: '500000',
          col12: '35000',
          col13: '350',
          col14: '60',
          col15: '20',
          col16: '25',
          col17: '14000'
        }
      }, {
        values: {
          col11: '320000',
          col12: '40000',
          col13: '550',
          col14: '32',
          col15: '4',
          col16: '5',
          col17: '6800'
        },
        targets: {
          col11: '500000',
          col12: '35000',
          col13: '350',
          col14: '60',
          col15: '20',
          col16: '25',
          col17: '15000'
        }
      }],
      context: `Стоматологічна клініка "Здорова Посмішка"
- 3 лікарі-стоматологи + хірург-імплантолог + 2 адміністратори
- 4 стоматологічних крісла
- Середній чек: 4,500 грн
- Імплантація: від 18,000 грн за одиницю
- Основні канали: Google Ads (50%), Instagram (30%), рекомендації (20%)
- Неявки (не прийшли на прийом) зростають до 16% - втрата часу та грошей
- Мало послуг на візит (1.5 замість 2.5) - недопродаж
- Низький дохід на крісло - неефективне завантаження
- Дохід з пацієнта падає - не повертаються на профілактику`,
      priorities: `1. Знизити неявки з 16% до 5% (SMS нагадування, депозити)
2. Підвищити послуг на візит з 1.5 до 2.5 (допродаж, плани лікування)
3. Збільшити дохід на крісло на 50% через оптимізацію розкладу
4. Підняти дохід з пацієнта з 6,800 до 15,000 грн (програма лояльності)`
    },
    manufacturing: {
      name: 'Виробництво',
      icon: 'Settings',
      companyName: 'Меблева фабрика "Комфорт"',
      columns: [
      // Тижневі - 10 показників
      {
        id: 'col1',
        name: 'Замовлень',
        responsible: 'Менеджер',
        period: 'weekly',
        format: 'number',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col2',
        name: 'Виготовлено',
        responsible: 'Виробництво',
        period: 'weekly',
        format: 'number',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col3',
        name: 'План',
        responsible: 'Виробництво',
        period: 'weekly',
        format: 'percent',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col4',
        name: 'Брак',
        responsible: 'ОТК',
        period: 'weekly',
        format: 'percent',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col5',
        name: 'Виручка',
        responsible: 'Директор',
        period: 'weekly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col6',
        name: 'Собівартість',
        responsible: 'Бухгалтер',
        period: 'weekly',
        format: 'uah',
        importance: 'high',
        visibleToEmployees: []
      },
      // Неочевидні тижневі
      {
        id: 'col7',
        name: 'Простій год',
        responsible: 'Виробництво',
        period: 'weekly',
        format: 'number',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col8',
        name: 'Ефективність',
        responsible: 'Виробництво',
        period: 'weekly',
        format: 'percent',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col9',
        name: 'Переробка грн',
        responsible: 'ОТК',
        period: 'weekly',
        format: 'uah',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col10',
        name: 'Виробіток',
        responsible: 'HR',
        period: 'weekly',
        format: 'number',
        importance: 'medium',
        visibleToEmployees: []
      },
      // Місячні - 7 показників
      {
        id: 'col11',
        name: 'Прибуток',
        responsible: 'Директор',
        period: 'monthly',
        format: 'uah',
        importance: 'critical',
        visibleToEmployees: []
      }, {
        id: 'col12',
        name: 'Сировина',
        responsible: 'Закупівлі',
        period: 'monthly',
        format: 'uah',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col13',
        name: 'Маржа',
        responsible: 'Директор',
        period: 'monthly',
        format: 'percent',
        importance: 'critical',
        visibleToEmployees: []
      },
      // Неочевидні місячні
      {
        id: 'col14',
        name: 'Рекламації',
        responsible: 'ОТК',
        period: 'monthly',
        format: 'number',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col15',
        name: 'Запас днів',
        responsible: 'Закупівлі',
        period: 'monthly',
        format: 'number',
        importance: 'medium',
        visibleToEmployees: []
      }, {
        id: 'col16',
        name: 'Борг днів',
        responsible: 'Бухгалтер',
        period: 'monthly',
        format: 'number',
        importance: 'high',
        visibleToEmployees: []
      }, {
        id: 'col17',
        name: 'Термін днів',
        responsible: 'Виробництво',
        period: 'monthly',
        format: 'number',
        importance: 'critical',
        visibleToEmployees: []
      }],
      weeklyData: [{
        values: {
          col1: '14',
          col2: '50',
          col3: '100',
          col4: '2',
          col5: '400000',
          col6: '300000',
          col7: '4',
          col8: '78',
          col9: '8000',
          col10: '3.3'
        },
        targets: {
          col1: '12',
          col2: '45',
          col3: '100',
          col4: '3',
          col5: '380000',
          col6: '280000',
          col7: '8',
          col8: '75',
          col9: '12000',
          col10: '3.0'
        }
      }, {
        values: {
          col1: '12',
          col2: '45',
          col3: '90',
          col4: '3',
          col5: '380000',
          col6: '285000',
          col7: '6',
          col8: '72',
          col9: '11000',
          col10: '3.0'
        },
        targets: {
          col1: '12',
          col2: '45',
          col3: '100',
          col4: '3',
          col5: '380000',
          col6: '280000',
          col7: '8',
          col8: '75',
          col9: '12000',
          col10: '3.0'
        }
      }, {
        values: {
          col1: '15',
          col2: '52',
          col3: '104',
          col4: '2',
          col5: '420000',
          col6: '310000',
          col7: '5',
          col8: '76',
          col9: '9000',
          col10: '3.5'
        },
        targets: {
          col1: '14',
          col2: '48',
          col3: '100',
          col4: '2',
          col5: '420000',
          col6: '300000',
          col7: '6',
          col8: '78',
          col9: '10000',
          col10: '3.2'
        }
      }, {
        values: {
          col1: '11',
          col2: '38',
          col3: '76',
          col4: '5',
          col5: '340000',
          col6: '270000',
          col7: '12',
          col8: '62',
          col9: '18000',
          col10: '2.5'
        },
        targets: {
          col1: '14',
          col2: '48',
          col3: '100',
          col4: '2',
          col5: '420000',
          col6: '300000',
          col7: '6',
          col8: '78',
          col9: '10000',
          col10: '3.2'
        }
      }, {
        values: {
          col1: '14',
          col2: '48',
          col3: '96',
          col4: '4',
          col5: '395000',
          col6: '295000',
          col7: '8',
          col8: '68',
          col9: '14000',
          col10: '3.2'
        },
        targets: {
          col1: '15',
          col2: '50',
          col3: '100',
          col4: '2',
          col5: '450000',
          col6: '300000',
          col7: '5',
          col8: '80',
          col9: '8000',
          col10: '3.5'
        }
      }, {
        values: {
          col1: '13',
          col2: '42',
          col3: '84',
          col4: '6',
          col5: '365000',
          col6: '290000',
          col7: '14',
          col8: '58',
          col9: '22000',
          col10: '2.8'
        },
        targets: {
          col1: '15',
          col2: '50',
          col3: '100',
          col4: '2',
          col5: '450000',
          col6: '300000',
          col7: '5',
          col8: '80',
          col9: '8000',
          col10: '3.5'
        }
      }, {
        values: {
          col1: '10',
          col2: '35',
          col3: '70',
          col4: '7',
          col5: '320000',
          col6: '260000',
          col7: '18',
          col8: '52',
          col9: '28000',
          col10: '2.3'
        },
        targets: {
          col1: '15',
          col2: '50',
          col3: '100',
          col4: '2',
          col5: '450000',
          col6: '300000',
          col7: '5',
          col8: '80',
          col9: '8000',
          col10: '3.5'
        }
      }, {
        values: {
          col1: '9',
          col2: '32',
          col3: '64',
          col4: '8',
          col5: '290000',
          col6: '245000',
          col7: '22',
          col8: '48',
          col9: '35000',
          col10: '2.1'
        },
        targets: {
          col1: '15',
          col2: '50',
          col3: '100',
          col4: '2',
          col5: '450000',
          col6: '300000',
          col7: '5',
          col8: '80',
          col9: '8000',
          col10: '3.5'
        }
      }],
      monthlyData: [{
        values: {
          col11: '560000',
          col12: '650000',
          col13: '35',
          col14: '2',
          col15: '12',
          col16: '28',
          col17: '14'
        },
        targets: {
          col11: '550000',
          col12: '620000',
          col13: '35',
          col14: '3',
          col15: '14',
          col16: '30',
          col17: '14'
        }
      }, {
        values: {
          col11: '520000',
          col12: '680000',
          col13: '32',
          col14: '3',
          col15: '10',
          col16: '32',
          col17: '15'
        },
        targets: {
          col11: '580000',
          col12: '640000',
          col13: '35',
          col14: '2',
          col15: '14',
          col16: '25',
          col17: '14'
        }
      }, {
        values: {
          col11: '480000',
          col12: '720000',
          col13: '28',
          col14: '5',
          col15: '8',
          col16: '38',
          col17: '18'
        },
        targets: {
          col11: '620000',
          col12: '650000',
          col13: '35',
          col14: '2',
          col15: '14',
          col16: '21',
          col17: '14'
        }
      }, {
        values: {
          col11: '410000',
          col12: '750000',
          col13: '25',
          col14: '7',
          col15: '6',
          col16: '45',
          col17: '21'
        },
        targets: {
          col11: '650000',
          col12: '650000',
          col13: '35',
          col14: '2',
          col15: '14',
          col16: '21',
          col17: '14'
        }
      }, {
        values: {
          col11: '350000',
          col12: '780000',
          col13: '22',
          col14: '9',
          col15: '5',
          col16: '52',
          col17: '24'
        },
        targets: {
          col11: '650000',
          col12: '650000',
          col13: '35',
          col14: '2',
          col15: '14',
          col16: '21',
          col17: '14'
        }
      }],
      context: `Меблева фабрика "Комфорт"
- Виробництво корпусних меблів на замовлення
- 15 працівників на виробництві + 3 менеджери + 2 монтажники
- Середнє замовлення: 28,000 грн
- Цикл виробництва: 2-3 тижні
- Ефективність обладнання падає з 78% до 48%
- Простої обладнання зростають - з 4 до 22 годин/тиждень
- Витрати на переробку браку виросли в 4 рази
- Виробіток на працівника впав з 3.3 до 2.1 одиниць
- Борг клієнтів виріс з 28 до 52 днів - не платять вчасно
- Термін виконання виріс з 14 до 24 днів`,
      priorities: `1. Підняти ефективність з 48% до 80% (ТО обладнання, навчання)
2. Скоротити простої з 22 до 5 годин/тиждень
3. Знизити брак з 8% до 2% та витрати на переробку
4. Скоротити борг клієнтів з 52 до 21 дня (передоплата, контроль)
5. Повернути термін виконання до 14 днів`
    }
  };
  const loadDemoData = async (type = 'consulting') => {
    const demo = DEMO_DATA[type];
    if (!demo) return;

    // Автоматичний бекап перед завантаженням демо!
    if (columns.length > 0 && companyId && user) {
      try {
        await db.collection('companies').doc(companyId).collection('backups').add({
          name: `Авто-бекап перед демо ${new Date().toLocaleString('uk-UA')}`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: user?.uid,
          data: {
            columns,
            rows,
            aiSettings,
            savedAnalyses
          },
          stats: {
            columnsCount: columns.length,
            rowsCount: rows.filter(r => !r.isTarget).length
          },
          autoBackup: true
        });
        console.log('Auto-backup created before demo');
      } catch (e) {
        console.error('Auto-backup failed:', e);
      }
    }
    const today = new Date();
    const getWeekDateKey = weeksAgo => {
      const d = new Date(today);
      d.setDate(d.getDate() - weeksAgo * 7);
      return getWeekKey(d);
    };
    const getMonthKeyLocal = monthsAgo => {
      const d = new Date(today.getFullYear(), today.getMonth() - monthsAgo, 1);
      return getMonthKeyFromDate(d);
    };
    const demoRows = [];
    const weekCount = demo.weeklyData.length;
    const monthCount = demo.monthlyData.length;

    // Тижневі записи (від найстаршого до поточного) - кожен зі своїми targets!
    demo.weeklyData.forEach((data, i) => {
      demoRows.push({
        id: `row${i + 1}`,
        isTarget: false,
        periodType: 'weekly',
        date: getWeekDateKey(weekCount - 1 - i),
        values: data.values,
        targets: data.targets,
        // Свої targets для кожного тижня!
        comments: {}
      });
    });

    // Місячні записи (від найстаршого до поточного)
    demo.monthlyData.forEach((data, i) => {
      demoRows.push({
        id: `month${i + 1}`,
        isTarget: false,
        periodType: 'monthly',
        date: getMonthKeyLocal(monthCount - 1 - i),
        values: data.values,
        targets: data.targets,
        // Свої targets для кожного місяця!
        comments: {}
      });
    });
    setColumns(demo.columns);
    setRows(demoRows);
    setAiSettings({
      businessContext: demo.context,
      priorities: demo.priorities,
      analysisPeriod: weekCount
    });
    setEmployees({});
    setSavedAnalyses([]);
    setCompanyName(`DEMO: ${demo.companyName}`);
    setCompanyId(null); // Скидаємо companyId щоб демо дані НЕ зберігались в реальну компанію!
    setDataLoaded(false); // Демо дані не потрібно зберігати
    setUserProfile({
      role: 'owner',
      name: 'Demo Admin'
    }); // Даємо права owner для демо

    toast.success(`${demo.name} — демо завантажено!`);
    setShowDemoModal(false);
  };
  const handleAuth = async (email, password, isRegister, inviteCode) => {
    setIsSubmitting(true);
    try {
      if (isRegister) {
        // Реєстрація тільки через invite
        if (!inviteCode) {
          toast.error('Реєстрація можлива тільки за запрошенням');
          return;
        }

        // Перевіряємо invite
        const inviteDoc = await db.collection('invites').doc(inviteCode).get();
        if (!inviteDoc.exists || inviteDoc.data().used) {
          toast.error('Невірний або використаний код запрошення');
          return;
        }
        const invite = inviteDoc.data();
        const inviteCompanyId = invite.companyId;

        // Створюємо користувача в Firebase Auth
        const authResult = await auth.createUserWithEmailAndPassword(email, password);

        // 1. Додаємо в глобальний users (для пошуку companyId)
        await db.collection('users').doc(authResult.user.uid).set({
          email,
          companyId: inviteCompanyId,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 2. Додаємо в companies/{companyId}/users
        await db.collection('companies').doc(inviteCompanyId).collection('users').doc(authResult.user.uid).set({
          email,
          name: invite.name || email.split('@')[0],
          role: 'employee',
          visibleColumns: invite.visibleColumns || [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // 3. Позначаємо invite як використаний
        await db.collection('invites').doc(inviteCode).update({
          used: true,
          usedBy: authResult.user.uid,
          usedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        toast.success('Ви приєдналися до команди!');
      } else {
        // Логін
        await auth.signInWithEmailAndPassword(email, password);
        toast.success('Вітаємо!');
      }
      // Clear invite from URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } catch (error) {
      console.error('Auth error:', error);
      if (error.code === 'auth/email-already-in-use') {
        toast.error('Цей email вже зареєстрований. Спробуйте увійти.');
      } else if (error.code === 'auth/wrong-password') {
        toast.error('Невірний пароль');
      } else if (error.code === 'auth/user-not-found') {
        toast.error('Користувача не знайдено');
      } else {
        toast.error(error.message);
      }
    } finally {
      setIsSubmitting(false);
    }
  };
  const handleLogout = async () => {
    // Скасовуємо pending save
    if (saveTimeoutRef.current) {
      clearTimeout(saveTimeoutRef.current);
      saveTimeoutRef.current = null;
    }
    await auth.signOut();
    setColumns([]);
    setRows([]);
    setEmployees({});
    setUserProfile(null);
    setCompanyId(null);
    setCompanyName('');
    setDataLoaded(false); // Скидаємо флаг при logout
    setAuthLoading(false); // Скидаємо стан завантаження
    setSavedAnalyses([]); // Скидаємо збережені аналізи
    setAiSettings({
      businessContext: '',
      priorities: '',
      analysisPeriod: 5
    }); // Скидаємо AI налаштування
    toast.info('До побачення!');
  };

  // ==================== DATA SAVING ====================
  // Ref для актуальних даних (уникаємо stale closure)
  const dataRef = useRef({
    columns,
    rows,
    aiSettings,
    savedAnalyses
  });
  
  // Використовуємо useRef для зберігання останньої версії даних
  const latestDataRef = useRef({ columns, rows, aiSettings, savedAnalyses });
  useEffect(() => {
    latestDataRef.current = { columns, rows, aiSettings, savedAnalyses };
  }, [columns, rows, aiSettings, savedAnalyses]);
  
  // Флаг для відстеження чи є незбережені зміни
  const hasUnsavedChanges = useRef(false);
  const lastSavedData = useRef(null);
  
  // Rollback система - зберігаємо останній успішно збережений стан
  const lastSuccessfulState = useRef(null);
  const saveRetryCount = useRef(0);
  const MAX_SAVE_RETRIES = 3;
  
  const saveData = useCallback(async (immediate = false, isRetry = false) => {
    // ЗАХИСТ: супер-адмін НІКОЛИ не зберігає в реальні компанії
    if (isSuperAdmin) {
      console.log('Skip save - super admin never saves to real companies');
      return { success: true };
    }
    if (!user || !companyId || !isOwner) {
      console.log('Skip save - no permission', {
        user: !!user,
        companyId,
        isOwner
      });
      return { success: true };
    }
    
    // Копіюємо ПОТОЧНИЙ state (не через ref який може бути старим)
    const dataToSave = {
      columns: JSON.parse(JSON.stringify(latestDataRef.current.columns)),
      rows: JSON.parse(JSON.stringify(latestDataRef.current.rows)),
      aiSettings: { ...latestDataRef.current.aiSettings },
      savedAnalyses: [...latestDataRef.current.savedAnalyses]
    };
    
    if (!dataToSave.columns || dataToSave.columns.length === 0 || !dataToSave.rows || dataToSave.rows.length === 0) {
      console.log('Skip save - no data', {
        cols: dataToSave.columns?.length,
        rows: dataToSave.rows?.length
      });
      return { success: true };
    }
    
    // Перевірка чи дані змінились (оптимізація)
    const dataHash = JSON.stringify(dataToSave);
    if (lastSavedData.current === dataHash) {
      console.log('Skip save - no changes');
      return { success: true };
    }
    
    console.log('Saving data...', {
      cols: dataToSave.columns?.length,
      rows: dataToSave.rows?.length,
      companyId,
      immediate,
      retry: isRetry ? saveRetryCount.current : 0
    });
    setSaveStatus('saving');
    
    try {
      await db.collection('companies').doc(companyId).update({
        columns: dataToSave.columns,
        rows: dataToSave.rows,
        aiSettings: dataToSave.aiSettings || {},
        savedAnalyses: dataToSave.savedAnalyses || [],
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log('Data saved successfully');
      lastSavedData.current = dataHash;
      hasUnsavedChanges.current = false;
      saveRetryCount.current = 0;
      
      // Зберігаємо успішний стан для можливого rollback
      lastSuccessfulState.current = dataToSave;
      
      setSaveStatus('saved');
      setTimeout(() => setSaveStatus(null), 2000);
      return { success: true };
    } catch (error) {
      console.error('Error saving:', error);
      saveRetryCount.current++;
      
      // Автоматичний retry
      if (saveRetryCount.current < MAX_SAVE_RETRIES) {
        console.log(`Retrying save (${saveRetryCount.current}/${MAX_SAVE_RETRIES})...`);
        setSaveStatus('saving');
        
        // Експоненційний backoff
        const delay = Math.min(1000 * Math.pow(2, saveRetryCount.current), 8000);
        await new Promise(resolve => setTimeout(resolve, delay));
        
        return saveData(immediate, true);
      }
      
      // Всі retry вичерпані - пропонуємо rollback
      setSaveStatus('error');
      saveRetryCount.current = 0;
      
      // Показуємо помилку з можливістю rollback
      if (lastSuccessfulState.current) {
        toast.error('Помилка збереження. Дані можуть бути втрачені.', 6000);
      } else {
        toast.error(t.saveError);
      }
      
      return { success: false, error };
    }
  }, [user, companyId, isOwner, isSuperAdmin, t.saveError]);
  
  // Функція для ручного rollback
  const rollbackToLastSaved = useCallback(() => {
    if (!lastSuccessfulState.current) {
      toast.warning('Немає збереженого стану для відновлення');
      return;
    }
    
    setColumns(lastSuccessfulState.current.columns);
    setRows(lastSuccessfulState.current.rows);
    setAiSettings(lastSuccessfulState.current.aiSettings);
    setSavedAnalyses(lastSuccessfulState.current.savedAnalyses);
    
    hasUnsavedChanges.current = false;
    setSaveStatus(null);
    toast.success('Дані відновлено до останнього збереженого стану');
  }, []);
  
  const debouncedSave = useCallback(() => {
    hasUnsavedChanges.current = true;
    if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
    saveTimeoutRef.current = setTimeout(() => saveData(false), CONSTANTS.SAVE_DEBOUNCE_MS);
  }, [saveData]);
  
  // Ініціалізуємо lastSuccessfulState при першому завантаженні даних
  useEffect(() => {
    if (dataLoaded && columns.length > 0 && rows.length > 0 && !lastSuccessfulState.current) {
      lastSuccessfulState.current = {
        columns: JSON.parse(JSON.stringify(columns)),
        rows: JSON.parse(JSON.stringify(rows)),
        aiSettings: { ...aiSettings },
        savedAnalyses: [...savedAnalyses]
      };
      console.log('Initialized lastSuccessfulState for rollback');
    }
  }, [dataLoaded, columns, rows, aiSettings, savedAnalyses]);
  
  // Зберігаємо при зміні даних
  useEffect(() => {
    // Зберігаємо тільки якщо:
    // - є юзер і companyId
    // - це власник
    // - НЕ супер-адмін (він ніколи не зберігає)
    // - є дані (columns і rows)
    // - не йде завантаження
    // - ДАНІ ЗАВАНТАЖЕНІ (dataLoaded) - щоб не перезаписати порожніми!
    if (user && companyId && columns.length > 0 && rows.length > 0 && isOwner && !isSuperAdmin && !authLoading && dataLoaded) {
      debouncedSave();
    }
  }, [user, columns, rows, aiSettings, savedAnalyses, isOwner, isSuperAdmin, companyId, debouncedSave, authLoading, dataLoaded]);

  // Зберігаємо при закритті вкладки (beforeunload)
  useEffect(() => {
    const handleBeforeUnload = (e) => {
      if (hasUnsavedChanges.current && companyId && isOwner && !isSuperAdmin) {
        // Негайне збереження
        if (saveTimeoutRef.current) {
          clearTimeout(saveTimeoutRef.current);
        }
        // Синхронний запит не можливий, але спробуємо sendBeacon якщо доступний
        // В реальності Firestore не підтримує sendBeacon, тому просто попереджаємо
        e.preventDefault();
        e.returnValue = 'У вас є незбережені зміни. Ви впевнені що хочете вийти?';
        return e.returnValue;
      }
    };
    
    const handleVisibilityChange = () => {
      // Зберігаємо коли вкладка стає невидимою
      if (document.hidden && hasUnsavedChanges.current && companyId && isOwner && !isSuperAdmin) {
        if (saveTimeoutRef.current) {
          clearTimeout(saveTimeoutRef.current);
        }
        saveData(true);
      }
    };
    
    window.addEventListener('beforeunload', handleBeforeUnload);
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
    };
  }, [companyId, isOwner, isSuperAdmin, saveData]);

  // Cleanup saveTimeoutRef при unmount
  useEffect(() => {
    return () => {
      if (saveTimeoutRef.current) {
        clearTimeout(saveTimeoutRef.current);
        saveTimeoutRef.current = null;
      }
      // Спроба зберегти при unmount
      if (hasUnsavedChanges.current) {
        saveData(true);
      }
    };
  }, [saveData]);

  // ==================== DATA HANDLERS ====================
  const addColumn = () => {
    if (!canEdit || !newStatsName.trim()) return;
    
    // Ліміт на кількість колонок
    if (columns.length >= 50) {
      toast.error('Максимум 50 показників');
      return;
    }
    
    const newColumn = {
      id: Date.now().toString(),
      name: SecurityUtils.sanitize(newStatsName),
      responsible: SecurityUtils.sanitize(newStatsResponsible),
      period: CONSTANTS.PERIODS.includes(newStatsPeriod) ? newStatsPeriod : 'weekly',
      format: CONSTANTS.FORMATS.includes(newStatsFormat) ? newStatsFormat : 'number',
      importance: CONSTANTS.IMPORTANCE_LEVELS.includes(newStatsImportance) ? newStatsImportance : 'medium',
      inverted: Boolean(newStatsInverted),
      visibleToEmployees: []
    };
    setColumns([...columns, newColumn]);
    // Add target value
    if (newStatsTarget) {
      const sanitizedTarget = SecurityUtils.safeString(newStatsTarget);
      setRows(rows.map(row => row.isTarget ? {
        ...row,
        values: {
          ...row.values,
          [newColumn.id]: sanitizedTarget
        }
      } : row));
    }
    setNewStatsName('');
    setNewStatsResponsible('');
    setNewStatsPeriod('weekly');
    setNewStatsTarget('');
    setNewStatsFormat('number');
    setNewStatsImportance('medium');
    setNewStatsInverted(false);
    setShowAddStatsModal(false);
    toast.success(t.addStats);
  };
  const updateColumn = (colId, updates) => {
    // Санітизуємо оновлення
    const sanitizedUpdates = {};
    if (updates.name !== undefined) sanitizedUpdates.name = SecurityUtils.sanitize(updates.name);
    if (updates.responsible !== undefined) sanitizedUpdates.responsible = SecurityUtils.sanitize(updates.responsible);
    if (updates.period !== undefined) sanitizedUpdates.period = CONSTANTS.PERIODS.includes(updates.period) ? updates.period : 'weekly';
    if (updates.format !== undefined) sanitizedUpdates.format = CONSTANTS.FORMATS.includes(updates.format) ? updates.format : 'number';
    if (updates.importance !== undefined) sanitizedUpdates.importance = CONSTANTS.IMPORTANCE_LEVELS.includes(updates.importance) ? updates.importance : 'medium';
    if (updates.inverted !== undefined) sanitizedUpdates.inverted = Boolean(updates.inverted);
    if (updates.visibleToEmployees !== undefined) sanitizedUpdates.visibleToEmployees = Array.isArray(updates.visibleToEmployees) ? updates.visibleToEmployees : [];
    
    setColumns(columns.map(col => col.id === colId ? {
      ...col,
      ...sanitizedUpdates
    } : col));
  };
  const moveColumn = (draggedId, targetId) => {
    const draggedIdx = columns.findIndex(c => c.id === draggedId);
    const targetIdx = columns.findIndex(c => c.id === targetId);
    if (draggedIdx === -1 || targetIdx === -1) return;
    const newColumns = [...columns];
    const [dragged] = newColumns.splice(draggedIdx, 1);
    newColumns.splice(targetIdx, 0, dragged);
    setColumns(newColumns);
    toast.success('Порядок змінено');
  };
  
  // Переміщення рядка вгору/вниз
  const moveRowUp = (rowId, periodType) => {
    const periodRows = rows.filter(r => !r.isTarget && r.periodType === periodType);
    const idx = periodRows.findIndex(r => r.id === rowId);
    if (idx <= 0) return; // Вже вгорі
    
    // Міняємо місцями з попереднім
    const newPeriodRows = [...periodRows];
    [newPeriodRows[idx - 1], newPeriodRows[idx]] = [newPeriodRows[idx], newPeriodRows[idx - 1]];
    
    // Оновлюємо order
    const updatedRows = newPeriodRows.map((row, i) => ({ ...row, order: i }));
    
    // Об'єднуємо
    const targetRow = rows.find(r => r.isTarget);
    const otherRows = rows.filter(r => !r.isTarget && r.periodType !== periodType);
    setRows([targetRow, ...updatedRows, ...otherRows].filter(Boolean));
  };
  
  const moveRowDown = (rowId, periodType) => {
    const periodRows = rows.filter(r => !r.isTarget && r.periodType === periodType);
    const idx = periodRows.findIndex(r => r.id === rowId);
    if (idx === -1 || idx >= periodRows.length - 1) return; // Вже внизу
    
    // Міняємо місцями з наступним
    const newPeriodRows = [...periodRows];
    [newPeriodRows[idx], newPeriodRows[idx + 1]] = [newPeriodRows[idx + 1], newPeriodRows[idx]];
    
    // Оновлюємо order
    const updatedRows = newPeriodRows.map((row, i) => ({ ...row, order: i }));
    
    // Об'єднуємо
    const targetRow = rows.find(r => r.isTarget);
    const otherRows = rows.filter(r => !r.isTarget && r.periodType !== periodType);
    setRows([targetRow, ...updatedRows, ...otherRows].filter(Boolean));
  };
  
  const deleteColumn = id => {
    setConfirmDialog({
      isOpen: true,
      title: t.confirmDelete,
      message: 'Всі дані цього показника буде видалено',
      onConfirm: () => {
        setColumns(columns.filter(col => col.id !== id));
        setRows(rows.map(row => ({
          ...row,
          values: Object.fromEntries(Object.entries(row.values || {}).filter(([key]) => key !== id)),
          comments: Object.fromEntries(Object.entries(row.comments || {}).filter(([key]) => key !== id))
        })));
      }
    });
  };
  const addRow = (periodType = 'weekly') => {
    // Відкриваємо модал для вибору періоду
    setAddPeriodType(periodType);
    if (periodType === 'monthly') {
      setSelectedAddPeriod(getMonthKeyFromDate(new Date()));
    } else {
      setSelectedAddPeriod(getWeekKey(new Date()));
    }
    setShowAddPeriodModal(true);
  };
  const confirmAddPeriod = () => {
    if (!selectedAddPeriod) {
      toast.error('Оберіть період');
      return;
    }

    // Перевірка на дублікат
    const existingRow = rows.find(r => !r.isTarget && r.periodType === addPeriodType && r.date === selectedAddPeriod);
    if (existingRow) {
      toast.warning(`Цей ${addPeriodType === 'monthly' ? 'місяць' : 'тиждень'} вже існує!`);
      return;
    }
    const newRow = {
      id: Date.now().toString(),
      isTarget: false,
      periodType: addPeriodType,
      date: selectedAddPeriod,
      values: {},
      targets: {},
      comments: {}
    };
    setRows([...rows, newRow]);
    setShowAddPeriodModal(false);
    toast.success(addPeriodType === 'monthly' ? 'Додано місяць' : 'Додано тиждень');
  };
  const deleteRow = id => {
    setConfirmDialog({
      isOpen: true,
      title: t.confirmDelete,
      onConfirm: () => setRows(rows.filter(row => row.id !== id))
    });
  };
  const updateDate = (rowId, date) => setRows(rows.map(row => row.id === rowId ? {
    ...row,
    date
  } : row));
  const updateValue = (rowId, colId, value) => setRows(rows.map(row => row.id === rowId ? {
    ...row,
    values: {
      ...row.values,
      [colId]: value
    }
  } : row));
  const updateTarget = (rowId, colId, value) => setRows(rows.map(row => row.id === rowId ? {
    ...row,
    targets: {
      ...row.targets,
      [colId]: value
    }
  } : row));

  // Keyboard navigation для таблиці
  const handleTableKeyDown = useCallback((e, rowIdx, colIdx, totalRows, totalCols) => {
    const inputs = document.querySelectorAll('.stats-table input[type="number"], .mobile-excel-table input[type="number"]');
    const currentIndex = Array.from(inputs).findIndex(input => input === e.target);
    if (e.key === 'Enter' || e.key === 'Tab' && !e.shiftKey) {
      e.preventDefault();
      // Переходимо до наступного інпуту
      const nextInput = inputs[currentIndex + 1];
      if (nextInput) {
        nextInput.focus();
        nextInput.select();
      }
    } else if (e.key === 'Tab' && e.shiftKey) {
      e.preventDefault();
      // Переходимо до попереднього інпуту
      const prevInput = inputs[currentIndex - 1];
      if (prevInput) {
        prevInput.focus();
        prevInput.select();
      }
    } else if (e.key === 'ArrowDown') {
      e.preventDefault();
      // Переходимо на рядок нижче (приблизно)
      const nextRowInput = inputs[currentIndex + totalCols];
      if (nextRowInput) {
        nextRowInput.focus();
        nextRowInput.select();
      }
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      // Переходимо на рядок вище
      const prevRowInput = inputs[currentIndex - totalCols];
      if (prevRowInput) {
        prevRowInput.focus();
        prevRowInput.select();
      }
    } else if (e.key === 'Escape') {
      e.target.blur();
    }
  }, []);
  const updateComment = (rowId, colId, comment) => setRows(rows.map(row => row.id === rowId ? {
    ...row,
    comments: {
      ...row.comments,
      [colId]: comment
    }
  } : row));

  // ==================== TEAM HANDLERS ====================
  const generateInviteCode = () => Math.random().toString(36).substring(2, 10).toUpperCase();
  const addEmployee = async () => {
    if (!newEmployeeName.trim() || !isOwner || !companyId) {
      toast.error("Вкажіть ім'я співробітника");
      return;
    }
    const code = generateInviteCode();
    const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${code}`;
    try {
      // Створюємо invite з companyId (без email - співробітник сам введе)
      await db.collection('invites').doc(code).set({
        companyId: companyId,
        companyName: companyName,
        name: newEmployeeName,
        visibleColumns: selectedColumns,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        used: false
      });
      setGeneratedInviteLink(inviteLink);
      toast.success(t.inviteLink);
    } catch (error) {
      console.error('Error creating invite:', error);
      toast.error('Помилка створення запрошення');
    }
  };
  const copyInviteLink = async () => {
    await navigator.clipboard.writeText(generatedInviteLink);
    toast.success(t.linkCopied);
  };
  const removeEmployee = employeeId => {
    // Не дозволяємо видаляти owner
    if (employees[employeeId]?.role === 'owner') {
      toast.error('Неможливо видалити власника');
      return;
    }
    setConfirmDialog({
      isOpen: true,
      title: 'Видалити співробітника?',
      onConfirm: async () => {
        if (!companyId) return;
        try {
          // Видаляємо з companies/{companyId}/users
          await db.collection('companies').doc(companyId).collection('users').doc(employeeId).delete();

          // Оновлюємо локальний state
          const newEmployees = {
            ...employees
          };
          delete newEmployees[employeeId];
          setEmployees(newEmployees);
          toast.success('Співробітника видалено');
        } catch (error) {
          console.error('Error removing employee:', error);
          toast.error('Помилка видалення');
        }
      }
    });
  };
  const updateEmployeeColumns = async (employeeId, visibleCols) => {
    if (!companyId) return;

    // Оновлюємо локальний state
    const newEmployees = {
      ...employees,
      [employeeId]: {
        ...employees[employeeId],
        visibleColumns: visibleCols
      }
    };
    setEmployees(newEmployees);

    // Зберігаємо в Firebase
    try {
      await db.collection('companies').doc(companyId).collection('users').doc(employeeId).update({
        visibleColumns: visibleCols
      });
      console.log('Employee columns updated');
    } catch (error) {
      console.error('Error updating employee columns:', error);
      toast.error('Помилка оновлення доступу');
    }
  };

  // ==================== AI HANDLERS ====================
  const saveAnalysis = analysis => {
    // analysis може містити: text, date, period, orders
    setSavedAnalyses([analysis, ...savedAnalyses].slice(0, 20));
    toast.success('Збережено в історію!');
  };
  const deletePlan = idx => {
    setConfirmDialog({
      isOpen: true,
      title: 'Видалити цей план?',
      onConfirm: () => {
        setSavedAnalyses(savedAnalyses.filter((_, i) => i !== idx));
        toast.success('План видалено');
      }
    });
  };

  // ==================== EXPORT/IMPORT ====================
  const exportToExcel = () => {
    const wb = XLSX.utils.book_new();

    // === ТИЖНЕВІ ПОКАЗНИКИ ===
    const weeklyColumns = visibleColumns.filter(c => c.period !== 'monthly');
    if (weeklyColumns.length > 0) {
      const weeklyHeaders = ['Тиждень', ...weeklyColumns.map(col => col.name)];
      const responsibleRow = ['Відповідальний', ...weeklyColumns.map(col => col.responsible || '-')];
      const targetRowData = ['ПЛАН', ...weeklyColumns.map(col => targetRow?.values?.[col.id] || '')];
      const weeklyRows = rows.filter(r => !r.isTarget && r.periodType !== 'monthly' && r.date).sort((a, b) => new Date(b.date) - new Date(a.date));
      const weeklyData = weeklyRows.map(row => {
        const weekLabel = formatWeekLabel(row.date);
        return [weekLabel, ...weeklyColumns.map(col => row.values?.[col.id] || '')];
      });
      const wsWeekly = XLSX.utils.aoa_to_sheet([weeklyHeaders, responsibleRow, targetRowData, ...weeklyData]);
      // Ширина колонок
      wsWeekly['!cols'] = [{
        wch: 15
      }, ...weeklyColumns.map(() => ({
        wch: 12
      }))];
      XLSX.utils.book_append_sheet(wb, wsWeekly, 'Тижневі');
    }

    // === МІСЯЧНІ ПОКАЗНИКИ ===
    const monthlyColumns = visibleColumns.filter(c => c.period === 'monthly');
    if (monthlyColumns.length > 0) {
      const monthlyHeaders = ['Місяць', ...monthlyColumns.map(col => col.name)];
      const responsibleRowM = ['Відповідальний', ...monthlyColumns.map(col => col.responsible || '-')];
      const targetRowDataM = ['ПЛАН', ...monthlyColumns.map(col => targetRow?.values?.[col.id] || '')];
      const monthlyRows = rows.filter(r => !r.isTarget && r.periodType === 'monthly' && r.date).sort((a, b) => b.date.localeCompare(a.date));
      const monthlyData = monthlyRows.map(row => {
        const monthLabel = formatMonthLabel(row.date);
        return [monthLabel, ...monthlyColumns.map(col => row.values?.[col.id] || '')];
      });
      const wsMonthly = XLSX.utils.aoa_to_sheet([monthlyHeaders, responsibleRowM, targetRowDataM, ...monthlyData]);
      wsMonthly['!cols'] = [{
        wch: 18
      }, ...monthlyColumns.map(() => ({
        wch: 12
      }))];
      XLSX.utils.book_append_sheet(wb, wsMonthly, 'Місячні');
    }

    // === ВСІ ДАНІ (старий формат для сумісності) ===
    const allHeaders = [t.date, ...visibleColumns.map(col => `${col.name} (${col.responsible || '-'})`)];
    const allTargetRow = [t.target, ...visibleColumns.map(col => targetRow?.values?.[col.id] || '')];
    const allData = dataRows.map(row => [row.date, ...visibleColumns.map(col => row.values?.[col.id] || '')]);
    const wsAll = XLSX.utils.aoa_to_sheet([allHeaders, allTargetRow, ...allData]);
    XLSX.utils.book_append_sheet(wb, wsAll, 'Всі дані');
    XLSX.writeFile(wb, `statistics_${companyName || 'export'}_${new Date().toISOString().split('T')[0]}.xlsx`);
    toast.success(t.export);
  };

  // ==================== BACKUP SYSTEM (FIRESTORE) ====================
  const [showBackupModal, setShowBackupModal] = useState(false);
  const [backups, setBackups] = useState([]);
  const [backupLoading, setBackupLoading] = useState(false);
  const MAX_BACKUPS = 10;

  // Завантажити список бекапів з Firestore
  const loadBackups = useCallback(async () => {
    if (!companyId) return;
    setBackupLoading(true);
    try {
      const snapshot = await db.collection('companies').doc(companyId).collection('backups').orderBy('createdAt', 'desc').limit(MAX_BACKUPS).get();
      const loadedBackups = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setBackups(loadedBackups);
    } catch (e) {
      console.error('Error loading backups:', e);
      toast.error('Помилка завантаження бекапів');
    } finally {
      setBackupLoading(false);
    }
  }, [companyId]);

  // Створити бекап в Firestore
  const createBackup = useCallback(async (name = '') => {
    if (!companyId || !user || columns.length === 0) {
      toast.error('Немає даних для бекапу');
      return;
    }
    setBackupLoading(true);
    try {
      const backupData = {
        name: name || `Бекап ${new Date().toLocaleString('uk-UA')}`,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: user.uid,
        data: {
          columns: columns,
          rows: rows,
          aiSettings: aiSettings,
          savedAnalyses: savedAnalyses
        },
        stats: {
          columnsCount: columns.length,
          rowsCount: rows.filter(r => !r.isTarget).length
        }
      };
      await db.collection('companies').doc(companyId).collection('backups').add(backupData);

      // Видаляємо старі бекапи якщо їх більше MAX_BACKUPS
      const snapshot = await db.collection('companies').doc(companyId).collection('backups').orderBy('createdAt', 'desc').get();
      if (snapshot.docs.length > MAX_BACKUPS) {
        const toDelete = snapshot.docs.slice(MAX_BACKUPS);
        for (const doc of toDelete) {
          await doc.ref.delete();
        }
      }
      await loadBackups();
      toast.success('Бекап створено');
    } catch (e) {
      console.error('Error creating backup:', e);
      toast.error('Помилка створення бекапу');
    } finally {
      setBackupLoading(false);
    }
  }, [companyId, user, columns, rows, aiSettings, savedAnalyses, loadBackups]);

  // Відновити з бекапу
  const restoreBackup = useCallback(async backupId => {
    const backup = backups.find(b => b.id === backupId);
    if (!backup) {
      toast.error('Бекап не знайдено');
      return;
    }
    if (!confirm(`Відновити дані з "${backup.name}"?\n\nПоточні дані будуть замінені!`)) {
      return;
    }
    setBackupLoading(true);
    try {
      // Автоматичний бекап поточних даних перед відновленням!
      if (columns.length > 0) {
        await db.collection('companies').doc(companyId).collection('backups').add({
          name: `Авто-бекап перед відновленням ${new Date().toLocaleString('uk-UA')}`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: user?.uid,
          data: {
            columns,
            rows,
            aiSettings,
            savedAnalyses
          },
          stats: {
            columnsCount: columns.length,
            rowsCount: rows.filter(r => !r.isTarget).length
          },
          autoBackup: true
        });
        console.log('Auto-backup created before restore');
      }

      // Оновлюємо дані в компанії
      await db.collection('companies').doc(companyId).update({
        columns: backup.data.columns || [],
        rows: backup.data.rows || [],
        aiSettings: backup.data.aiSettings || {},
        savedAnalyses: backup.data.savedAnalyses || [],
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Оновлюємо локальний стан
      setColumns(backup.data.columns || []);
      setRows(backup.data.rows || []);
      setAiSettings(backup.data.aiSettings || {
        businessContext: '',
        priorities: '',
        analysisPeriod: 5
      });
      setSavedAnalyses(backup.data.savedAnalyses || []);
      setShowBackupModal(false);
      toast.success('Дані відновлено з бекапу');

      // Записуємо в історію
      logChange(db, companyId, user?.uid, userProfile?.name || 'Unknown', 'restore', 'backup', `Відновлено з бекапу: ${backup.name}`);
    } catch (e) {
      console.error('Error restoring backup:', e);
      toast.error('Помилка відновлення');
    } finally {
      setBackupLoading(false);
    }
  }, [backups, companyId, columns, rows, aiSettings, savedAnalyses, user, userProfile]);

  // Видалити бекап
  const deleteBackup = useCallback(async backupId => {
    if (!confirm('Видалити цей бекап?')) return;
    setBackupLoading(true);
    try {
      await db.collection('companies').doc(companyId).collection('backups').doc(backupId).delete();
      setBackups(backups.filter(b => b.id !== backupId));
      toast.success('Бекап видалено');
    } catch (e) {
      console.error('Error deleting backup:', e);
      toast.error('Помилка видалення');
    } finally {
      setBackupLoading(false);
    }
  }, [backups, companyId]);

  // Завантажуємо бекапи при зміні компанії
  useEffect(() => {
    if (companyId) loadBackups();
  }, [companyId, loadBackups]);

  // Імпорт з Excel
  const [showImportModal, setShowImportModal] = useState(false);
  const [importPreview, setImportPreview] = useState(null);
  const fileInputRef = React.useRef(null);
  const handleFileSelect = async e => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    // Перевірка розміру файлу (макс 5MB)
    if (file.size > 5 * 1024 * 1024) {
      toast.error('Файл занадто великий (макс 5MB)');
      return;
    }
    
    try {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data);

      // Парсимо дані
      const preview = {
        columns: [],
        rows: [],
        weeklyCount: 0,
        monthlyCount: 0
      };

      // Читаємо лист "Тижневі" або перший лист
      const weeklySheet = wb.Sheets['Тижневі'] || wb.Sheets[wb.SheetNames[0]];
      if (weeklySheet) {
        const weeklyData = XLSX.utils.sheet_to_json(weeklySheet, {
          header: 1
        });
        if (weeklyData.length >= 2) {
          const headers = weeklyData[0];
          const responsibles = weeklyData[1];
          const targets = weeklyData[2];

          // Створюємо колонки (пропускаємо перший стовпець - дата)
          // SECURITY: Санітизація всіх даних з Excel
          for (let i = 1; i < headers.length && i <= 50; i++) { // Ліміт 50 колонок
            if (headers[i]) {
              preview.columns.push({
                id: `col${i}`,
                name: SecurityUtils.sanitize(headers[i]),
                responsible: responsibles?.[i] !== 'Відповідальний' 
                  ? SecurityUtils.sanitize(responsibles?.[i] || '') 
                  : '',
                period: 'weekly',
                format: detectFormat(SecurityUtils.safeString(headers[i])),
                importance: 'medium',
                visibleToEmployees: []
              });
            }
          }

          // Зчитуємо рядки даних (починаємо з 3-го рядка, пропускаючи ПЛАН)
          const startRow = responsibles?.[0] === 'Відповідальний' ? targets?.[0] === 'ПЛАН' ? 3 : 2 : 1;
          for (let r = startRow; r < weeklyData.length && r <= 500; r++) { // Ліміт 500 рядків
            const rowData = weeklyData[r];
            if (!rowData || !rowData[0]) continue;
            const values = {};
            for (let c = 1; c < rowData.length && c <= preview.columns.length; c++) {
              // SECURITY: Санітизація значень
              values[`col${c}`] = SecurityUtils.safeString(rowData[c] || '');
            }

            // Парсимо дату з першого стовпця
            const dateStr = SecurityUtils.safeString(rowData[0]);
            const weekKey = parseWeekFromLabel(dateStr);
            preview.rows.push({
              id: `row${preview.rows.length + 1}`,
              isTarget: false,
              periodType: 'weekly',
              date: weekKey || getWeekKey(new Date()),
              values,
              targets: {},
              comments: {}
            });
            preview.weeklyCount++;
          }

          // Зчитуємо плани
          if (targets?.[0] === 'ПЛАН') {
            const targetValues = {};
            for (let c = 1; c < targets.length && c <= preview.columns.length; c++) {
              if (targets[c]) targetValues[`col${c}`] = String(targets[c]);
            }
            preview.rows.forEach(row => {
              if (row.periodType === 'weekly') row.targets = {
                ...targetValues
              };
            });
          }
        }
      }

      // Читаємо лист "Місячні"
      const monthlySheet = wb.Sheets['Місячні'];
      if (monthlySheet) {
        const monthlyData = XLSX.utils.sheet_to_json(monthlySheet, {
          header: 1
        });
        if (monthlyData.length >= 2) {
          const headers = monthlyData[0];
          const responsibles = monthlyData[1];
          const targets = monthlyData[2];
          const colOffset = preview.columns.length;

          // Додаємо місячні колонки (з санітизацією та лімітом)
          for (let i = 1; i < headers.length && (colOffset + i) <= 50; i++) {
            if (headers[i]) {
              preview.columns.push({
                id: `col${colOffset + i}`,
                name: SecurityUtils.sanitize(headers[i]),
                responsible: responsibles?.[i] !== 'Відповідальний' 
                  ? SecurityUtils.sanitize(responsibles?.[i] || '') 
                  : '',
                period: 'monthly',
                format: detectFormat(SecurityUtils.safeString(headers[i])),
                importance: 'medium',
                visibleToEmployees: []
              });
            }
          }

          // Зчитуємо місячні дані (з санітизацією та лімітом)
          const startRow = responsibles?.[0] === 'Відповідальний' ? targets?.[0] === 'ПЛАН' ? 3 : 2 : 1;
          for (let r = startRow; r < monthlyData.length && preview.monthlyCount <= 100; r++) {
            const rowData = monthlyData[r];
            if (!rowData || !rowData[0]) continue;
            const values = {};
            for (let c = 1; c < rowData.length; c++) {
              values[`col${colOffset + c}`] = SecurityUtils.safeString(rowData[c] || '');
            }
            const dateStr = SecurityUtils.safeString(rowData[0]);
            const monthKey = parseMonthFromLabel(dateStr);
            preview.rows.push({
              id: `month${preview.monthlyCount + 1}`,
              isTarget: false,
              periodType: 'monthly',
              date: monthKey || getMonthKeyFromDate(new Date()),
              values,
              targets: {},
              comments: {}
            });
            preview.monthlyCount++;
          }

          // Плани для місячних
          if (targets?.[0] === 'ПЛАН') {
            const targetValues = {};
            for (let c = 1; c < targets.length; c++) {
              if (targets[c]) targetValues[`col${colOffset + c}`] = SecurityUtils.safeString(targets[c]);
            }
            preview.rows.forEach(row => {
              if (row.periodType === 'monthly') row.targets = {
                ...targetValues
              };
            });
          }
        }
      }
      setImportPreview(preview);
      setShowImportModal(true);
    } catch (err) {
      console.error('Import error:', err);
      toast.error('Помилка читання файлу: ' + (err.message || 'Невідома помилка'));
    }

    // Reset input
    if (fileInputRef.current) fileInputRef.current.value = '';
  };
  const detectFormat = name => {
    const lower = SecurityUtils.safeString(name).toLowerCase();
    if (lower.includes('%') || lower.includes('конверсія') || lower.includes('roi') || lower.includes('маржа')) return 'percent';
    if (lower.includes('$') || lower.includes('usd') || lower.includes('долар')) return 'usd';
    if (lower.includes('€') || lower.includes('eur') || lower.includes('євро')) return 'eur';
    if (lower.includes('грн') || lower.includes('₴') || lower.includes('дохід') || lower.includes('виручка') || lower.includes('прибуток') || lower.includes('витрат') || lower.includes('бюджет') || lower.includes('чек') || lower.includes('вартість') || lower.includes('собівартість') || lower.includes('сировин')) return 'uah';
    return 'number';
  };
  const parseWeekFromLabel = label => {
    // Формат: "09.12 - 15.12" або "Тиждень 50" або "2024-W50"
    const match = label.match(/(\d{2})\.(\d{2})\s*-\s*(\d{2})\.(\d{2})/);
    if (match) {
      const year = new Date().getFullYear();
      const startDate = new Date(year, parseInt(match[2]) - 1, parseInt(match[1]));
      return getWeekKey(startDate);
    }
    const weekMatch = label.match(/W?(\d{1,2})/i);
    if (weekMatch) {
      const weekNum = parseInt(weekMatch[1]);
      const year = new Date().getFullYear();
      return `${year}-W${String(weekNum).padStart(2, '0')}`;
    }
    return null;
  };
  const parseMonthFromLabel = label => {
    // Формат: "Грудень 2024" або "12.2024" або "2024-12"
    const months = ['січень', 'лютий', 'березень', 'квітень', 'травень', 'червень', 'липень', 'серпень', 'вересень', 'жовтень', 'листопад', 'грудень'];
    const lower = label.toLowerCase();
    for (let i = 0; i < months.length; i++) {
      if (lower.includes(months[i])) {
        const yearMatch = label.match(/(\d{4})/);
        const year = yearMatch ? parseInt(yearMatch[1]) : new Date().getFullYear();
        return `${year}-${String(i + 1).padStart(2, '0')}`;
      }
    }
    const numMatch = label.match(/(\d{1,2})[\.\/](\d{4})/);
    if (numMatch) {
      return `${numMatch[2]}-${String(numMatch[1]).padStart(2, '0')}`;
    }
    const isoMatch = label.match(/(\d{4})-(\d{2})/);
    if (isoMatch) return `${isoMatch[1]}-${isoMatch[2]}`;
    return null;
  };
  
  // Loading states
  const [isImporting, setIsImporting] = useState(false);
  const [isDeletingBackup, setIsDeletingBackup] = useState(null);
  const [isRestoringBackup, setIsRestoringBackup] = useState(null);
  
  const confirmImport = async mode => {
    if (!importPreview || isImporting) return;
    
    setIsImporting(true);

    // Автоматичний бекап перед імпортом!
    if (columns.length > 0 && companyId) {
      try {
        await db.collection('companies').doc(companyId).collection('backups').add({
          name: `Авто-бекап перед імпортом ${new Date().toLocaleString('uk-UA')}`,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: user?.uid,
          data: {
            columns,
            rows,
            aiSettings,
            savedAnalyses
          },
          stats: {
            columnsCount: columns.length,
            rowsCount: rows.filter(r => !r.isTarget).length
          },
          autoBackup: true
        });
        console.log('Auto-backup created before import');
      } catch (e) {
        console.error('Auto-backup failed:', e);
      }
    }
    
    try {
      if (mode === 'replace') {
        setColumns(importPreview.columns);
        setRows(importPreview.rows);
      } else {
        // Merge - додаємо нові колонки та рядки
        const existingColNames = columns.map(c => c.name.toLowerCase());
        const newColumns = importPreview.columns.filter(c => !existingColNames.includes(c.name.toLowerCase()));

        // Оновлюємо ID нових колонок
        const maxColId = Math.max(...columns.map(c => parseInt(c.id.replace('col', '')) || 0), 0);
        newColumns.forEach((col, i) => {
          col.id = `col${maxColId + i + 1}`;
        });
        setColumns([...columns, ...newColumns]);

        // Додаємо рядки з унікальними датами
        const existingDates = new Set(rows.map(r => `${r.periodType}-${r.date}`));
        const newRows = importPreview.rows.filter(r => !existingDates.has(`${r.periodType}-${r.date}`));
        const maxRowId = Math.max(...rows.map(r => parseInt(r.id.replace('row', '').replace('month', '')) || 0), 0);
        newRows.forEach((row, i) => {
          row.id = row.periodType === 'monthly' ? `month${maxRowId + i + 1}` : `row${maxRowId + i + 1}`;
        });
        setRows([...rows, ...newRows]);
      }
      setShowImportModal(false);
      setImportPreview(null);
      toast.success(`Імпортовано: ${importPreview.columns.length} показників, ${importPreview.weeklyCount} тижнів, ${importPreview.monthlyCount} місяців`);

      // Записуємо в історію
      if (companyId) {
        logChange(db, companyId, user?.uid, userProfile?.name || 'Unknown', 'import', 'data', `Імпорт: ${importPreview.columns.length} показників, ${importPreview.weeklyCount} тижнів, ${importPreview.monthlyCount} місяців`);
      }
    } finally {
      setIsImporting(false);
    }
  };

  // ==================== RENDER ====================
  if (authLoading) return /*#__PURE__*/React.createElement("div", {
    className: "min-h-screen flex flex-col items-center justify-center bg-gray-50 p-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-16 h-16 rounded-2xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-lg shadow-primary-500/30 mb-4"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-8 h-8 text-white"
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 text-gray-600"
  }, /*#__PURE__*/React.createElement(Spinner, { size: "sm" }), /*#__PURE__*/React.createElement("span", {
    className: "font-medium"
  }, "Завантаження...")), /*#__PURE__*/React.createElement("div", {
    className: "mt-8 w-full max-w-md space-y-3"
  }, /*#__PURE__*/React.createElement("div", { className: "skeleton h-12 rounded-xl" }), /*#__PURE__*/React.createElement("div", { className: "skeleton h-32 rounded-xl" }), /*#__PURE__*/React.createElement("div", { className: "flex gap-2" }, 
    /*#__PURE__*/React.createElement("div", { className: "skeleton h-10 rounded-lg flex-1" }),
    /*#__PURE__*/React.createElement("div", { className: "skeleton h-10 rounded-lg flex-1" }),
    /*#__PURE__*/React.createElement("div", { className: "skeleton h-10 rounded-lg flex-1" })
  )));
  if (!user) return /*#__PURE__*/React.createElement(AuthForm, {
    t: t,
    onAuth: handleAuth,
    isLoading: isSubmitting
  });
  return /*#__PURE__*/React.createElement("div", {
    className: "min-h-screen bg-gray-50"
  }, /*#__PURE__*/React.createElement("input", {
    type: "file",
    ref: fileInputRef,
    accept: ".xlsx,.xls,.csv",
    onChange: handleFileSelect,
    className: "hidden"
  }), saveStatus && /*#__PURE__*/React.createElement("div", {
    className: `fixed top-4 right-4 z-50 px-4 py-2 rounded-xl text-sm font-semibold shadow-lg animate-slide-down flex items-center gap-2
                            ${saveStatus === 'saving' ? 'bg-amber-100 text-amber-700' : ''}
                            ${saveStatus === 'saved' ? 'bg-green-100 text-green-700' : ''}
                            ${saveStatus === 'error' ? 'bg-red-100 text-red-700' : ''}
                        `
  }, saveStatus === 'saving' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Spinner, {
    size: "sm",
    className: "mr-1"
  }), t.saving), saveStatus === 'saved' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.CheckCircle, {
    className: "w-4 h-4 inline mr-2"
  }), t.saved), saveStatus === 'error' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-4 h-4 mr-1"
  }), /*#__PURE__*/React.createElement("span", null, t.saveError), lastSuccessfulState.current && /*#__PURE__*/React.createElement("button", {
    onClick: rollbackToLastSaved,
    className: "ml-2 px-2 py-1 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600 transition-colors"
  }, "\u0412\u0456\u0434\u043D\u043E\u0432\u0438\u0442\u0438"))), /*#__PURE__*/React.createElement("div", {
    className: "w-full px-4 lg:px-8 pb-24 sm:pb-8"
  }, /*#__PURE__*/React.createElement("header", {
    className: "card p-3 sm:p-4 mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between gap-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 sm:gap-3 min-w-0"
  }, /*#__PURE__*/React.createElement("div", {
    className: "w-10 h-10 sm:w-12 sm:h-12 rounded-xl sm:rounded-2xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-lg shadow-primary-500/30 flex-shrink-0"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-5 h-5 sm:w-6 sm:h-6 text-white"
  })), /*#__PURE__*/React.createElement("div", {
    className: "min-w-0"
  }, /*#__PURE__*/React.createElement("h1", {
    className: "text-base sm:text-lg font-bold text-gray-900 truncate"
  }, companyName || t.appName), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2"
  }, isSuperAdmin ? /*#__PURE__*/React.createElement("span", {
    className: "badge text-xs bg-gradient-to-r from-red-500 to-pink-500 text-white"
  }, /*#__PURE__*/React.createElement(Icons.Shield, {
    className: "w-3 h-3 mr-1"
  }), "Admin") : /*#__PURE__*/React.createElement("span", {
    className: `badge text-xs ${isOwner ? 'badge-purple' : 'badge-amber'}`
  }, isOwner ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.Crown, {
    className: "w-3 h-3 mr-1"
  }), t.owner) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.User, {
    className: "w-3 h-3 mr-1"
  }), t.employee))))), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-1 sm:gap-2 flex-shrink-0"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowMenu(true),
    className: "btn btn-ghost btn-icon sm:hidden"
  }, /*#__PURE__*/React.createElement(Icons.Menu, {
    className: "w-6 h-6"
  })), /*#__PURE__*/React.createElement("div", {
    className: "hidden sm:flex items-center gap-1.5"
  }, isSuperAdmin && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAdminPanel(true),
    className: "btn btn-sm bg-gradient-to-r from-red-500 to-pink-500 text-white hover:from-red-600 hover:to-pink-600"
  }, /*#__PURE__*/React.createElement(Icons.Shield, {
    className: "w-4 h-4"
  })), canEdit && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAIModal(true),
    className: "btn btn-sm btn-ai"
  }, /*#__PURE__*/React.createElement(Icons.Brain, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveTab(activeTab === 'plans' ? 'stats' : 'plans'),
    className: `btn btn-sm ${activeTab === 'plans' ? 'btn-primary' : 'btn-secondary'}`
  }, /*#__PURE__*/React.createElement(Icons.FileText, {
    className: "w-4 h-4"
  }), savedAnalyses.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "ml-1 text-xs font-bold"
  }, savedAnalyses.length)), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowTeamModal(true),
    className: "btn btn-sm btn-secondary"
  }, /*#__PURE__*/React.createElement(Icons.Users, {
    className: "w-4 h-4"
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowDemoModal(true),
    className: "btn btn-sm btn-secondary",
    title: "\u0414\u0435\u043C\u043E"
  }, /*#__PURE__*/React.createElement(Icons.Play, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => fileInputRef.current?.click(),
    className: "btn btn-sm btn-secondary",
    title: "\u0406\u043C\u043F\u043E\u0440\u0442 \u0437 Excel"
  }, /*#__PURE__*/React.createElement(Icons.Upload, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: exportToExcel,
    className: "btn btn-sm btn-secondary",
    title: "\u0415\u043A\u0441\u043F\u043E\u0440\u0442 \u0432 Excel"
  }, /*#__PURE__*/React.createElement(Icons.Download, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      loadBackups();
      setShowBackupModal(true);
    },
    className: "btn btn-sm btn-secondary",
    title: "\u0411\u0435\u043A\u0430\u043F\u0438"
  }, /*#__PURE__*/React.createElement(Icons.Database, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: handleLogout,
    className: "btn btn-sm btn-ghost"
  }, /*#__PURE__*/React.createElement(Icons.LogOut, {
    className: "w-4 h-4"
  })))))), activeTab === 'stats' && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "hidden sm:flex gap-3 mb-4 items-center bg-white rounded-xl p-3 shadow-sm border border-gray-100"
  }, /*#__PURE__*/React.createElement("div", {
    className: "relative flex-1 max-w-xs"
  }, /*#__PURE__*/React.createElement(Icons.Search, {
    className: "w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
  }), /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "\u041F\u043E\u0448\u0443\u043A \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432...",
    value: searchQuery,
    onChange: e => setSearchQuery(e.target.value),
    className: "input-field pl-9 py-1.5 text-sm bg-gray-50"
  }), searchQuery && /*#__PURE__*/React.createElement("button", {
    onClick: () => setSearchQuery(''),
    className: "absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
  }, /*#__PURE__*/React.createElement(Icons.Close, {
    className: "w-4 h-4"
  }))), uniqueResponsibles.length > 0 && /*#__PURE__*/React.createElement("select", {
    value: filterResponsible,
    onChange: e => setFilterResponsible(e.target.value),
    className: "select-field py-1.5 text-sm w-auto bg-gray-50"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "\u0412\u0441\u0456 \u0432\u0456\u0434\u043F\u043E\u0432\u0456\u0434\u0430\u043B\u044C\u043D\u0456"), uniqueResponsibles.map(r => /*#__PURE__*/React.createElement("option", {
    key: r,
    value: r
  }, r))), (searchQuery || filterResponsible) && /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-500"
  }, "\u041F\u043E\u043A\u0430\u0437\u0430\u043D\u043E: ", weeklyColumns.length + monthlyColumns.length, " \u0437 ", columns.length), canEdit && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "h-6 w-px bg-gray-200 mx-1"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddStatsModal(true),
    className: "btn btn-primary btn-sm"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-4 h-4"
  }), t.addStats), /*#__PURE__*/React.createElement("button", {
    onClick: () => addRow('weekly'),
    className: "btn btn-secondary btn-sm"
  }, /*#__PURE__*/React.createElement(Icons.Calendar, {
    className: "w-4 h-4"
  }), "+ \u0422\u0438\u0436\u0434\u0435\u043D\u044C"), allMonthlyColumns.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => addRow('monthly'),
    className: "btn btn-secondary btn-sm"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-4 h-4"
  }), "+ \u041C\u0456\u0441\u044F\u0446\u044C")), /*#__PURE__*/React.createElement("div", {
    className: "h-6 w-px bg-gray-200 mx-1"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowTrendsModal(true),
    className: "btn btn-secondary btn-sm",
    title: "\u0413\u0440\u0430\u0444\u0456\u043A\u0438 \u0442\u0440\u0435\u043D\u0434\u0456\u0432"
  }, /*#__PURE__*/React.createElement(Icons.TrendingUp, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowCompareModal(true),
    className: "btn btn-secondary btn-sm",
    title: "\u041F\u043E\u0440\u0456\u0432\u043D\u044F\u043D\u043D\u044F \u043F\u0435\u0440\u0456\u043E\u0434\u0456\u0432"
  }, /*#__PURE__*/React.createElement(Icons.ArrowLeftRight, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAlertsModal(true),
    className: "btn btn-secondary btn-sm relative",
    title: "\u041F\u0440\u043E\u0431\u043B\u0435\u043C\u043D\u0456 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0438"
  }, /*#__PURE__*/React.createElement(Icons.AlertTriangle, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowPDFModal(true),
    className: "btn btn-secondary btn-sm",
    title: "\u0415\u043A\u0441\u043F\u043E\u0440\u0442 PDF"
  }, /*#__PURE__*/React.createElement(Icons.FileText, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("div", {
    className: "relative"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowToolsDropdown(!showToolsDropdown),
    className: "btn btn-sm btn-secondary",
    title: "\u0411\u0456\u043B\u044C\u0448\u0435 \u0456\u043D\u0441\u0442\u0440\u0443\u043C\u0435\u043D\u0442\u0456\u0432"
  }, /*#__PURE__*/React.createElement(Icons.ExternalLink, {
    className: "w-4 h-4"
  })), showToolsDropdown && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "fixed inset-0 z-40",
    onClick: () => setShowToolsDropdown(false)
  }), /*#__PURE__*/React.createElement("div", {
    className: "absolute right-0 top-full mt-2 w-52 bg-white rounded-xl shadow-xl border border-gray-100 py-2 z-50"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowHistoryModal(true);
      setShowToolsDropdown(false);
    },
    className: "flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-50 w-full text-left"
  }, /*#__PURE__*/React.createElement(Icons.Clock, {
    className: "w-4 h-4 text-blue-500"
  }), " \u0406\u0441\u0442\u043E\u0440\u0456\u044F \u0437\u043C\u0456\u043D"), /*#__PURE__*/React.createElement("hr", {
    className: "my-2"
  }), /*#__PURE__*/React.createElement("a", {
    href: "https://chatgpt.com/g/g-6851a70e282481918ad5c2894ff30b13-statistics",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-50",
    onClick: () => setShowToolsDropdown(false)
  }, /*#__PURE__*/React.createElement(Icons.Target, {
    className: "w-4 h-4 text-gray-500"
  }), "AI \u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043A\u0438"), /*#__PURE__*/React.createElement("a", {
    href: "https://chatgpt.com/g/g-684be37e3bcc81918f64088a2bb094da-instructions-generator",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-50",
    onClick: () => setShowToolsDropdown(false)
  }, /*#__PURE__*/React.createElement(Icons.Edit, {
    className: "w-4 h-4 text-gray-500"
  }), "\u0420\u043E\u0437\u043F\u043E\u0440\u044F\u0434\u0436\u0435\u043D\u043D\u044F"), /*#__PURE__*/React.createElement("a", {
    href: "https://alextalko.com/alta",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-50",
    onClick: () => setShowToolsDropdown(false)
  }, /*#__PURE__*/React.createElement(Icons.CheckSquare, {
    className: "w-4 h-4 text-gray-500"
  }), "\u0417\u0430\u0434\u0430\u0447\u0456"), /*#__PURE__*/React.createElement("a", {
    href: "https://alextalko.com/tms",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-50",
    onClick: () => setShowToolsDropdown(false)
  }, /*#__PURE__*/React.createElement(Icons.GitBranch, {
    className: "w-4 h-4 text-gray-500"
  }), "\u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430"), /*#__PURE__*/React.createElement("hr", {
    className: "my-2"
  }), /*#__PURE__*/React.createElement("a", {
    href: GPT_BOTTLENECK_URL,
    target: "_blank",
    rel: "noopener noreferrer",
    className: "flex items-center gap-2 px-4 py-2 text-sm hover:bg-gray-50",
    onClick: () => setShowToolsDropdown(false)
  }, /*#__PURE__*/React.createElement(Icons.Brain, {
    className: "w-4 h-4 text-purple-500"
  }), "AI \u0412\u0443\u0437\u044C\u043A\u0456 \u043C\u0456\u0441\u0446\u044F"))))), /*#__PURE__*/React.createElement("div", {
    className: "sm:hidden"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 mb-3"
  }, /*#__PURE__*/React.createElement("div", {
    className: "relative flex-1"
  }, /*#__PURE__*/React.createElement(Icons.Search, {
    className: "w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
  }), /*#__PURE__*/React.createElement("input", {
    type: "text",
    placeholder: "\u041F\u043E\u0448\u0443\u043A...",
    value: searchQuery,
    onChange: e => setSearchQuery(e.target.value),
    className: "input-field pl-9 py-2 text-sm w-full"
  })), uniqueResponsibles.length > 0 && /*#__PURE__*/React.createElement("select", {
    value: filterResponsible,
    onChange: e => setFilterResponsible(e.target.value),
    className: "select-field py-2 text-sm w-auto"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "\u0412\u0441\u0456"), uniqueResponsibles.map(r => /*#__PURE__*/React.createElement("option", {
    key: r,
    value: r
  }, r)))), weeklyColumns.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xs font-bold text-gray-700"
  }, "\u0422\u0438\u0436\u043D\u0435\u0432\u0456"), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => addRow('weekly'),
    className: "text-xs text-primary-600"
  }, "+ \u0422\u0438\u0436\u0434\u0435\u043D\u044C")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto -mx-4 px-4"
  }, /*#__PURE__*/React.createElement("table", {
    className: "mobile-excel-table"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "sticky-col"
  }, "\u0422\u0438\u0436\u0434."), weeklyColumns.map(col => /*#__PURE__*/React.createElement("th", {
    key: col.id,
    className: "wrap-header",
    title: col.inverted ? "Від'ємний (чим менше - тим краще)" : col.name
  }, col.inverted && /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "\u2193"), col.name)), canEdit && /*#__PURE__*/React.createElement("th", null))), /*#__PURE__*/React.createElement("tbody", null, weeklyRows.map((row, idx) => /*#__PURE__*/React.createElement("tr", {
    key: row.id,
    className: idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'
  }, /*#__PURE__*/React.createElement("td", {
    className: "sticky-col"
  }, /*#__PURE__*/React.createElement("select", {
    value: getWeekKey(row.date) || '',
    onChange: e => updateDate(row.id, e.target.value),
    className: "mobile-date-select"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "--"), WEEKS_CACHE.slice(0, 20).map(p => /*#__PURE__*/React.createElement("option", {
    key: p.key,
    value: p.key
  }, p.label)))), weeklyColumns.map((col, colIdx) => /*#__PURE__*/React.createElement("td", {
    key: col.id
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    inputMode: "decimal",
    value: row.values?.[col.id] || '',
    onChange: e => updateValue(row.id, col.id, e.target.value),
    onKeyDown: e => handleTableKeyDown(e, idx, colIdx, weeklyRows.length, weeklyColumns.length),
    className: "mobile-cell-input",
    placeholder: "0"
  }))), canEdit && /*#__PURE__*/React.createElement("td", null, /*#__PURE__*/React.createElement("button", {
    onClick: () => deleteRow(row.id),
    className: "text-red-400 p-1"
  }, /*#__PURE__*/React.createElement(Icons.Trash, {
    className: "w-3 h-3"
  }))))))))), monthlyColumns.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: "text-xs font-bold text-gray-700"
  }, "\u041C\u0456\u0441\u044F\u0447\u043D\u0456"), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => addRow('monthly'),
    className: "text-xs text-blue-600"
  }, "+ \u041C\u0456\u0441\u044F\u0446\u044C")), /*#__PURE__*/React.createElement("div", {
    className: "overflow-x-auto -mx-4 px-4"
  }, /*#__PURE__*/React.createElement("table", {
    className: "mobile-excel-table"
  }, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", {
    className: "sticky-col"
  }, "\u041C\u0456\u0441\u044F\u0446\u044C"), monthlyColumns.map(col => /*#__PURE__*/React.createElement("th", {
    key: col.id,
    className: "wrap-header",
    title: col.inverted ? "Від'ємний (чим менше - тим краще)" : col.name
  }, col.inverted && /*#__PURE__*/React.createElement("span", {
    className: "text-red-500"
  }, "\u2193"), col.name)), canEdit && /*#__PURE__*/React.createElement("th", null))), /*#__PURE__*/React.createElement("tbody", null, monthlyRows.map((row, idx) => /*#__PURE__*/React.createElement("tr", {
    key: row.id,
    className: idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'
  }, /*#__PURE__*/React.createElement("td", {
    className: "sticky-col"
  }, /*#__PURE__*/React.createElement("select", {
    value: row.date || '',
    onChange: e => updateDate(row.id, e.target.value),
    className: "mobile-date-select"
  }, /*#__PURE__*/React.createElement("option", {
    value: ""
  }, "--"), MONTHS_CACHE.slice(0, 12).map(p => /*#__PURE__*/React.createElement("option", {
    key: p.key,
    value: p.key
  }, p.label)))), monthlyColumns.map((col, colIdx) => /*#__PURE__*/React.createElement("td", {
    key: col.id
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    inputMode: "decimal",
    value: row.values?.[col.id] || '',
    onChange: e => updateValue(row.id, col.id, e.target.value),
    onKeyDown: e => handleTableKeyDown(e, idx, colIdx, monthlyRows.length, monthlyColumns.length),
    className: "mobile-cell-input",
    placeholder: "0"
  }))), canEdit && /*#__PURE__*/React.createElement("td", null, /*#__PURE__*/React.createElement("button", {
    onClick: () => deleteRow(row.id),
    className: "text-red-400 p-1"
  }, /*#__PURE__*/React.createElement(Icons.Trash, {
    className: "w-3 h-3"
  }))))))))), weeklyColumns.length === 0 && monthlyColumns.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "empty-state"
  }, /*#__PURE__*/React.createElement("div", {
    className: "empty-state-icon"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-10 h-10 text-primary-500"
  })), /*#__PURE__*/React.createElement("h3", {
    className: "text-xl font-bold text-gray-900 mb-2"
  }, t.noData), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 mb-6"
  }, "\u041F\u043E\u0447\u043D\u0456\u0442\u044C \u0437 \u0434\u043E\u0434\u0430\u0432\u0430\u043D\u043D\u044F \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432"), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddStatsModal(true),
    className: "btn btn-primary"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-5 h-5"
  }), t.addStats))), /*#__PURE__*/React.createElement("div", {
    className: "hidden sm:block space-y-6"
  }, weeklyColumns.length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-3"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-lg font-bold text-gray-900 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Calendar, {
    className: "w-5 h-5 text-primary-500"
  }), "\u0422\u0438\u0436\u043D\u0435\u0432\u0456 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0438", /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-normal text-gray-500"
  }, "(", weeklyColumns.length, " \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432)"), duplicateDates.weekly.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-3 h-3"
  }), duplicateDates.weekly.length, " \u0434\u0443\u0431\u043B\u0456\u043A\u0430\u0442(\u0456\u0432)")), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => addRow('weekly'),
    className: "btn btn-secondary btn-sm"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-4 h-4"
  }), "\u0414\u043E\u0434\u0430\u0442\u0438 \u0442\u0438\u0436\u0434\u0435\u043D\u044C")), /*#__PURE__*/React.createElement(StatsTable, {
    columns: weeklyColumns,
    rows: [targetRow, ...weeklyRows].filter(Boolean),
    targetRow: targetRow,
    periodType: "weekly",
    onDeleteRow: deleteRow,
    onDateChange: updateDate,
    onValueChange: updateValue,
    onTargetChange: updateTarget,
    onCommentChange: updateComment,
    onEditColumn: col => {
      setEditingColumn(col);
      setShowEditColumnModal(true);
    },
    onMoveColumn: moveColumn,
    onMoveRowUp: moveRowUp,
    onMoveRowDown: moveRowDown,
    editable: canEdit,
    t: t,
    duplicateDates: duplicateDates.weekly
  })), monthlyColumns.length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-3"
  }, /*#__PURE__*/React.createElement("h2", {
    className: "text-lg font-bold text-gray-900 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-5 h-5 text-blue-500"
  }), "\u041C\u0456\u0441\u044F\u0447\u043D\u0456 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0438", /*#__PURE__*/React.createElement("span", {
    className: "text-sm font-normal text-gray-500"
  }, "(", monthlyColumns.length, " \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432)"), duplicateDates.monthly.length > 0 && /*#__PURE__*/React.createElement("span", {
    className: "text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-3 h-3"
  }), duplicateDates.monthly.length, " \u0434\u0443\u0431\u043B\u0456\u043A\u0430\u0442(\u0456\u0432)")), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => addRow('monthly'),
    className: "btn btn-secondary btn-sm"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-4 h-4"
  }), "\u0414\u043E\u0434\u0430\u0442\u0438 \u043C\u0456\u0441\u044F\u0446\u044C")), /*#__PURE__*/React.createElement(StatsTable, {
    columns: monthlyColumns,
    rows: [targetRow, ...monthlyRows].filter(Boolean),
    targetRow: targetRow,
    periodType: "monthly",
    onDeleteRow: deleteRow,
    onDateChange: updateDate,
    onValueChange: updateValue,
    onTargetChange: updateTarget,
    onCommentChange: updateComment,
    onEditColumn: col => {
      setEditingColumn(col);
      setShowEditColumnModal(true);
    },
    onMoveColumn: moveColumn,
    onMoveRowUp: moveRowUp,
    onMoveRowDown: moveRowDown,
    editable: canEdit,
    t: t,
    duplicateDates: duplicateDates.monthly
  })), weeklyColumns.length === 0 && monthlyColumns.length === 0 && /*#__PURE__*/React.createElement("div", {
    className: "empty-state"
  }, /*#__PURE__*/React.createElement("div", {
    className: "empty-state-icon"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-10 h-10 text-primary-500"
  })), /*#__PURE__*/React.createElement("h3", {
    className: "text-xl font-bold text-gray-900 mb-2"
  }, t.noData), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 mb-6"
  }, "\u041F\u043E\u0447\u043D\u0456\u0442\u044C \u0437 \u0434\u043E\u0434\u0430\u0432\u0430\u043D\u043D\u044F \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432"), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddStatsModal(true),
    className: "btn btn-primary"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-5 h-5"
  }), t.addStats)))), activeTab === 'plans' && /*#__PURE__*/React.createElement(PlansView, {
    savedAnalyses: savedAnalyses,
    onDelete: deletePlan,
    toast: toast,
    t: t
  })), /*#__PURE__*/React.createElement("nav", {
    className: "bottom-nav mobile-only"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveTab('stats'),
    className: `bottom-nav-item ${activeTab === 'stats' ? 'active' : ''}`
  }, /*#__PURE__*/React.createElement(Icons.BarChart, null), /*#__PURE__*/React.createElement("span", null, "\u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043A\u0430")), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAIModal(true),
    className: `bottom-nav-item`
  }, /*#__PURE__*/React.createElement(Icons.Brain, null), /*#__PURE__*/React.createElement("span", null, "AI")), canEdit && /*#__PURE__*/React.createElement("button", {
    onClick: () => setActiveTab('plans'),
    className: `bottom-nav-item ${activeTab === 'plans' ? 'active' : ''}`
  }, /*#__PURE__*/React.createElement(Icons.FileText, null), /*#__PURE__*/React.createElement("span", null, "\u041F\u043B\u0430\u043D\u0438")), /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowMenu(true),
    className: "bottom-nav-item"
  }, /*#__PURE__*/React.createElement(Icons.Menu, null), /*#__PURE__*/React.createElement("span", null, "\u041C\u0435\u043D\u044E"))), canEdit && /*#__PURE__*/React.createElement(React.Fragment, null, showQuickActions && /*#__PURE__*/React.createElement("div", {
    className: "quick-actions mobile-only animate-fade-in"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAddStatsModal(true);
      setShowQuickActions(false);
    },
    className: "quick-action-btn bg-blue-500 text-white",
    title: "\u0414\u043E\u0434\u0430\u0442\u0438 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-5 h-5"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      exportToExcel();
      setShowQuickActions(false);
    },
    className: "quick-action-btn bg-purple-500 text-white",
    title: "\u0415\u043A\u0441\u043F\u043E\u0440\u0442"
  }, /*#__PURE__*/React.createElement(Icons.Download, {
    className: "w-5 h-5"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      loadBackups();
      setShowBackupModal(true);
      setShowQuickActions(false);
    },
    className: "quick-action-btn bg-emerald-500 text-white",
    title: "\u0411\u0435\u043A\u0430\u043F\u0438"
  }, /*#__PURE__*/React.createElement(Icons.Database, {
    className: "w-5 h-5"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowDemoModal(true);
      setShowQuickActions(false);
    },
    className: "quick-action-btn bg-amber-500 text-white",
    title: "\u0414\u0435\u043C\u043E \u0434\u0430\u043D\u0456"
  }, /*#__PURE__*/React.createElement(Icons.Sparkles, {
    className: "w-5 h-5"
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      if (showQuickActions) {
        setShowQuickActions(false);
      } else {
        addRow();
      }
    },
    onLongPress: () => setShowQuickActions(true),
    onContextMenu: e => {
      e.preventDefault();
      setShowQuickActions(!showQuickActions);
    },
    className: "fab mobile-only"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: `transition-transform ${showQuickActions ? 'rotate-45' : ''}`
  }))), /*#__PURE__*/React.createElement("a", {
    href: SUPPORT_URL,
    target: "_blank",
    rel: "noopener noreferrer",
    className: "support-btn"
  }, /*#__PURE__*/React.createElement(Icons.MessageCircle, {
    className: "w-5 h-5"
  }), /*#__PURE__*/React.createElement("span", {
    className: "hidden sm:inline"
  }, t.support)), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showMenu,
    onClose: () => setShowMenu(false),
    title: ""
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-4 p-4 bg-gradient-to-r from-primary-50 to-green-50 rounded-2xl mb-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: `w-14 h-14 rounded-2xl flex items-center justify-center ${isSuperAdmin ? 'bg-gradient-to-br from-red-500 to-pink-500' : 'bg-gradient-to-br from-primary-500 to-primary-600'}`
  }, isSuperAdmin ? /*#__PURE__*/React.createElement(Icons.Shield, {
    className: "w-7 h-7 text-white"
  }) : /*#__PURE__*/React.createElement(Icons.User, {
    className: "w-7 h-7 text-white"
  })), /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("p", {
    className: "font-bold text-gray-900"
  }, companyName || t.appName), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500"
  }, user?.email), isSuperAdmin ? /*#__PURE__*/React.createElement("span", {
    className: "badge mt-1 bg-gradient-to-r from-red-500 to-pink-500 text-white"
  }, "Super Admin") : /*#__PURE__*/React.createElement("span", {
    className: `badge mt-1 ${isOwner ? 'badge-purple' : 'badge-amber'}`
  }, isOwner ? t.owner : t.employee))), isSuperAdmin && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "pt-2 pb-1"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-semibold text-red-400 uppercase tracking-wider px-1 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.Shield, {
    className: "w-3 h-3"
  }), "Super Admin")), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAdminPanel(true);
      setShowMenu(false);
    },
    className: "btn bg-gradient-to-r from-red-500 to-pink-500 text-white w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Shield, {
    className: "w-5 h-5"
  }), "\u0410\u0434\u043C\u0456\u043D-\u043F\u0430\u043D\u0435\u043B\u044C")), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between p-4 bg-gray-50 rounded-2xl"
  }, /*#__PURE__*/React.createElement("span", {
    className: "font-medium flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Globe, {
    className: "w-5 h-5 text-gray-400"
  }), "\u041C\u043E\u0432\u0430"), /*#__PURE__*/React.createElement("select", {
    value: language,
    onChange: e => setLanguage(e.target.value),
    className: "px-4 py-2 bg-white rounded-xl text-sm font-medium border border-gray-200"
  }, /*#__PURE__*/React.createElement("option", {
    value: "uk"
  }, "\uD83C\uDDFA\uD83C\uDDE6 \u0423\u043A\u0440\u0430\u0457\u043D\u0441\u044C\u043A\u0430"), /*#__PURE__*/React.createElement("option", {
    value: "ru"
  }, "\uD83C\uDDF7\uD83C\uDDFA \u0420\u0443\u0441\u0441\u043A\u0438\u0439"))), canEdit && /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "pt-2 pb-1"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-semibold text-gray-400 uppercase tracking-wider px-1"
  }, "\u0414\u0456\u0457")), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAIModal(true);
      setShowMenu(false);
    },
    className: "btn btn-ai w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Brain, {
    className: "w-5 h-5"
  }), "AI \u0410\u043D\u0430\u043B\u0456\u0437"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAddStatsModal(true);
      setShowMenu(false);
    },
    className: "btn btn-primary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-5 h-5"
  }), t.addStats), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      addRow();
      setShowMenu(false);
    },
    className: "btn btn-secondary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-5 h-5"
  }), t.addRow), /*#__PURE__*/React.createElement("div", {
    className: "pt-4 pb-1"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-semibold text-gray-400 uppercase tracking-wider px-1"
  }, "TALKO \u0415\u043A\u043E\u0441\u0438\u0441\u0442\u0435\u043C\u0430")), /*#__PURE__*/React.createElement("a", {
    href: "https://chatgpt.com/g/g-6851a70e282481918ad5c2894ff30b13-statistics",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "btn btn-secondary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Target, {
    className: "w-5 h-5"
  }), "AI \u0420\u043E\u0437\u0440\u043E\u0431\u043D\u0438\u043A \u0441\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043A"), /*#__PURE__*/React.createElement("a", {
    href: "https://chatgpt.com/g/g-684be37e3bcc81918f64088a2bb094da-instructions-generator",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "btn btn-secondary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Edit, {
    className: "w-5 h-5"
  }), "\u0413\u0435\u043D\u0435\u0440\u0430\u0442\u043E\u0440 \u0440\u043E\u0437\u043F\u043E\u0440\u044F\u0434\u0436\u0435\u043D\u044C"), /*#__PURE__*/React.createElement("a", {
    href: "https://alextalko.com/alta",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "btn btn-secondary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.CheckSquare, {
    className: "w-5 h-5"
  }), "TALKO Task Manager"), /*#__PURE__*/React.createElement("a", {
    href: "https://alextalko.com/tms",
    target: "_blank",
    rel: "noopener noreferrer",
    className: "btn btn-secondary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.GitBranch, {
    className: "w-5 h-5"
  }), "\u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430 \u043A\u043E\u043C\u043F\u0430\u043D\u0456\u0457"), /*#__PURE__*/React.createElement("div", {
    className: "pt-4 pb-1"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-semibold text-gray-400 uppercase tracking-wider px-1"
  }, "\u0423\u043F\u0440\u0430\u0432\u043B\u0456\u043D\u043D\u044F")), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowTeamModal(true);
      setShowMenu(false);
    },
    className: "btn btn-secondary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Users, {
    className: "w-5 h-5"
  }), t.teamManagement)), /*#__PURE__*/React.createElement("div", {
    className: "pt-4 pb-1"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-semibold text-gray-400 uppercase tracking-wider px-1"
  }, "\u0406\u043D\u0448\u0435")), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      fileInputRef.current?.click();
      setShowMenu(false);
    },
    className: "btn btn-secondary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Upload, {
    className: "w-5 h-5"
  }), "\u0406\u043C\u043F\u043E\u0440\u0442 \u0437 Excel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      exportToExcel();
      setShowMenu(false);
    },
    className: "btn btn-primary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Download, {
    className: "w-5 h-5"
  }), "\u0415\u043A\u0441\u043F\u043E\u0440\u0442 \u0432 Excel"), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowMenu(false);
      setShowDemoModal(true);
    },
    className: "btn btn-secondary w-full justify-start"
  }, /*#__PURE__*/React.createElement(Icons.Play, {
    className: "w-5 h-5"
  }), "\u0414\u0435\u043C\u043E-\u0434\u0430\u043D\u0456 \u0434\u043B\u044F \u0442\u0435\u0441\u0442\u0443\u0432\u0430\u043D\u043D\u044F"), /*#__PURE__*/React.createElement("a", {
    href: GPT_BOTTLENECK_URL,
    target: "_blank",
    rel: "noopener noreferrer",
    className: "btn btn-secondary w-full justify-start",
    onClick: () => setShowMenu(false)
  }, /*#__PURE__*/React.createElement(Icons.Brain, {
    className: "w-5 h-5"
  }), "AI \u0410\u043D\u0430\u043B\u0456\u0437 \u0432\u0443\u0437\u044C\u043A\u0438\u0445 \u043C\u0456\u0441\u0446\u044C"), /*#__PURE__*/React.createElement("a", {
    href: SUPPORT_URL,
    target: "_blank",
    rel: "noopener noreferrer",
    className: "btn btn-secondary w-full justify-start",
    onClick: () => setShowMenu(false)
  }, /*#__PURE__*/React.createElement(Icons.MessageCircle, {
    className: "w-5 h-5"
  }), t.support), /*#__PURE__*/React.createElement("div", {
    className: "pt-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      handleLogout();
      setShowMenu(false);
    },
    className: "btn btn-ghost w-full justify-start text-red-500"
  }, /*#__PURE__*/React.createElement(Icons.LogOut, {
    className: "w-5 h-5"
  }), t.logout)))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showAddStatsModal,
    onClose: () => setShowAddStatsModal(false),
    title: t.addStats
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.statsName, " *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newStatsName,
    onChange: e => setNewStatsName(e.target.value),
    className: "input-field",
    placeholder: "\u041D\u0430\u043F\u0440\u0438\u043A\u043B\u0430\u0434: \u041F\u0440\u043E\u0434\u0430\u0436\u0456",
    autoFocus: true
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.responsible), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newStatsResponsible,
    onChange: e => setNewStatsResponsible(e.target.value),
    className: "input-field",
    placeholder: "\u041D\u0430\u043F\u0440\u0438\u043A\u043B\u0430\u0434: \u0406\u0432\u0430\u043D"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.period), /*#__PURE__*/React.createElement("select", {
    value: newStatsPeriod,
    onChange: e => setNewStatsPeriod(e.target.value),
    className: "select-field"
  }, /*#__PURE__*/React.createElement("option", {
    value: "daily"
  }, t.periodDaily), /*#__PURE__*/React.createElement("option", {
    value: "weekly"
  }, t.periodWeekly), /*#__PURE__*/React.createElement("option", {
    value: "monthly"
  }, t.periodMonthly), /*#__PURE__*/React.createElement("option", {
    value: "custom"
  }, t.periodCustom))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.target), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newStatsTarget,
    onChange: e => setNewStatsTarget(e.target.value),
    className: "input-field",
    placeholder: "\u041D\u0430\u043F\u0440\u0438\u043A\u043B\u0430\u0434: 100"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.valueFormat), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-5 gap-2"
  }, [{
    value: 'number',
    label: '123',
    title: t.formatNumber
  }, {
    value: 'percent',
    label: '%',
    title: t.formatPercent
  }, {
    value: 'uah',
    label: '₴',
    title: t.formatUAH
  }, {
    value: 'usd',
    label: '$',
    title: t.formatUSD
  }, {
    value: 'eur',
    label: '€',
    title: t.formatEUR
  }].map(fmt => /*#__PURE__*/React.createElement("button", {
    key: fmt.value,
    type: "button",
    onClick: () => setNewStatsFormat(fmt.value),
    title: fmt.title,
    className: `p-3 rounded-xl text-lg font-bold transition-all ${newStatsFormat === fmt.value ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
  }, fmt.label)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.importance || 'Важливість'), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-2"
  }, [{
    value: 'critical',
    label: 'Критично',
    desc: 'Впливає на гроші',
    color: 'bg-red-500',
    icon: 'DollarSign'
  }, {
    value: 'high',
    label: 'Висока',
    desc: 'Важливий процес',
    color: 'bg-orange-500',
    icon: 'AlertCircle'
  }, {
    value: 'medium',
    label: 'Середня',
    desc: 'Стандартний',
    color: 'bg-yellow-500',
    icon: 'Minus'
  }, {
    value: 'low',
    label: 'Низька',
    desc: 'Допоміжний',
    color: 'bg-green-500',
    icon: 'Check'
  }].map(imp => {
    const IconComponent = Icons[imp.icon];
    return /*#__PURE__*/React.createElement("button", {
      key: imp.value,
      type: "button",
      onClick: () => setNewStatsImportance(imp.value),
      className: `p-2 rounded-xl text-left transition-all ${newStatsImportance === imp.value ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "font-medium text-sm flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: `w-3 h-3 rounded-full ${imp.color}`
    }), imp.label), /*#__PURE__*/React.createElement("div", {
      className: `text-xs ${newStatsImportance === imp.value ? 'text-white/80' : 'text-gray-500'}`
    }, imp.desc));
  }))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-xl p-3"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-center gap-3 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: newStatsInverted,
    onChange: e => setNewStatsInverted(e.target.checked),
    className: "w-5 h-5 rounded border-gray-300 text-primary-500 focus:ring-primary-500"
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-sm text-gray-900 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.TrendingDown, {
    className: "w-4 h-4 text-red-500"
  }), "\u0412\u0456\u0434'\u0454\u043C\u043D\u0438\u0439 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A"), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "\u0427\u0438\u043C \u043C\u0435\u043D\u0448\u0435 \u2014 \u0442\u0438\u043C \u043A\u0440\u0430\u0449\u0435 (\u0441\u043A\u0430\u0441\u0443\u0432\u0430\u043D\u043D\u044F, \u043F\u043E\u043C\u0438\u043B\u043A\u0438, \u0431\u0440\u0430\u043A)")))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddStatsModal(false),
    className: "btn btn-secondary flex-1"
  }, t.cancel), /*#__PURE__*/React.createElement("button", {
    onClick: addColumn,
    disabled: !newStatsName.trim(),
    className: "btn btn-primary flex-1"
  }, t.add)))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showEditColumnModal,
    onClose: () => {
      setShowEditColumnModal(false);
      setEditingColumn(null);
    },
    title: t.editColumn
  }, editingColumn && /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.statsName), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: editingColumn.name,
    onChange: e => setEditingColumn({
      ...editingColumn,
      name: e.target.value
    }),
    className: "input-field"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.responsible), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: editingColumn.responsible || '',
    onChange: e => setEditingColumn({
      ...editingColumn,
      responsible: e.target.value
    }),
    className: "input-field"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.period), /*#__PURE__*/React.createElement("select", {
    value: editingColumn.period,
    onChange: e => setEditingColumn({
      ...editingColumn,
      period: e.target.value
    }),
    className: "select-field"
  }, /*#__PURE__*/React.createElement("option", {
    value: "daily"
  }, t.periodDaily), /*#__PURE__*/React.createElement("option", {
    value: "weekly"
  }, t.periodWeekly), /*#__PURE__*/React.createElement("option", {
    value: "monthly"
  }, t.periodMonthly), /*#__PURE__*/React.createElement("option", {
    value: "custom"
  }, t.periodCustom))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.target), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: targetRow?.values?.[editingColumn.id] || '',
    onChange: e => updateValue('target', editingColumn.id, e.target.value),
    className: "input-field"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.valueFormat), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-5 gap-2"
  }, [{
    value: 'number',
    label: '123',
    title: t.formatNumber
  }, {
    value: 'percent',
    label: '%',
    title: t.formatPercent
  }, {
    value: 'uah',
    label: '₴',
    title: t.formatUAH
  }, {
    value: 'usd',
    label: '$',
    title: t.formatUSD
  }, {
    value: 'eur',
    label: '€',
    title: t.formatEUR
  }].map(fmt => /*#__PURE__*/React.createElement("button", {
    key: fmt.value,
    type: "button",
    onClick: () => setEditingColumn({
      ...editingColumn,
      format: fmt.value
    }),
    title: fmt.title,
    className: `p-3 rounded-xl text-lg font-bold transition-all ${(editingColumn.format || 'number') === fmt.value ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
  }, fmt.label)))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, t.importance || 'Важливість'), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-2"
  }, [{
    value: 'critical',
    label: 'Критично',
    desc: 'Впливає на гроші',
    color: 'bg-red-500'
  }, {
    value: 'high',
    label: 'Висока',
    desc: 'Важливий процес',
    color: 'bg-orange-500'
  }, {
    value: 'medium',
    label: 'Середня',
    desc: 'Стандартний',
    color: 'bg-yellow-500'
  }, {
    value: 'low',
    label: 'Низька',
    desc: 'Допоміжний',
    color: 'bg-green-500'
  }].map(imp => /*#__PURE__*/React.createElement("button", {
    key: imp.value,
    type: "button",
    onClick: () => setEditingColumn({
      ...editingColumn,
      importance: imp.value
    }),
    className: `p-2 rounded-xl text-left transition-all ${(editingColumn.importance || 'medium') === imp.value ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`
  }, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-sm flex items-center gap-2"
  }, /*#__PURE__*/React.createElement("span", {
    className: `w-3 h-3 rounded-full ${imp.color}`
  }), imp.label), /*#__PURE__*/React.createElement("div", {
    className: `text-xs ${(editingColumn.importance || 'medium') === imp.value ? 'text-white/80' : 'text-gray-500'}`
  }, imp.desc))))), /*#__PURE__*/React.createElement("div", {
    className: "bg-gray-50 rounded-xl p-3"
  }, /*#__PURE__*/React.createElement("label", {
    className: "flex items-center gap-3 cursor-pointer"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: editingColumn.inverted || false,
    onChange: e => setEditingColumn({
      ...editingColumn,
      inverted: e.target.checked
    }),
    className: "w-5 h-5 rounded border-gray-300 text-primary-500 focus:ring-primary-500"
  }), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-medium text-sm text-gray-900 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.TrendingDown, {
    className: "w-4 h-4 text-red-500"
  }), "\u0412\u0456\u0434'\u0454\u043C\u043D\u0438\u0439 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A"), /*#__PURE__*/React.createElement("div", {
    className: "text-xs text-gray-500"
  }, "\u0427\u0438\u043C \u043C\u0435\u043D\u0448\u0435 \u2014 \u0442\u0438\u043C \u043A\u0440\u0430\u0449\u0435 (\u0441\u043A\u0430\u0441\u0443\u0432\u0430\u043D\u043D\u044F, \u043F\u043E\u043C\u0438\u043B\u043A\u0438, \u0431\u0440\u0430\u043A)")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, "\u041F\u043E\u0437\u0438\u0446\u0456\u044F"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => {
      const idx = columns.findIndex(c => c.id === editingColumn.id);
      if (idx > 0) {
        moveColumn(editingColumn.id, columns[idx - 1].id);
      }
    },
    disabled: columns.findIndex(c => c.id === editingColumn.id) === 0,
    className: "flex-1 btn btn-secondary flex items-center justify-center gap-2 disabled:opacity-50"
  }, /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M15 19l-7-7 7-7"
  })), "\u0412\u043B\u0456\u0432\u043E"), /*#__PURE__*/React.createElement("div", {
    className: "px-4 py-2 bg-gray-100 rounded-xl text-sm font-medium text-gray-600 flex items-center"
  }, columns.findIndex(c => c.id === editingColumn.id) + 1, " / ", columns.length), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => {
      const idx = columns.findIndex(c => c.id === editingColumn.id);
      if (idx < columns.length - 1) {
        moveColumn(editingColumn.id, columns[idx + 1].id);
      }
    },
    disabled: columns.findIndex(c => c.id === editingColumn.id) === columns.length - 1,
    className: "flex-1 btn btn-secondary flex items-center justify-center gap-2 disabled:opacity-50"
  }, "\u0412\u043F\u0440\u0430\u0432\u043E", /*#__PURE__*/React.createElement("svg", {
    className: "w-4 h-4",
    fill: "none",
    stroke: "currentColor",
    viewBox: "0 0 24 24"
  }, /*#__PURE__*/React.createElement("path", {
    strokeLinecap: "round",
    strokeLinejoin: "round",
    strokeWidth: 2,
    d: "M9 5l7 7-7 7"
  }))))), Object.keys(employees).length > 0 && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, t.visibleColumns), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2"
  }, Object.entries(employees).map(([empId, emp]) => /*#__PURE__*/React.createElement("label", {
    key: empId,
    className: "checkbox-item"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: editingColumn.visibleToEmployees?.includes(empId) || false,
    onChange: e => {
      const newVisible = e.target.checked ? [...(editingColumn.visibleToEmployees || []), empId] : (editingColumn.visibleToEmployees || []).filter(id => id !== empId);
      setEditingColumn({
        ...editingColumn,
        visibleToEmployees: newVisible
      });
    }
  }), /*#__PURE__*/React.createElement("span", null, emp.name || emp.email))))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      deleteColumn(editingColumn.id);
      setShowEditColumnModal(false);
      setEditingColumn(null);
    },
    className: "btn btn-danger"
  }, /*#__PURE__*/React.createElement(Icons.Trash, {
    className: "w-4 h-4"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowEditColumnModal(false);
      setEditingColumn(null);
    },
    className: "btn btn-secondary flex-1"
  }, t.cancel), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      updateColumn(editingColumn.id, editingColumn);
      setShowEditColumnModal(false);
      setEditingColumn(null);
      toast.success(t.saved);
    },
    className: "btn btn-primary flex-1"
  }, t.save)))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showTeamModal,
    onClose: () => setShowTeamModal(false),
    title: t.teamManagement,
    size: "lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setSelectedColumns(columns.map(c => c.id));
      setShowAddEmployeeModal(true);
    },
    className: "btn btn-primary w-full"
  }, /*#__PURE__*/React.createElement(Icons.UserPlus, {
    className: "w-5 h-5"
  }), t.addEmployee), /*#__PURE__*/React.createElement("h4", {
    className: "font-semibold text-gray-700"
  }, t.employees), Object.keys(employees).length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, t.noEmployees) : /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, Object.entries(employees).map(([empId, emp]) => /*#__PURE__*/React.createElement("div", {
    key: empId,
    className: "p-4 bg-gray-50 rounded-xl"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "font-semibold text-gray-900"
  }, emp.name || emp.email), /*#__PURE__*/React.createElement("div", {
    className: "text-sm text-gray-500"
  }, emp.email), /*#__PURE__*/React.createElement("span", {
    className: `badge mt-2 ${emp.role === 'owner' ? 'badge-primary' : 'badge-green'}`
  }, emp.role === 'owner' ? 'Власник' : t.activeEmployee)), emp.role !== 'owner' && /*#__PURE__*/React.createElement("button", {
    onClick: () => removeEmployee(empId),
    className: "btn btn-ghost btn-icon text-red-500"
  }, /*#__PURE__*/React.createElement(Icons.Trash, {
    className: "w-4 h-4"
  }))), emp.role !== 'owner' && /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mb-2"
  }, t.visibleColumns, ":"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-1"
  }, columns.map(col => {
    const isVisible = emp.visibleColumns?.includes(col.id);
    return /*#__PURE__*/React.createElement("button", {
      key: col.id,
      onClick: () => {
        const newCols = isVisible ? emp.visibleColumns.filter(id => id !== col.id) : [...(emp.visibleColumns || []), col.id];
        updateEmployeeColumns(empId, newCols);
      },
      className: `text-xs px-2 py-1 rounded-lg transition-colors ${isVisible ? 'bg-primary-100 text-primary-700' : 'bg-gray-200 text-gray-500'}`
    }, col.name);
  })))))))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showAddEmployeeModal,
    onClose: () => {
      setShowAddEmployeeModal(false);
      setGeneratedInviteLink('');
      setNewEmployeeEmail('');
      setNewEmployeeName('');
    },
    title: t.addEmployee
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-blue-50 border border-blue-200 rounded-xl"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-blue-700 flex items-start gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Info, {
    className: "w-4 h-4 mt-0.5 flex-shrink-0"
  }), /*#__PURE__*/React.createElement("span", null, "\u0421\u0442\u0432\u043E\u0440\u0456\u0442\u044C \u0437\u0430\u043F\u0440\u043E\u0448\u0435\u043D\u043D\u044F \u0437 \u0456\u043C'\u044F\u043C \u0441\u043F\u0456\u0432\u0440\u043E\u0431\u0456\u0442\u043D\u0438\u043A\u0430. \u0412\u0456\u043D \u0441\u0430\u043C \u0432\u0432\u0435\u0434\u0435 \u0441\u0432\u043E\u044E \u043F\u043E\u0448\u0442\u0443 \u0442\u0430 \u043F\u0430\u0440\u043E\u043B\u044C \u043F\u0440\u0438 \u0440\u0435\u0454\u0441\u0442\u0440\u0430\u0446\u0456\u0457."))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1.5"
  }, "\u0406\u043C'\u044F \u0441\u043F\u0456\u0432\u0440\u043E\u0431\u0456\u0442\u043D\u0438\u043A\u0430 *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newEmployeeName,
    onChange: e => setNewEmployeeName(e.target.value),
    className: "input-field",
    placeholder: "\u041D\u0430\u043F\u0440\u0438\u043A\u043B\u0430\u0434: \u0406\u0432\u0430\u043D \u041F\u0435\u0442\u0440\u0435\u043D\u043A\u043E",
    autoFocus: true
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, t.visibleColumns), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-2 mb-2"
  }, /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setSelectedColumns(columns.map(c => c.id)),
    className: "text-xs text-primary-600 hover:underline"
  }, "\u0412\u0438\u0431\u0440\u0430\u0442\u0438 \u0432\u0441\u0456"), /*#__PURE__*/React.createElement("span", {
    className: "text-gray-300"
  }, "|"), /*#__PURE__*/React.createElement("button", {
    type: "button",
    onClick: () => setSelectedColumns([]),
    className: "text-xs text-gray-500 hover:underline"
  }, "\u0417\u043D\u044F\u0442\u0438 \u0432\u0441\u0456")), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-xl p-3"
  }, columns.map(col => /*#__PURE__*/React.createElement("label", {
    key: col.id,
    className: "checkbox-item"
  }, /*#__PURE__*/React.createElement("input", {
    type: "checkbox",
    checked: selectedColumns.includes(col.id),
    onChange: e => {
      setSelectedColumns(e.target.checked ? [...selectedColumns, col.id] : selectedColumns.filter(id => id !== col.id));
    }
  }), /*#__PURE__*/React.createElement("span", null, col.name), col.responsible && /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-gray-400 ml-1"
  }, "(", col.responsible, ")")))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, "\u041E\u0431\u0440\u0430\u043D\u043E: ", selectedColumns.length, " \u0437 ", columns.length)), generatedInviteLink && /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm font-bold text-green-800 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.CheckCircle, {
    className: "w-5 h-5"
  }), "\u0417\u0430\u043F\u0440\u043E\u0448\u0435\u043D\u043D\u044F \u0441\u0442\u0432\u043E\u0440\u0435\u043D\u043E!"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-green-700 mb-3"
  }, "\u041D\u0430\u0434\u0456\u0448\u043B\u0456\u0442\u044C \u0446\u0435 \u043F\u043E\u0441\u0438\u043B\u0430\u043D\u043D\u044F \u0441\u043F\u0456\u0432\u0440\u043E\u0431\u0456\u0442\u043D\u0438\u043A\u0443:"), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: generatedInviteLink,
    readOnly: true,
    className: "flex-1 px-3 py-2 text-sm bg-white border border-green-200 rounded-lg font-mono"
  }), /*#__PURE__*/React.createElement("button", {
    onClick: copyInviteLink,
    className: "btn btn-primary"
  }, /*#__PURE__*/React.createElement(Icons.Copy, {
    className: "w-4 h-4"
  })))), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3 pt-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setShowAddEmployeeModal(false);
      setGeneratedInviteLink('');
      setNewEmployeeName('');
    },
    className: "btn btn-secondary flex-1"
  }, generatedInviteLink ? 'Закрити' : t.cancel), !generatedInviteLink && /*#__PURE__*/React.createElement("button", {
    onClick: addEmployee,
    disabled: !newEmployeeName.trim(),
    className: "btn btn-primary flex-1"
  }, /*#__PURE__*/React.createElement(Icons.UserPlus, {
    className: "w-4 h-4"
  }), "\u0421\u0442\u0432\u043E\u0440\u0438\u0442\u0438 \u0437\u0430\u043F\u0440\u043E\u0448\u0435\u043D\u043D\u044F")))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showAIModal,
    onClose: () => setShowAIModal(false),
    title: t.aiAnalysis,
    size: "full"
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-r from-gray-50 to-slate-50 rounded-xl border border-gray-200"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-gray-900 flex items-center gap-2 mb-3"
  }, /*#__PURE__*/React.createElement(Icons.Calendar, {
    className: "w-5 h-5"
  }), "\u0417\u0432\u0456\u0442\u043D\u0438\u0439 \u0442\u0438\u0436\u0434\u0435\u043D\u044C"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-2"
  }, DAYS_FULL.map((day, idx) => /*#__PURE__*/React.createElement("button", {
    key: idx,
    onClick: () => setWeekStartDay(idx),
    className: `px-3 py-2 rounded-lg text-sm font-medium transition-all ${weekStartDay === idx ? 'bg-primary-500 text-white shadow-lg' : 'bg-white text-gray-600 border border-gray-200 hover:border-primary-300'}`
  }, DAYS_SHORT[idx], " \u2014 ", DAYS_SHORT[(idx + 6) % 7]))), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-2"
  }, "\u0417\u0430\u0440\u0430\u0437: ", /*#__PURE__*/React.createElement("b", null, DAYS_FULL[weekStartDay]), " \u2192 ", DAYS_FULL[(weekStartDay + 6) % 7])), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-200"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-3"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-purple-900 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Building, {
    className: "w-5 h-5"
  }), "\u041A\u043E\u043D\u0442\u0435\u043A\u0441\u0442 \u0432\u0430\u0448\u043E\u0433\u043E \u0431\u0456\u0437\u043D\u0435\u0441\u0443"), /*#__PURE__*/React.createElement("span", {
    className: "text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full"
  }, "\u041E\u0431\u043E\u0432'\u044F\u0437\u043A\u043E\u0432\u043E")), /*#__PURE__*/React.createElement("textarea", {
    value: aiSettings.businessContext,
    onChange: e => setAiSettings({
      ...aiSettings,
      businessContext: e.target.value
    }),
    className: "textarea-field border-purple-200 focus:border-purple-400",
    rows: 3,
    placeholder: "\u041E\u043F\u0438\u0448\u0456\u0442\u044C \u0432\u0430\u0448 \u0431\u0456\u0437\u043D\u0435\u0441: \u0433\u0430\u043B\u0443\u0437\u044C, \u043F\u043E\u0441\u043B\u0443\u0433\u0438, \u043A\u043E\u043C\u0430\u043D\u0434\u0430, \u0441\u0435\u0440\u0435\u0434\u043D\u0456\u0439 \u0447\u0435\u043A, \u043A\u0430\u043D\u0430\u043B\u0438 \u0437\u0430\u043B\u0443\u0447\u0435\u043D\u043D\u044F \u043A\u043B\u0456\u0454\u043D\u0442\u0456\u0432..."
  })), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-amber-900 flex items-center gap-2 mb-3"
  }, /*#__PURE__*/React.createElement(Icons.Target, {
    className: "w-5 h-5"
  }), "\u041F\u0440\u0456\u043E\u0440\u0438\u0442\u0435\u0442\u0438 \u0437\u0430\u0440\u0430\u0437"), /*#__PURE__*/React.createElement("textarea", {
    value: aiSettings.priorities,
    onChange: e => setAiSettings({
      ...aiSettings,
      priorities: e.target.value
    }),
    className: "textarea-field border-amber-200 focus:border-amber-400",
    rows: 2,
    placeholder: "\u0429\u043E \u043D\u0430\u0439\u0432\u0430\u0436\u043B\u0438\u0432\u0456\u0448\u0435 \u0437\u0430\u0440\u0430\u0437? \u0417\u0431\u0456\u043B\u044C\u0448\u0438\u0442\u0438 \u043F\u0440\u043E\u0434\u0430\u0436\u0456, \u043E\u043F\u0442\u0438\u043C\u0456\u0437\u0443\u0432\u0430\u0442\u0438 \u0432\u0438\u0442\u0440\u0430\u0442\u0438, \u043F\u043E\u043A\u0440\u0430\u0449\u0438\u0442\u0438 \u043A\u043E\u043D\u0432\u0435\u0440\u0441\u0456\u044E..."
  })), !aiSettings.businessContext && /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-red-50 border border-red-200 rounded-xl flex items-center gap-3"
  }, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-5 h-5 text-red-500 flex-shrink-0"
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-red-700"
  }, "\u0417\u0430\u043F\u043E\u0432\u043D\u0456\u0442\u044C \u043A\u043E\u043D\u0442\u0435\u043A\u0441\u0442 \u0431\u0456\u0437\u043D\u0435\u0441\u0443 \u0432\u0438\u0449\u0435 \u2014 \u0431\u0435\u0437 \u043D\u044C\u043E\u0433\u043E AI \u043D\u0435 \u0437\u043C\u043E\u0436\u0435 \u0434\u0430\u0442\u0438 \u043A\u043E\u0440\u0438\u0441\u043D\u0456 \u0440\u0435\u043A\u043E\u043C\u0435\u043D\u0434\u0430\u0446\u0456\u0457")), /*#__PURE__*/React.createElement(AIAnalysis, {
    columns: visibleColumns,
    rows: rows,
    targetRow: targetRow,
    aiSettings: aiSettings,
    language: language,
    onSaveAnalysis: saveAnalysis,
    savedAnalyses: savedAnalyses,
    t: t
  }))), isSuperAdmin && /*#__PURE__*/React.createElement(Modal, {
    isOpen: showAdminPanel,
    onClose: () => setShowAdminPanel(false),
    title: "\u0410\u0434\u043C\u0456\u043D-\u043F\u0430\u043D\u0435\u043B\u044C",
    size: "lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-6"
  }, /*#__PURE__*/React.createElement("div", {
    className: "p-5 bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-2xl"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-red-900 flex items-center gap-2 mb-4"
  }, /*#__PURE__*/React.createElement(Icons.Building, {
    className: "w-5 h-5"
  }), "\u0421\u0442\u0432\u043E\u0440\u0438\u0442\u0438 \u043D\u043E\u0432\u0443 \u043A\u043E\u043C\u043F\u0430\u043D\u0456\u044E"), /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "\u041D\u0430\u0437\u0432\u0430 \u043A\u043E\u043C\u043F\u0430\u043D\u0456\u0457 *"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newCompanyName,
    onChange: e => setNewCompanyName(e.target.value),
    className: "input-field",
    placeholder: "\u041D\u0430\u043F\u0440\u0438\u043A\u043B\u0430\u0434: \u041A\u043B\u0456\u043D\u0456\u043A\u0430 \u0417\u0434\u043E\u0440\u043E\u0432'\u044F"
  })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "Email \u0432\u043B\u0430\u0441\u043D\u0438\u043A\u0430 *"), /*#__PURE__*/React.createElement("input", {
    type: "email",
    value: newOwnerEmail,
    onChange: e => setNewOwnerEmail(e.target.value),
    className: "input-field",
    placeholder: "owner@company.com"
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500 mt-1"
  }, "\u041F\u0456\u0441\u043B\u044F \u0441\u0442\u0432\u043E\u0440\u0435\u043D\u043D\u044F \u2014 \u0434\u043E\u0434\u0430\u0439\u0442\u0435 \u0446\u044C\u043E\u0433\u043E \u044E\u0437\u0435\u0440\u0430 \u0432 Firebase Console")), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-1"
  }, "\u0406\u043C'\u044F \u0432\u043B\u0430\u0441\u043D\u0438\u043A\u0430"), /*#__PURE__*/React.createElement("input", {
    type: "text",
    value: newOwnerName,
    onChange: e => setNewOwnerName(e.target.value),
    className: "input-field",
    placeholder: "\u0406\u0432\u0430\u043D \u041F\u0435\u0442\u0440\u0435\u043D\u043A\u043E"
  })), /*#__PURE__*/React.createElement("button", {
    onClick: createCompany,
    disabled: adminLoading || !newCompanyName.trim() || !newOwnerEmail.trim(),
    className: "btn btn-primary w-full"
  }, adminLoading ? /*#__PURE__*/React.createElement(Icons.Loader, {
    className: "w-5 h-5"
  }) : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-5 h-5"
  }), "\u0421\u0442\u0432\u043E\u0440\u0438\u0442\u0438 \u043A\u043E\u043C\u043F\u0430\u043D\u0456\u044E")))), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("div", {
    className: "flex items-center justify-between mb-3"
  }, /*#__PURE__*/React.createElement("h3", {
    className: "font-bold text-gray-900 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Building, {
    className: "w-5 h-5 text-gray-600"
  }), "\u041A\u043E\u043C\u043F\u0430\u043D\u0456\u0457 (", adminCompanies.length, ")"), /*#__PURE__*/React.createElement("button", {
    onClick: loadAdminCompanies,
    className: "btn btn-ghost btn-sm"
  }, /*#__PURE__*/React.createElement(Icons.RefreshCw, {
    className: "w-4 h-4"
  }))), adminCompanies.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement(Icons.Building, {
    className: "w-12 h-12 mx-auto mb-2 text-gray-300"
  }), /*#__PURE__*/React.createElement("p", null, "\u041A\u043E\u043C\u043F\u0430\u043D\u0456\u0439 \u0449\u0435 \u043D\u0435\u043C\u0430\u0454")) : /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 max-h-80 overflow-y-auto"
  }, adminCompanies.map(company => /*#__PURE__*/React.createElement("div", {
    key: company.id,
    className: "p-4 bg-gray-50 rounded-xl"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex items-start justify-between"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex-1"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-bold text-gray-900"
  }, company.name), /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-gray-500 flex items-center gap-1 mt-1"
  }, /*#__PURE__*/React.createElement(Icons.User, {
    className: "w-3 h-3"
  }), company.ownerEmail), /*#__PURE__*/React.createElement("div", {
    className: "flex items-center gap-3 mt-2 text-xs text-gray-400"
  }, /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-3 h-3"
  }), company.columns?.length || 0, " \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432"), /*#__PURE__*/React.createElement("span", {
    className: "flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.Calendar, {
    className: "w-3 h-3"
  }), (company.rows?.length || 1) - 1, " \u0437\u0430\u043F\u0438\u0441\u0456\u0432"))), /*#__PURE__*/React.createElement("button", {
    onClick: () => deleteCompany(company.id, company.name),
    className: "btn btn-ghost btn-icon text-red-500 hover:bg-red-50"
  }, /*#__PURE__*/React.createElement(Icons.Trash, {
    className: "w-4 h-4"
  }))), /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      navigator.clipboard.writeText(company.ownerEmail);
      toast.success('Email скопійовано!');
    },
    className: "mt-2 text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1"
  }, /*#__PURE__*/React.createElement(Icons.Copy, {
    className: "w-3 h-3"
  }), "\u0421\u043A\u043E\u043F\u0456\u044E\u0432\u0430\u0442\u0438 email \u0434\u043B\u044F Firebase"))))), /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-amber-50 border border-amber-200 rounded-xl"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-bold text-amber-900 flex items-center gap-2 mb-2"
  }, /*#__PURE__*/React.createElement(Icons.Info, {
    className: "w-4 h-4"
  }), "\u042F\u043A \u0434\u043E\u0434\u0430\u0442\u0438 \u0432\u043B\u0430\u0441\u043D\u0438\u043A\u0430"), /*#__PURE__*/React.createElement("ol", {
    className: "text-sm text-amber-800 space-y-1 list-decimal list-inside"
  }, /*#__PURE__*/React.createElement("li", null, "\u0421\u0442\u0432\u043E\u0440\u0456\u0442\u044C \u043A\u043E\u043C\u043F\u0430\u043D\u0456\u044E \u0432\u0438\u0449\u0435"), /*#__PURE__*/React.createElement("li", null, "\u0421\u043A\u043E\u043F\u0456\u044E\u0439\u0442\u0435 email \u0432\u043B\u0430\u0441\u043D\u0438\u043A\u0430"), /*#__PURE__*/React.createElement("li", null, "\u0417\u0430\u0439\u0434\u0456\u0442\u044C \u0432 ", /*#__PURE__*/React.createElement("b", null, "Firebase Console \u2192 Authentication")), /*#__PURE__*/React.createElement("li", null, "\u041D\u0430\u0442\u0438\u0441\u043D\u0456\u0442\u044C ", /*#__PURE__*/React.createElement("b", null, "Add user")), /*#__PURE__*/React.createElement("li", null, "\u0412\u0441\u0442\u0430\u0432\u0442\u0435 email \u0442\u0430 \u043F\u0440\u0438\u0434\u0443\u043C\u0430\u0439\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C"), /*#__PURE__*/React.createElement("li", null, "\u0412\u043B\u0430\u0441\u043D\u0438\u043A \u0437\u043C\u043E\u0436\u0435 \u0443\u0432\u0456\u0439\u0442\u0438 \u0442\u0430 \u043A\u0435\u0440\u0443\u0432\u0430\u0442\u0438 \u043A\u043E\u043C\u043F\u0430\u043D\u0456\u0454\u044E"))))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showImportModal,
    onClose: () => {
      setShowImportModal(false);
      setImportPreview(null);
    },
    title: "\uD83D\uDCE5 \u0406\u043C\u043F\u043E\u0440\u0442 \u0437 Excel"
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, importPreview ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "p-4 bg-green-50 border border-green-200 rounded-xl"
  }, /*#__PURE__*/React.createElement("h4", {
    className: "font-bold text-green-800 mb-2 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Check, {
    className: "w-5 h-5"
  }), " \u0424\u0430\u0439\u043B \u0440\u043E\u0437\u043F\u0456\u0437\u043D\u0430\u043D\u043E"), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-3 gap-4 text-sm"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-green-600"
  }, importPreview.columns.length), /*#__PURE__*/React.createElement("div", {
    className: "text-green-700"
  }, "\u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432")), /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-blue-600"
  }, importPreview.weeklyCount), /*#__PURE__*/React.createElement("div", {
    className: "text-blue-700"
  }, "\u0442\u0438\u0436\u043D\u0456\u0432")), /*#__PURE__*/React.createElement("div", {
    className: "text-center"
  }, /*#__PURE__*/React.createElement("div", {
    className: "text-2xl font-bold text-purple-600"
  }, importPreview.monthlyCount), /*#__PURE__*/React.createElement("div", {
    className: "text-purple-700"
  }, "\u043C\u0456\u0441\u044F\u0446\u0456\u0432")))), importPreview.columns.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-gray-50 rounded-xl"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs font-medium text-gray-500 mb-2"
  }, "\u0417\u043D\u0430\u0439\u0434\u0435\u043D\u0456 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0438:"), /*#__PURE__*/React.createElement("div", {
    className: "flex flex-wrap gap-1"
  }, importPreview.columns.slice(0, 10).map((col, i) => /*#__PURE__*/React.createElement("span", {
    key: i,
    className: "px-2 py-1 bg-white rounded-lg text-xs border"
  }, col.name)), importPreview.columns.length > 10 && /*#__PURE__*/React.createElement("span", {
    className: "px-2 py-1 text-xs text-gray-400"
  }, "+", importPreview.columns.length - 10, " \u0449\u0435"))), columns.length > 0 && /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-amber-50 border border-amber-200 rounded-xl"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm text-amber-700 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.AlertTriangle, {
    className: "w-4 h-4"
  }), "\u0423 \u0432\u0430\u0441 \u0432\u0436\u0435 \u0454 ", columns.length, " \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432 \u0442\u0430 ", rows.filter(r => !r.isTarget).length, " \u0437\u0430\u043F\u0438\u0441\u0456\u0432")), /*#__PURE__*/React.createElement("div", {
    className: "grid grid-cols-2 gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => confirmImport('replace'),
    className: "btn btn-primary",
    disabled: isImporting
  }, isImporting ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Spinner, { size: "sm", className: "mr-2" }), "\u0406\u043C\u043F\u043E\u0440\u0442...") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.RefreshCw, {
    className: "w-4 h-4"
  }), "\u0417\u0430\u043C\u0456\u043D\u0438\u0442\u0438 \u0432\u0441\u0435")), columns.length > 0 && /*#__PURE__*/React.createElement("button", {
    onClick: () => confirmImport('merge'),
    className: "btn btn-secondary",
    disabled: isImporting
  }, isImporting ? /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Spinner, { size: "sm", className: "mr-2" }), "\u0406\u043C\u043F\u043E\u0440\u0442...") : /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-4 h-4"
  }), "\u0414\u043E\u0434\u0430\u0442\u0438 \u0434\u043E \u0456\u0441\u043D\u0443\u044E\u0447\u0438\u0445")))) : /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8"
  }, /*#__PURE__*/React.createElement(Icons.Upload, {
    className: "w-12 h-12 text-gray-300 mx-auto mb-4"
  }), /*#__PURE__*/React.createElement("p", {
    className: "text-gray-500 mb-4"
  }, "\u0412\u0438\u0431\u0435\u0440\u0456\u0442\u044C \u0444\u0430\u0439\u043B Excel \u0434\u043B\u044F \u0456\u043C\u043F\u043E\u0440\u0442\u0443"), /*#__PURE__*/React.createElement("button", {
    onClick: () => fileInputRef.current?.click(),
    className: "btn btn-primary"
  }, /*#__PURE__*/React.createElement(Icons.Upload, {
    className: "w-4 h-4"
  }), "\u0412\u0438\u0431\u0440\u0430\u0442\u0438 \u0444\u0430\u0439\u043B")), /*#__PURE__*/React.createElement("div", {
    className: "pt-3 border-t"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400"
  }, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-4 h-4 text-amber-500 inline mr-1"
  }), " \u041F\u0456\u0434\u0442\u0440\u0438\u043C\u0443\u0432\u0430\u043D\u0456 \u0444\u043E\u0440\u043C\u0430\u0442\u0438: .xlsx, .xls, .csv", /*#__PURE__*/React.createElement("br", null), "\u0414\u043B\u044F \u043D\u0430\u0439\u043A\u0440\u0430\u0449\u043E\u0433\u043E \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0443 \u0432\u0438\u043A\u043E\u0440\u0438\u0441\u0442\u043E\u0432\u0443\u0439\u0442\u0435 \u0444\u0430\u0439\u043B, \u0435\u043A\u0441\u043F\u043E\u0440\u0442\u043E\u0432\u0430\u043D\u0438\u0439 \u0437 \u0446\u0456\u0454\u0457 \u0441\u0438\u0441\u0442\u0435\u043C\u0438")))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showAddPeriodModal,
    onClose: () => setShowAddPeriodModal(false),
    title: addPeriodType === 'monthly' ? 'Додати місяць' : 'Додати тиждень'
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("label", {
    className: "block text-sm font-medium text-gray-700 mb-2"
  }, addPeriodType === 'monthly' ? 'Оберіть будь-який день місяця' : 'Оберіть будь-який день тижня'), /*#__PURE__*/React.createElement(DatePickerCalendar, {
    selectedDate: selectedAddPeriod ? addPeriodType === 'monthly' ? `${selectedAddPeriod}-01` : selectedAddPeriod : null,
    onSelect: (key, date) => setSelectedAddPeriod(key),
    weekStartDay: weekStartDay,
    periodType: addPeriodType
  })), selectedAddPeriod && /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-primary-50 border border-primary-200 rounded-xl"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-sm font-medium text-primary-900 flex items-center gap-2"
  }, /*#__PURE__*/React.createElement(Icons.Check, {
    className: "w-4 h-4"
  }), addPeriodType === 'monthly' ? `Обрано: ${formatMonthLabel(selectedAddPeriod)}` : `Обрано тиждень: ${formatWeekLabel(new Date(selectedAddPeriod), weekStartDay)}`)), /*#__PURE__*/React.createElement("div", {
    className: "flex gap-3"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setShowAddPeriodModal(false),
    className: "btn btn-secondary flex-1"
  }, "\u0421\u043A\u0430\u0441\u0443\u0432\u0430\u0442\u0438"), /*#__PURE__*/React.createElement("button", {
    onClick: confirmAddPeriod,
    disabled: !selectedAddPeriod,
    className: "btn btn-primary flex-1"
  }, /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-4 h-4"
  }), "\u0414\u043E\u0434\u0430\u0442\u0438")))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showDemoModal,
    onClose: () => setShowDemoModal(false),
    title: "\u041E\u0431\u0435\u0440\u0456\u0442\u044C \u0442\u0438\u043F \u0431\u0456\u0437\u043D\u0435\u0441\u0443"
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-3"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-gray-600 text-sm mb-4"
  }, "\u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0442\u0435 \u0434\u0435\u043C\u043E-\u0434\u0430\u043D\u0456 \u0434\u043B\u044F \u0442\u0435\u0441\u0442\u0443\u0432\u0430\u043D\u043D\u044F \u0441\u0438\u0441\u0442\u0435\u043C\u0438 \u0442\u0430 AI-\u0430\u043D\u0430\u043B\u0456\u0437\u0443"), Object.entries(DEMO_DATA).map(([key, demo]) => {
    const IconComponent = Icons[demo.icon] || Icons.BarChart;
    return /*#__PURE__*/React.createElement("button", {
      key: key,
      onClick: () => {
        if (columns.length > 0 && !isSuperAdmin) {
          setConfirmDialog({
            isOpen: true,
            title: 'Завантажити демо-дані?',
            message: 'Поточні дані будуть замінені на демонстраційні. Продовжити?',
            onConfirm: () => loadDemoData(key)
          });
          setShowDemoModal(false);
        } else {
          loadDemoData(key);
        }
      },
      className: "w-full p-4 text-left bg-gray-50 hover:bg-primary-50 border-2 border-gray-200 hover:border-primary-300 rounded-2xl transition-all"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "w-10 h-10 rounded-xl bg-primary-100 flex items-center justify-center"
    }, /*#__PURE__*/React.createElement(IconComponent, {
      className: "w-5 h-5 text-primary-600"
    })), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("h3", {
      className: "font-bold text-gray-900"
    }, demo.name), /*#__PURE__*/React.createElement("p", {
      className: "text-sm text-gray-500"
    }, demo.companyName))));
  }), /*#__PURE__*/React.createElement("div", {
    className: "pt-3 border-t mt-4"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-400 text-center"
  }, "\u041F\u0456\u0441\u043B\u044F \u0437\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F \u0441\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 ", /*#__PURE__*/React.createElement("b", null, "AI \u0410\u043D\u0430\u043B\u0456\u0437"), " \u2014 \u043A\u043E\u043D\u0442\u0435\u043A\u0441\u0442 \u0431\u0456\u0437\u043D\u0435\u0441\u0443 \u0432\u0436\u0435 \u0437\u0430\u043F\u043E\u0432\u043D\u0435\u043D\u0438\u0439")))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showBackupModal,
    onClose: () => setShowBackupModal(false),
    title: "\u0411\u0435\u043A\u0430\u043F\u0438 \u0434\u0430\u043D\u0438\u0445",
    size: "lg"
  }, /*#__PURE__*/React.createElement("div", {
    className: "space-y-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => createBackup(),
    className: "btn btn-primary flex-1",
    disabled: backupLoading
  }, backupLoading ? /*#__PURE__*/React.createElement(Icons.Loader, {
    className: "w-4 h-4 animate-spin"
  }) : /*#__PURE__*/React.createElement(Icons.Plus, {
    className: "w-4 h-4"
  }), "\u0421\u0442\u0432\u043E\u0440\u0438\u0442\u0438 \u0431\u0435\u043A\u0430\u043F")), /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-gray-500"
  }, /*#__PURE__*/React.createElement(Icons.Cloud, {
    className: "w-4 h-4 text-blue-400 inline mr-1"
  }), " \u0411\u0435\u043A\u0430\u043F\u0438 \u0437\u0431\u0435\u0440\u0456\u0433\u0430\u044E\u0442\u044C\u0441\u044F \u0432 \u0445\u043C\u0430\u0440\u0456 (Firestore). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C ", MAX_BACKUPS, " \u0431\u0435\u043A\u0430\u043F\u0456\u0432."), /*#__PURE__*/React.createElement("div", {
    className: "space-y-2 max-h-96 overflow-y-auto"
  }, backupLoading && backups.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement(Icons.Loader, {
    className: "w-8 h-8 mx-auto mb-3 text-gray-300 animate-spin"
  }), /*#__PURE__*/React.createElement("p", null, "\u0417\u0430\u0432\u0430\u043D\u0442\u0430\u0436\u0435\u043D\u043D\u044F \u0431\u0435\u043A\u0430\u043F\u0456\u0432...")) : backups.length === 0 ? /*#__PURE__*/React.createElement("div", {
    className: "text-center py-8 text-gray-500"
  }, /*#__PURE__*/React.createElement(Icons.Database, {
    className: "w-12 h-12 mx-auto mb-3 text-gray-300"
  }), /*#__PURE__*/React.createElement("p", null, "\u041D\u0435\u043C\u0430\u0454 \u0437\u0431\u0435\u0440\u0435\u0436\u0435\u043D\u0438\u0445 \u0431\u0435\u043A\u0430\u043F\u0456\u0432"), /*#__PURE__*/React.createElement("p", {
    className: "text-xs mt-1"
  }, "\u0421\u0442\u0432\u043E\u0440\u0456\u0442\u044C \u043F\u0435\u0440\u0448\u0438\u0439 \u0431\u0435\u043A\u0430\u043F \u0434\u043B\u044F \u0437\u0430\u0445\u0438\u0441\u0442\u0443 \u0434\u0430\u043D\u0438\u0445")) : backups.map((backup, idx) => {
    // Обробка Firestore Timestamp
    const createdAt = backup.createdAt?.toDate ? backup.createdAt.toDate() : new Date(backup.createdAt);
    return /*#__PURE__*/React.createElement("div", {
      key: backup.id,
      className: `p-3 rounded-xl border ${idx === 0 ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-start justify-between gap-3"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex-1 min-w-0"
    }, /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-2"
    }, /*#__PURE__*/React.createElement("span", {
      className: "font-medium text-gray-900 truncate"
    }, backup.name), idx === 0 && /*#__PURE__*/React.createElement("span", {
      className: "text-xs bg-green-500 text-white px-1.5 py-0.5 rounded"
    }, "\u041E\u0441\u0442\u0430\u043D\u043D\u0456\u0439")), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-3 mt-1 text-xs text-gray-500"
    }, /*#__PURE__*/React.createElement("span", null, createdAt.toLocaleString('uk-UA')), /*#__PURE__*/React.createElement("span", null, "\u2022"), /*#__PURE__*/React.createElement("span", null, backup.stats?.columnsCount || 0, " \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0456\u0432"), /*#__PURE__*/React.createElement("span", null, "\u2022"), /*#__PURE__*/React.createElement("span", null, backup.stats?.rowsCount || 0, " \u0437\u0430\u043F\u0438\u0441\u0456\u0432"))), /*#__PURE__*/React.createElement("div", {
      className: "flex items-center gap-1"
    }, /*#__PURE__*/React.createElement("button", {
      onClick: () => restoreBackup(backup.id),
      className: "btn btn-sm btn-primary",
      disabled: backupLoading,
      title: "\u0412\u0456\u0434\u043D\u043E\u0432\u0438\u0442\u0438"
    }, backupLoading ? /*#__PURE__*/React.createElement(Spinner, { size: "sm" }) : /*#__PURE__*/React.createElement(Icons.Undo, {
      className: "w-3.5 h-3.5"
    })), /*#__PURE__*/React.createElement("button", {
      onClick: () => deleteBackup(backup.id),
      className: "btn btn-sm btn-ghost text-red-500",
      title: "\u0412\u0438\u0434\u0430\u043B\u0438\u0442\u0438",
      disabled: backupLoading
    }, backupLoading ? /*#__PURE__*/React.createElement(Spinner, { size: "sm", className: "text-red-500" }) : /*#__PURE__*/React.createElement(Icons.Trash, {
      className: "w-3.5 h-3.5"
    })))));
  })), /*#__PURE__*/React.createElement("div", {
    className: "p-3 bg-amber-50 border border-amber-200 rounded-xl"
  }, /*#__PURE__*/React.createElement("p", {
    className: "text-xs text-amber-800"
  }, /*#__PURE__*/React.createElement("b", null, /*#__PURE__*/React.createElement(Icons.AlertCircle, {
    className: "w-4 h-4 text-amber-600 inline mr-1"
  }), "\u041F\u043E\u0440\u0430\u0434\u0430:"), " \u0421\u0442\u0432\u043E\u0440\u044E\u0439\u0442\u0435 \u0431\u0435\u043A\u0430\u043F \u043F\u0435\u0440\u0435\u0434 \u0432\u0430\u0436\u043B\u0438\u0432\u0438\u043C\u0438 \u0437\u043C\u0456\u043D\u0430\u043C\u0438. \u041F\u0440\u0438 \u0432\u0456\u0434\u043D\u043E\u0432\u043B\u0435\u043D\u043D\u0456 \u043F\u043E\u0442\u043E\u0447\u043D\u0456 \u0434\u0430\u043D\u0456 \u0431\u0443\u0434\u0443\u0442\u044C \u0437\u0430\u043C\u0456\u043D\u0435\u043D\u0456 \u0434\u0430\u043D\u0438\u043C\u0438 \u0437 \u0431\u0435\u043A\u0430\u043F\u0443.")))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showTrendsModal,
    onClose: () => setShowTrendsModal(false),
    title: "\u0413\u0440\u0430\u0444\u0456\u043A\u0438 \u0442\u0440\u0435\u043D\u0434\u0456\u0432",
    size: "full"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex flex-col h-full gap-4"
  }, /*#__PURE__*/React.createElement("div", {
    className: "flex gap-2 border-b pb-2"
  }, /*#__PURE__*/React.createElement("button", {
    onClick: () => setTrendsPeriodType('weekly'),
    className: `px-4 py-2 rounded-t-lg text-sm font-medium flex items-center gap-1 ${trendsPeriodType === 'weekly' ? 'bg-primary-100 text-primary-700' : 'text-gray-500 hover:bg-gray-100'}`
  }, /*#__PURE__*/React.createElement(Icons.Calendar, {
    className: "w-4 h-4"
  }), " \u0422\u0438\u0436\u043D\u0435\u0432\u0456"), /*#__PURE__*/React.createElement("button", {
    onClick: () => setTrendsPeriodType('monthly'),
    className: `px-4 py-2 rounded-t-lg text-sm font-medium flex items-center gap-1 ${trendsPeriodType === 'monthly' ? 'bg-primary-100 text-primary-700' : 'text-gray-500 hover:bg-gray-100'}`
  }, /*#__PURE__*/React.createElement(Icons.BarChart, {
    className: "w-4 h-4"
  }), " \u041C\u0456\u0441\u044F\u0447\u043D\u0456")), /*#__PURE__*/React.createElement("div", {
    className: "flex-1 min-h-0"
  }, /*#__PURE__*/React.createElement(ChartErrorBoundary, null, /*#__PURE__*/React.createElement(TrendsChart, {
    columns: columns,
    rows: rows,
    periodType: trendsPeriodType,
    t: t
  }))))), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showPDFModal,
    onClose: () => setShowPDFModal(false),
    title: "\u0415\u043A\u0441\u043F\u043E\u0440\u0442 PDF \u0437\u0432\u0456\u0442\u0443"
  }, /*#__PURE__*/React.createElement(PDFExport, {
    columns: columns,
    rows: rows,
    companyName: companyName,
    aiSettings: aiSettings,
    t: t
  })), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showHistoryModal,
    onClose: () => setShowHistoryModal(false),
    title: "\u0406\u0441\u0442\u043E\u0440\u0456\u044F \u0437\u043C\u0456\u043D",
    size: "lg"
  }, /*#__PURE__*/React.createElement(ChangeHistory, {
    companyId: companyId,
    t: t
  })), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showCompareModal,
    onClose: () => setShowCompareModal(false),
    title: "\u041F\u043E\u0440\u0456\u0432\u043D\u044F\u043D\u043D\u044F \u043F\u0435\u0440\u0456\u043E\u0434\u0456\u0432",
    size: "lg"
  }, /*#__PURE__*/React.createElement("div", { className: "space-y-4" },
    /*#__PURE__*/React.createElement("div", { className: "flex gap-2 border-b pb-2" },
      /*#__PURE__*/React.createElement("button", {
        onClick: () => setComparePeriodType('weekly'),
        className: `px-4 py-2 rounded-t-lg text-sm font-medium ${comparePeriodType === 'weekly' ? 'bg-primary-100 text-primary-700' : 'text-gray-500 hover:bg-gray-100'}`
      }, "Тижневі"),
      /*#__PURE__*/React.createElement("button", {
        onClick: () => setComparePeriodType('monthly'),
        className: `px-4 py-2 rounded-t-lg text-sm font-medium ${comparePeriodType === 'monthly' ? 'bg-primary-100 text-primary-700' : 'text-gray-500 hover:bg-gray-100'}`
      }, "Місячні")
    ),
    /*#__PURE__*/React.createElement(PeriodComparison, {
      columns: columns,
      rows: rows,
      periodType: comparePeriodType,
      t: t
    })
  )), /*#__PURE__*/React.createElement(Modal, {
    isOpen: showAlertsModal,
    onClose: () => setShowAlertsModal(false),
    title: "\u041F\u0440\u043E\u0431\u043B\u0435\u043C\u043D\u0456 \u043F\u043E\u043A\u0430\u0437\u043D\u0438\u043A\u0438"
  }, /*#__PURE__*/React.createElement("div", { className: "space-y-4" },
    /*#__PURE__*/React.createElement("h4", { className: "font-medium text-gray-700" }, "Тижневі показники"),
    /*#__PURE__*/React.createElement(AlertsPanel, {
      columns: columns,
      rows: rows,
      targetRow: rows.find(r => r.isTarget),
      periodType: "weekly"
    }),
    columns.some(c => c.period === 'monthly') && /*#__PURE__*/React.createElement(React.Fragment, null,
      /*#__PURE__*/React.createElement("h4", { className: "font-medium text-gray-700 mt-4" }, "Місячні показники"),
      /*#__PURE__*/React.createElement(AlertsPanel, {
        columns: columns,
        rows: rows,
        targetRow: rows.find(r => r.isTarget),
        periodType: "monthly"
      })
    )
  )), /*#__PURE__*/React.createElement(ConfirmDialog, {
    isOpen: confirmDialog.isOpen,
    onClose: () => setConfirmDialog({
      isOpen: false
    }),
    onConfirm: confirmDialog.onConfirm,
    title: confirmDialog.title,
    message: confirmDialog.message
  }));
};

// ==================== ROOT ====================
const Root = () => /*#__PURE__*/React.createElement(ErrorBoundary, null, /*#__PURE__*/React.createElement(ToastProvider, null, /*#__PURE__*/React.createElement(App, null)));
ReactDOM.createRoot(document.getElementById('root')).render(/*#__PURE__*/React.createElement(Root, null));
    </script>
</body>
</html>
