<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#22c55e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Трекер статистики Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html, body { font-family: 'Inter', system-ui, sans-serif; -webkit-font-smoothing: antialiased; overscroll-behavior: none; }
        
        /* Safe area для notched devices */
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-slide-down { animation: slideDown 0.2s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-bounce { animation: bounce 0.6s ease-in-out; }
        
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        /* Toast */
        .toast-container { position: fixed; top: calc(12px + var(--sat)); left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; width: calc(100% - 32px); max-width: 400px; }
        .toast { padding: 14px 18px; border-radius: 14px; font-weight: 600; font-size: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; pointer-events: auto; animation: slideDown 0.3s ease-out; background: #fff; }
        .toast-success { border-left: 4px solid #22c55e; }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-info { border-left: 4px solid #3b82f6; }
        .toast-warning { border-left: 4px solid #f59e0b; }
        
        /* Cards */
        .card { background: white; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06); }
        
        /* Inputs - більші для мобільного */
        .input-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 16px; transition: all 0.2s; min-height: 52px; }
        .input-field:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1); }
        .input-field:disabled { background: #f9fafb; cursor: not-allowed; }
        
        .textarea-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 15px; transition: all 0.2s; resize: vertical; min-height: 100px; line-height: 1.5; }
        .textarea-field:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1); }
        
        /* Buttons - великі touch targets */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 22px; font-weight: 600; font-size: 15px; border-radius: 14px; transition: all 0.2s; cursor: pointer; border: none; min-height: 52px; -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4); }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover:not(:disabled) { background: #e5e7eb; }
        .btn-ghost { background: transparent; color: #6b7280; }
        .btn-ghost:hover:not(:disabled) { background: #f3f4f6; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3); }
        .btn-ai:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4); }
        .btn-icon { width: 52px; height: 52px; padding: 0; border-radius: 14px; }
        .btn-sm { padding: 10px 16px; font-size: 14px; min-height: 44px; border-radius: 12px; }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-amber { background: #fef3c7; color: #92400e; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-purple { background: #f3e8ff; color: #6b21a8; }
        .badge-white { background: rgba(255,255,255,0.9); color: #374151; }
        .badge-primary { background: #dcfce7; color: #166534; }
        
        /* Progress */
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease-out; }
        
        /* Modal - оптимізовано для мобільного */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9000; animation: fadeIn 0.2s ease-out; }
        .modal-content { position: fixed; background: white; z-index: 9001; overflow-y: auto; overscroll-behavior: contain; }
        @media (min-width: 640px) { 
            .modal-content { top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 24px; width: 90%; max-height: 90vh; animation: scaleIn 0.3s ease-out; } 
        }
        @media (max-width: 639px) { 
            .modal-content { 
                bottom: 0; left: 0; right: 0; 
                border-radius: 24px 24px 0 0; 
                max-height: calc(95vh - var(--sat)); 
                animation: slideUp 0.3s ease-out;
                padding-bottom: calc(20px + var(--sab));
            } 
        }
        .sheet-handle { width: 40px; height: 5px; background: #d1d5db; border-radius: 10px; margin: 10px auto 20px; }
        
        /* Stats Card - мобільна картка */
        .stats-card { 
            background: white; 
            border-radius: 20px; 
            padding: 18px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
            border: 1px solid #f3f4f6;
            transition: all 0.2s;
        }
        .stats-card:active { transform: scale(0.99); background: #fafafa; }
        
        /* Stats Table - десктоп */
        .stats-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .stats-table th { background: #f9fafb; padding: 14px 18px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; z-index: 10; }
        .stats-table td { padding: 14px 18px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .stats-table tbody tr:nth-child(odd) td { background: #ffffff; }
        .stats-table tbody tr:nth-child(even) td { background: #f9fafb; }
        .stats-table tr:hover td { background: #f0fdf4 !important; }
        .stats-table .sticky-col { position: sticky; left: 0; z-index: 5; box-shadow: 2px 0 4px rgba(0,0,0,0.05); }
        .stats-table tbody tr:nth-child(odd) .sticky-col { background: #ffffff; }
        .stats-table tbody tr:nth-child(even) .sticky-col { background: #f9fafb; }
        .stats-table tr:hover .sticky-col { background: #f0fdf4 !important; }
        .stats-table th[draggable="true"] { cursor: grab; user-select: none; }
        .stats-table th[draggable="true"]:active { cursor: grabbing; }
        .stats-table th.drag-over { background: #dcfce7 !important; box-shadow: inset 0 0 0 2px #22c55e; }
        .target-row { background: linear-gradient(90deg, #fef3c7 0%, #fefce8 100%); }
        .target-row td { border-bottom: 2px solid #fcd34d; }
        .target-row .sticky-col { background: linear-gradient(90deg, #fef3c7 0%, #fefce8 100%); }
        
        /* Bottom Navigation - мобільна навігація */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 16px calc(8px + var(--sab));
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            color: #9ca3af;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .bottom-nav-item:active { transform: scale(0.95); }
        .bottom-nav-item.active { color: #22c55e; background: #f0fdf4; }
        .bottom-nav-item svg { width: 24px; height: 24px; }
        
        /* FAB - floating action button */
        .fab { 
            position: fixed; 
            bottom: calc(80px + var(--sab)); 
            right: 20px; 
            width: 60px; 
            height: 60px; 
            border-radius: 18px; 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
            color: white; 
            border: none; 
            box-shadow: 0 6px 24px rgba(34, 197, 94, 0.4); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            z-index: 99;
        }
        .fab:active { transform: scale(0.92); }
        .fab svg { width: 28px; height: 28px; }
        
        /* Quick actions - швидкі дії */
        .quick-actions {
            position: fixed;
            bottom: calc(150px + var(--sab));
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 98;
        }
        .quick-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transition: all 0.2s;
        }
        .quick-action-btn:active { transform: scale(0.92); }
        
        /* Period badge */
        .period-badge { font-size: 11px; padding: 4px 8px; border-radius: 8px; background: #e0e7ff; color: #3730a3; font-weight: 600; }
        
        /* Status dots */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-filled { background: #22c55e; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2); }
        .status-pending { background: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
        .status-overdue { background: #ef4444; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); }
        
        /* AI Result */
        .ai-result { background: linear-gradient(135deg, #faf5ff 0%, #f0f9ff 100%); border: 1px solid #e9d5ff; border-radius: 20px; padding: 20px; }
        
        /* Support button - в правому верхньому куті */
        .support-btn {
            position: fixed;
            top: 80px;
            right: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
            text-decoration: none;
            transition: all 0.2s;
            z-index: 100;
        }
        .support-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }
        .support-btn:active {
            transform: scale(0.96);
        }
        @media (max-width: 640px) {
            .support-btn {
                top: auto;
                bottom: calc(80px + var(--sab));
                right: 16px;
                padding: 12px;
                border-radius: 50%;
            }
            .support-btn span { display: none; }
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .desktop-only { display: none !important; }
            body { padding-bottom: calc(70px + var(--sab)); }
            .btn { min-height: 52px; }
            .btn-icon { width: 52px; height: 52px; }
            .input-field { min-height: 52px; font-size: 16px; }
            .card { border-radius: 20px; }
            
            /* Покращений scroll */
            .scroll-container { 
                -webkit-overflow-scrolling: touch; 
                scroll-behavior: smooth;
                overscroll-behavior: contain;
            }
            
            /* Більші touch targets для value inputs */
            .value-input {
                min-height: 48px;
                font-size: 18px;
                font-weight: 600;
                text-align: center;
                border-radius: 12px;
            }
        }
        @media (min-width: 641px) { 
            .mobile-only { display: none !important; } 
            .bottom-nav { display: none; }
        }
        
        /* Checkbox items */
        .checkbox-item { display: flex; align-items: center; gap: 14px; padding: 14px; background: #f9fafb; border-radius: 14px; cursor: pointer; transition: all 0.2s; }
        .checkbox-item:active { background: #f3f4f6; transform: scale(0.98); }
        .checkbox-item input[type="checkbox"] { width: 22px; height: 22px; accent-color: #22c55e; cursor: pointer; }
        
        /* Select field */
        .select-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 16px; transition: all 0.2s; cursor: pointer; min-height: 52px; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 44px; }
        .select-field:focus { outline: none; border-color: #22c55e; }
        
        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            text-align: center;
        }
        .empty-state-icon {
            width: 80px;
            height: 80px;
            border-radius: 24px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        /* Pull to refresh indicator */
        .pull-indicator {
            position: fixed;
            top: calc(var(--sat) + 60px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #22c55e;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo, createContext, useContext } = React;

        // ==================== CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA850ceFuupxSBL9WwoKovkDzIshPAl_W8",
            authDomain: "stats-tracker-ai.firebaseapp.com",
            projectId: "stats-tracker-ai",
            storageBucket: "stats-tracker-ai.firebasestorage.app",
            messagingSenderId: "373376418182",
            appId: "1:373376418182:web:1b4cf979f73a8e6271ec07"
        };

        // OpenAI API Key (встановіть ліміт $20 в OpenAI Dashboard!)
        const OPENAI_API_KEY = null; // Ключ зберігається в Cloudflare Worker
        const OPENAI_MODEL = "gpt-4o";

        const SUPPORT_URL = "https://chatgpt.com/g/g-693bf67a13e48191940632f9d6bedb63-talko-statistics-ai-support";
        const GPT_BOTTLENECK_URL = "https://chatgpt.com/g/g-6856346cb4c481918bb7e00d87b59d9c-ai-alex-talko-bottleneck-analysis";

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence().catch(console.log);

        // ==================== SVG ICONS ====================
        const Icons = {
            Menu: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            Close: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Plus: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Edit: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>,
            Check: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M20 6 9 17l-5-5"/></svg>,
            Copy: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Undo: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>,
            BarChart: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>,
            Target: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Calendar: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>,
            DollarSign: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Gift: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>,
            Search: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Minus: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14"/></svg>,
            ArrowRight: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            TrendingUp: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            TrendingDown: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></svg>,
            Download: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            User: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Users: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            UserPlus: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
            Crown: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>,
            LogOut: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Mail: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            Lock: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Eye: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"/><path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"/><path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"/><path d="m2 2 20 20"/></svg>,
            Settings: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            AlertCircle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            AlertTriangle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            CheckCircle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Info: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Loader: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin" {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            MessageCircle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>,
            Link: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Sparkles: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>,
            Globe: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
            ChevronDown: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m6 9 6 6 6-6"/></svg>,
            Building: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>,
            Brain: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.967-.516"/><path d="M19.967 17.484A4 4 0 0 1 18 18"/></svg>,
            Clock: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Save: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>,
            History: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            HelpCircle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>,
            Star: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Circle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/></svg>,
            FileText: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>,
            RefreshCw: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Shield: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            GripVertical: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
            GitBranch: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="6" x2="6" y1="3" y2="15"/><circle cx="18" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><path d="M18 9a9 9 0 0 1-9 9"/></svg>,
            CheckSquare: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="m9 12 2 2 4-4"/></svg>,
            ExternalLink: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>,
            Play: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><polygon points="6 3 20 12 6 21 6 3"/></svg>,
            Database: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>,
        };

        // ==================== TRANSLATIONS ====================
        const translations = {
            uk: {
                appName: 'Трекер статистики',
                loading: 'Завантаження...',
                login: 'Вхід', register: 'Реєстрація', email: 'Email', password: 'Пароль',
                loginBtn: 'Увійти', registerBtn: 'Зареєструватися', logout: 'Вийти',
                noAccount: 'Немає акаунту?', hasAccount: 'Вже є акаунт?',
                companyName: 'Назва компанії', companyPlaceholder: 'Наприклад: Клініка "Здоров\'я"',
                owner: 'Власник', employee: 'Співробітник',
                menu: 'Меню', dashboard: 'Дашборд', statistics: 'Статистика', team: 'Команда', settings: 'Налаштування',
                add: 'Додати', save: 'Зберегти', cancel: 'Скасувати', delete: 'Видалити', edit: 'Редагувати', close: 'Закрити', confirm: 'Підтвердити', copy: 'Копіювати', undo: 'Відмінити',
                addStats: 'Додати показник', addRow: 'Додати запис', statsName: 'Назва показника', responsible: 'Відповідальний',
                date: 'Дата', target: 'Ціль', value: 'Значення', progress: 'Прогрес', comment: 'Коментар', addComment: 'Додати коментар',
                period: 'Періодичність', periodDaily: 'Щодня', periodWeekly: 'Щотижня', periodMonthly: 'Щомісяця', periodCustom: 'Довільно',
                search: 'Пошук...', noData: 'Даних поки немає',
                teamManagement: 'Управління командою', addEmployee: 'Додати співробітника', employeeEmail: 'Email співробітника', employeeName: "Ім'я співробітника",
                employees: 'Співробітники', noEmployees: 'Співробітників ще немає', removeEmployee: 'Видалити співробітника',
                visibleColumns: 'Доступ до показників', pendingInvite: 'Очікує', activeEmployee: 'Активний',
                inviteLink: 'Посилання для входу', linkCopied: 'Скопійовано!', joinWorkspace: 'Приєднатися', enterInviteCode: 'Код запрошення', joinBtn: 'Приєднатися',
                export: 'Експорт', import: 'Імпорт', exportExcel: 'Експорт Excel', importExcel: 'Імпорт Excel',
                saving: 'Збереження...', saved: 'Збережено', saveError: 'Помилка',
                columns: 'Показників', periods: 'Записів', values: 'Значень',
                support: 'Підтримка',
                confirmDelete: 'Видалити?', confirmClear: 'Очистити всі дані?',
                aiAnalysis: 'AI Аналіз', aiSettings: 'Налаштування AI',
                businessContext: 'Контекст бізнесу', businessContextPlaceholder: 'Опишіть ваш бізнес: галузь, послуги, середній чек, кількість співробітників...',
                priorities: 'Пріоритети зараз', prioritiesPlaceholder: 'Що найважливіше зараз? Збільшення продажів, оптимізація витрат...',
                analysisPeriod: 'Період аналізу', additionalFocus: 'Додатковий фокус', additionalFocusPlaceholder: 'Наприклад: Чому впали продажі у п\'ятницю?',
                runAnalysis: 'Запустити аналіз', analyzing: 'Аналізую...',
                lastWeeks: 'тижнів', aiResult: 'Результат аналізу', saveAnalysis: 'Зберегти', analysisHistory: 'Історія аналізів',
                overview: 'Загальна картина', bottleneck: 'Вузьке місце', recommendations: 'Рекомендації', weekPlan: 'План на тиждень',
                filled: 'Заповнено', pending: 'Очікує', overdue: 'Прострочено',
                editColumn: 'Редагувати показник', columnSettings: 'Налаштування показника',
                valueFormat: 'Формат значення', formatNumber: 'Число', formatPercent: 'Відсотки %', formatUAH: 'Гривні ₴', formatUSD: 'Долари $', formatEUR: 'Євро €',
                importance: 'Важливість', importanceCritical: 'Критично (впливає на гроші)', importanceHigh: 'Висока', importanceMedium: 'Середня', importanceLow: 'Низька (допоміжний)',
            },
            ru: {
                appName: 'Трекер статистики',
                loading: 'Загрузка...',
                login: 'Вход', register: 'Регистрация', email: 'Email', password: 'Пароль',
                loginBtn: 'Войти', registerBtn: 'Зарегистрироваться', logout: 'Выйти',
                noAccount: 'Нет аккаунта?', hasAccount: 'Уже есть аккаунт?',
                companyName: 'Название компании', companyPlaceholder: 'Например: Клиника "Здоровье"',
                owner: 'Владелец', employee: 'Сотрудник',
                menu: 'Меню', add: 'Добавить', save: 'Сохранить', cancel: 'Отмена', delete: 'Удалить',
                addStats: 'Добавить показатель', addRow: 'Добавить запись', statsName: 'Название показателя', responsible: 'Ответственный',
                date: 'Дата', target: 'Цель', value: 'Значение', comment: 'Комментарий',
                period: 'Периодичность', periodDaily: 'Ежедневно', periodWeekly: 'Еженедельно', periodMonthly: 'Ежемесячно', periodCustom: 'Произвольно',
                teamManagement: 'Управление командой', addEmployee: 'Добавить сотрудника',
                aiAnalysis: 'AI Анализ', businessContext: 'Контекст бизнеса', priorities: 'Приоритеты', runAnalysis: 'Запустить анализ',
                overview: 'Общая картина', bottleneck: 'Узкое место', recommendations: 'Рекомендации', weekPlan: 'План на неделю',
                valueFormat: 'Формат значения', formatNumber: 'Число', formatPercent: 'Проценты %', formatUAH: 'Гривны ₴', formatUSD: 'Доллары $', formatEUR: 'Евро €',
            }
        };

        // ==================== FORMAT VALUE ====================
        const formatValue = (value, format) => {
            if (value === '' || value === null || value === undefined || value === '-') return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return value;
            
            switch (format) {
                case 'percent':
                    return `${num.toLocaleString('uk-UA')}%`;
                case 'uah':
                    return `${num.toLocaleString('uk-UA')} ₴`;
                case 'usd':
                    return `$${num.toLocaleString('en-US')}`;
                case 'eur':
                    return `€${num.toLocaleString('de-DE')}`;
                case 'number':
                default:
                    return num.toLocaleString('uk-UA');
            }
        };

        // ==================== WEEK HELPERS ====================
        const getWeekRange = (date) => {
            const d = new Date(date);
            if (isNaN(d.getTime())) return null;
            const day = d.getDay();
            const diffToMonday = day === 0 ? -6 : 1 - day;
            const monday = new Date(d);
            monday.setDate(d.getDate() + diffToMonday);
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            return { start: monday, end: sunday };
        };

        const formatWeekLabel = (date) => {
            const range = getWeekRange(date);
            if (!range) return 'Невірна дата';
            const { start, end } = range;
            const formatDay = (d) => d.getDate().toString().padStart(2, '0');
            const formatMonth = (d) => (d.getMonth() + 1).toString().padStart(2, '0');
            const year = end.getFullYear().toString().slice(-2);
            
            if (start.getMonth() === end.getMonth()) {
                return `${formatDay(start)}-${formatDay(end)}.${formatMonth(end)}.${year}`;
            } else {
                return `${formatDay(start)}.${formatMonth(start)}-${formatDay(end)}.${formatMonth(end)}.${year}`;
            }
        };

        const getWeekKey = (date) => {
            const range = getWeekRange(date);
            if (!range) return null;
            return range.start.toISOString().split('T')[0];
        };

        const generateWeeks = (count = 12) => {
            const weeks = [];
            const today = new Date();
            
            for (let i = 0; i < count; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - (i * 7));
                const range = getWeekRange(d);
                if (!range) continue;
                const { start, end } = range;
                weeks.push({
                    key: start.toISOString().split('T')[0],
                    label: formatWeekLabel(d),
                    start: start,
                    end: end,
                    isCurrent: i === 0
                });
            }
            return weeks;
        };

        // Глобальний кеш тижнів (не змінюється протягом сесії)
        const WEEKS_CACHE = generateWeeks(16);

        // ==================== MONTH HELPERS ====================
        const getMonthKeyFromDate = (date) => {
            const d = new Date(date);
            if (isNaN(d.getTime())) return null;
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            return `${year}-${month}`;
        };

        const formatMonthLabel = (monthKey) => {
            if (!monthKey) return 'Невірний місяць';
            const [year, month] = monthKey.split('-');
            const monthNames = ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 
                               'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        };

        const generateMonths = (count = 12) => {
            const months = [];
            const today = new Date();
            
            for (let i = 0; i < count; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = getMonthKeyFromDate(d);
                months.push({
                    key: key,
                    label: formatMonthLabel(key),
                    isCurrent: i === 0
                });
            }
            return months;
        };

        const MONTHS_CACHE = generateMonths(12);

        const isWeekFilled = (weekKey, rows) => {
            return rows.some(row => {
                if (row.isTarget || !row.date) return false;
                const rowWeekKey = getWeekKey(row.date);
                return rowWeekKey === weekKey;
            });
        };

        const isMonthFilled = (monthKey, rows) => {
            return rows.some(row => {
                if (row.isTarget || !row.date || row.periodType !== 'monthly') return false;
                return row.date === monthKey;
            });
        };

        // ==================== TOAST ====================
        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = useCallback((message, type = 'info', duration = 3000) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), duration);
            }, []);
            const toast = useMemo(() => ({
                success: (msg) => addToast(msg, 'success'),
                error: (msg) => addToast(msg, 'error'),
                info: (msg) => addToast(msg, 'info'),
                warning: (msg) => addToast(msg, 'warning'),
            }), [addToast]);
            return (
                <ToastContext.Provider value={toast}>
                    {children}
                    <div className="toast-container">
                        {toasts.map(t => (
                            <div key={t.id} className={`toast toast-${t.type}`}>
                                {t.type === 'success' && <Icons.CheckCircle className="w-5 h-5 text-green-500" />}
                                {t.type === 'error' && <Icons.AlertCircle className="w-5 h-5 text-red-500" />}
                                {t.type === 'info' && <Icons.Info className="w-5 h-5 text-blue-500" />}
                                {t.type === 'warning' && <Icons.AlertCircle className="w-5 h-5 text-amber-500" />}
                                <span>{t.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToast = () => useContext(ToastContext);

        // ==================== MODAL ====================
        const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
            useEffect(() => {
                if (isOpen) document.body.style.overflow = 'hidden';
                return () => { document.body.style.overflow = ''; };
            }, [isOpen]);
            if (!isOpen) return null;
            const sizeClass = size === 'lg' ? 'sm:max-w-lg' : size === 'xl' ? 'sm:max-w-2xl' : size === '2xl' ? 'sm:max-w-4xl' : size === 'full' ? 'sm:max-w-[95vw] sm:w-[95vw]' : 'sm:max-w-md';
            const heightClass = size === '2xl' || size === 'full' ? 'max-h-[85vh]' : 'max-h-[70vh]';
            return (
                <>
                    <div className="modal-overlay" onClick={onClose} />
                    <div className={`modal-content ${sizeClass}`}>
                        <div className="sm:hidden"><div className="sheet-handle" /></div>
                        <div className="p-5">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-xl font-bold text-gray-900">{title}</h2>
                                <button onClick={onClose} className="btn btn-ghost btn-icon"><Icons.Close className="w-5 h-5" /></button>
                            </div>
                            <div className={`${heightClass} overflow-y-auto`}>{children}</div>
                        </div>
                    </div>
                </>
            );
        };

        // ==================== CONFIRM DIALOG ====================
        const ConfirmDialog = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <>
                    <div className="modal-overlay" onClick={onClose} />
                    <div className="modal-content">
                        <div className="sm:hidden"><div className="sheet-handle" /></div>
                        <div className="p-6 text-center">
                            <div className="w-14 h-14 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                                <Icons.AlertCircle className="w-7 h-7 text-red-500" />
                            </div>
                            <h3 className="text-lg font-bold text-gray-900 mb-2">{title}</h3>
                            {message && <p className="text-gray-600 mb-6">{message}</p>}
                            <div className="flex gap-3">
                                <button onClick={onClose} className="btn btn-secondary flex-1">Скасувати</button>
                                <button onClick={() => { onConfirm(); onClose(); }} className="btn btn-danger flex-1">Підтвердити</button>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // ==================== PROGRESS BAR ====================
        const ProgressBar = ({ value }) => {
            const getColor = () => {
                if (value >= 100) return 'bg-green-500';
                if (value >= 80) return 'bg-blue-500';
                if (value >= 50) return 'bg-amber-500';
                return 'bg-red-500';
            };
            return (
                <div className="progress-bar">
                    <div className={`progress-fill ${getColor()}`} style={{ width: `${Math.min(value, 100)}%` }} />
                </div>
            );
        };

        // ==================== AUTH FORM ====================
        const AuthForm = ({ t, onAuth, isLoading }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [inviteCode, setInviteCode] = useState('');
            const [inviteData, setInviteData] = useState(null);
            const [inviteLoading, setInviteLoading] = useState(false);
            const [inviteError, setInviteError] = useState('');
            
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('invite');
                if (code) {
                    setInviteCode(code);
                    setIsRegister(true);
                    loadInviteData(code);
                }
            }, []);
            
            const loadInviteData = async (code) => {
                setInviteLoading(true);
                setInviteError('');
                try {
                    const inviteDoc = await db.collection('invites').doc(code).get();
                    if (!inviteDoc.exists) {
                        setInviteError('Запрошення не знайдено');
                        return;
                    }
                    const data = inviteDoc.data();
                    if (data.used) {
                        setInviteError('Це запрошення вже використано');
                        return;
                    }
                    setInviteData(data);
                    console.log('Invite loaded:', data);
                } catch (error) {
                    console.error('Error loading invite:', error);
                    setInviteError('Помилка завантаження запрошення');
                } finally {
                    setInviteLoading(false);
                }
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onAuth(email, password, isRegister, inviteCode);
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary-50 via-white to-green-50 p-4" style={{ paddingTop: 'calc(env(safe-area-inset-top) + 16px)', paddingBottom: 'calc(env(safe-area-inset-bottom) + 16px)' }}>
                    <div className="w-full max-w-sm animate-fade-in">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 mx-auto mb-5 rounded-3xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-xl shadow-primary-500/30">
                                <Icons.BarChart className="w-10 h-10 text-white" />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-900">{t.appName}</h1>
                            <p className="text-gray-500 mt-2">
                                {inviteData ? 'Приєднайтесь до команди' : (isRegister ? t.register : t.login)}
                            </p>
                        </div>
                        
                        {/* Invite status */}
                        {inviteCode && (
                            <div className="mb-5">
                                {inviteLoading && (
                                    <div className="p-4 bg-gray-50 rounded-2xl flex items-center justify-center gap-2">
                                        <Icons.Loader className="w-5 h-5 text-primary-500" />
                                        <span className="text-gray-600">Завантаження...</span>
                                    </div>
                                )}
                                {inviteError && (
                                    <div className="p-4 bg-red-50 border border-red-200 rounded-2xl">
                                        <div className="flex items-center gap-2 text-red-700">
                                            <Icons.AlertCircle className="w-5 h-5" />
                                            <span className="font-medium">{inviteError}</span>
                                        </div>
                                        <button 
                                            onClick={() => { window.history.replaceState({}, '', window.location.pathname); window.location.reload(); }}
                                            className="mt-3 text-sm text-red-600 underline"
                                        >
                                            Увійти без запрошення
                                        </button>
                                    </div>
                                )}
                                {inviteData && !inviteError && (
                                    <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-2xl">
                                        <div className="flex items-center gap-3 mb-2">
                                            <div className="w-12 h-12 rounded-xl bg-green-500 flex items-center justify-center">
                                                <Icons.UserPlus className="w-6 h-6 text-white" />
                                            </div>
                                            <div>
                                                <p className="font-bold text-green-900">Запрошення для:</p>
                                                <p className="text-green-700 font-medium">{inviteData.name || 'Співробітник'}</p>
                                            </div>
                                        </div>
                                        <p className="text-sm text-green-600 mt-2 bg-green-100 p-2 rounded-lg">
                                            💡 Введіть <b>вашу пошту</b> та придумайте пароль
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}
                        
                        <form onSubmit={handleSubmit} className="card p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">{t.email}</label>
                                <div className="relative">
                                    <Icons.Mail className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                    <input 
                                        type="email" 
                                        value={email} 
                                        onChange={(e) => setEmail(e.target.value)} 
                                        className="input-field pl-12" 
                                        placeholder="your@email.com" 
                                        required 
                                        autoComplete="email"
                                        disabled={inviteLoading || !!inviteError}
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">{t.password}</label>
                                <div className="relative">
                                    <Icons.Lock className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                    <input 
                                        type={showPassword ? 'text' : 'password'} 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        className="input-field pl-12 pr-14" 
                                        placeholder="••••••••" 
                                        required 
                                        minLength={6} 
                                        autoComplete={isRegister ? 'new-password' : 'current-password'}
                                        disabled={inviteLoading || !!inviteError}
                                    />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600">
                                        {showPassword ? <Icons.EyeOff className="w-5 h-5" /> : <Icons.Eye className="w-5 h-5" />}
                                    </button>
                                </div>
                                {isRegister && <p className="text-xs text-gray-500 mt-1">Мінімум 6 символів</p>}
                            </div>
                            <button 
                                type="submit" 
                                className="btn btn-primary w-full text-base" 
                                disabled={isLoading || inviteLoading || !!inviteError}
                            >
                                {isLoading ? <Icons.Loader className="w-5 h-5" /> : (
                                    inviteData ? '🚀 Приєднатись' : (isRegister ? t.registerBtn : t.loginBtn)
                                )}
                            </button>
                        </form>
                        
                        {!inviteCode && (
                            <p className="text-center mt-6 text-sm text-gray-600">
                                {isRegister ? t.hasAccount : t.noAccount}{' '}
                                <button onClick={() => setIsRegister(!isRegister)} className="text-primary-600 font-bold hover:underline">
                                    {isRegister ? t.login : t.register}
                                </button>
                            </p>
                        )}
                        
                        {!inviteCode && isRegister && (
                            <p className="text-center mt-4 text-xs text-gray-500 bg-amber-50 p-3 rounded-xl">
                                <Icons.Info className="w-4 h-4 inline mr-1 text-amber-500" />
                                Реєстрація можлива тільки за запрошенням від власника
                            </p>
                        )}
                    </div>
                </div>
            );
        };

        // ==================== PERIOD HELPERS ====================
        const getPeriodLabel = (period, t) => {
            const labels = { daily: t.periodDaily, weekly: t.periodWeekly, monthly: t.periodMonthly, custom: t.periodCustom };
            return labels[period] || labels['weekly'] || 'Щотижня';
        };
        
        const getWeekNumber = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };
        
        const getMonthKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${d.getMonth()}`;
        };
        
        const isFilledForPeriod = (rows, colId, period) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            const todayWeek = getWeekNumber(today);
            const todayMonth = getMonthKey(today);
            
            for (const row of rows) {
                if (row.isTarget || !row.values?.[colId]) continue;
                const val = row.values[colId];
                if (!val && val !== 0) continue;
                
                const rowDate = new Date(row.date);
                rowDate.setHours(0, 0, 0, 0);
                
                if (period === 'daily' && row.date === todayStr) return true;
                if (period === 'weekly' && getWeekNumber(rowDate) === todayWeek) return true;
                if (period === 'monthly' && getMonthKey(rowDate) === todayMonth) return true;
                if (period === 'custom') return true;
            }
            return false;
        };

        // ==================== STATS CARD (MOBILE) ====================
        const StatsCardComponent = ({ row, columns, onDelete, onDateChange, onValueChange, onTargetChange, onCommentChange, editable, isEven, t, allRows, periodType = 'weekly' }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const [activeComment, setActiveComment] = useState(null);
            const [showTargets, setShowTargets] = useState(false);
            
            // Використовуємо відповідний кеш
            const periods = periodType === 'monthly' ? MONTHS_CACHE : WEEKS_CACHE;
            
            // Indexed Set для O(1) lookup
            const filledPeriodsSet = useMemo(() => {
                if (!allRows) return new Set();
                const set = new Set();
                allRows.forEach(r => {
                    if (!r.isTarget && r.date && r.id !== row.id && r.periodType === periodType) {
                        if (periodType === 'monthly') {
                            set.add(r.date);
                        } else {
                            const key = getWeekKey(r.date);
                            if (key) set.add(key);
                        }
                    }
                });
                return set;
            }, [allRows, row.id, periodType]);
            
            const getPeriodStatus = (periodKey) => {
                return filledPeriodsSet.has(periodKey) ? 'filled' : 'empty';
            };
            
            const getCurrentPeriodKey = () => {
                if (!row.date) return '';
                return periodType === 'monthly' ? row.date : getWeekKey(row.date);
            };
            
            const calculateProgress = (colId) => {
                const target = parseFloat(String(row.targets?.[colId] || '').replace(',', '.'));
                const value = parseFloat(String(row.values?.[colId] || '').replace(',', '.'));
                if (isNaN(target) || isNaN(value) || target === 0) return null;
                return Math.round((value / target) * 100);
            };
            
            const getProgressColor = (progress) => {
                if (progress >= 100) return { bg: 'bg-green-500', text: 'text-green-600', light: 'bg-green-100' };
                if (progress >= 80) return { bg: 'bg-blue-500', text: 'text-blue-600', light: 'bg-blue-100' };
                if (progress >= 50) return { bg: 'bg-amber-500', text: 'text-amber-600', light: 'bg-amber-100' };
                return { bg: 'bg-red-500', text: 'text-red-600', light: 'bg-red-100' };
            };
            
            const displayCols = isExpanded ? columns : columns.slice(0, 3);
            const hasAnyTarget = columns.some(col => row.targets?.[col.id]);
            
            return (
                <div className={`stats-card animate-fade-in ${isEven ? 'bg-gray-50/50' : ''}`} style={isEven ? {borderLeft: '4px solid #e5e7eb'} : {borderLeft: periodType === 'monthly' ? '4px solid #3b82f6' : '4px solid #22c55e'}}>
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <div className={`w-12 h-12 rounded-2xl bg-gradient-to-br ${periodType === 'monthly' ? 'from-blue-100 to-blue-200' : 'from-gray-100 to-gray-200'} flex items-center justify-center`}>
                                {periodType === 'monthly' ? (
                                    <Icons.BarChart className="w-6 h-6 text-blue-600" />
                                ) : (
                                    <Icons.Calendar className="w-6 h-6 text-gray-600" />
                                )}
                            </div>
                            <div className="flex-1">
                                <select 
                                    value={getCurrentPeriodKey()} 
                                    onChange={(e) => onDateChange(e.target.value)}
                                    disabled={!editable}
                                    className="font-bold text-base text-gray-900 bg-white border border-gray-200 rounded-lg px-2 py-1 focus:ring-1 focus:ring-primary-200 w-full"
                                    style={{ maxWidth: '160px' }}
                                >
                                    <option value="">{periodType === 'monthly' ? 'Оберіть місяць' : 'Оберіть тиждень'}</option>
                                    {periods.map(period => {
                                        const status = getPeriodStatus(period.key);
                                        return (
                                            <option key={period.key} value={period.key}>
                                                {period.label} {period.isCurrent ? '(зараз)' : ''} {status === 'filled' ? 'ok' : ''}
                                            </option>
                                        );
                                    })}
                                </select>
                                <p className="text-xs text-gray-500 mt-1">{columns.length} показників</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => setShowTargets(!showTargets)} 
                                className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${showTargets || hasAnyTarget ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-400'}`}
                                title="Показати/сховати план"
                            >
                                <Icons.Target className="w-5 h-5" />
                            </button>
                            {editable && (
                                <button onClick={onDelete} className="w-10 h-10 rounded-xl bg-red-50 flex items-center justify-center">
                                    <Icons.Trash className="w-5 h-5 text-red-400" />
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* Values Grid */}
                    <div className="space-y-3">
                        {displayCols.map(col => {
                            const progress = calculateProgress(col.id);
                            const colors = progress !== null ? getProgressColor(progress) : null;
                            const hasComment = row.comments?.[col.id];
                            const hasTarget = row.targets?.[col.id];
                            
                            return (
                                <div key={col.id} className="bg-gray-50 rounded-2xl p-4">
                                    {/* Metric header */}
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="font-semibold text-gray-900">{col.name}</span>
                                                {col.format && col.format !== 'number' && (
                                                    <span className="text-xs text-gray-400">
                                                        {col.format === 'percent' && '%'}
                                                        {col.format === 'uah' && '₴'}
                                                        {col.format === 'usd' && '$'}
                                                        {col.format === 'eur' && '€'}
                                                    </span>
                                                )}
                                                {hasComment && (
                                                    <button onClick={() => setActiveComment(activeComment === col.id ? null : col.id)} className="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                                                        <Icons.MessageCircle className="w-3.5 h-3.5 text-blue-600" />
                                                    </button>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="period-badge">{getPeriodLabel(col.period, t)}</span>
                                                {col.responsible && <span className="text-xs text-gray-500">{col.responsible}</span>}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Inputs row: Plan + Fact */}
                                    <div className="flex items-center gap-2">
                                        {(showTargets || hasTarget) && (
                                            <div className="flex-1">
                                                <label className="text-xs text-amber-600 font-medium mb-1 block">План</label>
                                                <input
                                                    type="text"
                                                    inputMode="decimal"
                                                    value={row.targets?.[col.id] || ''}
                                                    onChange={(e) => onTargetChange(col.id, e.target.value)}
                                                    className="w-full px-3 py-2 bg-amber-50 border-2 border-amber-200 rounded-xl text-center font-bold text-lg text-amber-700 focus:border-amber-400 focus:ring-0"
                                                    placeholder="—"
                                                />
                                            </div>
                                        )}
                                        <div className="flex-1">
                                            <label className="text-xs text-gray-500 font-medium mb-1 block">{showTargets || hasTarget ? 'Факт' : 'Значення'}</label>
                                            <div className="relative">
                                                <input
                                                    type="text"
                                                    inputMode="decimal"
                                                    value={row.values?.[col.id] || ''}
                                                    onChange={(e) => onValueChange(col.id, e.target.value)}
                                                    className={`w-full px-3 py-2 bg-white border-2 border-gray-200 rounded-xl text-center font-bold text-lg focus:border-primary-500 focus:ring-0 ${col.format === 'usd' || col.format === 'eur' ? 'pl-7' : ''} ${col.format === 'percent' || col.format === 'uah' ? 'pr-7' : ''}`}
                                                    placeholder="0"
                                                />
                                                {col.format === 'usd' && <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>}
                                                {col.format === 'eur' && <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">€</span>}
                                                {col.format === 'uah' && <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">₴</span>}
                                                {col.format === 'percent' && <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">%</span>}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Progress bar */}
                                    {progress !== null && (
                                        <div className="flex items-center gap-3 mt-3">
                                            <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div className={`h-full rounded-full ${colors.bg}`} style={{ width: `${Math.min(progress, 100)}%` }} />
                                            </div>
                                            <span className={`text-sm font-bold ${colors.text} text-right`} style={{ minWidth: '48px' }}>{progress}%</span>
                                        </div>
                                    )}
                                    
                                    {/* Comment input */}
                                    {activeComment === col.id && (
                                        <div className="mt-3">
                                            <input
                                                type="text"
                                                value={row.comments?.[col.id] || ''}
                                                onChange={(e) => onCommentChange(col.id, e.target.value)}
                                                className="w-full px-3 py-2 text-sm bg-white border border-gray-200 rounded-xl focus:border-primary-500"
                                                placeholder="💬 Коментар..."
                                            />
                                        </div>
                                    )}
                                    
                                    {/* Add comment button */}
                                    {!hasComment && activeComment !== col.id && (
                                        <button 
                                            onClick={() => setActiveComment(col.id)} 
                                            className="mt-2 text-xs text-gray-400 hover:text-gray-600"
                                        >
                                            + Коментар
                                        </button>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    
                    {/* Expand button */}
                    {columns.length > 3 && (
                        <button 
                            onClick={() => setIsExpanded(!isExpanded)} 
                            className="w-full mt-4 py-3 text-sm font-semibold text-primary-600 bg-primary-50 hover:bg-primary-100 rounded-xl flex items-center justify-center gap-2 transition-all"
                        >
                            <Icons.ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                            {isExpanded ? 'Згорнути' : `Показати ще ${columns.length - 3}`}
                        </button>
                    )}
                </div>
            );
        };
        
        // #2: React.memo для уникнення зайвих ре-рендерів
        const StatsCard = React.memo(StatsCardComponent);

        // ==================== STATS TABLE (DESKTOP) ====================
        const StatsTable = ({ columns, rows, targetRow, periodType = 'weekly', onDeleteRow, onDateChange, onValueChange, onCommentChange, onEditColumn, onMoveColumn, editable, t }) => {
            const [draggedCol, setDraggedCol] = useState(null);
            const [dragOverCol, setDragOverCol] = useState(null);
            
            // Використовуємо відповідний кеш залежно від типу періоду
            const periods = periodType === 'monthly' ? MONTHS_CACHE : WEEKS_CACHE;
            
            // Indexed Set для O(1) lookup
            const filledPeriodsSet = useMemo(() => {
                const set = new Set();
                rows.forEach(r => {
                    if (!r.isTarget && r.date) {
                        if (periodType === 'monthly') {
                            set.add(r.date); // Для місяців date вже є ключем
                        } else {
                            const key = getWeekKey(r.date);
                            if (key) set.add(key);
                        }
                    }
                });
                return set;
            }, [rows, periodType]);
            
            const calculateProgress = (row, colId) => {
                if (!targetRow || !row.values) return null;
                const target = parseFloat(String(targetRow.values[colId] || '').replace(',', '.'));
                const value = parseFloat(String(row.values[colId] || '').replace(',', '.'));
                if (isNaN(target) || isNaN(value) || target === 0) return null;
                return Math.round((value / target) * 100);
            };
            
            const getPeriodStatus = (periodKey) => {
                return filledPeriodsSet.has(periodKey) ? 'filled' : 'empty';
            };
            
            const getPeriodLabel = (date) => {
                if (!date) return periodType === 'monthly' ? 'Оберіть місяць' : 'Оберіть тиждень';
                return periodType === 'monthly' ? formatMonthLabel(date) : formatWeekLabel(date);
            };
            
            // Форматування значення з кольором
            const formatValue = (value, format, progress) => {
                if (!value && value !== 0) return null;
                const numValue = parseFloat(String(value).replace(',', '.').replace(/\s/g, ''));
                if (isNaN(numValue)) return value;
                
                // Форматування числа з роздільниками
                const formatted = new Intl.NumberFormat('uk-UA').format(numValue);
                
                // Колір на основі прогресу або типу
                let colorClass = 'text-gray-900';
                if (progress !== null) {
                    if (progress >= 100) colorClass = 'text-emerald-600 font-semibold';
                    else if (progress >= 80) colorClass = 'text-emerald-500';
                    else if (progress >= 50) colorClass = 'text-amber-600';
                    else colorClass = 'text-red-500';
                } else if (format === 'uah' || format === 'usd' || format === 'eur') {
                    colorClass = 'text-emerald-600 font-semibold';
                }
                
                // Символ валюти/формату
                let prefix = '';
                let suffix = '';
                if (format === 'uah') prefix = '₴';
                if (format === 'usd') prefix = '$';
                if (format === 'eur') prefix = '€';
                if (format === 'percent') suffix = '%';
                
                return (
                    <span className={colorClass}>
                        {prefix}{formatted}{suffix}
                    </span>
                );
            };
            
            const getProgressBadge = (progress) => {
                if (progress === null) return null;
                let colorClass = 'badge-red';
                if (progress >= 100) colorClass = 'badge-green';
                else if (progress >= 80) colorClass = 'badge-blue';
                else if (progress >= 50) colorClass = 'badge-amber';
                return <span className={`badge ${colorClass} ml-2`}>{progress}%</span>;
            };
            
            const getColumnStatus = (col) => {
                const isFilled = isFilledForPeriod(rows, col.id, col.period);
                if (col.period === 'custom') return null;
                return isFilled ? 'filled' : 'pending';
            };
            
            const handleDragStart = (e, colId) => {
                setDraggedCol(colId);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', colId);
            };
            
            const handleDragOver = (e, colId) => {
                e.preventDefault();
                if (draggedCol && draggedCol !== colId) {
                    setDragOverCol(colId);
                }
            };
            
            const handleDragLeave = () => {
                setDragOverCol(null);
            };
            
            const handleDrop = (e, targetColId) => {
                e.preventDefault();
                if (draggedCol && draggedCol !== targetColId && onMoveColumn) {
                    onMoveColumn(draggedCol, targetColId);
                }
                setDraggedCol(null);
                setDragOverCol(null);
            };
            
            const handleDragEnd = () => {
                setDraggedCol(null);
                setDragOverCol(null);
            };
            
            return (
                <div className="card overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="stats-table">
                            <thead>
                                <tr>
                                    <th className="sticky-col" style={{ minWidth: 170 }}>{periodType === 'monthly' ? 'МІСЯЦЬ' : 'ТИЖДЕНЬ'}</th>
                                    {columns.map((col, idx) => {
                                        const status = getColumnStatus(col);
                                        const isDragging = draggedCol === col.id;
                                        const isDragOver = dragOverCol === col.id;
                                        return (
                                            <th 
                                                key={col.id} 
                                                style={{ minWidth: 180 }}
                                                draggable={editable}
                                                onDragStart={(e) => handleDragStart(e, col.id)}
                                                onDragOver={(e) => handleDragOver(e, col.id)}
                                                onDragLeave={handleDragLeave}
                                                onDrop={(e) => handleDrop(e, col.id)}
                                                onDragEnd={handleDragEnd}
                                                className={`${editable ? 'cursor-grab active:cursor-grabbing' : ''} ${isDragging ? 'opacity-50' : ''} ${isDragOver ? 'drag-over' : ''}`}
                                            >
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        {editable && (
                                                            <Icons.GripVertical className="w-4 h-4 text-gray-300 flex-shrink-0" />
                                                        )}
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                {status && <span className={`status-dot ${status === 'filled' ? 'status-filled' : 'status-pending'}`}></span>}
                                                                <span>{col.name}</span>
                                                                {col.format && col.format !== 'number' && (
                                                                    <span className="text-xs font-normal text-gray-400">
                                                                        {col.format === 'percent' && '%'}
                                                                        {col.format === 'uah' && '₴'}
                                                                        {col.format === 'usd' && '$'}
                                                                        {col.format === 'eur' && '€'}
                                                                    </span>
                                                                )}
                                                            </div>
                                                            <div className="flex items-center gap-2 mt-1">
                                                                <span className="period-badge">{t.periodMonthly || 'Щомісяця'}</span>
                                                                {col.responsible && <span className="text-xs font-normal text-gray-400">{col.responsible}</span>}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {editable && (
                                                        <button onClick={() => onEditColumn(col)} className="p-1 hover:bg-gray-200 rounded text-gray-400 hover:text-gray-600">
                                                            <Icons.Settings className="w-4 h-4" />
                                                        </button>
                                                    )}
                                                </div>
                                            </th>
                                        );
                                    })}
                                    {editable && <th style={{ width: 60 }}></th>}
                                </tr>
                            </thead>
                            <tbody>
                                {targetRow && (
                                    <tr className="target-row">
                                        <td className="sticky-col font-bold text-amber-700">
                                            <div className="flex items-center gap-2"><Icons.Target className="w-4 h-4" />{t.target}</div>
                                        </td>
                                        {columns.map(col => (
                                            <td key={col.id}>
                                                <input
                                                    type="text" value={targetRow.values?.[col.id] || ''} onChange={(e) => onValueChange(targetRow.id, col.id, e.target.value)}
                                                    disabled={!editable} className="w-full px-2 py-1 text-sm font-bold bg-transparent border border-transparent rounded focus:border-amber-400 focus:bg-white" placeholder={t.target}
                                                />
                                            </td>
                                        ))}
                                        {editable && <td></td>}
                                    </tr>
                                )}
                                {rows.filter(r => !r.isTarget).map(row => {
                                    const currentPeriodKey = periodType === 'monthly' ? row.date : (row.date ? getWeekKey(row.date) : null);
                                    return (
                                    <tr key={row.id}>
                                        <td className="sticky-col">
                                            <select 
                                                value={currentPeriodKey || ''} 
                                                onChange={(e) => onDateChange(row.id, e.target.value)}
                                                className="w-full px-2 py-1.5 text-sm bg-white border border-gray-200 rounded-lg focus:border-primary-400 focus:ring-1 focus:ring-primary-200 cursor-pointer"
                                            >
                                                <option value="">{periodType === 'monthly' ? 'Оберіть місяць' : 'Оберіть тиждень'}</option>
                                                {periods.map(period => {
                                                    const status = getPeriodStatus(period.key);
                                                    const isCurrentRow = currentPeriodKey === period.key;
                                                    return (
                                                        <option 
                                                            key={period.key} 
                                                            value={period.key}
                                                            className={status === 'filled' && !isCurrentRow ? 'text-gray-400' : ''}
                                                        >
                                                            {period.label} {period.isCurrent ? '(поточний)' : ''} {status === 'filled' && !isCurrentRow ? 'ok' : ''}
                                                        </option>
                                                    );
                                                })}
                                            </select>
                                        </td>
                                        {columns.map(col => {
                                            const progress = calculateProgress(row, col.id);
                                            const value = row.values?.[col.id] || '';
                                            return (
                                                <td key={col.id}>
                                                    <div>
                                                        <div className="flex items-center gap-1">
                                                            {editable ? (
                                                                <input
                                                                    type="text" value={value} onChange={(e) => onValueChange(row.id, col.id, e.target.value)}
                                                                    className="w-24 px-2 py-1 text-sm bg-transparent border border-transparent rounded focus:border-primary-400 focus:bg-white" placeholder="0"
                                                                />
                                                            ) : (
                                                                <span className="px-2 py-1 text-sm">
                                                                    {formatValue(value, col.format, progress) || '-'}
                                                                </span>
                                                            )}
                                                            {progress !== null && (
                                                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                                                    progress >= 100 ? 'bg-emerald-100 text-emerald-700' : 
                                                                    progress >= 80 ? 'bg-blue-100 text-blue-700' : 
                                                                    progress >= 50 ? 'bg-amber-100 text-amber-700' : 
                                                                    'bg-red-100 text-red-700'
                                                                }`}>
                                                                    {progress}%
                                                                </span>
                                                            )}
                                                        </div>
                                                        <input
                                                            type="text" value={row.comments?.[col.id] || ''} onChange={(e) => onCommentChange(row.id, col.id, e.target.value)}
                                                            className="w-full px-2 py-0.5 mt-1 text-xs text-gray-500 bg-transparent border-none focus:ring-0" placeholder={t.comment}
                                                        />
                                                    </div>
                                                </td>
                                            );
                                        })}
                                        {editable && (
                                            <td><button onClick={() => onDeleteRow(row.id)} className="btn btn-ghost btn-icon"><Icons.Trash className="w-4 h-4 text-gray-400" /></button></td>
                                        )}
                                    </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // ==================== AI ANALYSIS (INTERACTIVE CHAT) ====================
        const AIAnalysis = ({ columns, rows, targetRow, aiSettings, language, onSaveAnalysis, savedAnalyses, onUpdateAiSettings, t }) => {
            const toast = useToast();
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [period, setPeriod] = useState(5);
            const [additionalFocus, setAdditionalFocus] = useState('');
            const [showHistory, setShowHistory] = useState(false);
            
            // Chat state
            const [step, setStep] = useState(0); // 0=start, 1=bottleneck, 2=solutions, 3=plan, 4=orders
            const [messages, setMessages] = useState([]);
            const [analysisData, setAnalysisData] = useState(null);
            const [selectedSolution, setSelectedSolution] = useState(null);
            const [customSolution, setCustomSolution] = useState('');
            const [showCustomInput, setShowCustomInput] = useState(false);
            const [orders, setOrders] = useState([]); // Розпорядження
            const [currentPlan, setCurrentPlan] = useState(''); // Зберігаємо план для генерації розпоряджень
            const chatEndRef = React.useRef(null);
            
            // Scroll to bottom on new messages
            React.useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);
            
            const WORKER_URL = 'https://openai-proxy.management-talco.workers.dev/';
            
            const getColumnsInfo = () => {
                const periodLabels = {
                    'daily': 'щоденно',
                    'weekly': 'щотижня',
                    'monthly': 'щомісяця',
                    'custom': 'довільно'
                };
                const formatLabels = {
                    'number': 'число',
                    'percent': 'відсотки (%)',
                    'uah': 'гривні (₴)',
                    'usd': 'долари ($)',
                    'eur': 'євро (€)'
                };
                const importanceLabels = {
                    'critical': 'КРИТИЧНИЙ (впливає на гроші)',
                    'high': 'Високий',
                    'medium': 'Середній',
                    'low': 'Низький (допоміжний)'
                };
                return columns.map(col => ({
                    name: col.name,
                    period: periodLabels[col.period] || col.period,
                    periodType: col.period === 'monthly' ? 'monthly' : 'weekly',
                    responsible: col.responsible || 'не вказано',
                    format: formatLabels[col.format] || 'число',
                    formatType: col.format || 'number',
                    importance: col.importance || 'medium',
                    importanceLabel: importanceLabels[col.importance] || 'Середній'
                }));
            };
            
            const formatValueForAI = (value, format) => {
                if (!value || value === '-') return '-';
                const num = parseFloat(String(value).replace(',', '.').replace(/\s/g, ''));
                if (isNaN(num)) return value;
                
                const formatted = new Intl.NumberFormat('uk-UA').format(num);
                switch (format) {
                    case 'percent': return `${formatted}%`;
                    case 'uah': return `${formatted} ₴`;
                    case 'usd': return `$${formatted}`;
                    case 'eur': return `€${formatted}`;
                    default: return formatted;
                }
            };
            
            const formatDateForAI = (date, periodType) => {
                if (!date) return '-';
                if (periodType === 'monthly') {
                    return formatMonthLabel(date); // "Грудень 2024"
                } else {
                    return formatWeekLabel(date); // "09-15.12.24"
                }
            };
            
            const getTableData = () => {
                const weeksAgo = new Date();
                weeksAgo.setDate(weeksAgo.getDate() - (period * 7));
                
                // Розділяємо колонки по періоду
                const weeklyColumns = columns.filter(c => c.period !== 'monthly');
                const monthlyColumns = columns.filter(c => c.period === 'monthly');
                
                // Фільтруємо і сортуємо тижневі рядки
                const weeklyRows = rows
                    .filter(r => !r.isTarget && r.periodType !== 'monthly' && r.date)
                    .filter(r => {
                        const rowDate = new Date(r.date);
                        return !isNaN(rowDate.getTime()) && rowDate >= weeksAgo;
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // Новіші зверху
                
                // Фільтруємо і сортуємо місячні рядки (за останні N місяців)
                const monthsAgo = Math.ceil(period / 4); // Приблизно
                const monthlyRows = rows
                    .filter(r => !r.isTarget && r.periodType === 'monthly' && r.date)
                    .sort((a, b) => b.date.localeCompare(a.date)) // "2024-12" > "2024-11"
                    .slice(0, monthsAgo + 2); // Беремо кілька останніх місяців
                
                // Форматуємо тижневі дані
                const weeklyData = weeklyRows.map(row => {
                    const rowData = { 'Період': formatDateForAI(row.date, 'weekly') };
                    weeklyColumns.forEach(col => {
                        const fact = row.values?.[col.id];
                        const plan = row.targets?.[col.id] || targetRow?.values?.[col.id];
                        const factFormatted = formatValueForAI(fact, col.format);
                        const planFormatted = formatValueForAI(plan, col.format);
                        
                        let diff = '-';
                        if (parseFloat(fact) && parseFloat(plan)) {
                            diff = Math.round((parseFloat(fact) / parseFloat(plan)) * 100) + '%';
                        }
                        
                        rowData[col.name] = `${factFormatted} (план: ${planFormatted}, виконання: ${diff})`;
                    });
                    return rowData;
                });
                
                // Форматуємо місячні дані
                const monthlyData = monthlyRows.map(row => {
                    const rowData = { 'Період': formatDateForAI(row.date, 'monthly') };
                    monthlyColumns.forEach(col => {
                        const fact = row.values?.[col.id];
                        const plan = row.targets?.[col.id] || targetRow?.values?.[col.id];
                        const factFormatted = formatValueForAI(fact, col.format);
                        const planFormatted = formatValueForAI(plan, col.format);
                        
                        let diff = '-';
                        if (parseFloat(fact) && parseFloat(plan)) {
                            diff = Math.round((parseFloat(fact) / parseFloat(plan)) * 100) + '%';
                        }
                        
                        rowData[col.name] = `${factFormatted} (план: ${planFormatted}, виконання: ${diff})`;
                    });
                    return rowData;
                });
                
                return {
                    weekly: { columns: weeklyColumns, data: weeklyData, rows: weeklyRows },
                    monthly: { columns: monthlyColumns, data: monthlyData, rows: monthlyRows }
                };
            };

            // === НОВЕ: Аналіз трендів та червоних прапорців ===
            const analyzeMetrics = (tableData) => {
                const results = {
                    weekly: [],
                    monthly: [],
                    redFlags: [],
                    periodComparison: []
                };
                
                const parseNum = (val) => {
                    if (!val) return null;
                    const num = parseFloat(String(val).replace(',', '.').replace(/\s/g, ''));
                    return isNaN(num) ? null : num;
                };
                
                // Аналіз тижневих показників
                tableData.weekly.columns.forEach(col => {
                    const values = tableData.weekly.rows.map(r => ({
                        date: r.date,
                        dateLabel: formatDateForAI(r.date, 'weekly'),
                        fact: parseNum(r.values?.[col.id]),
                        plan: parseNum(r.targets?.[col.id]) || parseNum(targetRow?.values?.[col.id])
                    })).filter(v => v.fact !== null);
                    
                    if (values.length < 2) return;
                    
                    // Розрахунки
                    const facts = values.map(v => v.fact);
                    const latest = facts[0];
                    const previous = facts[1];
                    const oldest = facts[facts.length - 1];
                    const avg = facts.reduce((a, b) => a + b, 0) / facts.length;
                    const min = Math.min(...facts);
                    const max = Math.max(...facts);
                    
                    // Тренд (останній vs попередній) - захист від ділення на 0
                    const weekChange = (previous && previous !== 0) 
                        ? Math.round((latest - previous) / previous * 100) 
                        : 0;
                    
                    // Тренд за весь період - захист від ділення на 0
                    const periodChange = (oldest && oldest !== 0) 
                        ? Math.round((latest - oldest) / oldest * 100) 
                        : 0;
                    
                    // Напрямок тренду (падає 3+ рази поспіль?)
                    let consecutiveDrops = 0;
                    for (let i = 0; i < facts.length - 1; i++) {
                        if (facts[i] < facts[i + 1]) consecutiveDrops++;
                        else break;
                    }
                    
                    // Виконання плану - захист від ділення на 0
                    const planExecutions = values
                        .filter(v => v.plan && v.plan !== 0)
                        .map(v => Math.round(v.fact / v.plan * 100));
                    const avgPlanExecution = planExecutions.length 
                        ? Math.round(planExecutions.reduce((a, b) => a + b, 0) / planExecutions.length)
                        : null;
                    const latestPlanExecution = (values[0]?.plan && values[0].plan !== 0)
                        ? Math.round(values[0].fact / values[0].plan * 100)
                        : null;
                    
                    // Визначення напрямку
                    let direction = 'стабільно';
                    if (periodChange > 10) direction = 'зростає';
                    else if (periodChange < -10) direction = 'падає';
                    
                    const metric = {
                        name: col.name,
                        responsible: col.responsible || 'не вказано',
                        format: col.format,
                        importance: col.importance || 'medium',
                        latest: { value: latest, date: values[0]?.dateLabel },
                        previous: { value: previous, date: values[1]?.dateLabel },
                        weekChange: weekChange,
                        periodChange: periodChange,
                        direction: direction,
                        avg: Math.round(avg * 10) / 10,
                        min: { value: min, date: values.find(v => v.fact === min)?.dateLabel },
                        max: { value: max, date: values.find(v => v.fact === max)?.dateLabel },
                        avgPlanExecution: avgPlanExecution,
                        latestPlanExecution: latestPlanExecution,
                        consecutiveDrops: consecutiveDrops
                    };
                    
                    results.weekly.push(metric);
                    
                    // === ЧЕРВОНІ ПРАПОРЦІ (з урахуванням importance) ===
                    const importanceMultiplier = { critical: 4, high: 3, medium: 2, low: 1 };
                    const colImportance = col.importance || 'medium';
                    
                    // 1. Падає 3+ періоди поспіль
                    if (consecutiveDrops >= 3) {
                        results.redFlags.push({
                            type: 'consecutive_drop',
                            severity: 'high',
                            importance: colImportance,
                            importanceScore: importanceMultiplier[colImportance] * 3,
                            metric: col.name,
                            message: `${col.name}: падає ${consecutiveDrops} тижні поспіль`,
                            details: `${formatValueForAI(oldest, col.format)} → ${formatValueForAI(latest, col.format)} (${periodChange > 0 ? '+' : ''}${periodChange}%)`
                        });
                    }
                    
                    // 2. Виконання плану < 70%
                    if (latestPlanExecution !== null && latestPlanExecution < 70) {
                        const sev = latestPlanExecution < 50 ? 'critical' : 'high';
                        results.redFlags.push({
                            type: 'low_execution',
                            severity: sev,
                            importance: colImportance,
                            importanceScore: importanceMultiplier[colImportance] * (sev === 'critical' ? 4 : 3),
                            metric: col.name,
                            message: `${col.name}: виконання плану лише ${latestPlanExecution}%`,
                            details: `Факт: ${formatValueForAI(latest, col.format)}, План: ${formatValueForAI(values[0]?.plan, col.format)}`
                        });
                    }
                    
                    // 3. Різке падіння (>20% за тиждень)
                    if (weekChange < -20) {
                        const sev = weekChange < -30 ? 'critical' : 'high';
                        results.redFlags.push({
                            type: 'sharp_drop',
                            severity: sev,
                            importance: colImportance,
                            importanceScore: importanceMultiplier[colImportance] * (sev === 'critical' ? 4 : 3),
                            metric: col.name,
                            message: `${col.name}: різке падіння ${weekChange}% за тиждень`,
                            details: `${values[1]?.dateLabel}: ${formatValueForAI(previous, col.format)} → ${values[0]?.dateLabel}: ${formatValueForAI(latest, col.format)}`
                        });
                    }
                    
                    // 4. Значення нижче мінімуму (за винятком останнього)
                    const prevMin = Math.min(...facts.slice(1));
                    if (latest < prevMin && facts.length > 2) {
                        results.redFlags.push({
                            type: 'new_minimum',
                            severity: 'medium',
                            importance: colImportance,
                            importanceScore: importanceMultiplier[colImportance] * 2,
                            metric: col.name,
                            message: `${col.name}: новий мінімум за період`,
                            details: `${formatValueForAI(latest, col.format)} — найнижче значення за ${facts.length} тижнів`
                        });
                    }
                    
                    // === ПОРІВНЯННЯ ПЕРІОДІВ ===
                    results.periodComparison.push({
                        metric: col.name,
                        type: 'weekly',
                        importance: colImportance,
                        current: { 
                            period: values[0]?.dateLabel, 
                            value: formatValueForAI(latest, col.format),
                            planExecution: latestPlanExecution ? `${latestPlanExecution}%` : '-'
                        },
                        previous: {
                            period: values[1]?.dateLabel,
                            value: formatValueForAI(previous, col.format),
                            planExecution: (values[1]?.plan && values[1].plan !== 0) ? `${Math.round(previous / values[1].plan * 100)}%` : '-'
                        },
                        change: `${weekChange > 0 ? '+' : ''}${weekChange}%`,
                        trend: weekChange > 5 ? 'up' : weekChange < -5 ? 'down' : 'stable'
                    });
                });
                
                // Аналіз місячних показників (аналогічно)
                tableData.monthly.columns.forEach(col => {
                    const values = tableData.monthly.rows.map(r => ({
                        date: r.date,
                        dateLabel: formatDateForAI(r.date, 'monthly'),
                        fact: parseNum(r.values?.[col.id]),
                        plan: parseNum(r.targets?.[col.id]) || parseNum(targetRow?.values?.[col.id])
                    })).filter(v => v.fact !== null);
                    
                    if (values.length < 2) return;
                    
                    const facts = values.map(v => v.fact);
                    const latest = facts[0];
                    const previous = facts[1];
                    const avg = facts.reduce((a, b) => a + b, 0) / facts.length;
                    
                    // Захист від ділення на 0
                    const monthChange = (previous && previous !== 0) 
                        ? Math.round((latest - previous) / previous * 100) 
                        : 0;
                    const latestPlanExecution = (values[0]?.plan && values[0].plan !== 0)
                        ? Math.round(values[0].fact / values[0].plan * 100)
                        : null;
                    
                    let direction = 'стабільно';
                    if (monthChange > 10) direction = 'зростає';
                    else if (monthChange < -10) direction = 'падає';
                    
                    const metric = {
                        name: col.name,
                        responsible: col.responsible || 'не вказано',
                        format: col.format,
                        importance: col.importance || 'medium',
                        latest: { value: latest, date: values[0]?.dateLabel },
                        previous: { value: previous, date: values[1]?.dateLabel },
                        monthChange: monthChange,
                        direction: direction,
                        avg: Math.round(avg * 10) / 10,
                        latestPlanExecution: latestPlanExecution
                    };
                    
                    results.monthly.push(metric);
                    
                    // Червоні прапорці для місячних (з importance)
                    const importanceMultiplier = { critical: 4, high: 3, medium: 2, low: 1 };
                    const colImportance = col.importance || 'medium';
                    
                    if (latestPlanExecution !== null && latestPlanExecution < 70) {
                        const sev = latestPlanExecution < 50 ? 'critical' : 'high';
                        results.redFlags.push({
                            type: 'low_execution',
                            severity: sev,
                            importance: colImportance,
                            importanceScore: importanceMultiplier[colImportance] * (sev === 'critical' ? 4 : 3),
                            metric: col.name,
                            message: `${col.name}: виконання плану лише ${latestPlanExecution}%`,
                            details: `Факт: ${formatValueForAI(latest, col.format)}, План: ${formatValueForAI(values[0]?.plan, col.format)}`
                        });
                    }
                    
                    if (monthChange < -15) {
                        const sev = monthChange < -25 ? 'critical' : 'high';
                        results.redFlags.push({
                            type: 'monthly_drop',
                            severity: sev,
                            importance: colImportance,
                            importanceScore: importanceMultiplier[colImportance] * (sev === 'critical' ? 4 : 3),
                            metric: col.name,
                            message: `${col.name}: падіння ${monthChange}% за місяць`,
                            details: `${values[1]?.dateLabel}: ${formatValueForAI(previous, col.format)} → ${values[0]?.dateLabel}: ${formatValueForAI(latest, col.format)}`
                        });
                    }
                    
                    results.periodComparison.push({
                        metric: col.name,
                        type: 'monthly',
                        importance: colImportance,
                        current: { 
                            period: values[0]?.dateLabel, 
                            value: formatValueForAI(latest, col.format),
                            planExecution: latestPlanExecution ? `${latestPlanExecution}%` : '-'
                        },
                        previous: {
                            period: values[1]?.dateLabel,
                            value: formatValueForAI(previous, col.format),
                            planExecution: (values[1]?.plan && values[1].plan !== 0) ? `${Math.round(previous / values[1].plan * 100)}%` : '-'
                        },
                        change: `${monthChange > 0 ? '+' : ''}${monthChange}%`,
                        trend: monthChange > 5 ? 'up' : monthChange < -5 ? 'down' : 'stable'
                    });
                });
                
                // Сортуємо червоні прапорці по importanceScore (більший = важливіший)
                results.redFlags.sort((a, b) => (b.importanceScore || 0) - (a.importanceScore || 0));
                
                return results;
            };
            
            // === ДЕТЕКЦІЯ ОБМЕЖЕНЬ АНАЛІЗУ ===
            const detectLimitations = (tableData, analysis) => {
                const limitations = [];
                const now = new Date();
                const currentMonth = now.getMonth();
                
                // 1. Сезонність
                const seasonalMonths = [11, 0, 6, 7]; // Грудень, Січень, Липень, Серпень
                if (seasonalMonths.includes(currentMonth)) {
                    const monthNames = { 11: 'грудень', 0: 'січень', 6: 'липень', 7: 'серпень' };
                    limitations.push({
                        type: 'seasonality',
                        iconName: 'Calendar',
                        title: 'Можлива сезонність',
                        description: `${monthNames[currentMonth].charAt(0).toUpperCase() + monthNames[currentMonth].slice(1)} — це сезонний місяць. Падіння може бути нормою для цього періоду.`,
                        question: 'Чи є у вас сезонний бізнес?',
                        action: 'check_seasonality'
                    });
                }
                
                // 2. Свята
                const holidays = [
                    { month: 11, days: [24, 25, 31], name: 'Новорічні свята' },
                    { month: 0, days: [1, 7], name: 'Новорічні/Різдво' },
                    { month: 2, days: [8], name: '8 Березня' },
                    { month: 4, days: [1, 9], name: 'Травневі свята' },
                    { month: 7, days: [24], name: 'День Незалежності' }
                ];
                const today = now.getDate();
                const nearHoliday = holidays.find(h => h.month === currentMonth && h.days.some(d => Math.abs(d - today) <= 7));
                if (nearHoliday) {
                    limitations.push({
                        type: 'holidays',
                        iconName: 'Gift',
                        title: 'Період свят',
                        description: `Зараз ${nearHoliday.name}. Активність клієнтів може бути нижчою.`,
                        question: 'Чи впливають свята на ваш бізнес?',
                        action: 'check_holidays'
                    });
                }
                
                // 3. Мало даних
                const weeklyCount = tableData.weekly?.rows?.length || 0;
                const monthlyCount = tableData.monthly?.rows?.length || 0;
                if (weeklyCount < 6 && weeklyCount > 0) {
                    limitations.push({
                        type: 'insufficient_data',
                        iconName: 'BarChart',
                        title: 'Мало тижневих даних',
                        description: `Лише ${weeklyCount} тижнів. Для точного аналізу трендів потрібно 6-8 тижнів.`,
                        question: 'Чи потрібен аналіз з такою вибіркою?',
                        action: 'proceed_anyway'
                    });
                }
                if (monthlyCount < 3 && monthlyCount > 0) {
                    limitations.push({
                        type: 'insufficient_monthly',
                        iconName: 'BarChart',
                        title: 'Мало місячних даних',
                        description: `Лише ${monthlyCount} місяці. Для аналізу трендів потрібно 3+ місяці.`,
                        question: 'Чи достатньо цих даних?',
                        action: 'proceed_anyway'
                    });
                }
                
                // 4. Пропущені значення
                let missingValues = 0;
                tableData.weekly?.rows?.forEach(row => {
                    tableData.weekly?.columns?.forEach(col => {
                        if (!row.values?.[col.id]) missingValues++;
                    });
                });
                if (missingValues > 3) {
                    limitations.push({
                        type: 'missing_values',
                        iconName: 'AlertTriangle',
                        title: 'Пропущені значення',
                        description: `${missingValues} значень не заповнені. Це може спотворити аналіз.`,
                        question: 'Продовжити з неповними даними?',
                        action: 'proceed_anyway'
                    });
                }
                
                // 5. Зовнішні фактори (якщо є валютні показники)
                const hasCurrency = tableData.weekly?.columns?.some(c => c.format === 'usd' || c.format === 'eur') ||
                                    tableData.monthly?.columns?.some(c => c.format === 'usd' || c.format === 'eur');
                if (hasCurrency) {
                    limitations.push({
                        type: 'currency',
                        iconName: 'DollarSign',
                        title: 'Валютні показники',
                        description: 'Є показники в іноземній валюті. Курс міг вплинути на результати.',
                        question: 'Врахувати зміни курсу?',
                        action: 'check_currency'
                    });
                }
                
                // 6. Аномалії (різкі стрибки)
                const anomalies = analysis.redFlags?.filter(f => f.type === 'sharp_drop' && Math.abs(parseInt(f.message.match(/-?\d+/)?.[0] || 0)) > 40);
                if (anomalies?.length > 0) {
                    limitations.push({
                        type: 'anomaly',
                        iconName: 'Search',
                        title: 'Аномальні дані',
                        description: `Є різкі зміни >40%. Це може бути помилка введення або реальна подія.`,
                        question: 'Перевірити коректність даних?',
                        action: 'check_anomaly'
                    });
                }
                
                return limitations;
            };
            
            const callAI = async (prompt) => {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.choices[0].message.content;
            };
            
            const addMessage = (type, content, buttons = null) => {
                setMessages(prev => [...prev, { type, content, buttons, time: new Date() }]);
            };
            
            // ЕТАП 1: Визначення вузького місця
            const startAnalysis = async () => {
                if (!aiSettings.businessContext) {
                    toast.warning('Заповніть контекст бізнесу');
                    return;
                }
                
                if (rows.filter(r => !r.isTarget).length < 2) {
                    toast.warning('Додайте більше даних (мінімум 2 записи)');
                    return;
                }
                
                setStep(1);
                setMessages([]);
                setIsAnalyzing(true);
                
                addMessage('system', 'Аналізую ваші дані... Це займе 1-2 хвилини.');
                
                const tableData = getTableData();
                const columnsInfo = getColumnsInfo();
                const analysis = analyzeMetrics(tableData);
                setAnalysisData({ tableData, analysis });
                
                // === ФОРМУЄМО БЛОК ТРЕНДІВ ===
                let trendsBlock = '';
                
                if (analysis.weekly.length > 0) {
                    trendsBlock += '\n### ТИЖНЕВІ ПОКАЗНИКИ — ТРЕНДИ:\n';
                    analysis.weekly.forEach(m => {
                        const arrow = m.direction === 'зростає' ? '↑' : m.direction === 'падає' ? '↓' : '→';
                        trendsBlock += `\n**${m.name}** (відповідальний: ${m.responsible}):\n`;
                        trendsBlock += `- Останній тиждень (${m.latest.date}): ${formatValueForAI(m.latest.value, m.format)}\n`;
                        trendsBlock += `- Попередній (${m.previous.date}): ${formatValueForAI(m.previous.value, m.format)}\n`;
                        trendsBlock += `- Зміна за тиждень: ${m.weekChange > 0 ? '+' : ''}${m.weekChange}% ${arrow}\n`;
                        trendsBlock += `- Тренд за період: ${m.direction} (${m.periodChange > 0 ? '+' : ''}${m.periodChange}%)\n`;
                        trendsBlock += `- Середнє: ${formatValueForAI(m.avg, m.format)}, Мін: ${formatValueForAI(m.min.value, m.format)} (${m.min.date}), Макс: ${formatValueForAI(m.max.value, m.format)} (${m.max.date})\n`;
                        if (m.latestPlanExecution) {
                            trendsBlock += `- Виконання плану: ${m.latestPlanExecution}% (середнє: ${m.avgPlanExecution}%)\n`;
                        }
                    });
                }
                
                if (analysis.monthly.length > 0) {
                    trendsBlock += '\n\n### МІСЯЧНІ ПОКАЗНИКИ — ТРЕНДИ:\n';
                    analysis.monthly.forEach(m => {
                        const arrow = m.direction === 'зростає' ? '↑' : m.direction === 'падає' ? '↓' : '→';
                        trendsBlock += `\n**${m.name}** (відповідальний: ${m.responsible}):\n`;
                        trendsBlock += `- Останній місяць (${m.latest.date}): ${formatValueForAI(m.latest.value, m.format)}\n`;
                        trendsBlock += `- Попередній (${m.previous.date}): ${formatValueForAI(m.previous.value, m.format)}\n`;
                        trendsBlock += `- Зміна: ${m.monthChange > 0 ? '+' : ''}${m.monthChange}% ${arrow}\n`;
                        if (m.latestPlanExecution) {
                            trendsBlock += `- Виконання плану: ${m.latestPlanExecution}%\n`;
                        }
                    });
                }
                
                // === ФОРМУЄМО БЛОК ЧЕРВОНИХ ПРАПОРЦІВ ===
                let redFlagsBlock = '';
                if (analysis.redFlags.length > 0) {
                    redFlagsBlock = '\n\n### [!] КРИТИЧНІ ПРОБЛЕМИ (автоматично виявлені):\n';
                    analysis.redFlags.forEach((flag, idx) => {
                        const icon = flag.severity === 'critical' ? '[!!!]' : flag.severity === 'high' ? '[!!]' : '[!]';
                        redFlagsBlock += `${idx + 1}. ${icon} ${flag.message}\n   └ ${flag.details}\n`;
                    });
                }
                
                // === ФОРМУЄМО БЛОК ПОРІВНЯННЯ ===
                let comparisonBlock = '\n\n### ПОРІВНЯННЯ ПЕРІОДІВ:\n';
                comparisonBlock += '| Показник | Важливість | Поточний | Попередній | Зміна |\n';
                comparisonBlock += '|----------|-----------|----------|------------|-------|\n';
                // Сортуємо по важливості
                const importanceOrder = { critical: 0, high: 1, medium: 2, low: 3 };
                const sortedComparison = [...analysis.periodComparison].sort((a, b) => 
                    importanceOrder[a.importance || 'medium'] - importanceOrder[b.importance || 'medium']
                );
                sortedComparison.forEach(c => {
                    const impIcon = { critical: '[КРИТ]', high: '[ВИС]', medium: '[СЕР]', low: '[НИЗ]' }[c.importance || 'medium'];
                    const trendIcon = { up: '[+]', down: '[-]', stable: '[=]' }[c.trend] || '[=]';
                    comparisonBlock += `| ${c.metric} | ${impIcon} | ${c.current.value} (${c.current.planExecution}) | ${c.previous.value} | ${c.change} ${trendIcon} |\n`;
                });
                
                // === ДЕТЕКЦІЯ ОБМЕЖЕНЬ ===
                const limitations = detectLimitations(tableData, analysis);
                
                // === ІСТОРІЯ АНАЛІЗІВ ===
                let historyBlock = '';
                if (savedAnalyses.length > 0) {
                    const lastAnalysis = savedAnalyses[savedAnalyses.length - 1];
                    const lastDate = new Date(lastAnalysis.date).toLocaleDateString('uk-UA');
                    historyBlock = `\n\n### [ІСТОРІЯ] ПОПЕРЕДНІЙ АНАЛІЗ (${lastDate}):\n`;
                    // Витягуємо вузьке місце з попереднього аналізу
                    const prevBottleneck = lastAnalysis.content?.match(/## ВУЗЬКЕ МІСЦЕ: (.+)/)?.[1] || 'не визначено';
                    historyBlock += `Минулого разу виявлено: "${prevBottleneck}"\n`;
                    historyBlock += `Порівняй з поточною ситуацією — чи є прогрес?\n`;
                }
                
                // === БЛОК ВАЖЛИВОСТІ ПОКАЗНИКІВ ===
                let importanceBlock = '\n\n### [$$] ВАЖЛИВІСТЬ ПОКАЗНИКІВ:\n';
                const criticalMetrics = columnsInfo.filter(c => c.importance === 'critical');
                const highMetrics = columnsInfo.filter(c => c.importance === 'high');
                if (criticalMetrics.length > 0) {
                    importanceBlock += `КРИТИЧНІ (впливають на гроші): ${criticalMetrics.map(c => c.name).join(', ')}\n`;
                }
                if (highMetrics.length > 0) {
                    importanceBlock += `ВИСОКІ: ${highMetrics.map(c => c.name).join(', ')}\n`;
                }
                importanceBlock += `\nЗверни БІЛЬШЕ уваги на критичні показники!\n`;
                
                const prompt = `Ти — бізнес-консультант з 10+ років досвіду. На основі ГОТОВОГО аналізу визнач ГОЛОВНЕ вузьке місце.

КОНТЕКСТ БІЗНЕСУ:
${aiSettings.businessContext}

ПРІОРИТЕТИ ВЛАСНИКА:
${aiSettings.priorities || 'Не вказано'}

${additionalFocus ? `ОСОБЛИВИЙ ФОКУС: ${additionalFocus}\n` : ''}
=== ГОТОВИЙ АНАЛІЗ ДАНИХ ===
${importanceBlock}
${redFlagsBlock}
${trendsBlock}
${comparisonBlock}
${historyBlock}

=== ТВОЄ ЗАВДАННЯ ===

На основі готового аналізу вище, визнач ОДНЕ головне вузьке місце.
ПРІОРИТЕТ: показники з важливістю [КРИТ] КРИТИЧНІ важливіші за інші!
Не рахуй тренди сам — вони вже пораховані.

Дай відповідь українською СТРОГО у форматі:

## ВУЗЬКЕ МІСЦЕ: [назва проблеми/функції]

### ФАКТИ (бери з аналізу вище):
- [цифра 1 + період + зміна]
- [цифра 2 + період + зміна]
- [цифра 3 + період + зміна]

### ЧОМУ ЦЕ КРИТИЧНО:
[1-2 речення: як це впливає на бізнес прямо зараз]

### ПРИЧИННО-НАСЛІДКОВИЙ ЗВ'ЯЗОК:
[Ланцюжок: проблема → наслідок 1 → наслідок 2 → втрати]

### ВТРАТИ:
Через це ви втрачаєте приблизно [сума] грн на [період]. Розрахунок: [як порахував].

### ПРОГНОЗ:
Якщо не виправити протягом [термін], то [конкретний наслідок з цифрами].

### САМОПЕРЕВІРКА:
- Достовірність: [чи всі цифри з наданих даних?]
- Логіка: [чи логічний причинно-наслідковий зв'язок?]
- Можливі похибки: [що могло вплинути на аналіз?]

ВАЖЛИВО: Використовуй ТІЛЬКИ цифри з готового аналізу. Не вигадуй і не рахуй сам.`;

                try {
                    let response = await callAI(prompt);
                    
                    // === ВАЛІДАЦІЯ ВІДПОВІДІ ===
                    const hasRequiredSections = response.includes('## ВУЗЬКЕ МІСЦЕ:') && 
                                                 response.includes('### ФАКТИ') && 
                                                 response.includes('### ВТРАТИ');
                    
                    if (!hasRequiredSections) {
                        // Перепитуємо AI
                        addMessage('system', 'Уточнюю формат відповіді...');
                        response = await callAI(`Твоя попередня відповідь була не в правильному форматі. Переформатуй її СТРОГО за шаблоном:

## ВУЗЬКЕ МІСЦЕ: [назва]

### ФАКТИ:
- [факт 1]
- [факт 2]

### ЧОМУ ЦЕ КРИТИЧНО:
[текст]

### ПРИЧИННО-НАСЛІДКОВИЙ ЗВ'ЯЗОК:
[текст]

### ВТРАТИ:
[текст з сумою]

### ПРОГНОЗ:
[текст]

### САМОПЕРЕВІРКА:
- Достовірність: [...]
- Логіка: [...]
- Можливі похибки: [...]

Ось твоя попередня відповідь для переформатування:
${response}`);
                    }
                    
                    addMessage('ai', response);
                    
                    // === ПОКАЗУЄМО ОБМЕЖЕННЯ ===
                    if (limitations.length > 0) {
                        let limitationsText = '\n\n---\n\n**МОЖЛИВІ ОБМЕЖЕННЯ АНАЛІЗУ:**\n';
                        limitations.forEach(l => {
                            limitationsText += `\n[!] **${l.title}**\n${l.description}\n`;
                        });
                        addMessage('warning', limitationsText);
                        
                        // Кнопки для обмежень
                        const limitationButtons = limitations.slice(0, 3).map(l => ({
                            text: l.title,
                            action: l.action,
                            icon: l.iconName || 'AlertCircle'
                        }));
                        limitationButtons.push({ text: 'Все ок, продовжити', action: 'understood', icon: 'CheckCircle' });
                        addMessage('buttons', null, limitationButtons);
                    } else {
                        addMessage('buttons', null, [
                            { text: 'Так, зрозуміло. Що робити?', action: 'understood', icon: 'CheckCircle' },
                            { text: 'Поясни детальніше', action: 'explain_more', icon: 'HelpCircle' },
                            { text: 'Глибший аналіз в ChatGPT', action: 'open_gpt_bottleneck', icon: 'Brain' }
                        ]);
                    }
                } catch (error) {
                    addMessage('error', 'Помилка аналізу: ' + error.message);
                }
                
                setIsAnalyzing(false);
            };
            
            // === ДОДАТКОВИЙ АНАЛІЗ (сезонність, валюта тощо) ===
            const runAdditionalAnalysis = async (type) => {
                setIsAnalyzing(true);
                addMessage('user', `Врахувати: ${type}`);
                addMessage('system', 'Проводжу додатковий аналіз...');
                
                const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
                
                let additionalPrompt = '';
                switch(type) {
                    case 'check_seasonality':
                        additionalPrompt = `Проаналізуй попередній аналіз з урахуванням СЕЗОННОСТІ.
                        
Поточний місяць може бути сезонно низьким. Перерахуй:
1. Чи нормальне падіння для цього періоду?
2. Як виглядали б результати порівняно з цим же періодом минулого року?
3. Скоригуй оцінку втрат з урахуванням сезонності.

Попередній аналіз:
${previousContext}`;
                        break;
                    case 'check_holidays':
                        additionalPrompt = `Проаналізуй попередній аналіз з урахуванням СВЯТКОВОГО ПЕРІОДУ.
                        
Зараз період свят — активність може бути нижчою. Оціни:
1. Наскільки падіння пов'язане зі святами?
2. Чи варто чекати відновлення після свят?
3. Які дії доцільні саме зараз?

Попередній аналіз:
${previousContext}`;
                        break;
                    case 'check_currency':
                        additionalPrompt = `Проаналізуй попередній аналіз з урахуванням КУРСУ ВАЛЮТ.
                        
Є показники в іноземній валюті. Оціни:
1. Як зміна курсу могла вплинути на показники?
2. Чи коректно порівнювати періоди без урахування курсу?
3. Скоригуй висновки якщо потрібно.

Попередній аналіз:
${previousContext}`;
                        break;
                    case 'check_anomaly':
                        additionalPrompt = `Перевір дані на АНОМАЛІЇ та помилки.
                        
Є різкі зміни показників (>40%). Проаналізуй:
1. Чи може це бути помилка введення даних?
2. Чи була конкретна подія що спричинила зміну?
3. Чи потрібно виключити цей період з аналізу?

Попередній аналіз:
${previousContext}`;
                        break;
                    default:
                        additionalPrompt = previousContext;
                }
                
                try {
                    const response = await callAI(additionalPrompt);
                    addMessage('ai', response);
                    addMessage('buttons', null, [
                        { text: 'Зрозуміло. Що робити?', action: 'understood', icon: 'CheckCircle' },
                        { text: 'Продовжити без змін', action: 'understood', icon: 'ArrowRight' }
                    ]);
                } catch (error) {
                    addMessage('error', 'Помилка: ' + error.message);
                }
                
                setIsAnalyzing(false);
            };
            
            // ЕТАП 2: Варіанти рішення
            const showSolutions = async (needMoreExplanation = false) => {
                setStep(2);
                setIsAnalyzing(true);
                
                if (needMoreExplanation) {
                    addMessage('user', 'Поясни детальніше');
                    addMessage('system', 'Готую розгорнуте пояснення...');
                } else {
                    addMessage('user', 'Так, зрозуміло. Що робити?');
                    addMessage('system', 'Готую варіанти рішення...');
                }
                
                const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
                
                const prompt = needMoreExplanation 
                    ? `Поясни детальніше причинно-наслідковий зв'язок вузького місця. Використовуй аналогії та приклади. Покажи як кожен крок впливає на наступний. Не використовуй емоджі.

Попередній аналіз:
${previousContext}

Дай розгорнуте пояснення українською, потім запитай чи зрозуміло.`
                    : `На основі виявленого вузького місця, запропонуй 3 ВАРІАНТИ РІШЕННЯ з ROI аналізом.

Попередній аналіз:
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Дай відповідь українською СТРОГО у форматі (без емоджі):

## ТРИ ВАРІАНТИ РІШЕННЯ

### ВАРІАНТ 1: [Назва]
- Суть: [1 речення]
- Плюси: [2-3 пункти]
- Мінуси: [1-2 пункти]
- Термін: [скільки днів]
- Вартість: [сума грн]
- ROI: вкладаєш [X] → отримуєш [Y] (1:[ratio])

### ВАРІАНТ 2: [Назва]
- Суть: [1 речення]
- Плюси: [2-3 пункти]
- Мінуси: [1-2 пункти]
- Термін: [скільки днів]
- Вартість: [сума грн]
- ROI: вкладаєш [X] → отримуєш [Y] (1:[ratio])

### ВАРІАНТ 3: [Назва]
- Суть: [1 речення]
- Плюси: [2-3 пункти]
- Мінуси: [1-2 пункти]
- Термін: [скільки днів]
- Вартість: [сума грн]
- ROI: вкладаєш [X] → отримуєш [Y] (1:[ratio])

---

### РЕКОМЕНДАЦІЯ:
Варіант [номер], тому що [чому саме цей варіант дає найкращий ROI для вашої ситуації].`;

                try {
                    const response = await callAI(prompt);
                    addMessage('ai', response);
                    
                    if (needMoreExplanation) {
                        addMessage('buttons', null, [
                            { text: 'Тепер зрозуміло. Що робити?', action: 'understood', icon: 'CheckCircle' },
                            { text: 'Ще раз поясни', action: 'explain_more', icon: 'HelpCircle' }
                        ]);
                    } else {
                        addMessage('buttons', null, [
                            { text: 'Варіант 1', action: 'solution_1', icon: 'Circle' },
                            { text: 'Варіант 2', action: 'solution_2', icon: 'Circle' },
                            { text: 'Варіант 3', action: 'solution_3', icon: 'Circle' },
                            { text: 'Рекомендований', action: 'solution_recommended', icon: 'Star' },
                            { text: 'Свій варіант', action: 'custom_solution', icon: 'Edit' }
                        ]);
                    }
                } catch (error) {
                    addMessage('error', 'Помилка: ' + error.message);
                }
                
                setIsAnalyzing(false);
            };
            
            // ЕТАП 3: План дій
            const createPlan = async (solutionNum) => {
                setStep(3);
                setSelectedSolution(solutionNum);
                setIsAnalyzing(true);
                
                const solutionText = solutionNum === 'recommended' ? 'рекомендований варіант' : `варіант ${solutionNum}`;
                addMessage('user', `Обираю ${solutionText}`);
                addMessage('system', 'Складаю програму розширення вузького місця...');
                
                const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
                const columnsInfo = getColumnsInfo();
                
                // Збираємо унікальних відповідальних
                const responsibles = [...new Set(columnsInfo.map(c => c.responsible).filter(r => r && r !== 'не вказано'))];
                
                const prompt = `Склади ПРОГРАМУ РОЗШИРЕННЯ ВУЗЬКОГО МІСЦЯ на основі обраного рішення.

Обрано: ${solutionText}

Попередній контекст (вузьке місце та варіанти):
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Відповідальні за показники:
${columnsInfo.map(c => `- ${c.name}: ${c.responsible}`).join('\n')}

Доступні виконавці: ${responsibles.length > 0 ? responsibles.join(', ') : 'Власник'}

Дай відповідь українською СТРОГО у такому форматі:

## ПРОГРАМА РОЗШИРЕННЯ ВУЗЬКОГО МІСЦЯ

### ВХІД:
- Вузьке місце: [назва функції/процесу]
- Зараз: [поточна метрика з даних]
- Ціль: [цільова метрика]

### ДІАГНОЗ
- Корінь: [1 речення — чому виникло вузьке місце]
- Блокер: [що конкретно заважає зараз]

### ПРОГРАМА

**Першочергові** (без них не рухаємось):
1. [Завдання] → Хто: [імя з виконавців] → Коли: день 1-2 → Готово коли: [критерій]
2. [Завдання] → Хто: [імя з виконавців] → Коли: день 2-3 → Готово коли: [критерій]

**Життєво важливі** (усунути блокери):
3. [Завдання] → Хто: [імя з виконавців] → Коли: день 3-5 → Готово коли: [критерій]
4. [Завдання] → Хто: [імя з виконавців] → Коли: день 4-6 → Готово коли: [критерій]

**Робочі** (конкретні кроки):
5. [Завдання] → Хто: [імя з виконавців] → Коли: день 5-7 → Готово коли: [критерій]
6. [Завдання] → Хто: [імя з виконавців] → Коли: день 6-8 → Готово коли: [критерій]

**Виробничі** (вимірюваний результат):
7. [Кількість + що зробити] → Хто: [імя з виконавців] → Коли: день 7-10 → Готово коли: [число]

### КОНТРОЛЬ
- Перевірка: день 10
- Успіх: [було X] → [стало Y]
- Якщо ні: [конкретна дія]

ПРАВИЛА яких дотримуйся:
- Призначай завдання ТІЛЬКИ людям з "Доступні виконавці"
- Першочергові завжди перші
- 1 завдання = 1 дія, 1 людина, 1 дедлайн
- Без "Готово коли" — завдання неповне
- Максимум 7-10 завдань
- Дедлайни в днях від старту`;

                try {
                    const response = await callAI(prompt);
                    setCurrentPlan(response); // Зберігаємо план
                    addMessage('ai', response);
                    addMessage('buttons', null, [
                        { text: 'Сформувати розпорядження', action: 'generate_orders', icon: 'FileText' },
                        { text: 'Зберегти план', action: 'save', icon: 'Save' },
                        { text: 'Скопіювати', action: 'copy', icon: 'Copy' },
                        { text: 'Почати спочатку', action: 'restart', icon: 'RefreshCw' }
                    ]);
                } catch (error) {
                    addMessage('error', 'Помилка: ' + error.message);
                }
                
                setIsAnalyzing(false);
            };
            
            // ЕТАП 3 (власний варіант): План дій для custom solution
            const createCustomPlan = async (customText) => {
                setStep(3);
                setSelectedSolution('custom');
                setIsAnalyzing(true);
                
                addMessage('user', `Мій варіант: ${customText}`);
                addMessage('system', 'Аналізую ваш варіант та складаю програму...');
                
                const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
                const columnsInfo = getColumnsInfo();
                const responsibles = [...new Set(columnsInfo.map(c => c.responsible).filter(r => r && r !== 'не вказано'))];
                
                const prompt = `Користувач запропонував ВЛАСНИЙ ВАРІАНТ рішення. Спочатку оціни його, потім склади програму.

ВАРІАНТ КОРИСТУВАЧА:
${customText}

Попередній контекст (вузьке місце):
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Доступні виконавці: ${responsibles.length > 0 ? responsibles.join(', ') : 'Власник'}

Дай відповідь українською СТРОГО у такому форматі:

## ОЦІНКА ВАШОГО ВАРІАНТУ

### Сильні сторони:
- [пункт 1]
- [пункт 2]

### Можливі ризики:
- [пункт 1]
- [пункт 2]

### Рекомендація:
[як покращити або на що звернути увагу]

---

## ПРОГРАМА РОЗШИРЕННЯ ВУЗЬКОГО МІСЦЯ

### ВХІД:
- Вузьке місце: [назва функції/процесу]
- Зараз: [поточна метрика]
- Ціль: [цільова метрика]

### ДІАГНОЗ
- Корінь: [1 речення — чому виникло вузьке місце]
- Блокер: [що конкретно заважає зараз]

### ПРОГРАМА

**Першочергові** (без них не рухаємось):
1. [Завдання] → Хто: [імя з виконавців] → Коли: день 1-2 → Готово коли: [критерій]
2. [Завдання] → Хто: [імя з виконавців] → Коли: день 2-3 → Готово коли: [критерій]

**Життєво важливі** (усунути блокери):
3. [Завдання] → Хто: [імя з виконавців] → Коли: день 3-5 → Готово коли: [критерій]

**Робочі** (конкретні кроки):
4. [Завдання] → Хто: [імя з виконавців] → Коли: день 5-7 → Готово коли: [критерій]
5. [Завдання] → Хто: [імя з виконавців] → Коли: день 6-8 → Готово коли: [критерій]

**Виробничі** (вимірюваний результат):
6. [Кількість + що зробити] → Хто: [імя з виконавців] → Коли: день 7-10 → Готово коли: [число]

### КОНТРОЛЬ
- Перевірка: день 10
- Успіх: [було X] → [стало Y]
- Якщо ні: [конкретна дія]

ПРАВИЛО: Призначай завдання ТІЛЬКИ людям з "Доступні виконавці".`;

                try {
                    const response = await callAI(prompt);
                    setCurrentPlan(response); // Зберігаємо план
                    addMessage('ai', response);
                    addMessage('buttons', null, [
                        { text: 'Сформувати розпорядження', action: 'generate_orders', icon: 'FileText' },
                        { text: 'Зберегти план', action: 'save', icon: 'Save' },
                        { text: 'Скопіювати', action: 'copy', icon: 'Copy' },
                        { text: 'Почати спочатку', action: 'restart', icon: 'RefreshCw' }
                    ]);
                } catch (error) {
                    addMessage('error', 'Помилка: ' + error.message);
                }
                
                setIsAnalyzing(false);
                setCustomSolution('');
            };
            
            // ЕТАП 4: Генерація розпоряджень
            const generateOrders = async () => {
                setStep(4);
                setIsAnalyzing(true);
                setOrders([]);
                
                addMessage('user', 'Сформувати розпорядження');
                addMessage('system', 'Генерую розпорядження для кожного завдання...');
                
                const today = new Date();
                const formatDate = (daysFromNow) => {
                    const d = new Date(today);
                    d.setDate(d.getDate() + daysFromNow);
                    return d.toLocaleDateString('uk-UA');
                };
                
                const prompt = `На основі програми дій, сформуй РОЗПОРЯДЖЕННЯ для кожного завдання у форматі TALKO System.

ПРОГРАМА:
${currentPlan}

КОНТЕКСТ БІЗНЕСУ:
${aiSettings.businessContext}

Сьогоднішня дата: ${today.toLocaleDateString('uk-UA')}

Для КОЖНОГО завдання з програми створи окреме розпорядження у форматі:

---РОЗПОРЯДЖЕННЯ---
КОМУ: [Посада відповідального]
ДАТА: [дата створення - сьогодні]
ВІД КОГО: [Власник/Керівник]
НОМЕР: [порядковий номер]
ТЕРМІН ВИКОНАННЯ: [конкретна дата на основі "день X" з програми]

ДЛЯ ІНФОРМАЦІЇ:
[Коротке пояснення контексту - 1-2 речення чому це важливо]

ЗАВДАННЯ:
1. [Конкретна дія з результатом]
2. [Додаткова дія якщо потрібно]

ОЧІКУВАНИЙ ПРОДУКТ:
- [Що має бути готовим]
- [Кому передається результат]

ЗВІТ ПРО ВИКОНАННЯ:
[Коли, як і кому звітувати]

ПІДПИС: Керівник
---КІНЕЦЬ---

Створи розпорядження для КОЖНОГО завдання з програми (зазвичай 5-10 розпоряджень).
Розділяй розпорядження маркером ---РОЗПОРЯДЖЕННЯ--- та ---КІНЕЦЬ---`;

                try {
                    const response = await callAI(prompt);
                    
                    // Парсимо розпорядження
                    const orderTexts = response.split('---РОЗПОРЯДЖЕННЯ---').filter(t => t.trim());
                    const parsedOrders = orderTexts.map((text, idx) => {
                        const cleanText = text.replace('---КІНЕЦЬ---', '').trim();
                        
                        // Парсимо поля
                        const getField = (name) => {
                            const match = cleanText.match(new RegExp(`${name}:\\s*(.+?)(?=\\n[А-ЯІЇЄҐA-Z]|\\n\\n|$)`, 's'));
                            return match ? match[1].trim() : '';
                        };
                        
                        return {
                            id: idx + 1,
                            to: getField('КОМУ'),
                            date: getField('ДАТА') || today.toLocaleDateString('uk-UA'),
                            from: getField('ВІД КОГО') || 'Керівник',
                            number: getField('НОМЕР') || String(idx + 1),
                            deadline: getField('ТЕРМІН ВИКОНАННЯ'),
                            info: getField('ДЛЯ ІНФОРМАЦІЇ'),
                            tasks: getField('ЗАВДАННЯ'),
                            result: getField('ОЧІКУВАНИЙ ПРОДУКТ'),
                            report: getField('ЗВІТ ПРО ВИКОНАННЯ'),
                            fullText: cleanText
                        };
                    });
                    
                    setOrders(parsedOrders);
                    addMessage('ai', `Сформовано ${parsedOrders.length} розпоряджень. Ви можете переглянути кожне та вивантажити в Excel.`);
                    addMessage('orders_list', null);
                    addMessage('buttons', null, [
                        { text: 'Зберегти все', action: 'save', icon: 'Save' },
                        { text: 'Вивантажити в Excel', action: 'export_excel', icon: 'Download' },
                        { text: 'Скопіювати всі', action: 'copy_orders', icon: 'Copy' },
                        { text: 'Почати спочатку', action: 'restart', icon: 'RefreshCw' }
                    ]);
                } catch (error) {
                    addMessage('error', 'Помилка генерації: ' + error.message);
                }
                
                setIsAnalyzing(false);
            };
            
            // Експорт в Excel
            const exportOrdersToCSV = (ordersData) => {
                const headers = ['№', 'Кому', 'Дата', 'Від кого', 'Термін', 'Для інформації', 'Завдання', 'Очікуваний продукт', 'Звіт'];
                const csvRows = ordersData.map(o => [
                    o.number,
                    o.to,
                    o.date,
                    o.from,
                    o.deadline,
                    (o.info || '').replace(/\n/g, ' '),
                    (o.tasks || '').replace(/\n/g, ' '),
                    (o.result || '').replace(/\n/g, ' '),
                    (o.report || '').replace(/\n/g, ' ')
                ]);
                
                const BOM = '\uFEFF';
                return BOM + [headers, ...csvRows].map(row => 
                    row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(';')
                ).join('\n');
            };
            
            const downloadCSV = (csvContent, filename) => {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                toast.success('Файл завантажено!');
            };
            
            const exportToExcel = () => {
                if (orders.length === 0) {
                    toast.warning('Немає розпоряджень для експорту');
                    return;
                }
                
                const csvContent = exportOrdersToCSV(orders);
                downloadCSV(csvContent, `rozporyadzhennya_${new Date().toISOString().split('T')[0]}.csv`);
            };
            
            // Обробка кнопок
            const handleButton = (action) => {
                switch(action) {
                    case 'understood':
                        showSolutions(false);
                        break;
                    case 'explain_more':
                        showSolutions(true);
                        break;
                    case 'check_seasonality':
                    case 'check_holidays':
                    case 'check_currency':
                    case 'check_anomaly':
                    case 'proceed_anyway':
                        runAdditionalAnalysis(action);
                        break;
                    case 'solution_1':
                        createPlan('1');
                        break;
                    case 'solution_2':
                        createPlan('2');
                        break;
                    case 'solution_3':
                        createPlan('3');
                        break;
                    case 'solution_recommended':
                        createPlan('recommended');
                        break;
                    case 'custom_solution':
                        setShowCustomInput(true);
                        addMessage('system', 'Опишіть ваш варіант рішення:');
                        addMessage('custom_input', null);
                        break;
                    case 'submit_custom':
                        if (customSolution.trim()) {
                            createCustomPlan(customSolution);
                            setShowCustomInput(false);
                        }
                        break;
                    case 'generate_orders':
                        generateOrders();
                        break;
                    case 'export_excel':
                        exportToExcel();
                        break;
                    case 'copy_orders':
                        const allOrdersText = orders.map(o => o.fullText).join('\n\n========================================\n\n');
                        navigator.clipboard.writeText(allOrdersText);
                        toast.success('Всі розпорядження скопійовано!');
                        break;
                    case 'save':
                        const fullText = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n\n---\n\n');
                        onSaveAnalysis({ 
                            text: fullText, 
                            content: fullText,
                            date: new Date().toISOString(), 
                            period,
                            orders: orders.length > 0 ? orders : null
                        });
                        break;
                    case 'copy':
                        const textToCopy = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n\n---\n\n');
                        navigator.clipboard.writeText(textToCopy);
                        toast.success('Скопійовано!');
                        break;
                    case 'restart':
                        setStep(0);
                        setMessages([]);
                        setSelectedSolution(null);
                        setShowCustomInput(false);
                        setCustomSolution('');
                        setOrders([]);
                        setCurrentPlan('');
                        break;
                    case 'open_gpt_bottleneck':
                        window.open(GPT_BOTTLENECK_URL, '_blank');
                        toast.success('Відкрито ChatGPT. Скопіюйте дані з Excel для глибшого аналізу.');
                        break;
                }
            };
            
            // Рендер повідомлення
            const renderMessage = (msg, idx) => {
                if (msg.type === 'buttons') {
                    return (
                        <div key={idx} className="flex flex-wrap gap-2 my-4">
                            {msg.buttons.map((btn, i) => {
                                const IconComponent = btn.icon ? Icons[btn.icon] : null;
                                return (
                                    <button 
                                        key={i} 
                                        onClick={() => handleButton(btn.action)}
                                        disabled={isAnalyzing}
                                        className="btn btn-secondary text-sm flex items-center gap-2"
                                    >
                                        {IconComponent && <IconComponent className="w-4 h-4" />}
                                        {btn.text}
                                    </button>
                                );
                            })}
                        </div>
                    );
                }
                
                if (msg.type === 'custom_input') {
                    return (
                        <div key={idx} className="my-4 p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                            <textarea
                                value={customSolution}
                                onChange={(e) => setCustomSolution(e.target.value)}
                                placeholder="Опишіть ваш варіант рішення... Наприклад: Хочу найняти ще одного менеджера з продажів та налаштувати автоматичну воронку в CRM"
                                className="w-full p-3 border border-amber-300 rounded-xl text-sm resize-none focus:outline-none focus:ring-2 focus:ring-amber-400"
                                rows={4}
                                disabled={isAnalyzing}
                            />
                            <div className="flex gap-2 mt-3">
                                <button 
                                    onClick={() => handleButton('submit_custom')}
                                    disabled={isAnalyzing || !customSolution.trim()}
                                    className="btn btn-primary text-sm flex items-center gap-2"
                                >
                                    {isAnalyzing ? <><Icons.Loader className="w-4 h-4" /> Аналізую...</> : <><Icons.FileText className="w-4 h-4" /> Скласти план</>}
                                </button>
                                <button 
                                    onClick={() => {
                                        setShowCustomInput(false);
                                        setMessages(prev => prev.filter(m => m.type !== 'custom_input' && m.content !== 'Опишіть ваш варіант рішення:'));
                                    }}
                                    disabled={isAnalyzing}
                                    className="btn btn-ghost text-sm"
                                >
                                    Скасувати
                                </button>
                            </div>
                        </div>
                    );
                }
                
                // Рендер списку розпоряджень
                if (msg.type === 'orders_list') {
                    return (
                        <div key={idx} className="my-4 space-y-3">
                            <div className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                <Icons.FileText className="w-4 h-4" />
                                <span>Розпорядження ({orders.length})</span>
                            </div>
                            {orders.map((order, i) => (
                                <details key={i} className="group bg-white border border-gray-200 rounded-xl overflow-hidden">
                                    <summary className="flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                                        <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-primary-600 text-white flex items-center justify-center font-bold text-sm">
                                            {order.number}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <p className="font-medium text-gray-900 truncate">{order.to || 'Відповідальний'}</p>
                                            <p className="text-xs text-gray-500">Термін: {order.deadline || 'Не вказано'}</p>
                                        </div>
                                        <Icons.ChevronDown className="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform" />
                                    </summary>
                                    <div className="p-4 pt-0 border-t border-gray-100 bg-gray-50">
                                        <div className="space-y-3 text-sm">
                                            <div className="grid grid-cols-2 gap-2 text-xs">
                                                <div><span className="text-gray-500">Дата:</span> {order.date}</div>
                                                <div><span className="text-gray-500">Від:</span> {order.from}</div>
                                            </div>
                                            {order.info && (
                                                <div>
                                                    <p className="text-xs font-medium text-gray-500 mb-1">ДЛЯ ІНФОРМАЦІЇ:</p>
                                                    <p className="text-gray-700">{order.info}</p>
                                                </div>
                                            )}
                                            {order.tasks && (
                                                <div>
                                                    <p className="text-xs font-medium text-gray-500 mb-1">ЗАВДАННЯ:</p>
                                                    <p className="text-gray-700 whitespace-pre-wrap">{order.tasks}</p>
                                                </div>
                                            )}
                                            {order.result && (
                                                <div>
                                                    <p className="text-xs font-medium text-gray-500 mb-1">ОЧІКУВАНИЙ ПРОДУКТ:</p>
                                                    <p className="text-gray-700 whitespace-pre-wrap">{order.result}</p>
                                                </div>
                                            )}
                                            {order.report && (
                                                <div>
                                                    <p className="text-xs font-medium text-gray-500 mb-1">ЗВІТ:</p>
                                                    <p className="text-gray-700">{order.report}</p>
                                                </div>
                                            )}
                                            <button 
                                                onClick={() => {
                                                    navigator.clipboard.writeText(order.fullText);
                                                    toast.success(`Розпорядження №${order.number} скопійовано!`);
                                                }}
                                                className="text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1"
                                            >
                                                <Icons.Copy className="w-3 h-3" /> Скопіювати
                                            </button>
                                        </div>
                                    </div>
                                </details>
                            ))}
                        </div>
                    );
                }
                
                const styles = {
                    system: 'bg-blue-50 border-blue-200 text-blue-800',
                    ai: 'bg-gradient-to-br from-purple-50 to-indigo-50 border-purple-200 text-gray-800',
                    user: 'bg-green-50 border-green-200 text-green-800 ml-auto',
                    error: 'bg-red-50 border-red-200 text-red-800',
                    warning: 'bg-amber-50 border-amber-200 text-amber-800'
                };
                
                const typeIcons = {
                    system: Icons.Settings,
                    ai: Icons.Brain,
                    user: Icons.User,
                    error: Icons.AlertCircle,
                    warning: Icons.AlertTriangle
                };
                const TypeIcon = typeIcons[msg.type];
                
                return (
                    <div key={idx} className={`p-4 rounded-2xl border ${styles[msg.type]} animate-fade-in`}>
                        {msg.type === 'system' && <div className="flex items-center gap-2 mb-2"><Icons.Loader className={`w-4 h-4 ${isAnalyzing ? 'animate-spin' : ''}`} /><span className="font-medium text-sm">Система</span></div>}
                        {msg.type === 'ai' && <div className="flex items-center gap-2 mb-2"><Icons.Brain className="w-4 h-4 text-purple-600" /><span className="font-medium text-sm text-purple-700">AI Консультант</span></div>}
                        {msg.type === 'warning' && <div className="flex items-center gap-2 mb-2"><Icons.AlertTriangle className="w-4 h-4 text-amber-600" /><span className="font-medium text-sm text-amber-700">Увага</span></div>}
                        <div className="whitespace-pre-wrap text-sm leading-relaxed">{msg.content}</div>
                    </div>
                );
            };
            
            return (
                <div className="space-y-4">
                    {/* Налаштування (тільки на старті) */}
                    {step === 0 && (
                        <>
                            <div className="flex items-center gap-3 mb-4">
                                <label className="text-sm font-medium text-gray-700">{t.analysisPeriod}:</label>
                                <select value={period} onChange={(e) => setPeriod(Number(e.target.value))} className="select-field w-auto">
                                    <option value={3}>3 {t.lastWeeks}</option>
                                    <option value={5}>5 {t.lastWeeks}</option>
                                    <option value={7}>7 {t.lastWeeks}</option>
                                    <option value={10}>10 {t.lastWeeks}</option>
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.additionalFocus}</label>
                                <input
                                    type="text" value={additionalFocus} onChange={(e) => setAdditionalFocus(e.target.value)}
                                    className="input-field" placeholder={t.additionalFocusPlaceholder}
                                />
                            </div>
                            
                            <div className="flex gap-3">
                                <button onClick={startAnalysis} disabled={isAnalyzing} className="btn btn-ai flex-1">
                                    {isAnalyzing ? <><Icons.Loader className="w-5 h-5" />{t.analyzing}</> : <><Icons.Brain className="w-5 h-5" />{t.runAnalysis}</>}
                                </button>
                                {savedAnalyses?.length > 0 && (
                                    <button onClick={() => setShowHistory(!showHistory)} className="btn btn-secondary">
                                        <Icons.History className="w-5 h-5" />
                                    </button>
                                )}
                            </div>
                            
                            {showHistory && savedAnalyses?.length > 0 && (
                                <div className="space-y-2 p-4 bg-gray-50 rounded-xl">
                                    <h4 className="font-semibold text-gray-700 mb-2">{t.analysisHistory}</h4>
                                    {savedAnalyses.slice(0, 5).map((analysis, i) => (
                                        <details key={i} className="group bg-white rounded-lg overflow-hidden border border-gray-100">
                                            <summary className="p-3 cursor-pointer hover:bg-gray-50 flex items-center gap-2">
                                                <div className="flex-1">
                                                    <div className="text-sm font-medium text-gray-900">{new Date(analysis.date).toLocaleDateString('uk-UA')}</div>
                                                    <div className="text-xs text-gray-500 flex items-center gap-2">
                                                        <span>{analysis.period} тижнів</span>
                                                        {analysis.orders?.length > 0 && (
                                                            <span className="text-primary-600">• {analysis.orders.length} розпоряджень</span>
                                                        )}
                                                    </div>
                                                </div>
                                                <Icons.ChevronDown className="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" />
                                            </summary>
                                            <div className="p-3 pt-0 border-t border-gray-100 bg-gray-50">
                                                <div className="text-xs text-gray-600 whitespace-pre-wrap max-h-40 overflow-y-auto">{analysis.text?.substring(0, 500)}...</div>
                                                {analysis.orders?.length > 0 && (
                                                    <div className="mt-2 flex gap-2">
                                                        <button 
                                                            onClick={() => {
                                                                const csv = exportOrdersToCSV(analysis.orders);
                                                                downloadCSV(csv, `rozporyadzhennya_${new Date(analysis.date).toISOString().split('T')[0]}.csv`);
                                                            }}
                                                            className="text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1"
                                                        >
                                                            <Icons.Download className="w-3 h-3" /> Excel
                                                        </button>
                                                        <button 
                                                            onClick={() => {
                                                                navigator.clipboard.writeText(analysis.orders.map(o => o.fullText).join('\n\n===\n\n'));
                                                                toast.success('Скопійовано!');
                                                            }}
                                                            className="text-xs text-gray-600 hover:text-gray-700 flex items-center gap-1"
                                                        >
                                                            <Icons.Copy className="w-3 h-3" /> Копіювати
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </details>
                                    ))}
                                </div>
                            )}
                            
                            {/* Підказка */}
                            <div className="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl border border-purple-100">
                                <h4 className="font-bold text-purple-900 mb-2 flex items-center gap-2"><Icons.Brain className="w-5 h-5" /> Як працює AI-консультант:</h4>
                                <ol className="text-sm text-purple-800 space-y-1">
                                    <li><strong>1.</strong> Визначаю вузьке місце та поясню причини</li>
                                    <li><strong>2.</strong> Запропоную 3 варіанти рішення з ROI</li>
                                    <li><strong>3.</strong> Складу програму дій з конкретними завданнями</li>
                                    <li><strong>4.</strong> Сформую розпорядження для команди (Excel)</li>
                                </ol>
                                <p className="text-xs text-purple-600 mt-2 flex items-center gap-1"><Icons.Clock className="w-3 h-3" /> Весь процес займає 5-7 хвилин</p>
                            </div>
                        </>
                    )}
                    
                    {/* Чат */}
                    {step > 0 && (
                        <div className="space-y-3 overflow-y-auto pr-2">
                            {/* Progress */}
                            <div className="flex items-center gap-2 p-3 bg-gray-100 rounded-xl sticky top-0 z-10">
                                <div className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${step >= 1 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`}>1</div>
                                <div className={`flex-1 h-1 rounded ${step >= 2 ? 'bg-purple-500' : 'bg-gray-300'}`} />
                                <div className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${step >= 2 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`}>2</div>
                                <div className={`flex-1 h-1 rounded ${step >= 3 ? 'bg-purple-500' : 'bg-gray-300'}`} />
                                <div className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${step >= 3 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`}>3</div>
                                <div className={`flex-1 h-1 rounded ${step >= 4 ? 'bg-purple-500' : 'bg-gray-300'}`} />
                                <div className={`w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold ${step >= 4 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`}>4</div>
                            </div>
                            
                            {/* Messages */}
                            {messages.map((msg, idx) => renderMessage(msg, idx))}
                            
                            {/* Scroll anchor */}
                            <div ref={chatEndRef} />
                        </div>
                    )}
                </div>
            );
        };

        // ==================== PLANS VIEW ====================
        const PlansView = ({ savedAnalyses, onDelete, onExportExcel, toast, t }) => {
            const [expandedPlan, setExpandedPlan] = useState(null);
            const [expandedOrder, setExpandedOrder] = useState(null);
            
            const exportOrdersToCSV = (ordersData) => {
                const headers = ['№', 'Кому', 'Дата', 'Від кого', 'Термін', 'Для інформації', 'Завдання', 'Очікуваний продукт', 'Звіт'];
                const csvRows = ordersData.map(o => [
                    o.number, o.to, o.date, o.from, o.deadline,
                    (o.info || '').replace(/\n/g, ' '),
                    (o.tasks || '').replace(/\n/g, ' '),
                    (o.result || '').replace(/\n/g, ' '),
                    (o.report || '').replace(/\n/g, ' ')
                ]);
                const BOM = '\uFEFF';
                return BOM + [headers, ...csvRows].map(row => 
                    row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(';')
                ).join('\n');
            };
            
            const downloadCSV = (csvContent, filename) => {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                toast.success('Файл завантажено!');
            };
            
            if (!savedAnalyses?.length) {
                return (
                    <div className="text-center py-16">
                        <div className="w-20 h-20 mx-auto mb-6 rounded-3xl bg-gradient-to-br from-purple-100 to-indigo-100 flex items-center justify-center">
                            <Icons.FileText className="w-10 h-10 text-purple-400" />
                        </div>
                        <h3 className="text-xl font-bold text-gray-900 mb-2">Планів ще немає</h3>
                        <p className="text-gray-500 mb-6">Запустіть AI-аналіз щоб отримати перший план</p>
                    </div>
                );
            }
            
            return (
                <div className="space-y-4">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <Icons.FileText className="w-6 h-6 text-primary-600" />
                            Збережені плани
                        </h2>
                        <span className="badge badge-primary">{savedAnalyses.length}</span>
                    </div>
                    
                    {savedAnalyses.map((analysis, idx) => (
                        <div key={idx} className="card overflow-hidden">
                            {/* Header */}
                            <div 
                                className="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                                onClick={() => setExpandedPlan(expandedPlan === idx ? null : idx)}
                            >
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-indigo-500 text-white flex items-center justify-center font-bold">
                                        {idx + 1}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="font-semibold text-gray-900">
                                            {new Date(analysis.date).toLocaleDateString('uk-UA', { 
                                                day: 'numeric', month: 'long', year: 'numeric' 
                                            })}
                                        </div>
                                        <div className="text-sm text-gray-500 flex items-center gap-3">
                                            <span className="flex items-center gap-1">
                                                <Icons.Calendar className="w-3 h-3" />
                                                {analysis.period} тижнів
                                            </span>
                                            {analysis.orders?.length > 0 && (
                                                <span className="flex items-center gap-1 text-primary-600">
                                                    <Icons.FileText className="w-3 h-3" />
                                                    {analysis.orders.length} розпоряджень
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                    <Icons.ChevronDown className={`w-5 h-5 text-gray-400 transition-transform ${expandedPlan === idx ? 'rotate-180' : ''}`} />
                                </div>
                            </div>
                            
                            {/* Expanded content */}
                            {expandedPlan === idx && (
                                <div className="border-t border-gray-100">
                                    {/* Action buttons */}
                                    <div className="p-4 bg-gray-50 flex flex-wrap gap-2">
                                        <button 
                                            onClick={() => {
                                                navigator.clipboard.writeText(analysis.text);
                                                toast.success('План скопійовано!');
                                            }}
                                            className="btn btn-secondary text-sm flex items-center gap-2"
                                        >
                                            <Icons.Copy className="w-4 h-4" /> Копіювати план
                                        </button>
                                        {analysis.orders?.length > 0 && (
                                            <button 
                                                onClick={() => {
                                                    const csv = exportOrdersToCSV(analysis.orders);
                                                    downloadCSV(csv, `rozporyadzhennya_${new Date(analysis.date).toISOString().split('T')[0]}.csv`);
                                                }}
                                                className="btn btn-primary text-sm flex items-center gap-2"
                                            >
                                                <Icons.Download className="w-4 h-4" /> Excel розпоряджень
                                            </button>
                                        )}
                                        <button 
                                            onClick={() => onDelete(idx)}
                                            className="btn btn-ghost text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                                        >
                                            <Icons.Trash className="w-4 h-4" /> Видалити
                                        </button>
                                    </div>
                                    
                                    {/* Plan text */}
                                    <div className="p-4">
                                        <h4 className="font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                            <Icons.Brain className="w-4 h-4 text-purple-600" />
                                            Програма дій
                                        </h4>
                                        <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-4 text-sm text-gray-700 whitespace-pre-wrap max-h-80 overflow-y-auto">
                                            {analysis.text}
                                        </div>
                                    </div>
                                    
                                    {/* Orders */}
                                    {analysis.orders?.length > 0 && (
                                        <div className="p-4 border-t border-gray-100">
                                            <h4 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                                <Icons.FileText className="w-4 h-4 text-primary-600" />
                                                Розпорядження ({analysis.orders.length})
                                            </h4>
                                            <div className="space-y-2">
                                                {analysis.orders.map((order, orderIdx) => (
                                                    <details key={orderIdx} className="group bg-white border border-gray-200 rounded-xl overflow-hidden">
                                                        <summary className="flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-50 transition-colors">
                                                            <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-primary-600 text-white flex items-center justify-center font-bold text-sm">
                                                                {order.number}
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <p className="font-medium text-gray-900 truncate text-sm">{order.to || 'Відповідальний'}</p>
                                                                <p className="text-xs text-gray-500">Термін: {order.deadline || 'Не вказано'}</p>
                                                            </div>
                                                            <Icons.ChevronDown className="w-4 h-4 text-gray-400 group-open:rotate-180 transition-transform" />
                                                        </summary>
                                                        <div className="p-3 pt-0 border-t border-gray-100 bg-gray-50 text-sm space-y-2">
                                                            {order.tasks && (
                                                                <div>
                                                                    <p className="text-xs font-medium text-gray-500">ЗАВДАННЯ:</p>
                                                                    <p className="text-gray-700 whitespace-pre-wrap">{order.tasks}</p>
                                                                </div>
                                                            )}
                                                            {order.result && (
                                                                <div>
                                                                    <p className="text-xs font-medium text-gray-500">ПРОДУКТ:</p>
                                                                    <p className="text-gray-700 whitespace-pre-wrap">{order.result}</p>
                                                                </div>
                                                            )}
                                                            <button 
                                                                onClick={() => {
                                                                    navigator.clipboard.writeText(order.fullText);
                                                                    toast.success(`Розпорядження №${order.number} скопійовано!`);
                                                                }}
                                                                className="text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1"
                                                            >
                                                                <Icons.Copy className="w-3 h-3" /> Скопіювати
                                                            </button>
                                                        </div>
                                                    </details>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        };

        // ==================== MAIN APP ====================
        const App = () => {
            const toast = useToast();
            
            // Auth state
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            // Data state
            const [columns, setColumns] = useState([]);
            const [rows, setRows] = useState([]);
            const [employees, setEmployees] = useState({});
            const [aiSettings, setAiSettings] = useState({ businessContext: '', priorities: '', analysisPeriod: 5 });
            const [savedAnalyses, setSavedAnalyses] = useState([]);
            
            // UI state
            const [language, setLanguage] = useState('uk');
            const [saveStatus, setSaveStatus] = useState(null);
            const [showMenu, setShowMenu] = useState(false);
            const [activeTab, setActiveTab] = useState('stats');
            const [showQuickActions, setShowQuickActions] = useState(false);
            const [showAddStatsModal, setShowAddStatsModal] = useState(false);
            const [showEditColumnModal, setShowEditColumnModal] = useState(false);
            const [showTeamModal, setShowTeamModal] = useState(false);
            const [showAddEmployeeModal, setShowAddEmployeeModal] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [showDemoModal, setShowDemoModal] = useState(false);
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false });
            const [editingColumn, setEditingColumn] = useState(null);
            const [companyId, setCompanyId] = useState(null);
            const [companyName, setCompanyName] = useState('');
            
            // Form state
            const [newStatsName, setNewStatsName] = useState('');
            const [newStatsResponsible, setNewStatsResponsible] = useState('');
            const [newStatsPeriod, setNewStatsPeriod] = useState('weekly');
            const [newStatsTarget, setNewStatsTarget] = useState('');
            const [newStatsFormat, setNewStatsFormat] = useState('number'); // number, percent, uah, usd, eur
            const [newStatsImportance, setNewStatsImportance] = useState('medium'); // critical, high, medium, low
            const [newEmployeeEmail, setNewEmployeeEmail] = useState('');
            const [newEmployeeName, setNewEmployeeName] = useState('');
            const [selectedColumns, setSelectedColumns] = useState([]);
            const [generatedInviteLink, setGeneratedInviteLink] = useState('');
            
            const saveTimeoutRef = useRef(null);
            const SUPER_ADMIN_EMAIL = 'management.talco@gmail.com';
            
            // Admin state
            const [showAdminPanel, setShowAdminPanel] = useState(false);
            const [adminCompanies, setAdminCompanies] = useState([]);
            const [newCompanyName, setNewCompanyName] = useState('');
            const [newOwnerEmail, setNewOwnerEmail] = useState('');
            const [newOwnerName, setNewOwnerName] = useState('');
            const [adminLoading, setAdminLoading] = useState(false);
            
            const t = useMemo(() => translations[language] || translations.uk, [language]);
            const isOwner = userProfile?.role === 'owner';
            const isSuperAdmin = user?.email === SUPER_ADMIN_EMAIL;
            const targetRow = rows.find(r => r.isTarget);
            const dataRows = rows.filter(r => !r.isTarget);
            
            // Групування колонок по періоду
            const weeklyColumns = useMemo(() => columns.filter(c => c.period === 'weekly' || c.period === 'daily'), [columns]);
            const monthlyColumns = useMemo(() => columns.filter(c => c.period === 'monthly'), [columns]);
            
            // Групування рядків по типу періоду
            const weeklyRows = useMemo(() => dataRows.filter(r => r.periodType !== 'monthly'), [dataRows]);
            const monthlyRows = useMemo(() => dataRows.filter(r => r.periodType === 'monthly'), [dataRows]);
            
            // Visible columns for employees
            const visibleColumns = useMemo(() => {
                if (isOwner || isSuperAdmin) return columns;
                // Для співробітника беремо його дані з employees
                const employeeData = employees[user?.uid];
                console.log('Employee visibility check:', { 
                    uid: user?.uid, 
                    employeeData, 
                    allEmployeeIds: Object.keys(employees),
                    columnsCount: columns.length 
                });
                if (!employeeData?.visibleColumns || employeeData.visibleColumns.length === 0) {
                    // Якщо немає збережених колонок - показуємо всі (fallback)
                    console.log('Employee columns not found, showing all columns');
                    return columns;
                }
                const filtered = columns.filter(col => employeeData.visibleColumns.includes(col.id));
                console.log('Filtered columns for employee:', filtered.length);
                return filtered;
            }, [columns, isOwner, isSuperAdmin, employees, user]);

            // ==================== AUTH ====================
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
                    setUser(authUser);
                    if (authUser) {
                        // Якщо супер-адмін - завантажуємо список компаній + демо-дані
                        if (authUser.email === SUPER_ADMIN_EMAIL) {
                            await loadAdminCompanies();
                            // Автоматично завантажуємо демо-дані для супер-адміна
                            loadSuperAdminDemo();
                            setAuthLoading(false);
                        } else {
                            await loadUserProfile(authUser.uid);
                        }
                    }
                    else { setUserProfile(null); setAuthLoading(false); }
                });
                return () => unsubscribe();
            }, []);
            
            // Завантаження списку компаній для адміна
            const loadAdminCompanies = async () => {
                try {
                    const snapshot = await db.collection('companies').orderBy('createdAt', 'desc').get();
                    const companies = [];
                    snapshot.forEach(doc => {
                        companies.push({ id: doc.id, ...doc.data() });
                    });
                    setAdminCompanies(companies);
                    console.log('Admin companies loaded:', companies.length);
                } catch (error) {
                    console.error('Error loading companies:', error);
                }
            };
            
            // Створення нової компанії (тільки супер-адмін)
            const createCompany = async () => {
                if (!newCompanyName.trim() || !newOwnerEmail.trim()) {
                    toast.error('Вкажіть назву компанії та email власника');
                    return;
                }
                
                setAdminLoading(true);
                try {
                    // 1. Створюємо компанію
                    const companyRef = await db.collection('companies').add({
                        name: newCompanyName,
                        ownerEmail: newOwnerEmail,
                        ownerName: newOwnerName || newOwnerEmail.split('@')[0],
                        columns: [],
                        rows: [{ id: 'target', isTarget: true, date: '', values: {}, comments: {} }],
                        aiSettings: { businessContext: '', priorities: '', analysisPeriod: 5 },
                        savedAnalyses: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('Company created:', companyRef.id);
                    
                    // 2. Створюємо pending owner запис (буде активовано після створення в Firebase Auth)
                    await db.collection('pendingOwners').doc(newOwnerEmail.toLowerCase()).set({
                        companyId: companyRef.id,
                        companyName: newCompanyName,
                        ownerName: newOwnerName || newOwnerEmail.split('@')[0],
                        email: newOwnerEmail,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    toast.success(`Компанію "${newCompanyName}" створено! Тепер створіть користувача ${newOwnerEmail} в Firebase Console.`);
                    
                    // Очищаємо форму
                    setNewCompanyName('');
                    setNewOwnerEmail('');
                    setNewOwnerName('');
                    
                    // Оновлюємо список
                    await loadAdminCompanies();
                    
                } catch (error) {
                    console.error('Error creating company:', error);
                    toast.error('Помилка створення компанії: ' + error.message);
                } finally {
                    setAdminLoading(false);
                }
            };
            
            // Видалення компанії (тільки супер-адмін)
            const deleteCompany = (companyId, companyName) => {
                setConfirmDialog({
                    isOpen: true,
                    title: `Видалити компанію "${companyName}"?`,
                    message: 'Всі дані компанії буде видалено назавжди!',
                    onConfirm: async () => {
                        try {
                            // Видаляємо всіх користувачів компанії
                            const usersSnapshot = await db.collection('companies').doc(companyId).collection('users').get();
                            const batch = db.batch();
                            usersSnapshot.forEach(doc => batch.delete(doc.ref));
                            await batch.commit();
                            
                            // Видаляємо компанію
                            await db.collection('companies').doc(companyId).delete();
                            
                            toast.success('Компанію видалено');
                            await loadAdminCompanies();
                        } catch (error) {
                            console.error('Error deleting company:', error);
                            toast.error('Помилка видалення');
                        }
                    }
                });
            };
            
            const loadUserProfile = async (userId) => {
                try {
                    const currentUser = auth.currentUser;
                    const userEmail = currentUser?.email?.toLowerCase();
                    
                    // 1. Спочатку шукаємо глобальний профіль користувача
                    const userDoc = await db.collection('users').doc(userId).get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const userCompanyId = userData.companyId;
                        console.log('User found:', { userId, companyId: userCompanyId });
                        
                        if (userCompanyId) {
                            // 2. Завантажуємо дані компанії
                            setCompanyId(userCompanyId);
                            await loadCompanyData(userCompanyId, userId);
                        }
                    } else {
                        // Можливо це новий owner - перевіряємо pendingOwners
                        console.log('User not found, checking pendingOwners for:', userEmail);
                        
                        if (userEmail) {
                            const pendingDoc = await db.collection('pendingOwners').doc(userEmail).get();
                            
                            if (pendingDoc.exists) {
                                const pending = pendingDoc.data();
                                console.log('Found pending owner:', pending);
                                
                                // Активуємо owner
                                await activatePendingOwner(userId, userEmail, pending);
                            } else {
                                console.log('No pending owner found');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                    toast.error('Помилка завантаження профілю');
                } finally {
                    setAuthLoading(false);
                }
            };
            
            // Активація pending owner
            const activatePendingOwner = async (userId, email, pending) => {
                try {
                    console.log('Activating pending owner:', { userId, email, pending });
                    
                    // 1. Додаємо в глобальний users
                    await db.collection('users').doc(userId).set({
                        email: email,
                        companyId: pending.companyId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 2. Додаємо в companies/{companyId}/users як owner
                    await db.collection('companies').doc(pending.companyId).collection('users').doc(userId).set({
                        email: email,
                        name: pending.ownerName || email.split('@')[0],
                        role: 'owner',
                        visibleColumns: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 3. Видаляємо pending запис
                    await db.collection('pendingOwners').doc(email).delete();
                    
                    toast.success(`Вітаємо! Ви власник компанії "${pending.companyName}"`);
                    
                    // 4. Завантажуємо дані компанії
                    setCompanyId(pending.companyId);
                    await loadCompanyData(pending.companyId, userId);
                    
                } catch (error) {
                    console.error('Error activating owner:', error);
                    toast.error('Помилка активації: ' + error.message);
                }
            };
            
            const loadCompanyData = async (companyId, userId) => {
                try {
                    console.log('Loading company:', companyId);
                    
                    // 1. Завантажуємо дані компанії
                    const companyDoc = await db.collection('companies').doc(companyId).get();
                    if (!companyDoc.exists) {
                        console.log('Company not found:', companyId);
                        return;
                    }
                    
                    const companyData = companyDoc.data();
                    setCompanyName(companyData.name || '');
                    setColumns(companyData.columns || []);
                    
                    // Міграція старих дат у формат тижнів
                    const migratedRows = (companyData.rows || []).map(row => {
                        if (row.isTarget || !row.date) return row;
                        // Перевіряємо чи дата вже в форматі weekKey (YYYY-MM-DD понеділка)
                        const weekKey = getWeekKey(row.date);
                        if (weekKey && row.date !== weekKey) {
                            // Міграція: конвертуємо будь-яку дату в початок тижня
                            console.log('Migrating date:', row.date, '→', weekKey);
                            return { ...row, date: weekKey };
                        }
                        return row;
                    });
                    
                    // Перевіряємо чи є targetRow, якщо ні - створюємо
                    const hasTargetRow = migratedRows.some(r => r.isTarget);
                    if (!hasTargetRow) {
                        console.log('Creating missing targetRow');
                        migratedRows.unshift({ id: 'target', isTarget: true, date: '', values: {}, comments: {} });
                    }
                    
                    setRows(migratedRows);
                    
                    setAiSettings(companyData.aiSettings || { businessContext: '', priorities: '', analysisPeriod: 5 });
                    setSavedAnalyses(companyData.savedAnalyses || []);
                    
                    // 2. Завантажуємо всіх користувачів компанії
                    const usersSnapshot = await db.collection('companies').doc(companyId).collection('users').get();
                    const employeesData = {};
                    usersSnapshot.forEach(doc => {
                        employeesData[doc.id] = doc.data();
                    });
                    setEmployees(employeesData);
                    
                    // 3. Встановлюємо профіль поточного користувача з завантажених даних
                    const currentUserProfile = employeesData[userId];
                    if (currentUserProfile) {
                        console.log('User profile in company:', currentUserProfile);
                        setUserProfile(currentUserProfile);
                    } else {
                        console.log('User not found in company users:', userId);
                    }
                    
                    console.log('Company loaded:', { 
                        name: companyData.name,
                        columnsCount: companyData.columns?.length, 
                        rowsCount: companyData.rows?.length,
                        usersCount: Object.keys(employeesData).length 
                    });
                    
                } catch (error) {
                    console.error('Error loading company:', error);
                }
            };
            
            const initializeDefaultData = () => {
                const defaultColumns = [{ id: Date.now().toString(), name: 'Показник 1', responsible: '', period: 'weekly', visibleToEmployees: [] }];
                const targetRow = { id: 'target', isTarget: true, date: '', values: {}, comments: {} };
                const currentWeekKey = getWeekKey(new Date()) || new Date().toISOString().split('T')[0];
                const defaultRows = [targetRow, { id: Date.now().toString() + '-1', isTarget: false, date: currentWeekKey, values: {}, comments: {} }];
                setColumns(defaultColumns);
                setRows(defaultRows);
            };
            
            // ==================== DEMO DATA ====================
            // Завантаження демо-даних для супер-адміна (тихо, без toast)
            // Завантаження демо для супер-адміна (тихо, без модалки)
            const loadSuperAdminDemo = () => {
                // Буде викликано після ініціалізації DEMO_DATA
                setTimeout(() => {
                    loadDemoData('consulting');
                    setUserProfile({ role: 'owner', name: 'Super Admin' });
                    console.log('Super Admin demo data loaded');
                }, 100);
            };
            
            // Демо-дані для різних типів бізнесу
            const DEMO_DATA = {
                consulting: {
                    name: '🎯 Консалтинг',
                    companyName: 'TALKO Consulting',
                    columns: [
                        { id: 'col1', name: 'Консультацій', responsible: 'Олена', period: 'weekly', format: 'number', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col2', name: 'Нових лідів', responsible: 'Марія', period: 'weekly', format: 'number', importance: 'high', visibleToEmployees: [] },
                        { id: 'col3', name: 'Конверсія в угоду', responsible: 'Олена', period: 'weekly', format: 'percent', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col4', name: 'Закритих угод', responsible: 'Олена', period: 'weekly', format: 'number', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col5', name: 'Дохід тижня', responsible: 'Олександр', period: 'weekly', format: 'uah', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col6', name: 'Маркетинг бюджет', responsible: 'Ігор', period: 'weekly', format: 'usd', importance: 'medium', visibleToEmployees: [] },
                        { id: 'col7', name: 'Чистий прибуток', responsible: 'Олександр', period: 'monthly', format: 'uah', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col8', name: 'Витрати на маркетинг', responsible: 'Ігор', period: 'monthly', format: 'uah', importance: 'high', visibleToEmployees: [] },
                        { id: 'col9', name: 'ROI маркетингу', responsible: 'Ігор', period: 'monthly', format: 'percent', importance: 'high', visibleToEmployees: [] },
                    ],
                    weeklyValues: [
                        { col1: '18', col2: '42', col3: '12', col4: '5', col5: '125000', col6: '850' },
                        { col1: '22', col2: '38', col3: '14', col4: '5', col5: '140000', col6: '920' },
                        { col1: '15', col2: '51', col3: '10', col4: '5', col5: '145000', col6: '1200' },
                        { col1: '19', col2: '67', col3: '9', col4: '6', col5: '168000', col6: '1100' },
                        { col1: '21', col2: '58', col3: '10', col4: '6', col5: '174000', col6: '950' },
                        { col1: '17', col2: '44', col3: '11', col4: '5', col5: '135000', col6: '880' },
                    ],
                    weeklyTargets: { col1: '20', col2: '50', col3: '15', col4: '8', col5: '200000', col6: '900' },
                    monthlyValues: [
                        { col7: '480000', col8: '45000', col9: '320' },
                        { col7: '520000', col8: '52000', col9: '280' },
                        { col7: '410000', col8: '48000', col9: '250' },
                    ],
                    monthlyTargets: { col7: '600000', col8: '45000', col9: '380' },
                    context: `Консалтингова компанія "TALKO Consulting"
- Спеціалізація: бізнес-трансформація для МСБ
- Команда: 4 консультанти + 2 менеджери з продажів
- Середній чек: 28,000 грн за проект
- Цикл угоди: 2-3 тижні від ліда до контракту
- Основні канали: рекомендації (60%), реклама Facebook/Google (30%), вебінари (10%)
- Маркетинг бюджет: $800-1200/тиждень
- Поточна проблема: багато лідів, але низька конверсія в угоди (10% замість 15%)`,
                    priorities: `1. Підвищити конверсію лідів в угоди (зараз 10%, ціль 15%)
2. Оптимізувати витрати на маркетинг (ROI впав)
3. Збільшити середній чек до 30,000 грн`
                },
                dental: {
                    name: '🦷 Стоматологія',
                    companyName: 'Клініка "Здорова Посмішка"',
                    columns: [
                        { id: 'col1', name: 'Первинних пацієнтів', responsible: 'Адміністратор', period: 'weekly', format: 'number', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col2', name: 'Записів на лікування', responsible: 'Адміністратор', period: 'weekly', format: 'number', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col3', name: 'Конверсія в лікування', responsible: 'Лікар', period: 'weekly', format: 'percent', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col4', name: 'Імплантацій', responsible: 'Хірург', period: 'weekly', format: 'number', importance: 'high', visibleToEmployees: [] },
                        { id: 'col5', name: 'Виручка тижня', responsible: 'Директор', period: 'weekly', format: 'uah', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col6', name: 'Середній чек', responsible: 'Директор', period: 'weekly', format: 'uah', importance: 'high', visibleToEmployees: [] },
                        { id: 'col7', name: 'Чистий прибуток', responsible: 'Директор', period: 'monthly', format: 'uah', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col8', name: 'Витрати на рекламу', responsible: 'Маркетолог', period: 'monthly', format: 'uah', importance: 'high', visibleToEmployees: [] },
                        { id: 'col9', name: 'Вартість ліда', responsible: 'Маркетолог', period: 'monthly', format: 'uah', importance: 'high', visibleToEmployees: [] },
                    ],
                    weeklyValues: [
                        { col1: '24', col2: '18', col3: '75', col4: '3', col5: '185000', col6: '4200' },
                        { col1: '28', col2: '15', col3: '54', col4: '2', col5: '156000', col6: '3800' },
                        { col1: '31', col2: '19', col3: '61', col4: '4', col5: '198000', col6: '4100' },
                        { col1: '22', col2: '12', col3: '55', col4: '2', col5: '142000', col6: '3600' },
                        { col1: '35', col2: '17', col3: '49', col4: '3', col5: '168000', col6: '3900' },
                        { col1: '29', col2: '14', col3: '48', col4: '2', col5: '145000', col6: '3700' },
                    ],
                    weeklyTargets: { col1: '30', col2: '22', col3: '70', col4: '4', col5: '220000', col6: '4500' },
                    monthlyValues: [
                        { col7: '380000', col8: '35000', col9: '420' },
                        { col7: '420000', col8: '42000', col9: '480' },
                        { col7: '350000', col8: '38000', col9: '520' },
                    ],
                    monthlyTargets: { col7: '500000', col8: '35000', col9: '350' },
                    context: `Стоматологічна клініка "Здорова Посмішка"
- 3 лікарі-стоматологи + хірург-імплантолог + 2 адміністратори
- Середній чек: 4,500 грн
- Імплантація: від 18,000 грн за одиницю
- Основні канали: Google Ads (50%), Instagram (30%), рекомендації (20%)
- Рекламний бюджет: 35,000-45,000 грн/місяць
- Поточна проблема: багато первинних консультацій, але низька конверсія в лікування (48% замість 70%)
- Пацієнти йдуть "подумати" і не повертаються`,
                    priorities: `1. Підвищити конверсію первинка → лікування (зараз 48%, ціль 70%)
2. Збільшити кількість імплантацій (високомаржинальна послуга)
3. Знизити вартість ліда (зараз 520 грн, ціль 350 грн)`
                },
                manufacturing: {
                    name: '🏭 Виробництво',
                    companyName: 'Меблева фабрика "Комфорт"',
                    columns: [
                        { id: 'col1', name: 'Замовлень', responsible: 'Менеджер', period: 'weekly', format: 'number', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col2', name: 'Виготовлено одиниць', responsible: 'Виробництво', period: 'weekly', format: 'number', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col3', name: 'Виконання плану', responsible: 'Виробництво', period: 'weekly', format: 'percent', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col4', name: 'Брак', responsible: 'ОТК', period: 'weekly', format: 'percent', importance: 'high', visibleToEmployees: [] },
                        { id: 'col5', name: 'Виручка тижня', responsible: 'Директор', period: 'weekly', format: 'uah', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col6', name: 'Собівартість', responsible: 'Бухгалтер', period: 'weekly', format: 'uah', importance: 'high', visibleToEmployees: [] },
                        { id: 'col7', name: 'Чистий прибуток', responsible: 'Директор', period: 'monthly', format: 'uah', importance: 'critical', visibleToEmployees: [] },
                        { id: 'col8', name: 'Витрати на сировину', responsible: 'Закупівлі', period: 'monthly', format: 'uah', importance: 'high', visibleToEmployees: [] },
                        { id: 'col9', name: 'Маржинальність', responsible: 'Директор', period: 'monthly', format: 'percent', importance: 'critical', visibleToEmployees: [] },
                    ],
                    weeklyValues: [
                        { col1: '12', col2: '45', col3: '90', col4: '3', col5: '380000', col6: '285000' },
                        { col1: '15', col2: '52', col3: '104', col4: '2', col5: '420000', col6: '310000' },
                        { col1: '11', col2: '38', col3: '76', col4: '5', col5: '340000', col6: '270000' },
                        { col1: '14', col2: '48', col3: '96', col4: '4', col5: '395000', col6: '295000' },
                        { col1: '13', col2: '42', col3: '84', col4: '6', col5: '365000', col6: '290000' },
                        { col1: '10', col2: '35', col3: '70', col4: '7', col5: '320000', col6: '260000' },
                    ],
                    weeklyTargets: { col1: '15', col2: '50', col3: '100', col4: '2', col5: '450000', col6: '300000' },
                    monthlyValues: [
                        { col7: '520000', col8: '680000', col9: '32' },
                        { col7: '480000', col8: '720000', col9: '28' },
                        { col7: '410000', col8: '750000', col9: '25' },
                    ],
                    monthlyTargets: { col7: '650000', col8: '650000', col9: '35' },
                    context: `Меблева фабрика "Комфорт"
- Виробництво корпусних меблів на замовлення
- 15 працівників на виробництві + 3 менеджери + 2 монтажники
- Середнє замовлення: 28,000 грн
- Цикл виробництва: 2-3 тижні
- Основні клієнти: приватні замовники (70%), дизайнери (30%)
- Поточна проблема: зростає брак (7% замість 2%), падає маржинальність
- Затримки через брак сировини та переробки`,
                    priorities: `1. Знизити відсоток браку (зараз 7%, ціль 2%)
2. Підвищити маржинальність (зараз 25%, ціль 35%)
3. Виконувати план виробництва на 100%`
                }
            };
            
            const loadDemoData = (type = 'consulting') => {
                const demo = DEMO_DATA[type];
                if (!demo) return;
                
                const today = new Date();
                const getWeekDateKey = (weeksAgo) => {
                    const d = new Date(today);
                    d.setDate(d.getDate() - (weeksAgo * 7));
                    return getWeekKey(d);
                };
                
                const getMonthKeyLocal = (monthsAgo) => {
                    const d = new Date(today.getFullYear(), today.getMonth() - monthsAgo, 1);
                    return getMonthKeyFromDate(d);
                };
                
                const demoRows = [];
                
                // Тижневі записи
                demo.weeklyValues.forEach((values, i) => {
                    demoRows.push({
                        id: `row${i + 1}`,
                        isTarget: false,
                        periodType: 'weekly',
                        date: getWeekDateKey(5 - i),
                        values,
                        targets: demo.weeklyTargets,
                        comments: {}
                    });
                });
                
                // Місячні записи
                demo.monthlyValues.forEach((values, i) => {
                    demoRows.push({
                        id: `month${i + 1}`,
                        isTarget: false,
                        periodType: 'monthly',
                        date: getMonthKeyLocal(2 - i),
                        values,
                        targets: demo.monthlyTargets,
                        comments: {}
                    });
                });
                
                setColumns(demo.columns);
                setRows(demoRows);
                setAiSettings({
                    businessContext: demo.context,
                    priorities: demo.priorities,
                    analysisPeriod: 5
                });
                setEmployees({});
                setSavedAnalyses([]);
                setCompanyName(`DEMO: ${demo.companyName}`);
                
                toast.success(`${demo.name} — демо завантажено! Спробуйте AI Аналіз 🤖`);
                setShowDemoModal(false);
            };
            
            const handleAuth = async (email, password, isRegister, inviteCode) => {
                setIsSubmitting(true);
                try {
                    if (isRegister) {
                        // Реєстрація тільки через invite
                        if (!inviteCode) {
                            toast.error('Реєстрація можлива тільки за запрошенням');
                            return;
                        }
                        
                        // Перевіряємо invite
                        const inviteDoc = await db.collection('invites').doc(inviteCode).get();
                        if (!inviteDoc.exists || inviteDoc.data().used) {
                            toast.error('Невірний або використаний код запрошення');
                            return;
                        }
                        
                        const invite = inviteDoc.data();
                        const inviteCompanyId = invite.companyId;
                        
                        // Створюємо користувача в Firebase Auth
                        const authResult = await auth.createUserWithEmailAndPassword(email, password);
                        
                        // 1. Додаємо в глобальний users (для пошуку companyId)
                        await db.collection('users').doc(authResult.user.uid).set({
                            email, 
                            companyId: inviteCompanyId,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // 2. Додаємо в companies/{companyId}/users
                        await db.collection('companies').doc(inviteCompanyId).collection('users').doc(authResult.user.uid).set({
                            email, 
                            name: invite.name || email.split('@')[0],
                            role: 'employee',
                            visibleColumns: invite.visibleColumns || [],
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // 3. Позначаємо invite як використаний
                        await db.collection('invites').doc(inviteCode).update({ 
                            used: true, 
                            usedBy: authResult.user.uid,
                            usedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        toast.success('Ви приєдналися до команди!');
                    } else {
                        // Логін
                        await auth.signInWithEmailAndPassword(email, password);
                        toast.success('Вітаємо!');
                    }
                    // Clear invite from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error('Auth error:', error);
                    if (error.code === 'auth/email-already-in-use') {
                        toast.error('Цей email вже зареєстрований. Спробуйте увійти.');
                    } else if (error.code === 'auth/wrong-password') {
                        toast.error('Невірний пароль');
                    } else if (error.code === 'auth/user-not-found') {
                        toast.error('Користувача не знайдено');
                    } else {
                        toast.error(error.message);
                    }
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            const handleLogout = async () => {
                // Скасовуємо pending save
                if (saveTimeoutRef.current) {
                    clearTimeout(saveTimeoutRef.current);
                    saveTimeoutRef.current = null;
                }
                await auth.signOut();
                setColumns([]); setRows([]); setEmployees({}); setUserProfile(null);
                setCompanyId(null); setCompanyName('');
                toast.info('До побачення!');
            };

            // ==================== DATA SAVING ====================
            // Ref для актуальних даних (уникаємо stale closure)
            const dataRef = useRef({ columns, rows, aiSettings, savedAnalyses });
            useEffect(() => {
                dataRef.current = { columns, rows, aiSettings, savedAnalyses };
            }, [columns, rows, aiSettings, savedAnalyses]);
            
            const saveData = useCallback(async () => {
                if (!user || !companyId || !isOwner) return;
                const data = dataRef.current;
                if (!data.columns || data.columns.length === 0 || !data.rows || data.rows.length === 0) {
                    console.log('Skip save - no data', { cols: data.columns?.length, rows: data.rows?.length });
                    return;
                }
                setSaveStatus('saving');
                try {
                    await db.collection('companies').doc(companyId).update({
                        columns: data.columns, 
                        rows: data.rows, 
                        aiSettings: data.aiSettings || {}, 
                        savedAnalyses: data.savedAnalyses || [],
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    setSaveStatus('saved');
                    setTimeout(() => setSaveStatus(null), 2000);
                } catch (error) {
                    console.error('Error saving:', error);
                    setSaveStatus('error');
                    toast.error(t.saveError);
                }
            }, [user, companyId, isOwner]);
            
            const debouncedSave = useCallback(() => {
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                saveTimeoutRef.current = setTimeout(saveData, 2000);
            }, [saveData]);
            
            useEffect(() => {
                // Зберігаємо тільки якщо:
                // - є юзер і companyId
                // - це власник
                // - є дані (columns і rows)
                // - не йде завантаження
                if (user && companyId && columns.length > 0 && rows.length > 0 && isOwner && !authLoading) {
                    debouncedSave();
                }
            }, [columns, rows, aiSettings, savedAnalyses, isOwner, companyId, debouncedSave, authLoading]);

            // ==================== DATA HANDLERS ====================
            const addColumn = () => {
                if (!isOwner || !newStatsName.trim()) return;
                const newColumn = {
                    id: Date.now().toString(), name: newStatsName, responsible: newStatsResponsible,
                    period: newStatsPeriod, format: newStatsFormat, importance: newStatsImportance, visibleToEmployees: []
                };
                setColumns([...columns, newColumn]);
                // Add target value
                if (newStatsTarget) {
                    setRows(rows.map(row => row.isTarget ? { ...row, values: { ...row.values, [newColumn.id]: newStatsTarget } } : row));
                }
                setNewStatsName(''); setNewStatsResponsible(''); setNewStatsPeriod('weekly'); setNewStatsTarget(''); setNewStatsFormat('number'); setNewStatsImportance('medium');
                setShowAddStatsModal(false);
                toast.success(t.addStats);
            };
            
            const updateColumn = (colId, updates) => {
                setColumns(columns.map(col => col.id === colId ? { ...col, ...updates } : col));
            };
            
            const moveColumn = (draggedId, targetId) => {
                const draggedIdx = columns.findIndex(c => c.id === draggedId);
                const targetIdx = columns.findIndex(c => c.id === targetId);
                if (draggedIdx === -1 || targetIdx === -1) return;
                
                const newColumns = [...columns];
                const [dragged] = newColumns.splice(draggedIdx, 1);
                newColumns.splice(targetIdx, 0, dragged);
                setColumns(newColumns);
                toast.success('Порядок змінено');
            };
            
            const deleteColumn = (id) => {
                setConfirmDialog({
                    isOpen: true, title: t.confirmDelete, message: 'Всі дані цього показника буде видалено',
                    onConfirm: () => {
                        setColumns(columns.filter(col => col.id !== id));
                        setRows(rows.map(row => ({
                            ...row, values: Object.fromEntries(Object.entries(row.values || {}).filter(([key]) => key !== id)),
                            comments: Object.fromEntries(Object.entries(row.comments || {}).filter(([key]) => key !== id))
                        })));
                    }
                });
            };
            
            const addRow = (periodType = 'weekly') => {
                if (periodType === 'monthly') {
                    const currentMonthKey = getMonthKeyFromDate(new Date());
                    const newRow = { 
                        id: Date.now().toString(), 
                        isTarget: false, 
                        periodType: 'monthly',
                        date: currentMonthKey, 
                        values: {}, 
                        targets: {}, 
                        comments: {} 
                    };
                    setRows([...rows, newRow]);
                    toast.success('Додано місячний запис');
                } else {
                    const currentWeekKey = getWeekKey(new Date());
                    const newRow = { 
                        id: Date.now().toString(), 
                        isTarget: false, 
                        periodType: 'weekly',
                        date: currentWeekKey, 
                        values: {}, 
                        targets: {}, 
                        comments: {} 
                    };
                    setRows([...rows, newRow]);
                    toast.success('Додано тижневий запис');
                }
            };
            
            const deleteRow = (id) => {
                setConfirmDialog({
                    isOpen: true, title: t.confirmDelete,
                    onConfirm: () => setRows(rows.filter(row => row.id !== id))
                });
            };
            
            const updateDate = (rowId, date) => setRows(rows.map(row => row.id === rowId ? { ...row, date } : row));
            const updateValue = (rowId, colId, value) => setRows(rows.map(row => row.id === rowId ? { ...row, values: { ...row.values, [colId]: value } } : row));
            const updateTarget = (rowId, colId, value) => setRows(rows.map(row => row.id === rowId ? { ...row, targets: { ...row.targets, [colId]: value } } : row));
            const updateComment = (rowId, colId, comment) => setRows(rows.map(row => row.id === rowId ? { ...row, comments: { ...row.comments, [colId]: comment } } : row));

            // ==================== TEAM HANDLERS ====================
            const generateInviteCode = () => Math.random().toString(36).substring(2, 10).toUpperCase();
            
            const addEmployee = async () => {
                if (!newEmployeeName.trim() || !isOwner || !companyId) {
                    toast.error("Вкажіть ім'я співробітника");
                    return;
                }
                
                const code = generateInviteCode();
                const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${code}`;
                
                try {
                    // Створюємо invite з companyId (без email - співробітник сам введе)
                    await db.collection('invites').doc(code).set({
                        companyId: companyId,
                        companyName: companyName,
                        name: newEmployeeName,
                        visibleColumns: selectedColumns, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(), 
                        used: false
                    });
                    
                    setGeneratedInviteLink(inviteLink);
                    toast.success(t.inviteLink);
                } catch (error) {
                    console.error('Error creating invite:', error);
                    toast.error('Помилка створення запрошення');
                }
            };
            
            const copyInviteLink = async () => {
                await navigator.clipboard.writeText(generatedInviteLink);
                toast.success(t.linkCopied);
            };
            
            const removeEmployee = (employeeId) => {
                // Не дозволяємо видаляти owner
                if (employees[employeeId]?.role === 'owner') {
                    toast.error('Неможливо видалити власника');
                    return;
                }
                
                setConfirmDialog({
                    isOpen: true, title: 'Видалити співробітника?',
                    onConfirm: async () => {
                        if (!companyId) return;
                        
                        try {
                            // Видаляємо з companies/{companyId}/users
                            await db.collection('companies').doc(companyId).collection('users').doc(employeeId).delete();
                            
                            // Оновлюємо локальний state
                            const newEmployees = { ...employees };
                            delete newEmployees[employeeId];
                            setEmployees(newEmployees);
                            
                            toast.success('Співробітника видалено');
                        } catch (error) {
                            console.error('Error removing employee:', error);
                            toast.error('Помилка видалення');
                        }
                    }
                });
            };
            
            const updateEmployeeColumns = async (employeeId, visibleCols) => {
                if (!companyId) return;
                
                // Оновлюємо локальний state
                const newEmployees = {
                    ...employees, 
                    [employeeId]: { ...employees[employeeId], visibleColumns: visibleCols }
                };
                setEmployees(newEmployees);
                
                // Зберігаємо в Firebase
                try {
                    await db.collection('companies').doc(companyId).collection('users').doc(employeeId).update({ 
                        visibleColumns: visibleCols 
                    });
                    console.log('Employee columns updated');
                } catch (error) {
                    console.error('Error updating employee columns:', error);
                    toast.error('Помилка оновлення доступу');
                }
            };

            // ==================== AI HANDLERS ====================
            const saveAnalysis = (analysis) => {
                // analysis може містити: text, date, period, orders
                setSavedAnalyses([analysis, ...savedAnalyses].slice(0, 20));
                toast.success('Збережено в історію!');
            };
            
            const deletePlan = (idx) => {
                setConfirmDialog({
                    isOpen: true,
                    title: 'Видалити цей план?',
                    onConfirm: () => {
                        setSavedAnalyses(savedAnalyses.filter((_, i) => i !== idx));
                        toast.success('План видалено');
                    }
                });
            };

            // ==================== EXPORT/IMPORT ====================
            const exportToExcel = () => {
                const wb = XLSX.utils.book_new();
                
                // === ТИЖНЕВІ ПОКАЗНИКИ ===
                const weeklyColumns = visibleColumns.filter(c => c.period !== 'monthly');
                if (weeklyColumns.length > 0) {
                    const weeklyHeaders = ['Тиждень', ...weeklyColumns.map(col => col.name)];
                    const responsibleRow = ['Відповідальний', ...weeklyColumns.map(col => col.responsible || '-')];
                    const targetRowData = ['ПЛАН', ...weeklyColumns.map(col => targetRow?.values?.[col.id] || '')];
                    const weeklyRows = rows
                        .filter(r => !r.isTarget && r.periodType !== 'monthly' && r.date)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    const weeklyData = weeklyRows.map(row => {
                        const weekLabel = formatWeekLabel(row.date);
                        return [weekLabel, ...weeklyColumns.map(col => row.values?.[col.id] || '')];
                    });
                    
                    const wsWeekly = XLSX.utils.aoa_to_sheet([weeklyHeaders, responsibleRow, targetRowData, ...weeklyData]);
                    // Ширина колонок
                    wsWeekly['!cols'] = [{ wch: 15 }, ...weeklyColumns.map(() => ({ wch: 12 }))];
                    XLSX.utils.book_append_sheet(wb, wsWeekly, 'Тижневі');
                }
                
                // === МІСЯЧНІ ПОКАЗНИКИ ===
                const monthlyColumns = visibleColumns.filter(c => c.period === 'monthly');
                if (monthlyColumns.length > 0) {
                    const monthlyHeaders = ['Місяць', ...monthlyColumns.map(col => col.name)];
                    const responsibleRowM = ['Відповідальний', ...monthlyColumns.map(col => col.responsible || '-')];
                    const targetRowDataM = ['ПЛАН', ...monthlyColumns.map(col => targetRow?.values?.[col.id] || '')];
                    const monthlyRows = rows
                        .filter(r => !r.isTarget && r.periodType === 'monthly' && r.date)
                        .sort((a, b) => b.date.localeCompare(a.date));
                    const monthlyData = monthlyRows.map(row => {
                        const monthLabel = formatMonthLabel(row.date);
                        return [monthLabel, ...monthlyColumns.map(col => row.values?.[col.id] || '')];
                    });
                    
                    const wsMonthly = XLSX.utils.aoa_to_sheet([monthlyHeaders, responsibleRowM, targetRowDataM, ...monthlyData]);
                    wsMonthly['!cols'] = [{ wch: 18 }, ...monthlyColumns.map(() => ({ wch: 12 }))];
                    XLSX.utils.book_append_sheet(wb, wsMonthly, 'Місячні');
                }
                
                // === ВСІ ДАНІ (старий формат для сумісності) ===
                const allHeaders = [t.date, ...visibleColumns.map(col => `${col.name} (${col.responsible || '-'})`)];
                const allTargetRow = [t.target, ...visibleColumns.map(col => targetRow?.values?.[col.id] || '')];
                const allData = dataRows.map(row => [row.date, ...visibleColumns.map(col => row.values?.[col.id] || '')]);
                const wsAll = XLSX.utils.aoa_to_sheet([allHeaders, allTargetRow, ...allData]);
                XLSX.utils.book_append_sheet(wb, wsAll, 'Всі дані');
                
                XLSX.writeFile(wb, `statistics_${companyName || 'export'}_${new Date().toISOString().split('T')[0]}.xlsx`);
                toast.success(t.export);
            };

            // ==================== RENDER ====================
            if (authLoading) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <Icons.Loader className="w-8 h-8 text-primary-500" />
                </div>
            );
            
            if (!user) return <AuthForm t={t} onAuth={handleAuth} isLoading={isSubmitting} />;

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Save indicator */}
                    {saveStatus && (
                        <div className={`fixed top-4 right-4 z-50 px-4 py-2 rounded-xl text-sm font-semibold shadow-lg animate-slide-down
                            ${saveStatus === 'saving' ? 'bg-amber-100 text-amber-700' : ''}
                            ${saveStatus === 'saved' ? 'bg-green-100 text-green-700' : ''}
                            ${saveStatus === 'error' ? 'bg-red-100 text-red-700' : ''}
                        `}>
                            {saveStatus === 'saving' && <><Icons.Loader className="w-4 h-4 inline mr-2" />{t.saving}</>}
                            {saveStatus === 'saved' && <><Icons.CheckCircle className="w-4 h-4 inline mr-2" />{t.saved}</>}
                            {saveStatus === 'error' && <><Icons.AlertCircle className="w-4 h-4 inline mr-2" />{t.saveError}</>}
                        </div>
                    )}
                    
                    <div className="w-full px-4 lg:px-8 pb-24 sm:pb-8">
                        {/* Mobile Header */}
                        <header className="card p-4 mb-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-lg shadow-primary-500/30">
                                        <Icons.BarChart className="w-6 h-6 text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-lg sm:text-xl font-bold text-gray-900 truncate sm:max-w-none" style={{ maxWidth: '180px' }}>{companyName || t.appName}</h1>
                                        <div className="flex items-center gap-2">
                                            {isSuperAdmin ? (
                                                <span className="badge bg-gradient-to-r from-red-500 to-pink-500 text-white">
                                                    <Icons.Shield className="w-3 h-3 mr-1" />Super Admin
                                                </span>
                                            ) : (
                                                <span className={`badge ${isOwner ? 'badge-purple' : 'badge-amber'}`}>
                                                    {isOwner ? <><Icons.Crown className="w-3 h-3 mr-1" />{t.owner}</> : <><Icons.User className="w-3 h-3 mr-1" />{t.employee}</>}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    <select value={language} onChange={(e) => setLanguage(e.target.value)} className="hidden sm:block px-3 py-2 bg-gray-100 rounded-xl text-sm font-medium border-none">
                                        <option value="uk">🇺🇦 UA</option>
                                        <option value="ru">🇷🇺 RU</option>
                                    </select>
                                    
                                    <button onClick={() => setShowMenu(true)} className="btn btn-ghost btn-icon sm:hidden"><Icons.Menu className="w-6 h-6" /></button>
                                    
                                    <div className="hidden sm:flex items-center gap-2">
                                        {/* Super Admin Panel Button */}
                                        {isSuperAdmin && (
                                            <button onClick={() => setShowAdminPanel(true)} className="btn bg-gradient-to-r from-red-500 to-pink-500 text-white hover:from-red-600 hover:to-pink-600">
                                                <Icons.Shield className="w-4 h-4" /><span className="hidden lg:inline">Адмін</span>
                                            </button>
                                        )}
                                        {isOwner && (
                                            <>
                                                <button onClick={() => setShowAIModal(true)} className="btn btn-ai"><Icons.Brain className="w-4 h-4" /><span className="hidden lg:inline">{t.aiAnalysis}</span></button>
                                                <a href="https://chatgpt.com/g/g-6851a70e282481918ad5c2894ff30b13-statistics" target="_blank" rel="noopener noreferrer" className="btn btn-secondary" title="AI розробник статистик">
                                                    <Icons.Target className="w-4 h-4" /><span className="hidden lg:inline">Статистики</span>
                                                </a>
                                                <a href="https://chatgpt.com/g/g-684be37e3bcc81918f64088a2bb094da-instructions-generator" target="_blank" rel="noopener noreferrer" className="btn btn-secondary" title="Генератор розпоряджень">
                                                    <Icons.Edit className="w-4 h-4" /><span className="hidden lg:inline">Розпорядження</span>
                                                </a>
                                                <a href="https://alextalko.com/alta" target="_blank" rel="noopener noreferrer" className="btn btn-secondary" title="TALKO Task Manager">
                                                    <Icons.CheckSquare className="w-4 h-4" /><span className="hidden lg:inline">Задачі</span>
                                                </a>
                                                <a href="https://alextalko.com/tms" target="_blank" rel="noopener noreferrer" className="btn btn-secondary" title="Структура компанії">
                                                    <Icons.GitBranch className="w-4 h-4" /><span className="hidden lg:inline">Структура</span>
                                                </a>
                                                <button 
                                                    onClick={() => setActiveTab(activeTab === 'plans' ? 'stats' : 'plans')} 
                                                    className={`btn ${activeTab === 'plans' ? 'btn-primary' : 'btn-secondary'}`}
                                                >
                                                    <Icons.FileText className="w-4 h-4" /><span className="hidden lg:inline">Плани</span>
                                                    {savedAnalyses.length > 0 && <span className="ml-1 badge badge-white text-xs">{savedAnalyses.length}</span>}
                                                </button>
                                                <button onClick={() => setShowTeamModal(true)} className="btn btn-secondary"><Icons.Users className="w-4 h-4" /></button>
                                            </>
                                        )}
                                        <button onClick={exportToExcel} className="btn btn-secondary"><Icons.Download className="w-4 h-4" /><span className="hidden lg:inline">Excel</span></button>
                                        <button onClick={() => setShowDemoModal(true)} className="btn btn-secondary" title="Демо-дані для тестування"><Icons.Play className="w-4 h-4" /><span className="hidden lg:inline">Демо</span></button>
                                        <a href={GPT_BOTTLENECK_URL} target="_blank" rel="noopener noreferrer" className="btn btn-secondary" title="AI Аналіз вузьких місць"><Icons.Brain className="w-4 h-4" /><span className="hidden lg:inline">AI GPT</span></a>
                                        <button onClick={handleLogout} className="btn btn-ghost btn-icon"><Icons.LogOut className="w-5 h-5" /></button>
                                    </div>
                                </div>
                            </div>
                        </header>
                        
                        {/* Stats summary - покращені картки */}
                        {activeTab === 'stats' && (
                        <>
                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                            {[
                                { label: t.columns, value: visibleColumns.length, icon: Icons.BarChart, gradient: 'from-blue-500 to-indigo-500', shadow: 'shadow-blue-500/20' },
                                { label: t.periods, value: dataRows.length, icon: Icons.Calendar, gradient: 'from-green-500 to-emerald-500', shadow: 'shadow-green-500/20' },
                                { label: t.employees, value: Object.keys(employees).length, icon: Icons.Users, gradient: 'from-purple-500 to-pink-500', shadow: 'shadow-purple-500/20' },
                                { label: t.values, value: visibleColumns.length * dataRows.length, icon: Icons.Target, gradient: 'from-amber-500 to-orange-500', shadow: 'shadow-amber-500/20' },
                            ].map((stat, i) => (
                                <div key={i} className="card p-4 animate-fade-in" style={{ animationDelay: `${i * 0.05}s` }}>
                                    <div className={`w-10 h-10 rounded-xl bg-gradient-to-br ${stat.gradient} ${stat.shadow} shadow-lg flex items-center justify-center mb-3`}>
                                        <stat.icon className="w-5 h-5 text-white" />
                                    </div>
                                    <div className="text-2xl font-bold text-gray-900">{stat.value}</div>
                                    <div className="text-xs text-gray-500 font-medium">{stat.label}</div>
                                </div>
                            ))}
                        </div>
                        
                        {/* Action buttons (desktop) */}
                        {isOwner && (
                            <div className="hidden sm:flex gap-3 mb-4">
                                <button onClick={() => setShowAddStatsModal(true)} className="btn btn-primary"><Icons.Plus className="w-5 h-5" />{t.addStats}</button>
                                <button onClick={() => addRow('weekly')} className="btn btn-secondary"><Icons.Calendar className="w-5 h-5" />+ Тижневий запис</button>
                                {monthlyColumns.length > 0 && (
                                    <button onClick={() => addRow('monthly')} className="btn btn-secondary"><Icons.BarChart className="w-5 h-5" />+ Місячний запис</button>
                                )}
                            </div>
                        )}
                        
                        {/* Mobile: Cards view */}
                        <div className="sm:hidden space-y-6">
                            {/* Тижневі показники (mobile) */}
                            {weeklyColumns.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-3 px-1">
                                        <h2 className="text-base font-bold text-gray-900 flex items-center gap-2">
                                            <Icons.Calendar className="w-4 h-4 text-primary-500" />
                                            Тижневі
                                        </h2>
                                        {isOwner && (
                                            <button onClick={() => addRow('weekly')} className="text-sm text-primary-600 font-medium">+ Тиждень</button>
                                        )}
                                    </div>
                                    {weeklyRows.length > 0 ? (
                                        weeklyRows.map((row, index) => (
                                            <StatsCard 
                                                key={row.id} 
                                                row={row} 
                                                columns={weeklyColumns} 
                                                periodType="weekly"
                                                editable
                                                isEven={index % 2 === 1}
                                                allRows={rows}
                                                onDelete={() => deleteRow(row.id)} 
                                                onDateChange={(date) => updateDate(row.id, date)}
                                                onValueChange={(colId, value) => updateValue(row.id, colId, value)}
                                                onTargetChange={(colId, value) => updateTarget(row.id, colId, value)}
                                                onCommentChange={(colId, comment) => updateComment(row.id, colId, comment)} 
                                                t={t} 
                                            />
                                        ))
                                    ) : (
                                        <div className="text-center py-6 text-gray-500">
                                            Немає тижневих записів
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Місячні показники (mobile) */}
                            {monthlyColumns.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-3 px-1">
                                        <h2 className="text-base font-bold text-gray-900 flex items-center gap-2">
                                            <Icons.BarChart className="w-4 h-4 text-blue-500" />
                                            Місячні
                                        </h2>
                                        {isOwner && (
                                            <button onClick={() => addRow('monthly')} className="text-sm text-blue-600 font-medium">+ Місяць</button>
                                        )}
                                    </div>
                                    {monthlyRows.length > 0 ? (
                                        monthlyRows.map((row, index) => (
                                            <StatsCard 
                                                key={row.id} 
                                                row={row} 
                                                columns={monthlyColumns}
                                                periodType="monthly"
                                                editable
                                                isEven={index % 2 === 1}
                                                allRows={rows}
                                                onDelete={() => deleteRow(row.id)} 
                                                onDateChange={(date) => updateDate(row.id, date)}
                                                onValueChange={(colId, value) => updateValue(row.id, colId, value)}
                                                onTargetChange={(colId, value) => updateTarget(row.id, colId, value)}
                                                onCommentChange={(colId, comment) => updateComment(row.id, colId, comment)} 
                                                t={t} 
                                            />
                                        ))
                                    ) : (
                                        <div className="text-center py-6 text-gray-500">
                                            Немає місячних записів
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Порожній стан */}
                            {weeklyColumns.length === 0 && monthlyColumns.length === 0 && (
                                <div className="empty-state">
                                    <div className="empty-state-icon">
                                        <Icons.BarChart className="w-10 h-10 text-primary-500" />
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-900 mb-2">{t.noData}</h3>
                                    <p className="text-gray-500 mb-6">Почніть з додавання показників</p>
                                    {isOwner && (
                                        <button onClick={() => setShowAddStatsModal(true)} className="btn btn-primary">
                                            <Icons.Plus className="w-5 h-5" />{t.addStats}
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        {/* Desktop: Table view */}
                        <div className="hidden sm:block space-y-6">
                            {/* Секція тижневих показників */}
                            {weeklyColumns.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-3">
                                        <h2 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                                            <Icons.Calendar className="w-5 h-5 text-primary-500" />
                                            Тижневі показники
                                            <span className="text-sm font-normal text-gray-500">({weeklyColumns.length} показників)</span>
                                        </h2>
                                        {isOwner && (
                                            <button onClick={() => addRow('weekly')} className="btn btn-secondary btn-sm">
                                                <Icons.Plus className="w-4 h-4" />Додати тиждень
                                            </button>
                                        )}
                                    </div>
                                    <StatsTable 
                                        columns={weeklyColumns} 
                                        rows={[targetRow, ...weeklyRows].filter(Boolean)} 
                                        targetRow={targetRow}
                                        periodType="weekly"
                                        onDeleteRow={deleteRow} 
                                        onDateChange={updateDate} 
                                        onValueChange={updateValue} 
                                        onCommentChange={updateComment}
                                        onEditColumn={(col) => { setEditingColumn(col); setShowEditColumnModal(true); }}
                                        onMoveColumn={moveColumn}
                                        editable={isOwner} 
                                        t={t} 
                                    />
                                </div>
                            )}
                            
                            {/* Секція місячних показників */}
                            {monthlyColumns.length > 0 && (
                                <div>
                                    <div className="flex items-center justify-between mb-3">
                                        <h2 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                                            <Icons.BarChart className="w-5 h-5 text-blue-500" />
                                            Місячні показники
                                            <span className="text-sm font-normal text-gray-500">({monthlyColumns.length} показників)</span>
                                        </h2>
                                        {isOwner && (
                                            <button onClick={() => addRow('monthly')} className="btn btn-secondary btn-sm">
                                                <Icons.Plus className="w-4 h-4" />Додати місяць
                                            </button>
                                        )}
                                    </div>
                                    <StatsTable 
                                        columns={monthlyColumns} 
                                        rows={[targetRow, ...monthlyRows].filter(Boolean)} 
                                        targetRow={targetRow}
                                        periodType="monthly"
                                        onDeleteRow={deleteRow} 
                                        onDateChange={updateDate} 
                                        onValueChange={updateValue} 
                                        onCommentChange={updateComment}
                                        onEditColumn={(col) => { setEditingColumn(col); setShowEditColumnModal(true); }}
                                        onMoveColumn={moveColumn}
                                        editable={isOwner} 
                                        t={t} 
                                    />
                                </div>
                            )}
                            
                            {/* Порожній стан */}
                            {weeklyColumns.length === 0 && monthlyColumns.length === 0 && (
                                <div className="empty-state">
                                    <div className="empty-state-icon">
                                        <Icons.BarChart className="w-10 h-10 text-primary-500" />
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-900 mb-2">{t.noData}</h3>
                                    <p className="text-gray-500 mb-6">Почніть з додавання показників</p>
                                    {isOwner && (
                                        <button onClick={() => setShowAddStatsModal(true)} className="btn btn-primary">
                                            <Icons.Plus className="w-5 h-5" />{t.addStats}
                                        </button>
                                    )}
                                </div>
                            )}
                        </div>
                        </>
                        )}
                        
                        {/* Plans View */}
                        {activeTab === 'plans' && (
                            <PlansView 
                                savedAnalyses={savedAnalyses} 
                                onDelete={deletePlan}
                                toast={toast}
                                t={t}
                            />
                        )}
                    </div>
                    
                    {/* Bottom Navigation (Mobile) */}
                    <nav className="bottom-nav mobile-only">
                        <button onClick={() => setActiveTab('stats')} className={`bottom-nav-item ${activeTab === 'stats' ? 'active' : ''}`}>
                            <Icons.BarChart />
                            <span>Статистика</span>
                        </button>
                        {isOwner && (
                            <button onClick={() => setShowAIModal(true)} className={`bottom-nav-item`}>
                                <Icons.Brain />
                                <span>AI</span>
                            </button>
                        )}
                        {isOwner && (
                            <button onClick={() => setActiveTab('plans')} className={`bottom-nav-item ${activeTab === 'plans' ? 'active' : ''}`}>
                                <Icons.FileText />
                                <span>Плани</span>
                            </button>
                        )}
                        <button onClick={() => setShowMenu(true)} className="bottom-nav-item">
                            <Icons.Menu />
                            <span>Меню</span>
                        </button>
                    </nav>
                    
                    {/* FAB + Quick Actions (Mobile) */}
                    {isOwner && (
                        <>
                            {showQuickActions && (
                                <div className="quick-actions mobile-only animate-fade-in">
                                    <button onClick={() => { setShowAddStatsModal(true); setShowQuickActions(false); }} className="quick-action-btn bg-blue-500 text-white" title="Додати показник">
                                        <Icons.BarChart className="w-5 h-5" />
                                    </button>
                                    <button onClick={() => { exportToExcel(); setShowQuickActions(false); }} className="quick-action-btn bg-purple-500 text-white" title="Експорт">
                                        <Icons.Download className="w-5 h-5" />
                                    </button>
                                    <button onClick={() => { setShowDemoModal(true); setShowQuickActions(false); }} className="quick-action-btn bg-amber-500 text-white" title="Демо дані">
                                        <Icons.Sparkles className="w-5 h-5" />
                                    </button>
                                </div>
                            )}
                            <button 
                                onClick={() => {
                                    if (showQuickActions) {
                                        setShowQuickActions(false);
                                    } else {
                                        addRow();
                                    }
                                }}
                                onLongPress={() => setShowQuickActions(true)}
                                onContextMenu={(e) => { e.preventDefault(); setShowQuickActions(!showQuickActions); }}
                                className="fab mobile-only"
                            >
                                <Icons.Plus className={`transition-transform ${showQuickActions ? 'rotate-45' : ''}`} />
                            </button>
                        </>
                    )}
                    
                    {/* Support button - видима на всіх пристроях */}
                    <a href={SUPPORT_URL} target="_blank" rel="noopener noreferrer" className="support-btn">
                        <Icons.MessageCircle className="w-5 h-5" /><span className="hidden sm:inline">{t.support}</span>
                    </a>
                    
                    {/* Mobile menu - покращене */}
                    <Modal isOpen={showMenu} onClose={() => setShowMenu(false)} title="">
                        <div className="space-y-2">
                            {/* User info */}
                            <div className="flex items-center gap-4 p-4 bg-gradient-to-r from-primary-50 to-green-50 rounded-2xl mb-4">
                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center ${isSuperAdmin ? 'bg-gradient-to-br from-red-500 to-pink-500' : 'bg-gradient-to-br from-primary-500 to-primary-600'}`}>
                                    {isSuperAdmin ? <Icons.Shield className="w-7 h-7 text-white" /> : <Icons.User className="w-7 h-7 text-white" />}
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-gray-900">{companyName || t.appName}</p>
                                    <p className="text-sm text-gray-500">{user?.email}</p>
                                    {isSuperAdmin ? (
                                        <span className="badge mt-1 bg-gradient-to-r from-red-500 to-pink-500 text-white">Super Admin</span>
                                    ) : (
                                        <span className={`badge mt-1 ${isOwner ? 'badge-purple' : 'badge-amber'}`}>
                                            {isOwner ? t.owner : t.employee}
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            {/* Super Admin Panel */}
                            {isSuperAdmin && (
                                <>
                                    <div className="pt-2 pb-1">
                                        <p className="text-xs font-semibold text-red-400 uppercase tracking-wider px-1">🛡️ Super Admin</p>
                                    </div>
                                    <button onClick={() => { setShowAdminPanel(true); setShowMenu(false); }} className="btn bg-gradient-to-r from-red-500 to-pink-500 text-white w-full justify-start">
                                        <Icons.Shield className="w-5 h-5" />Адмін-панель
                                    </button>
                                </>
                            )}
                            
                            {/* Language */}
                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-2xl">
                                <span className="font-medium flex items-center gap-2">
                                    <Icons.Globe className="w-5 h-5 text-gray-400" />
                                    Мова
                                </span>
                                <select value={language} onChange={(e) => setLanguage(e.target.value)} className="px-4 py-2 bg-white rounded-xl text-sm font-medium border border-gray-200">
                                    <option value="uk">🇺🇦 Українська</option>
                                    <option value="ru">🇷🇺 Русский</option>
                                </select>
                            </div>
                            
                            {isOwner && (
                                <>
                                    <div className="pt-2 pb-1">
                                        <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-1">Дії</p>
                                    </div>
                                    <button onClick={() => { setShowAIModal(true); setShowMenu(false); }} className="btn btn-ai w-full justify-start">
                                        <Icons.Brain className="w-5 h-5" />AI Аналіз
                                    </button>
                                    <button onClick={() => { setShowAddStatsModal(true); setShowMenu(false); }} className="btn btn-primary w-full justify-start">
                                        <Icons.Plus className="w-5 h-5" />{t.addStats}
                                    </button>
                                    <button onClick={() => { addRow(); setShowMenu(false); }} className="btn btn-secondary w-full justify-start">
                                        <Icons.Plus className="w-5 h-5" />{t.addRow}
                                    </button>
                                    
                                    <div className="pt-4 pb-1">
                                        <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-1">TALKO Екосистема</p>
                                    </div>
                                    <a href="https://chatgpt.com/g/g-6851a70e282481918ad5c2894ff30b13-statistics" target="_blank" rel="noopener noreferrer" className="btn btn-secondary w-full justify-start">
                                        <Icons.Target className="w-5 h-5" />AI Розробник статистик
                                    </a>
                                    <a href="https://chatgpt.com/g/g-684be37e3bcc81918f64088a2bb094da-instructions-generator" target="_blank" rel="noopener noreferrer" className="btn btn-secondary w-full justify-start">
                                        <Icons.Edit className="w-5 h-5" />Генератор розпоряджень
                                    </a>
                                    <a href="https://alextalko.com/alta" target="_blank" rel="noopener noreferrer" className="btn btn-secondary w-full justify-start">
                                        <Icons.CheckSquare className="w-5 h-5" />TALKO Task Manager
                                    </a>
                                    <a href="https://alextalko.com/tms" target="_blank" rel="noopener noreferrer" className="btn btn-secondary w-full justify-start">
                                        <Icons.GitBranch className="w-5 h-5" />Структура компанії
                                    </a>
                                    
                                    <div className="pt-4 pb-1">
                                        <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-1">Управління</p>
                                    </div>
                                    <button onClick={() => { setShowTeamModal(true); setShowMenu(false); }} className="btn btn-secondary w-full justify-start">
                                        <Icons.Users className="w-5 h-5" />{t.teamManagement}
                                    </button>
                                </>
                            )}
                            
                            <div className="pt-4 pb-1">
                                <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-1">Інше</p>
                            </div>
                            <button onClick={() => { exportToExcel(); setShowMenu(false); }} className="btn btn-primary w-full justify-start">
                                <Icons.Download className="w-5 h-5" />Експорт в Excel
                            </button>
                            <button onClick={() => { setShowMenu(false); setShowDemoModal(true); }} className="btn btn-secondary w-full justify-start">
                                <Icons.Play className="w-5 h-5" />Демо-дані для тестування
                            </button>
                            <a href={GPT_BOTTLENECK_URL} target="_blank" rel="noopener noreferrer" className="btn btn-secondary w-full justify-start" onClick={() => setShowMenu(false)}>
                                <Icons.Brain className="w-5 h-5" />AI Аналіз вузьких місць
                            </a>
                            <a href={SUPPORT_URL} target="_blank" rel="noopener noreferrer" className="btn btn-secondary w-full justify-start" onClick={() => setShowMenu(false)}>
                                <Icons.MessageCircle className="w-5 h-5" />{t.support}
                            </a>
                            
                            <div className="pt-2">
                                <button onClick={() => { handleLogout(); setShowMenu(false); }} className="btn btn-ghost w-full justify-start text-red-500">
                                    <Icons.LogOut className="w-5 h-5" />{t.logout}
                                </button>
                            </div>
                        </div>
                    </Modal>
                    
                    {/* Add stats modal */}
                    <Modal isOpen={showAddStatsModal} onClose={() => setShowAddStatsModal(false)} title={t.addStats}>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.statsName} *</label>
                                <input type="text" value={newStatsName} onChange={(e) => setNewStatsName(e.target.value)} className="input-field" placeholder="Наприклад: Продажі" autoFocus />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.responsible}</label>
                                <input type="text" value={newStatsResponsible} onChange={(e) => setNewStatsResponsible(e.target.value)} className="input-field" placeholder="Наприклад: Іван" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.period}</label>
                                <select value={newStatsPeriod} onChange={(e) => setNewStatsPeriod(e.target.value)} className="select-field">
                                    <option value="daily">{t.periodDaily}</option>
                                    <option value="weekly">{t.periodWeekly}</option>
                                    <option value="monthly">{t.periodMonthly}</option>
                                    <option value="custom">{t.periodCustom}</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.target}</label>
                                <input type="text" value={newStatsTarget} onChange={(e) => setNewStatsTarget(e.target.value)} className="input-field" placeholder="Наприклад: 100" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.valueFormat}</label>
                                <div className="grid grid-cols-5 gap-2">
                                    {[
                                        { value: 'number', label: '123', title: t.formatNumber },
                                        { value: 'percent', label: '%', title: t.formatPercent },
                                        { value: 'uah', label: '₴', title: t.formatUAH },
                                        { value: 'usd', label: '$', title: t.formatUSD },
                                        { value: 'eur', label: '€', title: t.formatEUR },
                                    ].map(fmt => (
                                        <button
                                            key={fmt.value}
                                            type="button"
                                            onClick={() => setNewStatsFormat(fmt.value)}
                                            title={fmt.title}
                                            className={`p-3 rounded-xl text-lg font-bold transition-all ${newStatsFormat === fmt.value ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                        >
                                            {fmt.label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.importance || 'Важливість'}</label>
                                <div className="grid grid-cols-2 gap-2">
                                    {[
                                        { value: 'critical', label: 'Критично', desc: 'Впливає на гроші', color: 'bg-red-500', icon: 'DollarSign' },
                                        { value: 'high', label: 'Висока', desc: 'Важливий процес', color: 'bg-orange-500', icon: 'AlertCircle' },
                                        { value: 'medium', label: 'Середня', desc: 'Стандартний', color: 'bg-yellow-500', icon: 'Minus' },
                                        { value: 'low', label: 'Низька', desc: 'Допоміжний', color: 'bg-green-500', icon: 'Check' },
                                    ].map(imp => {
                                        const IconComponent = Icons[imp.icon];
                                        return (
                                            <button
                                                key={imp.value}
                                                type="button"
                                                onClick={() => setNewStatsImportance(imp.value)}
                                                className={`p-2 rounded-xl text-left transition-all ${newStatsImportance === imp.value ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                            >
                                                <div className="font-medium text-sm flex items-center gap-2">
                                                    <span className={`w-3 h-3 rounded-full ${imp.color}`}></span>
                                                    {imp.label}
                                                </div>
                                                <div className={`text-xs ${newStatsImportance === imp.value ? 'text-white/80' : 'text-gray-500'}`}>{imp.desc}</div>
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                            <div className="flex gap-3 pt-2">
                                <button onClick={() => setShowAddStatsModal(false)} className="btn btn-secondary flex-1">{t.cancel}</button>
                                <button onClick={addColumn} disabled={!newStatsName.trim()} className="btn btn-primary flex-1">{t.add}</button>
                            </div>
                        </div>
                    </Modal>
                    
                    {/* Edit column modal */}
                    <Modal isOpen={showEditColumnModal} onClose={() => { setShowEditColumnModal(false); setEditingColumn(null); }} title={t.editColumn}>
                        {editingColumn && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.statsName}</label>
                                    <input type="text" value={editingColumn.name} onChange={(e) => setEditingColumn({ ...editingColumn, name: e.target.value })} className="input-field" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.responsible}</label>
                                    <input type="text" value={editingColumn.responsible || ''} onChange={(e) => setEditingColumn({ ...editingColumn, responsible: e.target.value })} className="input-field" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.period}</label>
                                    <select value={editingColumn.period} onChange={(e) => setEditingColumn({ ...editingColumn, period: e.target.value })} className="select-field">
                                        <option value="daily">{t.periodDaily}</option>
                                        <option value="weekly">{t.periodWeekly}</option>
                                        <option value="monthly">{t.periodMonthly}</option>
                                        <option value="custom">{t.periodCustom}</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.target}</label>
                                    <input type="text" value={targetRow?.values?.[editingColumn.id] || ''} onChange={(e) => updateValue('target', editingColumn.id, e.target.value)} className="input-field" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.valueFormat}</label>
                                    <div className="grid grid-cols-5 gap-2">
                                        {[
                                            { value: 'number', label: '123', title: t.formatNumber },
                                            { value: 'percent', label: '%', title: t.formatPercent },
                                            { value: 'uah', label: '₴', title: t.formatUAH },
                                            { value: 'usd', label: '$', title: t.formatUSD },
                                            { value: 'eur', label: '€', title: t.formatEUR },
                                        ].map(fmt => (
                                            <button
                                                key={fmt.value}
                                                type="button"
                                                onClick={() => setEditingColumn({ ...editingColumn, format: fmt.value })}
                                                title={fmt.title}
                                                className={`p-3 rounded-xl text-lg font-bold transition-all ${(editingColumn.format || 'number') === fmt.value ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                            >
                                                {fmt.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.importance || 'Важливість'}</label>
                                    <div className="grid grid-cols-2 gap-2">
                                        {[
                                            { value: 'critical', label: 'Критично', desc: 'Впливає на гроші', color: 'bg-red-500' },
                                            { value: 'high', label: 'Висока', desc: 'Важливий процес', color: 'bg-orange-500' },
                                            { value: 'medium', label: 'Середня', desc: 'Стандартний', color: 'bg-yellow-500' },
                                            { value: 'low', label: 'Низька', desc: 'Допоміжний', color: 'bg-green-500' },
                                        ].map(imp => (
                                            <button
                                                key={imp.value}
                                                type="button"
                                                onClick={() => setEditingColumn({ ...editingColumn, importance: imp.value })}
                                                className={`p-2 rounded-xl text-left transition-all ${(editingColumn.importance || 'medium') === imp.value ? 'bg-primary-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                                            >
                                                <div className="font-medium text-sm flex items-center gap-2">
                                                    <span className={`w-3 h-3 rounded-full ${imp.color}`}></span>
                                                    {imp.label}
                                                </div>
                                                <div className={`text-xs ${(editingColumn.importance || 'medium') === imp.value ? 'text-white/80' : 'text-gray-500'}`}>{imp.desc}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Кнопки переміщення */}
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">Позиція</label>
                                    <div className="flex gap-2">
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const idx = columns.findIndex(c => c.id === editingColumn.id);
                                                if (idx > 0) {
                                                    moveColumn(editingColumn.id, columns[idx - 1].id);
                                                }
                                            }}
                                            disabled={columns.findIndex(c => c.id === editingColumn.id) === 0}
                                            className="flex-1 btn btn-secondary flex items-center justify-center gap-2 disabled:opacity-50"
                                        >
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                                            Вліво
                                        </button>
                                        <div className="px-4 py-2 bg-gray-100 rounded-xl text-sm font-medium text-gray-600 flex items-center">
                                            {columns.findIndex(c => c.id === editingColumn.id) + 1} / {columns.length}
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                const idx = columns.findIndex(c => c.id === editingColumn.id);
                                                if (idx < columns.length - 1) {
                                                    moveColumn(editingColumn.id, columns[idx + 1].id);
                                                }
                                            }}
                                            disabled={columns.findIndex(c => c.id === editingColumn.id) === columns.length - 1}
                                            className="flex-1 btn btn-secondary flex items-center justify-center gap-2 disabled:opacity-50"
                                        >
                                            Вправо
                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                                        </button>
                                    </div>
                                </div>
                                
                                {Object.keys(employees).length > 0 && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{t.visibleColumns}</label>
                                        <div className="space-y-2">
                                            {Object.entries(employees).map(([empId, emp]) => (
                                                <label key={empId} className="checkbox-item">
                                                    <input
                                                        type="checkbox"
                                                        checked={editingColumn.visibleToEmployees?.includes(empId) || false}
                                                        onChange={(e) => {
                                                            const newVisible = e.target.checked
                                                                ? [...(editingColumn.visibleToEmployees || []), empId]
                                                                : (editingColumn.visibleToEmployees || []).filter(id => id !== empId);
                                                            setEditingColumn({ ...editingColumn, visibleToEmployees: newVisible });
                                                        }}
                                                    />
                                                    <span>{emp.name || emp.email}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex gap-3 pt-2">
                                    <button onClick={() => { deleteColumn(editingColumn.id); setShowEditColumnModal(false); setEditingColumn(null); }} className="btn btn-danger">
                                        <Icons.Trash className="w-4 h-4" />
                                    </button>
                                    <button onClick={() => { setShowEditColumnModal(false); setEditingColumn(null); }} className="btn btn-secondary flex-1">{t.cancel}</button>
                                    <button onClick={() => { updateColumn(editingColumn.id, editingColumn); setShowEditColumnModal(false); setEditingColumn(null); toast.success(t.saved); }} className="btn btn-primary flex-1">{t.save}</button>
                                </div>
                            </div>
                        )}
                    </Modal>
                    
                    {/* Team modal */}
                    <Modal isOpen={showTeamModal} onClose={() => setShowTeamModal(false)} title={t.teamManagement} size="lg">
                        <div className="space-y-4">
                            <button onClick={() => { setSelectedColumns(columns.map(c => c.id)); setShowAddEmployeeModal(true); }} className="btn btn-primary w-full">
                                <Icons.UserPlus className="w-5 h-5" />{t.addEmployee}
                            </button>
                            
                            <h4 className="font-semibold text-gray-700">{t.employees}</h4>
                            
                            {Object.keys(employees).length === 0 ? (
                                <div className="text-center py-8 text-gray-500">{t.noEmployees}</div>
                            ) : (
                                <div className="space-y-3">
                                    {Object.entries(employees).map(([empId, emp]) => (
                                        <div key={empId} className="p-4 bg-gray-50 rounded-xl">
                                            <div className="flex items-center justify-between mb-3">
                                                <div>
                                                    <div className="font-semibold text-gray-900">{emp.name || emp.email}</div>
                                                    <div className="text-sm text-gray-500">{emp.email}</div>
                                                    <span className={`badge mt-2 ${emp.role === 'owner' ? 'badge-primary' : 'badge-green'}`}>
                                                        {emp.role === 'owner' ? 'Власник' : t.activeEmployee}
                                                    </span>
                                                </div>
                                                {emp.role !== 'owner' && (
                                                    <button onClick={() => removeEmployee(empId)} className="btn btn-ghost btn-icon text-red-500"><Icons.Trash className="w-4 h-4" /></button>
                                                )}
                                            </div>
                                            {emp.role !== 'owner' && (
                                            <div>
                                                <p className="text-xs text-gray-500 mb-2">{t.visibleColumns}:</p>
                                                <div className="flex flex-wrap gap-1">
                                                    {columns.map(col => {
                                                        const isVisible = emp.visibleColumns?.includes(col.id);
                                                        return (
                                                            <button
                                                                key={col.id}
                                                                onClick={() => {
                                                                    const newCols = isVisible ? emp.visibleColumns.filter(id => id !== col.id) : [...(emp.visibleColumns || []), col.id];
                                                                    updateEmployeeColumns(empId, newCols);
                                                                }}
                                                                className={`text-xs px-2 py-1 rounded-lg transition-colors ${isVisible ? 'bg-primary-100 text-primary-700' : 'bg-gray-200 text-gray-500'}`}
                                                            >
                                                                {col.name}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </Modal>
                    
                    {/* Add employee modal */}
                    <Modal isOpen={showAddEmployeeModal} onClose={() => { setShowAddEmployeeModal(false); setGeneratedInviteLink(''); setNewEmployeeEmail(''); setNewEmployeeName(''); }} title={t.addEmployee}>
                        <div className="space-y-4">
                            {/* Info */}
                            <div className="p-3 bg-blue-50 border border-blue-200 rounded-xl">
                                <p className="text-sm text-blue-700 flex items-start gap-2">
                                    <Icons.Info className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                    <span>Створіть запрошення з ім'ям співробітника. Він сам введе свою пошту та пароль при реєстрації.</span>
                                </p>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">Ім'я співробітника *</label>
                                <input 
                                    type="text" 
                                    value={newEmployeeName} 
                                    onChange={(e) => setNewEmployeeName(e.target.value)} 
                                    className="input-field" 
                                    placeholder="Наприклад: Іван Петренко"
                                    autoFocus
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">{t.visibleColumns}</label>
                                <div className="flex items-center gap-2 mb-2">
                                    <button 
                                        type="button"
                                        onClick={() => setSelectedColumns(columns.map(c => c.id))}
                                        className="text-xs text-primary-600 hover:underline"
                                    >
                                        Вибрати всі
                                    </button>
                                    <span className="text-gray-300">|</span>
                                    <button 
                                        type="button"
                                        onClick={() => setSelectedColumns([])}
                                        className="text-xs text-gray-500 hover:underline"
                                    >
                                        Зняти всі
                                    </button>
                                </div>
                                <div className="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-xl p-3">
                                    {columns.map(col => (
                                        <label key={col.id} className="checkbox-item">
                                            <input type="checkbox" checked={selectedColumns.includes(col.id)} onChange={(e) => {
                                                setSelectedColumns(e.target.checked ? [...selectedColumns, col.id] : selectedColumns.filter(id => id !== col.id));
                                            }} />
                                            <span>{col.name}</span>
                                            {col.responsible && <span className="text-xs text-gray-400 ml-1">({col.responsible})</span>}
                                        </label>
                                    ))}
                                </div>
                                <p className="text-xs text-gray-500 mt-1">Обрано: {selectedColumns.length} з {columns.length}</p>
                            </div>
                            
                            {generatedInviteLink && (
                                <div className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl">
                                    <p className="text-sm font-bold text-green-800 mb-2 flex items-center gap-2">
                                        <Icons.CheckCircle className="w-5 h-5" />
                                        Запрошення створено!
                                    </p>
                                    <p className="text-xs text-green-700 mb-3">Надішліть це посилання співробітнику:</p>
                                    <div className="flex gap-2">
                                        <input type="text" value={generatedInviteLink} readOnly className="flex-1 px-3 py-2 text-sm bg-white border border-green-200 rounded-lg font-mono" />
                                        <button onClick={copyInviteLink} className="btn btn-primary"><Icons.Copy className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            )}
                            
                            <div className="flex gap-3 pt-2">
                                <button onClick={() => { setShowAddEmployeeModal(false); setGeneratedInviteLink(''); setNewEmployeeName(''); }} className="btn btn-secondary flex-1">
                                    {generatedInviteLink ? 'Закрити' : t.cancel}
                                </button>
                                {!generatedInviteLink && (
                                    <button onClick={addEmployee} disabled={!newEmployeeName.trim()} className="btn btn-primary flex-1">
                                        <Icons.UserPlus className="w-4 h-4" />Створити запрошення
                                    </button>
                                )}
                            </div>
                        </div>
                    </Modal>
                    
                    {/* AI Analysis modal */}
                    <Modal isOpen={showAIModal} onClose={() => setShowAIModal(false)} title={t.aiAnalysis} size="full">
                        <div className="space-y-4">
                            {/* Контекст бізнесу - одразу видимий */}
                            <div className="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-200">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="font-bold text-purple-900 flex items-center gap-2">
                                        <Icons.Building className="w-5 h-5" />
                                        Контекст вашого бізнесу
                                    </h3>
                                    <span className="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full">Обов'язково</span>
                                </div>
                                <textarea
                                    value={aiSettings.businessContext} 
                                    onChange={(e) => setAiSettings({ ...aiSettings, businessContext: e.target.value })}
                                    className="textarea-field border-purple-200 focus:border-purple-400" 
                                    rows={3} 
                                    placeholder="Опишіть ваш бізнес: галузь, послуги, команда, середній чек, канали залучення клієнтів..."
                                />
                            </div>
                            
                            <div className="p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200">
                                <h3 className="font-bold text-amber-900 flex items-center gap-2 mb-3">
                                    <Icons.Target className="w-5 h-5" />
                                    Пріоритети зараз
                                </h3>
                                <textarea
                                    value={aiSettings.priorities} 
                                    onChange={(e) => setAiSettings({ ...aiSettings, priorities: e.target.value })}
                                    className="textarea-field border-amber-200 focus:border-amber-400" 
                                    rows={2} 
                                    placeholder="Що найважливіше зараз? Збільшити продажі, оптимізувати витрати, покращити конверсію..."
                                />
                            </div>
                            
                            {!aiSettings.businessContext && (
                                <div className="p-3 bg-red-50 border border-red-200 rounded-xl flex items-center gap-3">
                                    <Icons.AlertCircle className="w-5 h-5 text-red-500 flex-shrink-0" />
                                    <p className="text-sm text-red-700">Заповніть контекст бізнесу вище — без нього AI не зможе дати корисні рекомендації</p>
                                </div>
                            )}
                            
                            <AIAnalysis columns={visibleColumns} rows={rows} targetRow={targetRow} aiSettings={aiSettings} language={language} onSaveAnalysis={saveAnalysis} savedAnalyses={savedAnalyses} t={t} />
                        </div>
                    </Modal>
                    
                    {/* AI Settings modal - видалено, тепер все в одному місці */}
                    
                    {/* Admin Panel modal (Super Admin only) */}
                    {isSuperAdmin && (
                        <Modal isOpen={showAdminPanel} onClose={() => setShowAdminPanel(false)} title="🛡️ Адмін-панель" size="lg">
                            <div className="space-y-6">
                                {/* Create Company Form */}
                                <div className="p-5 bg-gradient-to-r from-red-50 to-pink-50 border border-red-200 rounded-2xl">
                                    <h3 className="font-bold text-red-900 flex items-center gap-2 mb-4">
                                        <Icons.Building className="w-5 h-5" />
                                        Створити нову компанію
                                    </h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Назва компанії *</label>
                                            <input 
                                                type="text" 
                                                value={newCompanyName} 
                                                onChange={(e) => setNewCompanyName(e.target.value)} 
                                                className="input-field" 
                                                placeholder="Наприклад: Клініка Здоров'я"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Email власника *</label>
                                            <input 
                                                type="email" 
                                                value={newOwnerEmail} 
                                                onChange={(e) => setNewOwnerEmail(e.target.value)} 
                                                className="input-field" 
                                                placeholder="owner@company.com"
                                            />
                                            <p className="text-xs text-gray-500 mt-1">Після створення — додайте цього юзера в Firebase Console</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Ім'я власника</label>
                                            <input 
                                                type="text" 
                                                value={newOwnerName} 
                                                onChange={(e) => setNewOwnerName(e.target.value)} 
                                                className="input-field" 
                                                placeholder="Іван Петренко"
                                            />
                                        </div>
                                        <button 
                                            onClick={createCompany} 
                                            disabled={adminLoading || !newCompanyName.trim() || !newOwnerEmail.trim()}
                                            className="btn btn-primary w-full"
                                        >
                                            {adminLoading ? <Icons.Loader className="w-5 h-5" /> : (
                                                <><Icons.Plus className="w-5 h-5" />Створити компанію</>
                                            )}
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Companies List */}
                                <div>
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="font-bold text-gray-900 flex items-center gap-2">
                                            <Icons.Building className="w-5 h-5 text-gray-600" />
                                            Компанії ({adminCompanies.length})
                                        </h3>
                                        <button onClick={loadAdminCompanies} className="btn btn-ghost btn-sm">
                                            <Icons.RefreshCw className="w-4 h-4" />
                                        </button>
                                    </div>
                                    
                                    {adminCompanies.length === 0 ? (
                                        <div className="text-center py-8 text-gray-500">
                                            <Icons.Building className="w-12 h-12 mx-auto mb-2 text-gray-300" />
                                            <p>Компаній ще немає</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2 max-h-80 overflow-y-auto">
                                            {adminCompanies.map(company => (
                                                <div key={company.id} className="p-4 bg-gray-50 rounded-xl">
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <h4 className="font-bold text-gray-900">{company.name}</h4>
                                                            <p className="text-sm text-gray-500 flex items-center gap-1 mt-1">
                                                                <Icons.User className="w-3 h-3" />
                                                                {company.ownerEmail}
                                                            </p>
                                                            <div className="flex items-center gap-3 mt-2 text-xs text-gray-400">
                                                                <span className="flex items-center gap-1">
                                                                    <Icons.BarChart className="w-3 h-3" />
                                                                    {company.columns?.length || 0} показників
                                                                </span>
                                                                <span className="flex items-center gap-1">
                                                                    <Icons.Calendar className="w-3 h-3" />
                                                                    {(company.rows?.length || 1) - 1} записів
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => deleteCompany(company.id, company.name)}
                                                            className="btn btn-ghost btn-icon text-red-500 hover:bg-red-50"
                                                        >
                                                            <Icons.Trash className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                    {/* Copy owner email for Firebase */}
                                                    <button 
                                                        onClick={() => {
                                                            navigator.clipboard.writeText(company.ownerEmail);
                                                            toast.success('Email скопійовано!');
                                                        }}
                                                        className="mt-2 text-xs text-primary-600 hover:text-primary-700 flex items-center gap-1"
                                                    >
                                                        <Icons.Copy className="w-3 h-3" />
                                                        Скопіювати email для Firebase
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                
                                {/* Instructions */}
                                <div className="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                                    <h4 className="font-bold text-amber-900 flex items-center gap-2 mb-2">
                                        <Icons.Info className="w-4 h-4" />
                                        Як додати власника
                                    </h4>
                                    <ol className="text-sm text-amber-800 space-y-1 list-decimal list-inside">
                                        <li>Створіть компанію вище</li>
                                        <li>Скопіюйте email власника</li>
                                        <li>Зайдіть в <b>Firebase Console → Authentication</b></li>
                                        <li>Натисніть <b>Add user</b></li>
                                        <li>Вставте email та придумайте пароль</li>
                                        <li>Власник зможе увійти та керувати компанією</li>
                                    </ol>
                                </div>
                            </div>
                        </Modal>
                    )}
                    
                    {/* Demo Modal */}
                    <Modal isOpen={showDemoModal} onClose={() => setShowDemoModal(false)} title="🎮 Оберіть тип бізнесу">
                        <div className="space-y-3">
                            <p className="text-gray-600 text-sm mb-4">Завантажте демо-дані для тестування системи та AI-аналізу</p>
                            
                            {Object.entries(DEMO_DATA).map(([key, demo]) => (
                                <button 
                                    key={key}
                                    onClick={() => {
                                        if (columns.length > 0 && !isSuperAdmin) {
                                            setConfirmDialog({
                                                isOpen: true,
                                                title: 'Завантажити демо-дані?',
                                                message: 'Поточні дані будуть замінені на демонстраційні. Продовжити?',
                                                onConfirm: () => loadDemoData(key)
                                            });
                                            setShowDemoModal(false);
                                        } else {
                                            loadDemoData(key);
                                        }
                                    }}
                                    className="w-full p-4 text-left bg-gray-50 hover:bg-primary-50 border-2 border-gray-200 hover:border-primary-300 rounded-2xl transition-all"
                                >
                                    <div className="flex items-center gap-3">
                                        <span className="text-2xl">{demo.name.split(' ')[0]}</span>
                                        <div>
                                            <h3 className="font-bold text-gray-900">{demo.name.split(' ').slice(1).join(' ')}</h3>
                                            <p className="text-sm text-gray-500">{demo.companyName}</p>
                                        </div>
                                    </div>
                                </button>
                            ))}
                            
                            <div className="pt-3 border-t mt-4">
                                <p className="text-xs text-gray-400 text-center">
                                    💡 Після завантаження спробуйте <b>AI Аналіз</b> — контекст бізнесу вже заповнений
                                </p>
                            </div>
                        </div>
                    </Modal>
                    
                    {/* Confirm dialog */}
                    {/* Demo selection modal */}
                    <Modal isOpen={showDemoModal} onClose={() => setShowDemoModal(false)} title="🎮 Виберіть тип бізнесу для демо">
                        <div className="space-y-3">
                            <p className="text-sm text-gray-600 mb-4">
                                Завантажте реалістичні демо-дані для тестування AI-аналізу та функціоналу системи
                            </p>
                            
                            {columns.length > 0 && (
                                <div className="p-3 bg-amber-50 border border-amber-200 rounded-xl flex items-center gap-2 mb-4">
                                    <Icons.AlertTriangle className="w-5 h-5 text-amber-500 flex-shrink-0" />
                                    <p className="text-sm text-amber-700">Поточні дані будуть замінені на демонстраційні</p>
                                </div>
                            )}
                            
                            {Object.entries(DEMO_DATA).map(([key, demo]) => (
                                <button
                                    key={key}
                                    onClick={() => loadDemoData(key)}
                                    className="w-full p-4 bg-white border-2 border-gray-200 rounded-2xl hover:border-primary-500 hover:bg-primary-50 transition-all text-left group"
                                >
                                    <div className="flex items-center gap-3">
                                        <div className="text-2xl">{demo.name.split(' ')[0]}</div>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-gray-900 group-hover:text-primary-700">{demo.name.split(' ').slice(1).join(' ')}</h3>
                                            <p className="text-sm text-gray-500">{demo.companyName}</p>
                                        </div>
                                        <Icons.ArrowRight className="w-5 h-5 text-gray-400 group-hover:text-primary-500 group-hover:translate-x-1 transition-transform" />
                                    </div>
                                </button>
                            ))}
                            
                            <div className="pt-3 border-t border-gray-100 mt-4">
                                <p className="text-xs text-gray-400 text-center">
                                    9 показників • 6 тижнів даних • Заповнений контекст для AI
                                </p>
                            </div>
                        </div>
                    </Modal>
                    
                    <ConfirmDialog isOpen={confirmDialog.isOpen} onClose={() => setConfirmDialog({ isOpen: false })} onConfirm={confirmDialog.onConfirm} title={confirmDialog.title} message={confirmDialog.message} />
                </div>
            );
        };

        // ==================== ROOT ====================
        const Root = () => (<ToastProvider><App /></ToastProvider>);
        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
