<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#22c55e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Трекер статистики Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d' }
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html, body { font-family: 'Inter', system-ui, sans-serif; -webkit-font-smoothing: antialiased; overscroll-behavior: none; }
        
        /* Safe area для notched devices */
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-slide-down { animation: slideDown 0.2s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-bounce { animation: bounce 0.6s ease-in-out; }
        
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        /* Toast */
        .toast-container { position: fixed; top: calc(12px + var(--sat)); left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 8px; pointer-events: none; width: calc(100% - 32px); max-width: 400px; }
        .toast { padding: 14px 18px; border-radius: 14px; font-weight: 600; font-size: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; pointer-events: auto; animation: slideDown 0.3s ease-out; background: #fff; }
        .toast-success { border-left: 4px solid #22c55e; }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-info { border-left: 4px solid #3b82f6; }
        .toast-warning { border-left: 4px solid #f59e0b; }
        
        /* Cards */
        .card { background: white; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06); }
        
        /* Inputs - більші для мобільного */
        .input-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 16px; transition: all 0.2s; min-height: 52px; }
        .input-field:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1); }
        .input-field:disabled { background: #f9fafb; cursor: not-allowed; }
        
        .textarea-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 15px; transition: all 0.2s; resize: vertical; min-height: 100px; line-height: 1.5; }
        .textarea-field:focus { outline: none; border-color: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1); }
        
        /* Buttons - великі touch targets */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 22px; font-weight: 600; font-size: 15px; border-radius: 14px; transition: all 0.2s; cursor: pointer; border: none; min-height: 52px; -webkit-user-select: none; user-select: none; }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3); }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4); }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover:not(:disabled) { background: #e5e7eb; }
        .btn-ghost { background: transparent; color: #6b7280; }
        .btn-ghost:hover:not(:disabled) { background: #f3f4f6; }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .btn-ai { background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3); }
        .btn-ai:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4); }
        .btn-icon { width: 52px; height: 52px; padding: 0; border-radius: 14px; }
        .btn-sm { padding: 10px 16px; font-size: 14px; min-height: 44px; border-radius: 12px; }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; letter-spacing: 0.3px; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-amber { background: #fef3c7; color: #92400e; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-purple { background: #f3e8ff; color: #6b21a8; }
        
        /* Progress */
        .progress-bar { height: 8px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease-out; }
        
        /* Modal - оптимізовано для мобільного */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9000; animation: fadeIn 0.2s ease-out; }
        .modal-content { position: fixed; background: white; z-index: 9001; overflow-y: auto; overscroll-behavior: contain; }
        @media (min-width: 640px) { 
            .modal-content { top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 24px; width: 90%; max-height: 90vh; animation: scaleIn 0.3s ease-out; } 
        }
        @media (max-width: 639px) { 
            .modal-content { 
                bottom: 0; left: 0; right: 0; 
                border-radius: 24px 24px 0 0; 
                max-height: calc(95vh - var(--sat)); 
                animation: slideUp 0.3s ease-out;
                padding-bottom: calc(20px + var(--sab));
            } 
        }
        .sheet-handle { width: 40px; height: 5px; background: #d1d5db; border-radius: 10px; margin: 10px auto 20px; }
        
        /* Stats Card - мобільна картка */
        .stats-card { 
            background: white; 
            border-radius: 20px; 
            padding: 18px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); 
            border: 1px solid #f3f4f6;
            transition: all 0.2s;
        }
        .stats-card:active { transform: scale(0.99); background: #fafafa; }
        
        /* Stats Table - десктоп */
        .stats-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .stats-table th { background: #f9fafb; padding: 14px 18px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; z-index: 10; }
        .stats-table td { padding: 14px 18px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .stats-table tr:hover td { background: #f9fafb; }
        .stats-table .sticky-col { position: sticky; left: 0; background: white; z-index: 5; box-shadow: 2px 0 4px rgba(0,0,0,0.05); }
        .stats-table tr:hover .sticky-col { background: #f9fafb; }
        .target-row { background: linear-gradient(90deg, #fef3c7 0%, #fefce8 100%); }
        .target-row td { border-bottom: 2px solid #fcd34d; }
        .target-row .sticky-col { background: linear-gradient(90deg, #fef3c7 0%, #fefce8 100%); }
        
        /* Bottom Navigation - мобільна навігація */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 16px calc(8px + var(--sab));
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 16px;
            border-radius: 12px;
            color: #9ca3af;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .bottom-nav-item:active { transform: scale(0.95); }
        .bottom-nav-item.active { color: #22c55e; background: #f0fdf4; }
        .bottom-nav-item svg { width: 24px; height: 24px; }
        
        /* FAB - floating action button */
        .fab { 
            position: fixed; 
            bottom: calc(80px + var(--sab)); 
            right: 20px; 
            width: 60px; 
            height: 60px; 
            border-radius: 18px; 
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); 
            color: white; 
            border: none; 
            box-shadow: 0 6px 24px rgba(34, 197, 94, 0.4); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            z-index: 99;
        }
        .fab:active { transform: scale(0.92); }
        .fab svg { width: 28px; height: 28px; }
        
        /* Quick actions - швидкі дії */
        .quick-actions {
            position: fixed;
            bottom: calc(150px + var(--sab));
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 98;
        }
        .quick-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transition: all 0.2s;
        }
        .quick-action-btn:active { transform: scale(0.92); }
        
        /* Period badge */
        .period-badge { font-size: 11px; padding: 4px 8px; border-radius: 8px; background: #e0e7ff; color: #3730a3; font-weight: 600; }
        
        /* Status dots */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-filled { background: #22c55e; box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2); }
        .status-pending { background: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
        .status-overdue { background: #ef4444; box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2); }
        
        /* AI Result */
        .ai-result { background: linear-gradient(135deg, #faf5ff 0%, #f0f9ff 100%); border: 1px solid #e9d5ff; border-radius: 20px; padding: 20px; }
        
        /* Support button - плаваюча кнопка */
        .support-btn {
            position: fixed;
            bottom: 24px;
            left: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 50px;
            font-weight: 600;
            font-size: 15px;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            text-decoration: none;
            transition: all 0.2s;
            z-index: 100;
        }
        .support-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }
        .support-btn:active {
            transform: scale(0.96);
        }
        @media (max-width: 640px) {
            .support-btn {
                bottom: calc(80px + var(--sab));
                left: 16px;
                padding: 14px;
                border-radius: 50%;
            }
        }
        
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .desktop-only { display: none !important; }
            body { padding-bottom: calc(70px + var(--sab)); }
            .btn { min-height: 52px; }
            .btn-icon { width: 52px; height: 52px; }
            .input-field { min-height: 52px; font-size: 16px; }
            .card { border-radius: 20px; }
            
            /* Покращений scroll */
            .scroll-container { 
                -webkit-overflow-scrolling: touch; 
                scroll-behavior: smooth;
                overscroll-behavior: contain;
            }
            
            /* Більші touch targets для value inputs */
            .value-input {
                min-height: 48px;
                font-size: 18px;
                font-weight: 600;
                text-align: center;
                border-radius: 12px;
            }
        }
        @media (min-width: 641px) { 
            .mobile-only { display: none !important; } 
            .bottom-nav { display: none; }
        }
        
        /* Checkbox items */
        .checkbox-item { display: flex; align-items: center; gap: 14px; padding: 14px; background: #f9fafb; border-radius: 14px; cursor: pointer; transition: all 0.2s; }
        .checkbox-item:active { background: #f3f4f6; transform: scale(0.98); }
        .checkbox-item input[type="checkbox"] { width: 22px; height: 22px; accent-color: #22c55e; cursor: pointer; }
        
        /* Select field */
        .select-field { width: 100%; padding: 14px 18px; background: white; border: 2px solid #e5e7eb; border-radius: 14px; font-size: 16px; transition: all 0.2s; cursor: pointer; min-height: 52px; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 44px; }
        .select-field:focus { outline: none; border-color: #22c55e; }
        
        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px 24px;
            text-align: center;
        }
        .empty-state-icon {
            width: 80px;
            height: 80px;
            border-radius: 24px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        /* Pull to refresh indicator */
        .pull-indicator {
            position: fixed;
            top: calc(var(--sat) + 60px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #22c55e;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo, createContext, useContext } = React;

        // ==================== CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyA850ceFuupxSBL9WwoKovkDzIshPAl_W8",
            authDomain: "stats-tracker-ai.firebaseapp.com",
            projectId: "stats-tracker-ai",
            storageBucket: "stats-tracker-ai.firebasestorage.app",
            messagingSenderId: "373376418182",
            appId: "1:373376418182:web:1b4cf979f73a8e6271ec07"
        };

        // OpenAI API Key (встановіть ліміт $20 в OpenAI Dashboard!)
        const OPENAI_API_KEY = null; // Ключ зберігається в Cloudflare Worker
        const OPENAI_MODEL = "gpt-4o";

        const SUPPORT_URL = "https://chatgpt.com/g/g-693bf67a13e48191940632f9d6bedb63-talko-statistics-ai-support";

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        db.enablePersistence().catch(console.log);

        // ==================== SVG ICONS ====================
        const Icons = {
            Menu: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            Close: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Plus: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Edit: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>,
            Check: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M20 6 9 17l-5-5"/></svg>,
            Copy: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            Undo: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>,
            BarChart: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>,
            Target: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Calendar: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>,
            Download: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            User: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Users: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            UserPlus: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
            Crown: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>,
            LogOut: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Mail: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
            Lock: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Eye: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49"/><path d="M14.084 14.158a3 3 0 0 1-4.242-4.242"/><path d="M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143"/><path d="m2 2 20 20"/></svg>,
            Settings: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            AlertCircle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            CheckCircle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            Info: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Loader: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin" {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            MessageCircle: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>,
            Link: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            Sparkles: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>,
            Globe: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
            ChevronDown: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m6 9 6 6 6-6"/></svg>,
            Building: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>,
            Brain: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.967-.516"/><path d="M19.967 17.484A4 4 0 0 1 18 18"/></svg>,
            Clock: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Save: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>,
            History: (p) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
        };

        // ==================== TRANSLATIONS ====================
        const translations = {
            uk: {
                appName: 'Трекер статистики',
                loading: 'Завантаження...',
                login: 'Вхід', register: 'Реєстрація', email: 'Email', password: 'Пароль',
                loginBtn: 'Увійти', registerBtn: 'Зареєструватися', logout: 'Вийти',
                noAccount: 'Немає акаунту?', hasAccount: 'Вже є акаунт?',
                companyName: 'Назва компанії', companyPlaceholder: 'Наприклад: Клініка "Здоров\'я"',
                owner: 'Власник', employee: 'Співробітник',
                menu: 'Меню', dashboard: 'Дашборд', statistics: 'Статистика', team: 'Команда', settings: 'Налаштування',
                add: 'Додати', save: 'Зберегти', cancel: 'Скасувати', delete: 'Видалити', edit: 'Редагувати', close: 'Закрити', confirm: 'Підтвердити', copy: 'Копіювати', undo: 'Відмінити',
                addStats: 'Додати показник', addRow: 'Додати запис', statsName: 'Назва показника', responsible: 'Відповідальний',
                date: 'Дата', target: 'Ціль', value: 'Значення', progress: 'Прогрес', comment: 'Коментар', addComment: 'Додати коментар',
                period: 'Періодичність', periodDaily: 'Щодня', periodWeekly: 'Щотижня', periodMonthly: 'Щомісяця', periodCustom: 'Довільно',
                search: 'Пошук...', noData: 'Даних поки немає',
                teamManagement: 'Управління командою', addEmployee: 'Додати співробітника', employeeEmail: 'Email співробітника', employeeName: "Ім'я співробітника",
                employees: 'Співробітники', noEmployees: 'Співробітників ще немає', removeEmployee: 'Видалити співробітника',
                visibleColumns: 'Доступ до показників', pendingInvite: 'Очікує', activeEmployee: 'Активний',
                inviteLink: 'Посилання для входу', linkCopied: 'Скопійовано!', joinWorkspace: 'Приєднатися', enterInviteCode: 'Код запрошення', joinBtn: 'Приєднатися',
                export: 'Експорт', import: 'Імпорт', exportExcel: 'Експорт Excel', importExcel: 'Імпорт Excel',
                saving: 'Збереження...', saved: 'Збережено', saveError: 'Помилка',
                columns: 'Показників', periods: 'Записів', values: 'Значень',
                support: 'Підтримка',
                confirmDelete: 'Видалити?', confirmClear: 'Очистити всі дані?',
                aiAnalysis: 'AI Аналіз', aiSettings: 'Налаштування AI',
                businessContext: 'Контекст бізнесу', businessContextPlaceholder: 'Опишіть ваш бізнес: галузь, послуги, середній чек, кількість співробітників...',
                priorities: 'Пріоритети зараз', prioritiesPlaceholder: 'Що найважливіше зараз? Збільшення продажів, оптимізація витрат...',
                analysisPeriod: 'Період аналізу', additionalFocus: 'Додатковий фокус', additionalFocusPlaceholder: 'Наприклад: Чому впали продажі у п\'ятницю?',
                runAnalysis: 'Запустити аналіз', analyzing: 'Аналізую...',
                lastWeeks: 'тижнів', aiResult: 'Результат аналізу', saveAnalysis: 'Зберегти', analysisHistory: 'Історія аналізів',
                overview: 'Загальна картина', bottleneck: 'Вузьке місце', recommendations: 'Рекомендації', weekPlan: 'План на тиждень',
                filled: 'Заповнено', pending: 'Очікує', overdue: 'Прострочено',
                editColumn: 'Редагувати показник', columnSettings: 'Налаштування показника',
            },
            ru: {
                appName: 'Трекер статистики',
                loading: 'Загрузка...',
                login: 'Вход', register: 'Регистрация', email: 'Email', password: 'Пароль',
                loginBtn: 'Войти', registerBtn: 'Зарегистрироваться', logout: 'Выйти',
                noAccount: 'Нет аккаунта?', hasAccount: 'Уже есть аккаунт?',
                companyName: 'Название компании', companyPlaceholder: 'Например: Клиника "Здоровье"',
                owner: 'Владелец', employee: 'Сотрудник',
                menu: 'Меню', add: 'Добавить', save: 'Сохранить', cancel: 'Отмена', delete: 'Удалить',
                addStats: 'Добавить показатель', addRow: 'Добавить запись', statsName: 'Название показателя', responsible: 'Ответственный',
                date: 'Дата', target: 'Цель', value: 'Значение', comment: 'Комментарий',
                period: 'Периодичность', periodDaily: 'Ежедневно', periodWeekly: 'Еженедельно', periodMonthly: 'Ежемесячно', periodCustom: 'Произвольно',
                teamManagement: 'Управление командой', addEmployee: 'Добавить сотрудника',
                aiAnalysis: 'AI Анализ', businessContext: 'Контекст бизнеса', priorities: 'Приоритеты', runAnalysis: 'Запустить анализ',
                overview: 'Общая картина', bottleneck: 'Узкое место', recommendations: 'Рекомендации', weekPlan: 'План на неделю',
            }
        };

        // ==================== TOAST ====================
        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = useCallback((message, type = 'info', duration = 3000) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), duration);
            }, []);
            const toast = useMemo(() => ({
                success: (msg) => addToast(msg, 'success'),
                error: (msg) => addToast(msg, 'error'),
                info: (msg) => addToast(msg, 'info'),
                warning: (msg) => addToast(msg, 'warning'),
            }), [addToast]);
            return (
                <ToastContext.Provider value={toast}>
                    {children}
                    <div className="toast-container">
                        {toasts.map(t => (
                            <div key={t.id} className={`toast toast-${t.type}`}>
                                {t.type === 'success' && <Icons.CheckCircle className="w-5 h-5 text-green-500" />}
                                {t.type === 'error' && <Icons.AlertCircle className="w-5 h-5 text-red-500" />}
                                {t.type === 'info' && <Icons.Info className="w-5 h-5 text-blue-500" />}
                                {t.type === 'warning' && <Icons.AlertCircle className="w-5 h-5 text-amber-500" />}
                                <span>{t.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToast = () => useContext(ToastContext);

        // ==================== MODAL ====================
        const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
            useEffect(() => {
                if (isOpen) document.body.style.overflow = 'hidden';
                return () => { document.body.style.overflow = ''; };
            }, [isOpen]);
            if (!isOpen) return null;
            const sizeClass = size === 'lg' ? 'sm:max-w-lg' : size === 'xl' ? 'sm:max-w-2xl' : size === '2xl' ? 'sm:max-w-4xl' : size === 'full' ? 'sm:max-w-[90vw] sm:max-h-[90vh]' : 'sm:max-w-md';
            const heightClass = size === '2xl' || size === 'full' ? 'max-h-[85vh]' : 'max-h-[70vh]';
            return (
                <>
                    <div className="modal-overlay" onClick={onClose} />
                    <div className={`modal-content ${sizeClass}`}>
                        <div className="sm:hidden"><div className="sheet-handle" /></div>
                        <div className="p-5">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-xl font-bold text-gray-900">{title}</h2>
                                <button onClick={onClose} className="btn btn-ghost btn-icon"><Icons.Close className="w-5 h-5" /></button>
                            </div>
                            <div className={`${heightClass} overflow-y-auto`}>{children}</div>
                        </div>
                    </div>
                </>
            );
        };

        // ==================== CONFIRM DIALOG ====================
        const ConfirmDialog = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <>
                    <div className="modal-overlay" onClick={onClose} />
                    <div className="modal-content">
                        <div className="sm:hidden"><div className="sheet-handle" /></div>
                        <div className="p-6 text-center">
                            <div className="w-14 h-14 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                                <Icons.AlertCircle className="w-7 h-7 text-red-500" />
                            </div>
                            <h3 className="text-lg font-bold text-gray-900 mb-2">{title}</h3>
                            {message && <p className="text-gray-600 mb-6">{message}</p>}
                            <div className="flex gap-3">
                                <button onClick={onClose} className="btn btn-secondary flex-1">Скасувати</button>
                                <button onClick={() => { onConfirm(); onClose(); }} className="btn btn-danger flex-1">Підтвердити</button>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // ==================== PROGRESS BAR ====================
        const ProgressBar = ({ value }) => {
            const getColor = () => {
                if (value >= 100) return 'bg-green-500';
                if (value >= 80) return 'bg-blue-500';
                if (value >= 50) return 'bg-amber-500';
                return 'bg-red-500';
            };
            return (
                <div className="progress-bar">
                    <div className={`progress-fill ${getColor()}`} style={{ width: `${Math.min(value, 100)}%` }} />
                </div>
            );
        };

        // ==================== AUTH FORM ====================
        const AuthForm = ({ t, onAuth, isLoading }) => {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [companyName, setCompanyName] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [inviteCode, setInviteCode] = useState('');
            
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const code = params.get('invite');
                if (code) setInviteCode(code);
            }, []);
            
            const handleSubmit = (e) => {
                e.preventDefault();
                onAuth(email, password, isRegister, companyName, inviteCode);
            };
            
            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-primary-50 via-white to-green-50 p-4" style={{ paddingTop: 'calc(env(safe-area-inset-top) + 16px)', paddingBottom: 'calc(env(safe-area-inset-bottom) + 16px)' }}>
                    <div className="w-full max-w-sm animate-fade-in">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 mx-auto mb-5 rounded-3xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-xl shadow-primary-500/30">
                                <Icons.BarChart className="w-10 h-10 text-white" />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-900">{t.appName}</h1>
                            <p className="text-gray-500 mt-2">{isRegister ? t.register : t.login}</p>
                        </div>
                        
                        {inviteCode && (
                            <div className="mb-5 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-2xl text-center">
                                <Icons.UserPlus className="w-8 h-8 text-green-500 mx-auto mb-2" />
                                <p className="font-semibold text-green-800">Вас запросили до команди!</p>
                                <p className="text-sm text-green-600">Зареєструйтесь щоб приєднатися</p>
                            </div>
                        )}
                        
                        <form onSubmit={handleSubmit} className="card p-6 space-y-4">
                            {isRegister && !inviteCode && (
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">{t.companyName}</label>
                                    <div className="relative">
                                        <Icons.Building className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                        <input type="text" value={companyName} onChange={(e) => setCompanyName(e.target.value)} className="input-field pl-12" placeholder={t.companyPlaceholder} required />
                                    </div>
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">{t.email}</label>
                                <div className="relative">
                                    <Icons.Mail className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-field pl-12" placeholder="email@example.com" required autoComplete="email" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">{t.password}</label>
                                <div className="relative">
                                    <Icons.Lock className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                                    <input type={showPassword ? 'text' : 'password'} value={password} onChange={(e) => setPassword(e.target.value)} className="input-field pl-12 pr-14" placeholder="••••••••" required minLength={6} autoComplete={isRegister ? 'new-password' : 'current-password'} />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600">
                                        {showPassword ? <Icons.EyeOff className="w-5 h-5" /> : <Icons.Eye className="w-5 h-5" />}
                                    </button>
                                </div>
                            </div>
                            <button type="submit" className="btn btn-primary w-full text-base" disabled={isLoading}>
                                {isLoading ? <Icons.Loader className="w-5 h-5" /> : (isRegister ? t.registerBtn : t.loginBtn)}
                            </button>
                        </form>
                        
                        <p className="text-center mt-6 text-sm text-gray-600">
                            {isRegister ? t.hasAccount : t.noAccount}{' '}
                            <button onClick={() => setIsRegister(!isRegister)} className="text-primary-600 font-bold hover:underline">
                                {isRegister ? t.login : t.register}
                            </button>
                        </p>
                    </div>
                </div>
            );
        };

        // ==================== PERIOD HELPERS ====================
        const getPeriodLabel = (period, t) => {
            const labels = { daily: t.periodDaily, weekly: t.periodWeekly, monthly: t.periodMonthly, custom: t.periodCustom };
            return labels[period] || period;
        };
        
        const getWeekNumber = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };
        
        const getMonthKey = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${d.getMonth()}`;
        };
        
        const isFilledForPeriod = (rows, colId, period) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            const todayWeek = getWeekNumber(today);
            const todayMonth = getMonthKey(today);
            
            for (const row of rows) {
                if (row.isTarget || !row.values?.[colId]) continue;
                const val = row.values[colId];
                if (!val && val !== 0) continue;
                
                const rowDate = new Date(row.date);
                rowDate.setHours(0, 0, 0, 0);
                
                if (period === 'daily' && row.date === todayStr) return true;
                if (period === 'weekly' && getWeekNumber(rowDate) === todayWeek) return true;
                if (period === 'monthly' && getMonthKey(rowDate) === todayMonth) return true;
                if (period === 'custom') return true;
            }
            return false;
        };

        // ==================== STATS CARD (MOBILE) ====================
        const StatsCard = ({ row, columns, onDelete, onDateChange, onValueChange, onTargetChange, onCommentChange, editable, t }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const [activeComment, setActiveComment] = useState(null);
            const [showTargets, setShowTargets] = useState(false);
            
            const calculateProgress = (colId) => {
                const target = parseFloat(String(row.targets?.[colId] || '').replace(',', '.'));
                const value = parseFloat(String(row.values?.[colId] || '').replace(',', '.'));
                if (isNaN(target) || isNaN(value) || target === 0) return null;
                return Math.round((value / target) * 100);
            };
            
            const getProgressColor = (progress) => {
                if (progress >= 100) return { bg: 'bg-green-500', text: 'text-green-600', light: 'bg-green-100' };
                if (progress >= 80) return { bg: 'bg-blue-500', text: 'text-blue-600', light: 'bg-blue-100' };
                if (progress >= 50) return { bg: 'bg-amber-500', text: 'text-amber-600', light: 'bg-amber-100' };
                return { bg: 'bg-red-500', text: 'text-red-600', light: 'bg-red-100' };
            };
            
            const displayCols = isExpanded ? columns : columns.slice(0, 3);
            const hasAnyTarget = columns.some(col => row.targets?.[col.id]);
            
            return (
                <div className="stats-card animate-fade-in">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                                <Icons.Calendar className="w-6 h-6 text-gray-600" />
                            </div>
                            <div>
                                <input 
                                    type="date" 
                                    value={row.date || ''} 
                                    onChange={(e) => onDateChange(e.target.value)} 
                                    className="font-bold text-lg text-gray-900 bg-transparent border-none p-0 focus:ring-0 w-full" 
                                    disabled={!editable} 
                                />
                                <p className="text-xs text-gray-500">{columns.length} показників</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => setShowTargets(!showTargets)} 
                                className={`w-10 h-10 rounded-xl flex items-center justify-center transition-colors ${showTargets || hasAnyTarget ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-400'}`}
                                title="Показати/сховати план"
                            >
                                <Icons.Target className="w-5 h-5" />
                            </button>
                            {editable && (
                                <button onClick={onDelete} className="w-10 h-10 rounded-xl bg-red-50 flex items-center justify-center">
                                    <Icons.Trash className="w-5 h-5 text-red-400" />
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* Values Grid */}
                    <div className="space-y-3">
                        {displayCols.map(col => {
                            const progress = calculateProgress(col.id);
                            const colors = progress !== null ? getProgressColor(progress) : null;
                            const hasComment = row.comments?.[col.id];
                            const hasTarget = row.targets?.[col.id];
                            
                            return (
                                <div key={col.id} className="bg-gray-50 rounded-2xl p-4">
                                    {/* Metric header */}
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="font-semibold text-gray-900">{col.name}</span>
                                                {hasComment && (
                                                    <button onClick={() => setActiveComment(activeComment === col.id ? null : col.id)} className="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                                                        <Icons.MessageCircle className="w-3.5 h-3.5 text-blue-600" />
                                                    </button>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <span className="period-badge">{getPeriodLabel(col.period, t)}</span>
                                                {col.responsible && <span className="text-xs text-gray-500">{col.responsible}</span>}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Inputs row: Plan + Fact */}
                                    <div className="flex items-center gap-2">
                                        {(showTargets || hasTarget) && (
                                            <div className="flex-1">
                                                <label className="text-xs text-amber-600 font-medium mb-1 block">План</label>
                                                <input
                                                    type="text"
                                                    inputMode="decimal"
                                                    value={row.targets?.[col.id] || ''}
                                                    onChange={(e) => onTargetChange(col.id, e.target.value)}
                                                    className="w-full px-3 py-2 bg-amber-50 border-2 border-amber-200 rounded-xl text-center font-bold text-lg text-amber-700 focus:border-amber-400 focus:ring-0"
                                                    placeholder="—"
                                                />
                                            </div>
                                        )}
                                        <div className="flex-1">
                                            <label className="text-xs text-gray-500 font-medium mb-1 block">{showTargets || hasTarget ? 'Факт' : 'Значення'}</label>
                                            <input
                                                type="text"
                                                inputMode="decimal"
                                                value={row.values?.[col.id] || ''}
                                                onChange={(e) => onValueChange(col.id, e.target.value)}
                                                className="w-full px-3 py-2 bg-white border-2 border-gray-200 rounded-xl text-center font-bold text-lg focus:border-primary-500 focus:ring-0"
                                                placeholder="0"
                                            />
                                        </div>
                                    </div>
                                    
                                    {/* Progress bar */}
                                    {progress !== null && (
                                        <div className="flex items-center gap-3 mt-3">
                                            <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div className={`h-full rounded-full ${colors.bg}`} style={{ width: `${Math.min(progress, 100)}%` }} />
                                            </div>
                                            <span className={`text-sm font-bold ${colors.text} min-w-[48px] text-right`}>{progress}%</span>
                                        </div>
                                    )}
                                    
                                    {/* Comment input */}
                                    {activeComment === col.id && (
                                        <div className="mt-3">
                                            <input
                                                type="text"
                                                value={row.comments?.[col.id] || ''}
                                                onChange={(e) => onCommentChange(col.id, e.target.value)}
                                                className="w-full px-3 py-2 text-sm bg-white border border-gray-200 rounded-xl focus:border-primary-500"
                                                placeholder="💬 Коментар..."
                                            />
                                        </div>
                                    )}
                                    
                                    {/* Add comment button */}
                                    {!hasComment && activeComment !== col.id && (
                                        <button 
                                            onClick={() => setActiveComment(col.id)} 
                                            className="mt-2 text-xs text-gray-400 hover:text-gray-600"
                                        >
                                            + Коментар
                                        </button>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    
                    {/* Expand button */}
                    {columns.length > 3 && (
                        <button 
                            onClick={() => setIsExpanded(!isExpanded)} 
                            className="w-full mt-4 py-3 text-sm font-semibold text-primary-600 bg-primary-50 hover:bg-primary-100 rounded-xl flex items-center justify-center gap-2 transition-all"
                        >
                            <Icons.ChevronDown className={`w-5 h-5 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                            {isExpanded ? 'Згорнути' : `Показати ще ${columns.length - 3}`}
                        </button>
                    )}
                </div>
            );
        };

        // ==================== STATS TABLE (DESKTOP) ====================
        const StatsTable = ({ columns, rows, targetRow, onDeleteRow, onDateChange, onValueChange, onCommentChange, onEditColumn, editable, t }) => {
            const calculateProgress = (row, colId) => {
                if (!targetRow || !row.values) return null;
                const target = parseFloat(String(targetRow.values[colId] || '').replace(',', '.'));
                const value = parseFloat(String(row.values[colId] || '').replace(',', '.'));
                if (isNaN(target) || isNaN(value) || target === 0) return null;
                return Math.round((value / target) * 100);
            };
            
            const getProgressBadge = (progress) => {
                if (progress === null) return null;
                let colorClass = 'badge-red';
                if (progress >= 100) colorClass = 'badge-green';
                else if (progress >= 80) colorClass = 'badge-blue';
                else if (progress >= 50) colorClass = 'badge-amber';
                return <span className={`badge ${colorClass} ml-2`}>{progress}%</span>;
            };
            
            const getColumnStatus = (col) => {
                const isFilled = isFilledForPeriod(rows, col.id, col.period);
                if (col.period === 'custom') return null;
                return isFilled ? 'filled' : 'pending';
            };
            
            return (
                <div className="card overflow-hidden">
                    <div className="overflow-x-auto">
                        <table className="stats-table">
                            <thead>
                                <tr>
                                    <th className="sticky-col" style={{ minWidth: 140 }}>{t.date}</th>
                                    {columns.map(col => {
                                        const status = getColumnStatus(col);
                                        return (
                                            <th key={col.id} style={{ minWidth: 180 }}>
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            {status && <span className={`status-dot ${status === 'filled' ? 'status-filled' : 'status-pending'}`}></span>}
                                                            <span>{col.name}</span>
                                                        </div>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className="period-badge">{getPeriodLabel(col.period, t)}</span>
                                                            {col.responsible && <span className="text-xs font-normal text-gray-400">{col.responsible}</span>}
                                                        </div>
                                                    </div>
                                                    {editable && (
                                                        <button onClick={() => onEditColumn(col)} className="p-1 hover:bg-gray-200 rounded text-gray-400 hover:text-gray-600">
                                                            <Icons.Settings className="w-4 h-4" />
                                                        </button>
                                                    )}
                                                </div>
                                            </th>
                                        );
                                    })}
                                    {editable && <th style={{ width: 60 }}></th>}
                                </tr>
                            </thead>
                            <tbody>
                                {targetRow && (
                                    <tr className="target-row">
                                        <td className="sticky-col font-bold text-amber-700">
                                            <div className="flex items-center gap-2"><Icons.Target className="w-4 h-4" />{t.target}</div>
                                        </td>
                                        {columns.map(col => (
                                            <td key={col.id}>
                                                <input
                                                    type="text" value={targetRow.values?.[col.id] || ''} onChange={(e) => onValueChange(targetRow.id, col.id, e.target.value)}
                                                    disabled={!editable} className="w-full px-2 py-1 text-sm font-bold bg-transparent border border-transparent rounded focus:border-amber-400 focus:bg-white" placeholder={t.target}
                                                />
                                            </td>
                                        ))}
                                        {editable && <td></td>}
                                    </tr>
                                )}
                                {rows.filter(r => !r.isTarget).map(row => (
                                    <tr key={row.id}>
                                        <td className="sticky-col">
                                            <input type="date" value={row.date || ''} onChange={(e) => onDateChange(row.id, e.target.value)} className="w-full px-2 py-1 text-sm bg-transparent border border-transparent rounded focus:border-primary-400 focus:bg-white" />
                                        </td>
                                        {columns.map(col => {
                                            const progress = calculateProgress(row, col.id);
                                            return (
                                                <td key={col.id}>
                                                    <div>
                                                        <div className="flex items-center">
                                                            <input
                                                                type="text" value={row.values?.[col.id] || ''} onChange={(e) => onValueChange(row.id, col.id, e.target.value)}
                                                                className="w-20 px-2 py-1 text-sm bg-transparent border border-transparent rounded focus:border-primary-400 focus:bg-white" placeholder="0"
                                                            />
                                                            {getProgressBadge(progress)}
                                                        </div>
                                                        <input
                                                            type="text" value={row.comments?.[col.id] || ''} onChange={(e) => onCommentChange(row.id, col.id, e.target.value)}
                                                            className="w-full px-2 py-0.5 mt-1 text-xs text-gray-500 bg-transparent border-none focus:ring-0" placeholder={t.comment}
                                                        />
                                                    </div>
                                                </td>
                                            );
                                        })}
                                        {editable && (
                                            <td><button onClick={() => onDeleteRow(row.id)} className="btn btn-ghost btn-icon"><Icons.Trash className="w-4 h-4 text-gray-400" /></button></td>
                                        )}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // ==================== AI ANALYSIS (INTERACTIVE CHAT) ====================
        const AIAnalysis = ({ columns, rows, targetRow, aiSettings, language, onSaveAnalysis, savedAnalyses, onUpdateAiSettings, t }) => {
            const toast = useToast();
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [period, setPeriod] = useState(5);
            const [additionalFocus, setAdditionalFocus] = useState('');
            const [showHistory, setShowHistory] = useState(false);
            
            // Chat state
            const [step, setStep] = useState(0); // 0=start, 1=bottleneck, 2=solutions, 3=plan
            const [messages, setMessages] = useState([]);
            const [analysisData, setAnalysisData] = useState(null);
            const [selectedSolution, setSelectedSolution] = useState(null);
            const [customSolution, setCustomSolution] = useState('');
            const [showCustomInput, setShowCustomInput] = useState(false);
            const chatEndRef = React.useRef(null);
            
            // Scroll to bottom on new messages
            React.useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);
            
            const WORKER_URL = 'https://openai-proxy.management-talco.workers.dev/';
            
            const getTableData = () => {
                const weeksAgo = new Date();
                weeksAgo.setDate(weeksAgo.getDate() - (period * 7));
                const filteredRows = rows.filter(r => !r.isTarget && new Date(r.date) >= weeksAgo);
                
                return filteredRows.map(row => {
                    const rowData = { 'Дата': row.date };
                    columns.forEach(col => {
                        const fact = row.values?.[col.id] || '-';
                        const plan = row.targets?.[col.id] || '-';
                        const diff = (parseFloat(fact) && parseFloat(plan)) 
                            ? Math.round((parseFloat(fact) / parseFloat(plan)) * 100) + '%' 
                            : '-';
                        rowData[col.name] = `Факт: ${fact}, План: ${plan}, Виконання: ${diff}`;
                    });
                    return rowData;
                });
            };
            
            const callAI = async (prompt) => {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.choices[0].message.content;
            };
            
            const addMessage = (type, content, buttons = null) => {
                setMessages(prev => [...prev, { type, content, buttons, time: new Date() }]);
            };
            
            // ЕТАП 1: Визначення вузького місця
            const startAnalysis = async () => {
                if (!aiSettings.businessContext) {
                    toast.warning('Заповніть контекст бізнесу');
                    return;
                }
                
                if (rows.filter(r => !r.isTarget).length < 2) {
                    toast.warning('Додайте більше даних (мінімум 2 записи)');
                    return;
                }
                
                setStep(1);
                setMessages([]);
                setIsAnalyzing(true);
                
                addMessage('system', '🔍 Аналізую ваші дані... Це займе 1-2 хвилини.');
                
                const tableData = getTableData();
                setAnalysisData(tableData);
                
                const prompt = `Ти — бізнес-консультант з 10+ років досвіду. Проаналізуй дані та визнач ГОЛОВНЕ вузьке місце.

КОНТЕКСТ БІЗНЕСУ:
${aiSettings.businessContext}

ПРІОРИТЕТИ:
${aiSettings.priorities || 'Не вказано'}

СТАТИСТИКА ЗА ${period} ТИЖНІВ:
${JSON.stringify(tableData, null, 2)}

${additionalFocus ? `ФОКУС: ${additionalFocus}` : ''}

Дай відповідь українською у форматі:

⚠️ ВУЗЬКЕ МІСЦЕ: [назва проблеми]

📉 ФАКТИ З ДАНИХ:
• [конкретна цифра 1]
• [конкретна цифра 2]
• [конкретна цифра 3]

🔗 ПРИЧИННО-НАСЛІДКОВИЙ ЗВ'ЯЗОК:
[Поясни ланцюжок: ця проблема → призводить до → що впливає на → кінцевий результат]

💸 ВТРАТИ:
Через це ви втрачаєте приблизно [сума] грн на [період].

Будь конкретним, використовуй реальні цифри з даних.`;

                try {
                    const response = await callAI(prompt);
                    addMessage('ai', response);
                    addMessage('buttons', null, [
                        { text: '✅ Так, зрозуміло. Що робити?', action: 'understood' },
                        { text: '🤔 Поясни детальніше', action: 'explain_more' }
                    ]);
                } catch (error) {
                    addMessage('error', 'Помилка аналізу: ' + error.message);
                }
                
                setIsAnalyzing(false);
            };
            
            // ЕТАП 2: Варіанти рішення
            const showSolutions = async (needMoreExplanation = false) => {
                setStep(2);
                setIsAnalyzing(true);
                
                if (needMoreExplanation) {
                    addMessage('user', '🤔 Поясни детальніше');
                    addMessage('system', '📚 Готую розгорнуте пояснення...');
                } else {
                    addMessage('user', '✅ Так, зрозуміло. Що робити?');
                    addMessage('system', '💡 Готую варіанти рішення...');
                }
                
                const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
                
                const prompt = needMoreExplanation 
                    ? `Поясни детальніше причинно-наслідковий зв'язок вузького місця. Використовуй аналогії та приклади. Покажи як кожен крок впливає на наступний.

Попередній аналіз:
${previousContext}

Дай розгорнуте пояснення українською, потім запитай чи зрозуміло.`
                    : `На основі виявленого вузького місця, запропонуй 3 ВАРІАНТИ РІШЕННЯ.

Попередній аналіз:
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Дай відповідь українською у форматі:

📋 ТРИ ВАРІАНТИ РІШЕННЯ:

1️⃣ ВАРІАНТ: [Назва]
✅ Плюси: [2-3 пункти]
❌ Мінуси: [1-2 пункти]
⏱ Термін: [скільки часу]
💰 Вартість: [орієнтовно]
📈 Очікуваний результат: [конкретно]

2️⃣ ВАРІАНТ: [Назва]
✅ Плюси: [2-3 пункти]
❌ Мінуси: [1-2 пункти]
⏱ Термін: [скільки часу]
💰 Вартість: [орієнтовно]
📈 Очікуваний результат: [конкретно]

3️⃣ ВАРІАНТ: [Назва]
✅ Плюси: [2-3 пункти]
❌ Мінуси: [1-2 пункти]
⏱ Термін: [скільки часу]
💰 Вартість: [орієнтовно]
📈 Очікуваний результат: [конкретно]

⭐ РЕКОМЕНДУЮ: Варіант [номер], тому що [коротке пояснення чому саме цей варіант найкращий для вашої ситуації].`;

                try {
                    const response = await callAI(prompt);
                    addMessage('ai', response);
                    
                    if (needMoreExplanation) {
                        addMessage('buttons', null, [
                            { text: '✅ Тепер зрозуміло. Що робити?', action: 'understood' },
                            { text: '🤔 Ще раз поясни', action: 'explain_more' }
                        ]);
                    } else {
                        addMessage('buttons', null, [
                            { text: '1️⃣ Обираю варіант 1', action: 'solution_1' },
                            { text: '2️⃣ Обираю варіант 2', action: 'solution_2' },
                            { text: '3️⃣ Обираю варіант 3', action: 'solution_3' },
                            { text: '⭐ Обираю рекомендований', action: 'solution_recommended' },
                            { text: '✏️ Свій варіант', action: 'custom_solution' }
                        ]);
                    }
                } catch (error) {
                    addMessage('error', 'Помилка: ' + error.message);
                }
                
                setIsAnalyzing(false);
            };
            
            // ЕТАП 3: План дій
            const createPlan = async (solutionNum) => {
                setStep(3);
                setSelectedSolution(solutionNum);
                setIsAnalyzing(true);
                
                const solutionText = solutionNum === 'recommended' ? 'рекомендований варіант' : `варіант ${solutionNum}`;
                addMessage('user', `⭐ Обираю ${solutionText}`);
                addMessage('system', '📋 Складаю детальний план дій та завдання...');
                
                const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
                
                const prompt = `Склади ДЕТАЛЬНИЙ ПЛАН ВПРОВАДЖЕННЯ обраного рішення.

Обрано: ${solutionText}

Попередній контекст:
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Дай відповідь українською у форматі:

📋 ПЛАН ВПРОВАДЖЕННЯ

🎯 ЦІЛЬ: [що хочемо досягти + конкретна метрика]

📅 ТИЖДЕНЬ 1:
□ Завдання 1.1: [конкретна дія]
  → Відповідальний: [хто]
  → Результат: [що отримаємо]
□ Завдання 1.2: [конкретна дія]
  → Відповідальний: [хто]
  → Результат: [що отримаємо]

📅 ТИЖДЕНЬ 2:
□ Завдання 2.1: [конкретна дія]
  → Відповідальний: [хто]
  → Результат: [що отримаємо]
□ Завдання 2.2: [конкретна дія]
  → Відповідальний: [хто]
  → Результат: [що отримаємо]

📅 ТИЖДЕНЬ 3-4:
□ Завдання 3.1: [конкретна дія]
  → Відповідальний: [хто]
  → Результат: [що отримаємо]

✅ КРИТЕРІЇ УСПІХУ:
• [Метрика 1]: було [X] → стало [Y]
• [Метрика 2]: було [X] → стало [Y]

⚡ ПЕРШИЙ КРОК ПРЯМО ЗАРАЗ:
[Одна конкретна дія яку можна зробити сьогодні]`;

                try {
                    const response = await callAI(prompt);
                    addMessage('ai', response);
                    addMessage('buttons', null, [
                        { text: '💾 Зберегти план', action: 'save' },
                        { text: '📋 Скопіювати', action: 'copy' },
                        { text: '🔄 Почати спочатку', action: 'restart' }
                    ]);
                } catch (error) {
                    addMessage('error', 'Помилка: ' + error.message);
                }
                
                setIsAnalyzing(false);
            };
            
            // ЕТАП 3 (власний варіант): План дій для custom solution
            const createCustomPlan = async (customText) => {
                setStep(3);
                setSelectedSolution('custom');
                setIsAnalyzing(true);
                
                addMessage('user', `✏️ Мій варіант: ${customText}`);
                addMessage('system', '📋 Аналізую ваш варіант та складаю план...');
                
                const previousContext = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n');
                
                const prompt = `Користувач запропонував ВЛАСНИЙ ВАРІАНТ рішення. Спочатку оціни його, потім склади план.

ВАРІАНТ КОРИСТУВАЧА:
${customText}

Попередній контекст (вузьке місце):
${previousContext}

Контекст бізнесу:
${aiSettings.businessContext}

Дай відповідь українською у форматі:

📝 ОЦІНКА ВАШОГО ВАРІАНТУ:
✅ Сильні сторони: [2-3 пункти]
⚠️ Можливі ризики: [1-2 пункти]
💡 Рекомендація: [як покращити або на що звернути увагу]

📋 ПЛАН ВПРОВАДЖЕННЯ

🎯 ЦІЛЬ: [що хочемо досягти + конкретна метрика]

📅 ТИЖДЕНЬ 1:
□ Завдання 1.1: [конкретна дія]
  → Відповідальний: [хто]
  → Результат: [що отримаємо]
□ Завдання 1.2: [конкретна дія]
  → Відповідальний: [хто]
  → Результат: [що отримаємо]

📅 ТИЖДЕНЬ 2:
□ Завдання 2.1: [конкретна дія]
  → Відповідальний: [хто]
  → Результат: [що отримаємо]

✅ КРИТЕРІЇ УСПІХУ:
• [Метрика 1]: було [X] → стало [Y]

⚡ ПЕРШИЙ КРОК ПРЯМО ЗАРАЗ:
[Одна конкретна дія яку можна зробити сьогодні]`;

                try {
                    const response = await callAI(prompt);
                    addMessage('ai', response);
                    addMessage('buttons', null, [
                        { text: '💾 Зберегти план', action: 'save' },
                        { text: '📋 Скопіювати', action: 'copy' },
                        { text: '🔄 Почати спочатку', action: 'restart' }
                    ]);
                } catch (error) {
                    addMessage('error', 'Помилка: ' + error.message);
                }
                
                setIsAnalyzing(false);
                setCustomSolution('');
            };
            
            // Обробка кнопок
            const handleButton = (action) => {
                switch(action) {
                    case 'understood':
                        showSolutions(false);
                        break;
                    case 'explain_more':
                        showSolutions(true);
                        break;
                    case 'solution_1':
                        createPlan('1');
                        break;
                    case 'solution_2':
                        createPlan('2');
                        break;
                    case 'solution_3':
                        createPlan('3');
                        break;
                    case 'solution_recommended':
                        createPlan('recommended');
                        break;
                    case 'custom_solution':
                        setShowCustomInput(true);
                        addMessage('system', '✏️ Опишіть ваш варіант рішення:');
                        addMessage('custom_input', null);
                        break;
                    case 'submit_custom':
                        if (customSolution.trim()) {
                            createCustomPlan(customSolution);
                            setShowCustomInput(false);
                        }
                        break;
                    case 'save':
                        const fullText = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n\n---\n\n');
                        onSaveAnalysis({ text: fullText, date: new Date().toISOString(), period });
                        toast.success('План збережено!');
                        break;
                    case 'copy':
                        const textToCopy = messages.filter(m => m.type === 'ai').map(m => m.content).join('\n\n---\n\n');
                        navigator.clipboard.writeText(textToCopy);
                        toast.success('Скопійовано!');
                        break;
                    case 'restart':
                        setStep(0);
                        setMessages([]);
                        setSelectedSolution(null);
                        setShowCustomInput(false);
                        setCustomSolution('');
                        break;
                }
            };
            
            // Рендер повідомлення
            const renderMessage = (msg, idx) => {
                if (msg.type === 'buttons') {
                    return (
                        <div key={idx} className="flex flex-wrap gap-2 my-4">
                            {msg.buttons.map((btn, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => handleButton(btn.action)}
                                    disabled={isAnalyzing}
                                    className="btn btn-secondary text-sm"
                                >
                                    {btn.text}
                                </button>
                            ))}
                        </div>
                    );
                }
                
                if (msg.type === 'custom_input') {
                    return (
                        <div key={idx} className="my-4 p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                            <textarea
                                value={customSolution}
                                onChange={(e) => setCustomSolution(e.target.value)}
                                placeholder="Опишіть ваш варіант рішення... Наприклад: Хочу найняти ще одного менеджера з продажів та налаштувати автоматичну воронку в CRM"
                                className="w-full p-3 border border-amber-300 rounded-xl text-sm resize-none focus:outline-none focus:ring-2 focus:ring-amber-400"
                                rows={4}
                                disabled={isAnalyzing}
                            />
                            <div className="flex gap-2 mt-3">
                                <button 
                                    onClick={() => handleButton('submit_custom')}
                                    disabled={isAnalyzing || !customSolution.trim()}
                                    className="btn btn-primary text-sm"
                                >
                                    {isAnalyzing ? <><Icons.Loader className="w-4 h-4" /> Аналізую...</> : '📋 Скласти план'}
                                </button>
                                <button 
                                    onClick={() => {
                                        setShowCustomInput(false);
                                        setMessages(prev => prev.filter(m => m.type !== 'custom_input' && m.content !== '✏️ Опишіть ваш варіант рішення:'));
                                    }}
                                    disabled={isAnalyzing}
                                    className="btn btn-ghost text-sm"
                                >
                                    Скасувати
                                </button>
                            </div>
                        </div>
                    );
                }
                
                const styles = {
                    system: 'bg-blue-50 border-blue-200 text-blue-800',
                    ai: 'bg-gradient-to-br from-purple-50 to-indigo-50 border-purple-200 text-gray-800',
                    user: 'bg-green-50 border-green-200 text-green-800 ml-auto max-w-[80%]',
                    error: 'bg-red-50 border-red-200 text-red-800'
                };
                
                return (
                    <div key={idx} className={`p-4 rounded-2xl border ${styles[msg.type]} animate-fade-in`}>
                        {msg.type === 'system' && <div className="flex items-center gap-2 mb-1"><Icons.Loader className={`w-4 h-4 ${isAnalyzing ? 'animate-spin' : ''}`} /><span className="font-medium text-sm">Система</span></div>}
                        <div className="whitespace-pre-wrap text-sm leading-relaxed">{msg.content}</div>
                    </div>
                );
            };
            
            return (
                <div className="space-y-4">
                    {/* Налаштування (тільки на старті) */}
                    {step === 0 && (
                        <>
                            <div className="flex items-center gap-3 mb-4">
                                <label className="text-sm font-medium text-gray-700">{t.analysisPeriod}:</label>
                                <select value={period} onChange={(e) => setPeriod(Number(e.target.value))} className="select-field w-auto">
                                    <option value={3}>3 {t.lastWeeks}</option>
                                    <option value={5}>5 {t.lastWeeks}</option>
                                    <option value={7}>7 {t.lastWeeks}</option>
                                    <option value={10}>10 {t.lastWeeks}</option>
                                </select>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.additionalFocus}</label>
                                <input
                                    type="text" value={additionalFocus} onChange={(e) => setAdditionalFocus(e.target.value)}
                                    className="input-field" placeholder={t.additionalFocusPlaceholder}
                                />
                            </div>
                            
                            <div className="flex gap-3">
                                <button onClick={startAnalysis} disabled={isAnalyzing} className="btn btn-ai flex-1">
                                    {isAnalyzing ? <><Icons.Loader className="w-5 h-5" />{t.analyzing}</> : <><Icons.Brain className="w-5 h-5" />{t.runAnalysis}</>}
                                </button>
                                {savedAnalyses?.length > 0 && (
                                    <button onClick={() => setShowHistory(!showHistory)} className="btn btn-secondary">
                                        <Icons.History className="w-5 h-5" />
                                    </button>
                                )}
                            </div>
                            
                            {showHistory && savedAnalyses?.length > 0 && (
                                <div className="space-y-2 p-4 bg-gray-50 rounded-xl">
                                    <h4 className="font-semibold text-gray-700 mb-2">{t.analysisHistory}</h4>
                                    {savedAnalyses.slice(0, 5).map((analysis, i) => (
                                        <div key={i} className="p-3 bg-white rounded-lg">
                                            <div className="text-sm font-medium text-gray-900">{new Date(analysis.date).toLocaleDateString()}</div>
                                            <div className="text-xs text-gray-500 mt-1 line-clamp-2">{analysis.text?.substring(0, 100)}...</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {/* Підказка */}
                            <div className="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-2xl border border-purple-100">
                                <h4 className="font-bold text-purple-900 mb-2">🤖 Як працює AI-консультант:</h4>
                                <ol className="text-sm text-purple-800 space-y-1">
                                    <li><strong>1.</strong> Визначаю вузьке місце та поясню причини</li>
                                    <li><strong>2.</strong> Запропоную 3 варіанти рішення з плюсами/мінусами</li>
                                    <li><strong>3.</strong> Складу план дій з конкретними завданнями</li>
                                </ol>
                                <p className="text-xs text-purple-600 mt-2">⏱ Весь процес займає 3-5 хвилин</p>
                            </div>
                        </>
                    )}
                    
                    {/* Чат */}
                    {step > 0 && (
                        <div className="space-y-3 overflow-y-auto pr-2">
                            {/* Progress */}
                            <div className="flex items-center gap-2 p-3 bg-gray-100 rounded-xl sticky top-0 z-10">
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${step >= 1 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`}>1</div>
                                <div className={`flex-1 h-1 rounded ${step >= 2 ? 'bg-purple-500' : 'bg-gray-300'}`} />
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${step >= 2 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`}>2</div>
                                <div className={`flex-1 h-1 rounded ${step >= 3 ? 'bg-purple-500' : 'bg-gray-300'}`} />
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${step >= 3 ? 'bg-purple-500 text-white' : 'bg-gray-300'}`}>3</div>
                            </div>
                            
                            {/* Messages */}
                            {messages.map((msg, idx) => renderMessage(msg, idx))}
                            
                            {/* Scroll anchor */}
                            <div ref={chatEndRef} />
                        </div>
                    )}
                </div>
            );
        };

        // ==================== MAIN APP ====================
        const App = () => {
            const toast = useToast();
            
            // Auth state
            const [user, setUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            // Data state
            const [columns, setColumns] = useState([]);
            const [rows, setRows] = useState([]);
            const [employees, setEmployees] = useState({});
            const [aiSettings, setAiSettings] = useState({ businessContext: '', priorities: '', analysisPeriod: 5 });
            const [savedAnalyses, setSavedAnalyses] = useState([]);
            
            // UI state
            const [language, setLanguage] = useState('uk');
            const [saveStatus, setSaveStatus] = useState(null);
            const [showMenu, setShowMenu] = useState(false);
            const [activeTab, setActiveTab] = useState('stats');
            const [showQuickActions, setShowQuickActions] = useState(false);
            const [showAddStatsModal, setShowAddStatsModal] = useState(false);
            const [showEditColumnModal, setShowEditColumnModal] = useState(false);
            const [showTeamModal, setShowTeamModal] = useState(false);
            const [showAddEmployeeModal, setShowAddEmployeeModal] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [confirmDialog, setConfirmDialog] = useState({ isOpen: false });
            const [editingColumn, setEditingColumn] = useState(null);
            
            // Form state
            const [newStatsName, setNewStatsName] = useState('');
            const [newStatsResponsible, setNewStatsResponsible] = useState('');
            const [newStatsPeriod, setNewStatsPeriod] = useState('weekly');
            const [newStatsTarget, setNewStatsTarget] = useState('');
            const [newEmployeeEmail, setNewEmployeeEmail] = useState('');
            const [newEmployeeName, setNewEmployeeName] = useState('');
            const [selectedColumns, setSelectedColumns] = useState([]);
            const [generatedInviteLink, setGeneratedInviteLink] = useState('');
            
            const saveTimeoutRef = useRef(null);
            
            const t = useMemo(() => translations[language] || translations.uk, [language]);
            const isOwner = userProfile?.role === 'owner';
            const workspaceOwnerId = isOwner ? user?.uid : userProfile?.ownerId;
            const targetRow = rows.find(r => r.isTarget);
            const dataRows = rows.filter(r => !r.isTarget);
            
            // Visible columns for employees
            const visibleColumns = useMemo(() => {
                if (isOwner) return columns;
                const employeeData = employees[user?.uid];
                if (!employeeData?.visibleColumns) return [];
                return columns.filter(col => employeeData.visibleColumns.includes(col.id));
            }, [columns, isOwner, employees, user]);

            // ==================== AUTH ====================
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
                    setUser(authUser);
                    if (authUser) await loadUserProfile(authUser.uid);
                    else { setUserProfile(null); setAuthLoading(false); }
                });
                return () => unsubscribe();
            }, []);
            
            const loadUserProfile = async (userId) => {
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const profile = userDoc.data();
                        setUserProfile(profile);
                        const ownerId = profile.role === 'owner' ? userId : profile.ownerId;
                        if (ownerId) await loadWorkspaceData(ownerId);
                    }
                } catch (error) {
                    console.error('Error loading profile:', error);
                    toast.error(t.errorGeneric);
                } finally {
                    setAuthLoading(false);
                }
            };
            
            const loadWorkspaceData = async (ownerId) => {
                try {
                    const workspaceDoc = await db.collection('workspaces').doc(ownerId).get();
                    if (workspaceDoc.exists) {
                        const data = workspaceDoc.data();
                        setColumns(data.columns || []);
                        setRows(data.rows || []);
                        setEmployees(data.employees || {});
                        setAiSettings(data.aiSettings || { businessContext: '', priorities: '', analysisPeriod: 5 });
                        setSavedAnalyses(data.savedAnalyses || []);
                    } else {
                        initializeDefaultData();
                    }
                } catch (error) {
                    console.error('Error loading workspace:', error);
                }
            };
            
            const initializeDefaultData = () => {
                const defaultColumns = [{ id: Date.now().toString(), name: 'Показник 1', responsible: '', period: 'weekly', visibleToEmployees: [] }];
                const targetRow = { id: 'target', isTarget: true, date: '', values: {}, comments: {} };
                const defaultRows = [targetRow, { id: Date.now().toString() + '-1', isTarget: false, date: new Date().toISOString().split('T')[0], values: {}, comments: {} }];
                setColumns(defaultColumns);
                setRows(defaultRows);
            };
            
            // ==================== DEMO DATA ====================
            const loadDemoData = () => {
                const demoColumns = [
                    { id: 'col1', name: 'Проведено консультацій', responsible: 'Олена', period: 'weekly', visibleToEmployees: [] },
                    { id: 'col2', name: 'Нових лідів', responsible: 'Марія', period: 'weekly', visibleToEmployees: [] },
                    { id: 'col3', name: 'Закритих угод', responsible: 'Олена', period: 'weekly', visibleToEmployees: [] },
                    { id: 'col4', name: 'Дохід (тис грн)', responsible: 'Олександр', period: 'weekly', visibleToEmployees: [] },
                    { id: 'col5', name: 'NPS оцінка', responsible: 'Марія', period: 'monthly', visibleToEmployees: [] },
                    { id: 'col6', name: 'Витрати на маркетинг (тис)', responsible: 'Ігор', period: 'weekly', visibleToEmployees: [] },
                ];
                
                const today = new Date();
                const getWeekDate = (weeksAgo) => {
                    const d = new Date(today);
                    d.setDate(d.getDate() - (weeksAgo * 7));
                    return d.toISOString().split('T')[0];
                };
                
                const demoRows = [
                    { id: 'row1', isTarget: false, date: getWeekDate(5), 
                      values: { col1: '18', col2: '42', col3: '6', col4: '156', col5: '8.5', col6: '28' }, 
                      targets: { col1: '20', col2: '45', col3: '8', col4: '180', col5: '9', col6: '30' },
                      comments: { col3: 'Сезонний спад' } },
                    { id: 'row2', isTarget: false, date: getWeekDate(4), 
                      values: { col1: '22', col2: '38', col3: '7', col4: '178', col5: '', col6: '32' }, 
                      targets: { col1: '20', col2: '50', col3: '8', col4: '200', col5: '', col6: '30' },
                      comments: { col1: 'Додали вебінар' } },
                    { id: 'row3', isTarget: false, date: getWeekDate(3), 
                      values: { col1: '15', col2: '51', col3: '5', col4: '145', col5: '', col6: '45' }, 
                      targets: { col1: '22', col2: '50', col3: '9', col4: '200', col5: '', col6: '35' },
                      comments: { col6: 'Запустили рекламу' } },
                    { id: 'row4', isTarget: false, date: getWeekDate(2), 
                      values: { col1: '19', col2: '67', col3: '4', col4: '132', col5: '8.2', col6: '48' }, 
                      targets: { col1: '22', col2: '55', col3: '10', col4: '220', col5: '9', col6: '40' },
                      comments: { col3: 'Проблема з закриттям!' } },
                    { id: 'row5', isTarget: false, date: getWeekDate(1), 
                      values: { col1: '21', col2: '58', col3: '6', col4: '168', col5: '', col6: '35' }, 
                      targets: { col1: '20', col2: '50', col3: '8', col4: '200', col5: '', col6: '35' },
                      comments: {} },
                    { id: 'row6', isTarget: false, date: getWeekDate(0), 
                      values: { col1: '17', col2: '44', col3: '5', col4: '148', col5: '', col6: '30' }, 
                      targets: { col1: '20', col2: '50', col3: '8', col4: '200', col5: '', col6: '30' },
                      comments: { col2: 'Впала конверсія з реклами' } },
                ];
                
                const demoAiSettings = {
                    businessContext: `Консалтингова компанія "TALKO Consulting"
- Спеціалізація: бізнес-трансформація для МСБ
- Команда: 4 консультанти + 2 менеджери з продажів
- Середній чек: 25,000 грн за проект
- Цикл угоди: 2-3 тижні від ліда до контракту
- Основні канали: рекомендації (60%), реклама Facebook/Google (30%), вебінари (10%)
- Поточна проблема: багато лідів, але низька конверсія в угоди`,
                    priorities: `1. Підвищити конверсію лідів в угоди (зараз ~10%, ціль 15%)
2. Оптимізувати витрати на маркетинг (ROI впав)
3. Збільшити кількість консультацій на людину`,
                    analysisPeriod: 5
                };
                
                setColumns(demoColumns);
                setRows(demoRows);
                setAiSettings(demoAiSettings);
                setEmployees({});
                setSavedAnalyses([]);
                
                toast.success('Демо-дані завантажено! Спробуйте AI Аналіз 🤖');
            };
            
            const handleAuth = async (email, password, isRegister, companyName, inviteCode) => {
                setIsSubmitting(true);
                try {
                    let authResult;
                    if (isRegister) {
                        authResult = await auth.createUserWithEmailAndPassword(email, password);
                        
                        if (inviteCode) {
                            // Join existing workspace
                            const inviteDoc = await db.collection('invites').doc(inviteCode).get();
                            if (inviteDoc.exists && !inviteDoc.data().used) {
                                const invite = inviteDoc.data();
                                await db.collection('users').doc(authResult.user.uid).set({
                                    email, role: 'employee', ownerId: invite.ownerId, name: invite.employeeName, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                // Update workspace employees
                                const workspaceRef = db.collection('workspaces').doc(invite.ownerId);
                                const workspaceDoc = await workspaceRef.get();
                                if (workspaceDoc.exists) {
                                    const employees = workspaceDoc.data().employees || {};
                                    // Remove pending entry, add real one
                                    const pendingKey = `pending_${inviteCode}`;
                                    const visibleColumns = employees[pendingKey]?.visibleColumns || invite.visibleColumns || [];
                                    delete employees[pendingKey];
                                    employees[authResult.user.uid] = { email, name: invite.employeeName, visibleColumns, active: true };
                                    await workspaceRef.update({ employees });
                                }
                                await db.collection('invites').doc(inviteCode).update({ used: true, usedBy: authResult.user.uid });
                                toast.success('Ви приєдналися до команди!');
                            } else {
                                toast.error('Невірний або використаний код запрошення');
                            }
                        } else {
                            // Create new workspace
                            await db.collection('users').doc(authResult.user.uid).set({
                                email, role: 'owner', companyName, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            toast.success('Компанію створено!');
                        }
                    } else {
                        await auth.signInWithEmailAndPassword(email, password);
                        toast.success('Вітаємо!');
                    }
                    // Clear invite from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    toast.error(error.message);
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            const handleLogout = async () => {
                await auth.signOut();
                setColumns([]); setRows([]); setEmployees({}); setUserProfile(null);
                toast.info('До побачення!');
            };

            // ==================== DATA SAVING ====================
            useEffect(() => {
                if (user && workspaceOwnerId && columns.length > 0) debouncedSave();
            }, [columns, rows, employees, aiSettings, savedAnalyses]);
            
            const saveData = async () => {
                if (!user || !workspaceOwnerId) return;
                setSaveStatus('saving');
                try {
                    await db.collection('workspaces').doc(workspaceOwnerId).set({
                        columns, rows, employees, aiSettings, savedAnalyses,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    setSaveStatus('saved');
                    setTimeout(() => setSaveStatus(null), 2000);
                } catch (error) {
                    console.error('Error saving:', error);
                    setSaveStatus('error');
                    toast.error(t.saveError);
                }
            };
            
            const debouncedSave = useCallback(() => {
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                saveTimeoutRef.current = setTimeout(saveData, 2000);
            }, [columns, rows, employees, aiSettings, savedAnalyses, workspaceOwnerId]);

            // ==================== DATA HANDLERS ====================
            const addColumn = () => {
                if (!isOwner || !newStatsName.trim()) return;
                const newColumn = {
                    id: Date.now().toString(), name: newStatsName, responsible: newStatsResponsible,
                    period: newStatsPeriod, visibleToEmployees: []
                };
                setColumns([...columns, newColumn]);
                // Add target value
                if (newStatsTarget) {
                    setRows(rows.map(row => row.isTarget ? { ...row, values: { ...row.values, [newColumn.id]: newStatsTarget } } : row));
                }
                setNewStatsName(''); setNewStatsResponsible(''); setNewStatsPeriod('weekly'); setNewStatsTarget('');
                setShowAddStatsModal(false);
                toast.success(t.addStats);
            };
            
            const updateColumn = (colId, updates) => {
                setColumns(columns.map(col => col.id === colId ? { ...col, ...updates } : col));
            };
            
            const deleteColumn = (id) => {
                setConfirmDialog({
                    isOpen: true, title: t.confirmDelete, message: 'Всі дані цього показника буде видалено',
                    onConfirm: () => {
                        setColumns(columns.filter(col => col.id !== id));
                        setRows(rows.map(row => ({
                            ...row, values: Object.fromEntries(Object.entries(row.values || {}).filter(([key]) => key !== id)),
                            comments: Object.fromEntries(Object.entries(row.comments || {}).filter(([key]) => key !== id))
                        })));
                    }
                });
            };
            
            const addRow = () => {
                const newRow = { id: Date.now().toString(), isTarget: false, date: new Date().toISOString().split('T')[0], values: {}, targets: {}, comments: {} };
                setRows([...rows, newRow]);
                toast.success(t.addRow);
            };
            
            const deleteRow = (id) => {
                setConfirmDialog({
                    isOpen: true, title: t.confirmDelete,
                    onConfirm: () => setRows(rows.filter(row => row.id !== id))
                });
            };
            
            const updateDate = (rowId, date) => setRows(rows.map(row => row.id === rowId ? { ...row, date } : row));
            const updateValue = (rowId, colId, value) => setRows(rows.map(row => row.id === rowId ? { ...row, values: { ...row.values, [colId]: value } } : row));
            const updateTarget = (rowId, colId, value) => setRows(rows.map(row => row.id === rowId ? { ...row, targets: { ...row.targets, [colId]: value } } : row));
            const updateComment = (rowId, colId, comment) => setRows(rows.map(row => row.id === rowId ? { ...row, comments: { ...row.comments, [colId]: comment } } : row));

            // ==================== TEAM HANDLERS ====================
            const generateInviteCode = () => Math.random().toString(36).substring(2, 10).toUpperCase();
            
            const addEmployee = async () => {
                if (!newEmployeeEmail.trim() || !isOwner) return;
                const code = generateInviteCode();
                const inviteLink = `${window.location.origin}${window.location.pathname}?invite=${code}`;
                
                try {
                    await db.collection('invites').doc(code).set({
                        ownerId: user.uid, ownerEmail: user.email, employeeEmail: newEmployeeEmail, employeeName: newEmployeeName,
                        visibleColumns: selectedColumns, createdAt: firebase.firestore.FieldValue.serverTimestamp(), used: false
                    });
                    
                    const tempId = `pending_${code}`;
                    setEmployees(prev => ({
                        ...prev, [tempId]: { email: newEmployeeEmail, name: newEmployeeName, visibleColumns: selectedColumns, pending: true, inviteCode: code }
                    }));
                    
                    setGeneratedInviteLink(inviteLink);
                    toast.success(t.inviteLink);
                } catch (error) {
                    console.error('Error creating invite:', error);
                    toast.error('Помилка створення запрошення');
                }
            };
            
            const copyInviteLink = async () => {
                await navigator.clipboard.writeText(generatedInviteLink);
                toast.success(t.linkCopied);
            };
            
            const removeEmployee = (employeeId) => {
                setConfirmDialog({
                    isOpen: true, title: 'Видалити співробітника?',
                    onConfirm: () => {
                        const newEmployees = { ...employees };
                        delete newEmployees[employeeId];
                        setEmployees(newEmployees);
                    }
                });
            };
            
            const updateEmployeeColumns = (employeeId, visibleCols) => {
                setEmployees(prev => ({
                    ...prev, [employeeId]: { ...prev[employeeId], visibleColumns: visibleCols }
                }));
            };

            // ==================== AI HANDLERS ====================
            const saveAnalysis = (analysis) => {
                setSavedAnalyses([analysis, ...savedAnalyses].slice(0, 20));
            };

            // ==================== EXPORT/IMPORT ====================
            const exportToExcel = () => {
                const headers = [t.date, ...visibleColumns.map(col => `${col.name}`)];
                const targetRowData = [t.target, ...visibleColumns.map(col => targetRow?.values[col.id] || '')];
                const data = dataRows.map(row => [row.date, ...visibleColumns.map(col => row.values?.[col.id] || '')]);
                
                const ws = XLSX.utils.aoa_to_sheet([headers, targetRowData, ...data]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Statistics');
                XLSX.writeFile(wb, `statistics_${new Date().toISOString().split('T')[0]}.xlsx`);
                toast.success(t.export);
            };

            // ==================== RENDER ====================
            if (authLoading) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <Icons.Loader className="w-8 h-8 text-primary-500" />
                </div>
            );
            
            if (!user) return <AuthForm t={t} onAuth={handleAuth} isLoading={isSubmitting} />;

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Save indicator */}
                    {saveStatus && (
                        <div className={`fixed top-4 right-4 z-50 px-4 py-2 rounded-xl text-sm font-semibold shadow-lg animate-slide-down
                            ${saveStatus === 'saving' ? 'bg-amber-100 text-amber-700' : ''}
                            ${saveStatus === 'saved' ? 'bg-green-100 text-green-700' : ''}
                            ${saveStatus === 'error' ? 'bg-red-100 text-red-700' : ''}
                        `}>
                            {saveStatus === 'saving' && <><Icons.Loader className="w-4 h-4 inline mr-2" />{t.saving}</>}
                            {saveStatus === 'saved' && <><Icons.CheckCircle className="w-4 h-4 inline mr-2" />{t.saved}</>}
                            {saveStatus === 'error' && <><Icons.AlertCircle className="w-4 h-4 inline mr-2" />{t.saveError}</>}
                        </div>
                    )}
                    
                    <div className="max-w-6xl mx-auto p-4 pb-24 sm:pb-8">
                        {/* Mobile Header */}
                        <header className="card p-4 mb-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-lg shadow-primary-500/30">
                                        <Icons.BarChart className="w-6 h-6 text-white" />
                                    </div>
                                    <div>
                                        <h1 className="text-lg sm:text-xl font-bold text-gray-900 truncate max-w-[180px] sm:max-w-none">{userProfile?.companyName || t.appName}</h1>
                                        <div className="flex items-center gap-2">
                                            <span className={`badge ${isOwner ? 'badge-purple' : 'badge-amber'}`}>
                                                {isOwner ? <><Icons.Crown className="w-3 h-3 mr-1" />{t.owner}</> : <><Icons.User className="w-3 h-3 mr-1" />{t.employee}</>}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    <select value={language} onChange={(e) => setLanguage(e.target.value)} className="hidden sm:block px-3 py-2 bg-gray-100 rounded-xl text-sm font-medium border-none">
                                        <option value="uk">🇺🇦 UA</option>
                                        <option value="ru">🇷🇺 RU</option>
                                    </select>
                                    
                                    <button onClick={() => setShowMenu(true)} className="btn btn-ghost btn-icon sm:hidden"><Icons.Menu className="w-6 h-6" /></button>
                                    
                                    <div className="hidden sm:flex items-center gap-2">
                                        {isOwner && (
                                            <>
                                                <button onClick={() => setShowAIModal(true)} className="btn btn-ai"><Icons.Brain className="w-4 h-4" /><span className="hidden lg:inline">{t.aiAnalysis}</span></button>
                                                <button onClick={() => setShowTeamModal(true)} className="btn btn-secondary"><Icons.Users className="w-4 h-4" /></button>
                                                <button onClick={loadDemoData} className="btn btn-secondary" title="Завантажити демо-дані"><Icons.Sparkles className="w-4 h-4" /></button>
                                            </>
                                        )}
                                        <button onClick={exportToExcel} className="btn btn-secondary"><Icons.Download className="w-4 h-4" /><span className="hidden lg:inline">Excel</span></button>
                                        <button onClick={handleLogout} className="btn btn-ghost btn-icon"><Icons.LogOut className="w-5 h-5" /></button>
                                    </div>
                                </div>
                            </div>
                        </header>
                        
                        {/* Stats summary - покращені картки */}
                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                            {[
                                { label: t.columns, value: visibleColumns.length, icon: Icons.BarChart, gradient: 'from-blue-500 to-indigo-500', shadow: 'shadow-blue-500/20' },
                                { label: t.periods, value: dataRows.length, icon: Icons.Calendar, gradient: 'from-green-500 to-emerald-500', shadow: 'shadow-green-500/20' },
                                { label: t.employees, value: Object.keys(employees).length, icon: Icons.Users, gradient: 'from-purple-500 to-pink-500', shadow: 'shadow-purple-500/20' },
                                { label: t.values, value: visibleColumns.length * dataRows.length, icon: Icons.Target, gradient: 'from-amber-500 to-orange-500', shadow: 'shadow-amber-500/20' },
                            ].map((stat, i) => (
                                <div key={i} className="card p-4 animate-fade-in" style={{ animationDelay: `${i * 0.05}s` }}>
                                    <div className={`w-10 h-10 rounded-xl bg-gradient-to-br ${stat.gradient} ${stat.shadow} shadow-lg flex items-center justify-center mb-3`}>
                                        <stat.icon className="w-5 h-5 text-white" />
                                    </div>
                                    <div className="text-2xl font-bold text-gray-900">{stat.value}</div>
                                    <div className="text-xs text-gray-500 font-medium">{stat.label}</div>
                                </div>
                            ))}
                        </div>
                        
                        {/* Action buttons (desktop) */}
                        {isOwner && (
                            <div className="hidden sm:flex gap-3 mb-4">
                                <button onClick={() => setShowAddStatsModal(true)} className="btn btn-primary"><Icons.Plus className="w-5 h-5" />{t.addStats}</button>
                                <button onClick={addRow} className="btn btn-secondary"><Icons.Plus className="w-5 h-5" />{t.addRow}</button>
                            </div>
                        )}
                        
                        {/* Mobile: Cards view */}
                        <div className="sm:hidden space-y-4">
                            {dataRows.length > 0 ? (
                                dataRows.map((row, index) => (
                                    <StatsCard 
                                        key={row.id} 
                                        row={row} 
                                        columns={visibleColumns} 
                                        editable
                                        onDelete={() => deleteRow(row.id)} 
                                        onDateChange={(date) => updateDate(row.id, date)}
                                        onValueChange={(colId, value) => updateValue(row.id, colId, value)}
                                        onTargetChange={(colId, value) => updateTarget(row.id, colId, value)}
                                        onCommentChange={(colId, comment) => updateComment(row.id, colId, comment)} 
                                        t={t} 
                                    />
                                ))
                            ) : (
                                <div className="empty-state">
                                    <div className="empty-state-icon">
                                        <Icons.BarChart className="w-10 h-10 text-primary-500" />
                                    </div>
                                    <h3 className="text-xl font-bold text-gray-900 mb-2">{t.noData}</h3>
                                    <p className="text-gray-500 mb-6">Почніть з додавання першого запису</p>
                                    {isOwner && (
                                        <div className="flex flex-col gap-3 w-full max-w-xs">
                                            <button onClick={loadDemoData} className="btn btn-secondary w-full">
                                                <Icons.Sparkles className="w-5 h-5" />
                                                Завантажити демо-дані
                                            </button>
                                            <button onClick={addRow} className="btn btn-primary w-full">
                                                <Icons.Plus className="w-5 h-5" />
                                                {t.addRow}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        
                        {/* Desktop: Table view */}
                        <div className="hidden sm:block">
                            <StatsTable columns={visibleColumns} rows={rows} targetRow={targetRow}
                                onDeleteRow={deleteRow} onDateChange={updateDate} onValueChange={updateValue} onCommentChange={updateComment}
                                onEditColumn={(col) => { setEditingColumn(col); setShowEditColumnModal(true); }}
                                editable={isOwner} t={t} />
                        </div>
                    </div>
                    
                    {/* Bottom Navigation (Mobile) */}
                    <nav className="bottom-nav mobile-only">
                        <button onClick={() => setActiveTab('stats')} className={`bottom-nav-item ${activeTab === 'stats' ? 'active' : ''}`}>
                            <Icons.BarChart />
                            <span>Статистика</span>
                        </button>
                        {isOwner && (
                            <button onClick={() => setShowAIModal(true)} className={`bottom-nav-item`}>
                                <Icons.Brain />
                                <span>AI</span>
                            </button>
                        )}
                        <button onClick={() => setShowMenu(true)} className="bottom-nav-item">
                            <Icons.Menu />
                            <span>Меню</span>
                        </button>
                    </nav>
                    
                    {/* FAB + Quick Actions (Mobile) */}
                    {isOwner && (
                        <>
                            {showQuickActions && (
                                <div className="quick-actions mobile-only animate-fade-in">
                                    <button onClick={() => { setShowAddStatsModal(true); setShowQuickActions(false); }} className="quick-action-btn bg-blue-500 text-white" title="Додати показник">
                                        <Icons.BarChart className="w-5 h-5" />
                                    </button>
                                    <button onClick={() => { exportToExcel(); setShowQuickActions(false); }} className="quick-action-btn bg-purple-500 text-white" title="Експорт">
                                        <Icons.Download className="w-5 h-5" />
                                    </button>
                                    <button onClick={() => { loadDemoData(); setShowQuickActions(false); }} className="quick-action-btn bg-amber-500 text-white" title="Демо дані">
                                        <Icons.Sparkles className="w-5 h-5" />
                                    </button>
                                </div>
                            )}
                            <button 
                                onClick={() => {
                                    if (showQuickActions) {
                                        setShowQuickActions(false);
                                    } else {
                                        addRow();
                                    }
                                }}
                                onLongPress={() => setShowQuickActions(true)}
                                onContextMenu={(e) => { e.preventDefault(); setShowQuickActions(!showQuickActions); }}
                                className="fab mobile-only"
                            >
                                <Icons.Plus className={`transition-transform ${showQuickActions ? 'rotate-45' : ''}`} />
                            </button>
                        </>
                    )}
                    
                    {/* Support button - видима на всіх пристроях */}
                    <a href={SUPPORT_URL} target="_blank" rel="noopener noreferrer" className="support-btn">
                        <Icons.MessageCircle className="w-5 h-5" /><span className="hidden sm:inline">{t.support}</span>
                    </a>
                    
                    {/* Mobile menu - покращене */}
                    <Modal isOpen={showMenu} onClose={() => setShowMenu(false)} title="">
                        <div className="space-y-2">
                            {/* User info */}
                            <div className="flex items-center gap-4 p-4 bg-gradient-to-r from-primary-50 to-green-50 rounded-2xl mb-4">
                                <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center">
                                    <Icons.User className="w-7 h-7 text-white" />
                                </div>
                                <div className="flex-1">
                                    <p className="font-bold text-gray-900">{userProfile?.companyName}</p>
                                    <p className="text-sm text-gray-500">{user?.email}</p>
                                    <span className={`badge mt-1 ${isOwner ? 'badge-purple' : 'badge-amber'}`}>
                                        {isOwner ? t.owner : t.employee}
                                    </span>
                                </div>
                            </div>
                            
                            {/* Language */}
                            <div className="flex items-center justify-between p-4 bg-gray-50 rounded-2xl">
                                <span className="font-medium flex items-center gap-2">
                                    <Icons.Globe className="w-5 h-5 text-gray-400" />
                                    Мова
                                </span>
                                <select value={language} onChange={(e) => setLanguage(e.target.value)} className="px-4 py-2 bg-white rounded-xl text-sm font-medium border border-gray-200">
                                    <option value="uk">🇺🇦 Українська</option>
                                    <option value="ru">🇷🇺 Русский</option>
                                </select>
                            </div>
                            
                            {isOwner && (
                                <>
                                    <div className="pt-2 pb-1">
                                        <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-1">Дії</p>
                                    </div>
                                    <button onClick={() => { setShowAIModal(true); setShowMenu(false); }} className="btn btn-ai w-full justify-start">
                                        <Icons.Brain className="w-5 h-5" />AI Аналіз
                                    </button>
                                    <button onClick={() => { setShowAddStatsModal(true); setShowMenu(false); }} className="btn btn-primary w-full justify-start">
                                        <Icons.Plus className="w-5 h-5" />{t.addStats}
                                    </button>
                                    <button onClick={() => { addRow(); setShowMenu(false); }} className="btn btn-secondary w-full justify-start">
                                        <Icons.Plus className="w-5 h-5" />{t.addRow}
                                    </button>
                                    
                                    <div className="pt-4 pb-1">
                                        <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-1">Управління</p>
                                    </div>
                                    <button onClick={() => { setShowTeamModal(true); setShowMenu(false); }} className="btn btn-secondary w-full justify-start">
                                        <Icons.Users className="w-5 h-5" />{t.teamManagement}
                                    </button>
                                    <button onClick={() => { loadDemoData(); setShowMenu(false); }} className="btn btn-secondary w-full justify-start">
                                        <Icons.Sparkles className="w-5 h-5" />Завантажити демо-дані
                                    </button>
                                </>
                            )}
                            
                            <div className="pt-4 pb-1">
                                <p className="text-xs font-semibold text-gray-400 uppercase tracking-wider px-1">Інше</p>
                            </div>
                            <button onClick={() => { exportToExcel(); setShowMenu(false); }} className="btn btn-primary w-full justify-start">
                                <Icons.Download className="w-5 h-5" />Експорт в Excel
                            </button>
                            <a href={SUPPORT_URL} target="_blank" rel="noopener noreferrer" className="btn btn-secondary w-full justify-start" onClick={() => setShowMenu(false)}>
                                <Icons.MessageCircle className="w-5 h-5" />{t.support}
                            </a>
                            
                            <div className="pt-2">
                                <button onClick={() => { handleLogout(); setShowMenu(false); }} className="btn btn-ghost w-full justify-start text-red-500">
                                    <Icons.LogOut className="w-5 h-5" />{t.logout}
                                </button>
                            </div>
                        </div>
                    </Modal>
                    
                    {/* Add stats modal */}
                    <Modal isOpen={showAddStatsModal} onClose={() => setShowAddStatsModal(false)} title={t.addStats}>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.statsName} *</label>
                                <input type="text" value={newStatsName} onChange={(e) => setNewStatsName(e.target.value)} className="input-field" placeholder="Наприклад: Продажі" autoFocus />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.responsible}</label>
                                <input type="text" value={newStatsResponsible} onChange={(e) => setNewStatsResponsible(e.target.value)} className="input-field" placeholder="Наприклад: Іван" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.period}</label>
                                <select value={newStatsPeriod} onChange={(e) => setNewStatsPeriod(e.target.value)} className="select-field">
                                    <option value="daily">{t.periodDaily}</option>
                                    <option value="weekly">{t.periodWeekly}</option>
                                    <option value="monthly">{t.periodMonthly}</option>
                                    <option value="custom">{t.periodCustom}</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.target}</label>
                                <input type="text" value={newStatsTarget} onChange={(e) => setNewStatsTarget(e.target.value)} className="input-field" placeholder="Наприклад: 100" />
                            </div>
                            <div className="flex gap-3 pt-2">
                                <button onClick={() => setShowAddStatsModal(false)} className="btn btn-secondary flex-1">{t.cancel}</button>
                                <button onClick={addColumn} disabled={!newStatsName.trim()} className="btn btn-primary flex-1">{t.add}</button>
                            </div>
                        </div>
                    </Modal>
                    
                    {/* Edit column modal */}
                    <Modal isOpen={showEditColumnModal} onClose={() => { setShowEditColumnModal(false); setEditingColumn(null); }} title={t.editColumn}>
                        {editingColumn && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.statsName}</label>
                                    <input type="text" value={editingColumn.name} onChange={(e) => setEditingColumn({ ...editingColumn, name: e.target.value })} className="input-field" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.responsible}</label>
                                    <input type="text" value={editingColumn.responsible || ''} onChange={(e) => setEditingColumn({ ...editingColumn, responsible: e.target.value })} className="input-field" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.period}</label>
                                    <select value={editingColumn.period} onChange={(e) => setEditingColumn({ ...editingColumn, period: e.target.value })} className="select-field">
                                        <option value="daily">{t.periodDaily}</option>
                                        <option value="weekly">{t.periodWeekly}</option>
                                        <option value="monthly">{t.periodMonthly}</option>
                                        <option value="custom">{t.periodCustom}</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.target}</label>
                                    <input type="text" value={targetRow?.values?.[editingColumn.id] || ''} onChange={(e) => updateValue('target', editingColumn.id, e.target.value)} className="input-field" />
                                </div>
                                
                                {Object.keys(employees).length > 0 && (
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">{t.visibleColumns}</label>
                                        <div className="space-y-2">
                                            {Object.entries(employees).map(([empId, emp]) => (
                                                <label key={empId} className="checkbox-item">
                                                    <input
                                                        type="checkbox"
                                                        checked={editingColumn.visibleToEmployees?.includes(empId) || false}
                                                        onChange={(e) => {
                                                            const newVisible = e.target.checked
                                                                ? [...(editingColumn.visibleToEmployees || []), empId]
                                                                : (editingColumn.visibleToEmployees || []).filter(id => id !== empId);
                                                            setEditingColumn({ ...editingColumn, visibleToEmployees: newVisible });
                                                        }}
                                                    />
                                                    <span>{emp.name || emp.email}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex gap-3 pt-2">
                                    <button onClick={() => { deleteColumn(editingColumn.id); setShowEditColumnModal(false); setEditingColumn(null); }} className="btn btn-danger">
                                        <Icons.Trash className="w-4 h-4" />
                                    </button>
                                    <button onClick={() => { setShowEditColumnModal(false); setEditingColumn(null); }} className="btn btn-secondary flex-1">{t.cancel}</button>
                                    <button onClick={() => { updateColumn(editingColumn.id, editingColumn); setShowEditColumnModal(false); setEditingColumn(null); toast.success(t.saved); }} className="btn btn-primary flex-1">{t.save}</button>
                                </div>
                            </div>
                        )}
                    </Modal>
                    
                    {/* Team modal */}
                    <Modal isOpen={showTeamModal} onClose={() => setShowTeamModal(false)} title={t.teamManagement} size="lg">
                        <div className="space-y-4">
                            <button onClick={() => { setSelectedColumns(columns.map(c => c.id)); setShowAddEmployeeModal(true); }} className="btn btn-primary w-full">
                                <Icons.UserPlus className="w-5 h-5" />{t.addEmployee}
                            </button>
                            
                            <h4 className="font-semibold text-gray-700">{t.employees}</h4>
                            
                            {Object.keys(employees).length === 0 ? (
                                <div className="text-center py-8 text-gray-500">{t.noEmployees}</div>
                            ) : (
                                <div className="space-y-3">
                                    {Object.entries(employees).map(([empId, emp]) => (
                                        <div key={empId} className="p-4 bg-gray-50 rounded-xl">
                                            <div className="flex items-center justify-between mb-3">
                                                <div>
                                                    <div className="font-semibold text-gray-900">{emp.name || emp.email}</div>
                                                    <div className="text-sm text-gray-500">{emp.email}</div>
                                                    <span className={`badge mt-2 ${emp.pending ? 'badge-amber' : 'badge-green'}`}>
                                                        {emp.pending ? t.pendingInvite : t.activeEmployee}
                                                    </span>
                                                </div>
                                                <button onClick={() => removeEmployee(empId)} className="btn btn-ghost btn-icon text-red-500"><Icons.Trash className="w-4 h-4" /></button>
                                            </div>
                                            <div>
                                                <p className="text-xs text-gray-500 mb-2">{t.visibleColumns}:</p>
                                                <div className="flex flex-wrap gap-1">
                                                    {columns.map(col => {
                                                        const isVisible = emp.visibleColumns?.includes(col.id);
                                                        return (
                                                            <button
                                                                key={col.id}
                                                                onClick={() => {
                                                                    const newCols = isVisible ? emp.visibleColumns.filter(id => id !== col.id) : [...(emp.visibleColumns || []), col.id];
                                                                    updateEmployeeColumns(empId, newCols);
                                                                }}
                                                                className={`text-xs px-2 py-1 rounded-lg transition-colors ${isVisible ? 'bg-primary-100 text-primary-700' : 'bg-gray-200 text-gray-500'}`}
                                                            >
                                                                {col.name}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </Modal>
                    
                    {/* Add employee modal */}
                    <Modal isOpen={showAddEmployeeModal} onClose={() => { setShowAddEmployeeModal(false); setGeneratedInviteLink(''); setNewEmployeeEmail(''); setNewEmployeeName(''); }} title={t.addEmployee}>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.employeeEmail}</label>
                                <input type="email" value={newEmployeeEmail} onChange={(e) => setNewEmployeeEmail(e.target.value)} className="input-field" placeholder="email@example.com" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1.5">{t.employeeName}</label>
                                <input type="text" value={newEmployeeName} onChange={(e) => setNewEmployeeName(e.target.value)} className="input-field" placeholder="Ім'я" />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">{t.visibleColumns}</label>
                                <div className="space-y-2 max-h-48 overflow-y-auto">
                                    {columns.map(col => (
                                        <label key={col.id} className="checkbox-item">
                                            <input type="checkbox" checked={selectedColumns.includes(col.id)} onChange={(e) => {
                                                setSelectedColumns(e.target.checked ? [...selectedColumns, col.id] : selectedColumns.filter(id => id !== col.id));
                                            }} />
                                            <span>{col.name}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            
                            {generatedInviteLink && (
                                <div className="p-4 bg-green-50 rounded-xl">
                                    <p className="text-sm font-semibold text-green-700 mb-2">{t.inviteLink}:</p>
                                    <div className="flex gap-2">
                                        <input type="text" value={generatedInviteLink} readOnly className="flex-1 px-3 py-2 text-sm bg-white border border-green-200 rounded-lg" />
                                        <button onClick={copyInviteLink} className="btn btn-primary"><Icons.Copy className="w-4 h-4" /></button>
                                    </div>
                                </div>
                            )}
                            
                            <div className="flex gap-3 pt-2">
                                <button onClick={() => { setShowAddEmployeeModal(false); setGeneratedInviteLink(''); }} className="btn btn-secondary flex-1">{t.cancel}</button>
                                <button onClick={addEmployee} disabled={!newEmployeeEmail.trim()} className="btn btn-primary flex-1">{generatedInviteLink ? 'Готово' : t.add}</button>
                            </div>
                        </div>
                    </Modal>
                    
                    {/* AI Analysis modal */}
                    <Modal isOpen={showAIModal} onClose={() => setShowAIModal(false)} title={t.aiAnalysis} size="2xl">
                        <div className="space-y-4">
                            {/* Контекст бізнесу - одразу видимий */}
                            <div className="p-4 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl border border-purple-200">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="font-bold text-purple-900 flex items-center gap-2">
                                        <Icons.Building className="w-5 h-5" />
                                        Контекст вашого бізнесу
                                    </h3>
                                    <span className="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full">Обов'язково</span>
                                </div>
                                <textarea
                                    value={aiSettings.businessContext} 
                                    onChange={(e) => setAiSettings({ ...aiSettings, businessContext: e.target.value })}
                                    className="textarea-field border-purple-200 focus:border-purple-400" 
                                    rows={3} 
                                    placeholder="Опишіть ваш бізнес: галузь, послуги, команда, середній чек, канали залучення клієнтів..."
                                />
                            </div>
                            
                            <div className="p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200">
                                <h3 className="font-bold text-amber-900 flex items-center gap-2 mb-3">
                                    <Icons.Target className="w-5 h-5" />
                                    Пріоритети зараз
                                </h3>
                                <textarea
                                    value={aiSettings.priorities} 
                                    onChange={(e) => setAiSettings({ ...aiSettings, priorities: e.target.value })}
                                    className="textarea-field border-amber-200 focus:border-amber-400" 
                                    rows={2} 
                                    placeholder="Що найважливіше зараз? Збільшити продажі, оптимізувати витрати, покращити конверсію..."
                                />
                            </div>
                            
                            {!aiSettings.businessContext && (
                                <div className="p-3 bg-red-50 border border-red-200 rounded-xl flex items-center gap-3">
                                    <Icons.AlertCircle className="w-5 h-5 text-red-500 flex-shrink-0" />
                                    <p className="text-sm text-red-700">Заповніть контекст бізнесу вище — без нього AI не зможе дати корисні рекомендації</p>
                                </div>
                            )}
                            
                            <AIAnalysis columns={visibleColumns} rows={rows} targetRow={targetRow} aiSettings={aiSettings} language={language} onSaveAnalysis={saveAnalysis} savedAnalyses={savedAnalyses} t={t} />
                        </div>
                    </Modal>
                    
                    {/* AI Settings modal - видалено, тепер все в одному місці */}
                    
                    {/* Confirm dialog */}
                    <ConfirmDialog isOpen={confirmDialog.isOpen} onClose={() => setConfirmDialog({ isOpen: false })} onConfirm={confirmDialog.onConfirm} title={confirmDialog.title} message={confirmDialog.message} />
                </div>
            );
        };

        // ==================== ROOT ====================
        const Root = () => (<ToastProvider><App /></ToastProvider>);
        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
